var pg=Object.create;var Lc=Object.defineProperty;var Ml=Object.getOwnPropertyDescriptor;var dg=Object.getOwnPropertyNames;var mg=Object.getPrototypeOf,fg=Object.prototype.hasOwnProperty;var hi=(o=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(o,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):o)(function(o){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+o+'" is not supported')});var _=(o,e)=>()=>(e||o((e={exports:{}}).exports,e),e.exports);var yg=(o,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of dg(e))!fg.call(o,n)&&n!==t&&Lc(o,n,{get:()=>e[n],enumerable:!(r=Ml(e,n))||r.enumerable});return o};var It=(o,e,t)=>(t=o!=null?pg(mg(o)):{},yg(e||!o||!o.__esModule?Lc(t,"default",{value:o,enumerable:!0}):t,o));var pi=(o,e,t,r)=>{for(var n=r>1?void 0:r?Ml(e,t):e,i=o.length-1,s;i>=0;i--)(s=o[i])&&(n=(r?s(e,t,n):s(n))||n);return r&&n&&Lc(e,t,n),n};var _c=_(()=>{var vl;(function(o){(function(e){var t=typeof globalThis=="object"||typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:a(),r=n(o);typeof t.Reflect<"u"&&(r=n(t.Reflect,r)),e(r,t),typeof t.Reflect>"u"&&(t.Reflect=o);function n(c,u){return function(l,h){Object.defineProperty(c,l,{configurable:!0,writable:!0,value:h}),u&&u(l,h)}}function i(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||s()}})(function(e,t){var r=Object.prototype.hasOwnProperty,n=typeof Symbol=="function",i=n&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=n&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,u=!a&&!c,l={create:a?function(){return Sr(Object.create(null))}:c?function(){return Sr({__proto__:null})}:function(){return Sr({})},has:u?function(g,E){return r.call(g,E)}:function(g,E){return E in g},get:u?function(g,E){return r.call(g,E)?g[E]:void 0}:function(g,E){return g[E]}},h=Object.getPrototypeOf(Function),p=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:Oc(),d=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:Ic(),m=typeof WeakMap=="function"?WeakMap:$c(),f=n?Symbol.for("@reflect-metadata:registry"):void 0,A=Mc(),R=vc(A);function I(g,E,N,q){if(B(N)){if(!ut(g))throw new TypeError;if(!ii(E))throw new TypeError;return $(g,E)}else{if(!ut(g))throw new TypeError;if(!ie(E))throw new TypeError;if(!ie(q)&&!B(q)&&!fe(q))throw new TypeError;return fe(q)&&(q=void 0),N=Se(N),T(g,E,N,q)}}e("decorate",I);function C(g,E){function N(q,G){if(!ie(q))throw new TypeError;if(!B(G)&&!Rc(G))throw new TypeError;j(g,E,q,G)}return N}e("metadata",C);function U(g,E,N,q){if(!ie(N))throw new TypeError;return B(q)||(q=Se(q)),j(g,E,N,q)}e("defineMetadata",U);function J(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),w(g,E,N)}e("hasMetadata",J);function ne(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),P(g,E,N)}e("hasOwnMetadata",ne);function oe(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),v(g,E,N)}e("getMetadata",oe);function z(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),D(g,E,N)}e("getOwnMetadata",z);function O(g,E){if(!ie(g))throw new TypeError;return B(E)||(E=Se(E)),Z(g,E)}e("getMetadataKeys",O);function he(g,E){if(!ie(g))throw new TypeError;return B(E)||(E=Se(E)),se(g,E)}e("getOwnMetadataKeys",he);function S(g,E,N){if(!ie(E))throw new TypeError;if(B(N)||(N=Se(N)),!ie(E))throw new TypeError;B(N)||(N=Se(N));var q=Ot(E,N,!1);return B(q)?!1:q.OrdinaryDeleteMetadata(g,E,N)}e("deleteMetadata",S);function $(g,E){for(var N=g.length-1;N>=0;--N){var q=g[N],G=q(E);if(!B(G)&&!fe(G)){if(!ii(G))throw new TypeError;E=G}}return E}function T(g,E,N,q){for(var G=g.length-1;G>=0;--G){var Te=g[G],Ne=Te(E,N,q);if(!B(Ne)&&!fe(Ne)){if(!ie(Ne))throw new TypeError;q=Ne}}return q}function w(g,E,N){var q=P(g,E,N);if(q)return!0;var G=Rr(E);return fe(G)?!1:w(g,G,N)}function P(g,E,N){var q=Ot(E,N,!1);return B(q)?!1:we(q.OrdinaryHasOwnMetadata(g,E,N))}function v(g,E,N){var q=P(g,E,N);if(q)return D(g,E,N);var G=Rr(E);if(!fe(G))return v(g,G,N)}function D(g,E,N){var q=Ot(E,N,!1);if(!B(q))return q.OrdinaryGetOwnMetadata(g,E,N)}function j(g,E,N,q){var G=Ot(N,q,!0);G.OrdinaryDefineOwnMetadata(g,E,N,q)}function Z(g,E){var N=se(g,E),q=Rr(g);if(q===null)return N;var G=Z(q,E);if(G.length<=0)return N;if(N.length<=0)return G;for(var Te=new d,Ne=[],ee=0,L=N;ee<L.length;ee++){var F=L[ee],Q=Te.has(F);Q||(Te.add(F),Ne.push(F))}for(var W=0,te=G;W<te.length;W++){var F=te[W],Q=Te.has(F);Q||(Te.add(F),Ne.push(F))}return Ne}function se(g,E){var N=Ot(g,E,!1);return N?N.OrdinaryOwnMetadataKeys(g,E):[]}function me(g){if(g===null)return 1;switch(typeof g){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return g===null?1:6;default:return 6}}function B(g){return g===void 0}function fe(g){return g===null}function ke(g){return typeof g=="symbol"}function ie(g){return typeof g=="object"?g!==null:typeof g=="function"}function Ee(g,E){switch(me(g)){case 0:return g;case 1:return g;case 2:return g;case 3:return g;case 4:return g;case 5:return g}var N=E===3?"string":E===5?"number":"default",q=si(g,i);if(q!==void 0){var G=q.call(g,N);if(ie(G))throw new TypeError;return G}return Ae(g,N==="default"?"number":N)}function Ae(g,E){if(E==="string"){var N=g.toString;if(xt(N)){var q=N.call(g);if(!ie(q))return q}var G=g.valueOf;if(xt(G)){var q=G.call(g);if(!ie(q))return q}}else{var G=g.valueOf;if(xt(G)){var q=G.call(g);if(!ie(q))return q}var Te=g.toString;if(xt(Te)){var q=Te.call(g);if(!ie(q))return q}}throw new TypeError}function we(g){return!!g}function qe(g){return""+g}function Se(g){var E=Ee(g,3);return ke(E)?E:qe(E)}function ut(g){return Array.isArray?Array.isArray(g):g instanceof Object?g instanceof Array:Object.prototype.toString.call(g)==="[object Array]"}function xt(g){return typeof g=="function"}function ii(g){return typeof g=="function"}function Rc(g){switch(me(g)){case 3:return!0;case 4:return!0;default:return!1}}function Cr(g,E){return g===E||g!==g&&E!==E}function si(g,E){var N=g[E];if(N!=null){if(!xt(N))throw new TypeError;return N}}function ai(g){var E=si(g,s);if(!xt(E))throw new TypeError;var N=E.call(g);if(!ie(N))throw new TypeError;return N}function oi(g){return g.value}function ci(g){var E=g.next();return E.done?!1:E}function ui(g){var E=g.return;E&&E.call(g)}function Rr(g){var E=Object.getPrototypeOf(g);if(typeof g!="function"||g===h||E!==h)return E;var N=g.prototype,q=N&&Object.getPrototypeOf(N);if(q==null||q===Object.prototype)return E;var G=q.constructor;return typeof G!="function"||G===g?E:G}function Sc(){var g;!B(f)&&typeof t.Reflect<"u"&&!(f in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(g=Pc(t.Reflect));var E,N,q,G=new m,Te={registerProvider:Ne,getProvider:L,setProvider:Q};return Te;function Ne(W){if(!Object.isExtensible(Te))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case g===W:break;case B(E):E=W;break;case E===W:break;case B(N):N=W;break;case N===W:break;default:q===void 0&&(q=new d),q.add(W);break}}function ee(W,te){if(!B(E)){if(E.isProviderFor(W,te))return E;if(!B(N)){if(N.isProviderFor(W,te))return E;if(!B(q))for(var de=ai(q);;){var be=ci(de);if(!be)return;var Ue=oi(be);if(Ue.isProviderFor(W,te))return ui(de),Ue}}}if(!B(g)&&g.isProviderFor(W,te))return g}function L(W,te){var de=G.get(W),be;return B(de)||(be=de.get(te)),B(be)&&(be=ee(W,te),B(be)||(B(de)&&(de=new p,G.set(W,de)),de.set(te,be))),be}function F(W){if(B(W))throw new TypeError;return E===W||N===W||!B(q)&&q.has(W)}function Q(W,te,de){if(!F(de))throw new Error("Metadata provider not registered.");var be=L(W,te);if(be!==de){if(!B(be))return!1;var Ue=G.get(W);B(Ue)&&(Ue=new p,G.set(W,Ue)),Ue.set(te,de)}return!0}}function Mc(){var g;return!B(f)&&ie(t.Reflect)&&Object.isExtensible(t.Reflect)&&(g=t.Reflect[f]),B(g)&&(g=Sc()),!B(f)&&ie(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,f,{enumerable:!1,configurable:!1,writable:!1,value:g}),g}function vc(g){var E=new m,N={isProviderFor:function(F,Q){var W=E.get(F);return B(W)?!1:W.has(Q)},OrdinaryDefineOwnMetadata:Ne,OrdinaryHasOwnMetadata:G,OrdinaryGetOwnMetadata:Te,OrdinaryOwnMetadataKeys:ee,OrdinaryDeleteMetadata:L};return A.registerProvider(N),N;function q(F,Q,W){var te=E.get(F),de=!1;if(B(te)){if(!W)return;te=new p,E.set(F,te),de=!0}var be=te.get(Q);if(B(be)){if(!W)return;if(be=new p,te.set(Q,be),!g.setProvider(F,Q,N))throw te.delete(Q),de&&E.delete(F),new Error("Wrong provider for target.")}return be}function G(F,Q,W){var te=q(Q,W,!1);return B(te)?!1:we(te.has(F))}function Te(F,Q,W){var te=q(Q,W,!1);if(!B(te))return te.get(F)}function Ne(F,Q,W,te){var de=q(W,te,!0);de.set(F,Q)}function ee(F,Q){var W=[],te=q(F,Q,!1);if(B(te))return W;for(var de=te.keys(),be=ai(de),Ue=0;;){var li=ci(be);if(!li)return W.length=Ue,W;var qc=oi(li);try{W[Ue]=qc}catch(Dc){try{ui(be)}finally{throw Dc}}Ue++}}function L(F,Q,W){var te=q(Q,W,!1);if(B(te)||!te.delete(F))return!1;if(te.size===0){var de=E.get(Q);B(de)||(de.delete(W),de.size===0&&E.delete(de))}return!0}}function Pc(g){var E=g.defineMetadata,N=g.hasOwnMetadata,q=g.getOwnMetadata,G=g.getOwnMetadataKeys,Te=g.deleteMetadata,Ne=new m,ee={isProviderFor:function(L,F){var Q=Ne.get(L);return!B(Q)&&Q.has(F)?!0:G(L,F).length?(B(Q)&&(Q=new d,Ne.set(L,Q)),Q.add(F),!0):!1},OrdinaryDefineOwnMetadata:E,OrdinaryHasOwnMetadata:N,OrdinaryGetOwnMetadata:q,OrdinaryOwnMetadataKeys:G,OrdinaryDeleteMetadata:Te};return ee}function Ot(g,E,N){var q=A.getProvider(g,E);if(!B(q))return q;if(N){if(A.setProvider(g,E,R))return R;throw new Error("Illegal state.")}}function Oc(){var g={},E=[],N=(function(){function ee(L,F,Q){this._index=0,this._keys=L,this._values=F,this._selector=Q}return ee.prototype["@@iterator"]=function(){return this},ee.prototype[s]=function(){return this},ee.prototype.next=function(){var L=this._index;if(L>=0&&L<this._keys.length){var F=this._selector(this._keys[L],this._values[L]);return L+1>=this._keys.length?(this._index=-1,this._keys=E,this._values=E):this._index++,{value:F,done:!1}}return{value:void 0,done:!0}},ee.prototype.throw=function(L){throw this._index>=0&&(this._index=-1,this._keys=E,this._values=E),L},ee.prototype.return=function(L){return this._index>=0&&(this._index=-1,this._keys=E,this._values=E),{value:L,done:!0}},ee})(),q=(function(){function ee(){this._keys=[],this._values=[],this._cacheKey=g,this._cacheIndex=-2}return Object.defineProperty(ee.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),ee.prototype.has=function(L){return this._find(L,!1)>=0},ee.prototype.get=function(L){var F=this._find(L,!1);return F>=0?this._values[F]:void 0},ee.prototype.set=function(L,F){var Q=this._find(L,!0);return this._values[Q]=F,this},ee.prototype.delete=function(L){var F=this._find(L,!1);if(F>=0){for(var Q=this._keys.length,W=F+1;W<Q;W++)this._keys[W-1]=this._keys[W],this._values[W-1]=this._values[W];return this._keys.length--,this._values.length--,Cr(L,this._cacheKey)&&(this._cacheKey=g,this._cacheIndex=-2),!0}return!1},ee.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=g,this._cacheIndex=-2},ee.prototype.keys=function(){return new N(this._keys,this._values,G)},ee.prototype.values=function(){return new N(this._keys,this._values,Te)},ee.prototype.entries=function(){return new N(this._keys,this._values,Ne)},ee.prototype["@@iterator"]=function(){return this.entries()},ee.prototype[s]=function(){return this.entries()},ee.prototype._find=function(L,F){if(!Cr(this._cacheKey,L)){this._cacheIndex=-1;for(var Q=0;Q<this._keys.length;Q++)if(Cr(this._keys[Q],L)){this._cacheIndex=Q;break}}return this._cacheIndex<0&&F&&(this._cacheIndex=this._keys.length,this._keys.push(L),this._values.push(void 0)),this._cacheIndex},ee})();return q;function G(ee,L){return ee}function Te(ee,L){return L}function Ne(ee,L){return[ee,L]}}function Ic(){var g=(function(){function E(){this._map=new p}return Object.defineProperty(E.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),E.prototype.has=function(N){return this._map.has(N)},E.prototype.add=function(N){return this._map.set(N,N),this},E.prototype.delete=function(N){return this._map.delete(N)},E.prototype.clear=function(){this._map.clear()},E.prototype.keys=function(){return this._map.keys()},E.prototype.values=function(){return this._map.keys()},E.prototype.entries=function(){return this._map.entries()},E.prototype["@@iterator"]=function(){return this.keys()},E.prototype[s]=function(){return this.keys()},E})();return g}function $c(){var g=16,E=l.create(),N=q();return(function(){function L(){this._key=q()}return L.prototype.has=function(F){var Q=G(F,!1);return Q!==void 0?l.has(Q,this._key):!1},L.prototype.get=function(F){var Q=G(F,!1);return Q!==void 0?l.get(Q,this._key):void 0},L.prototype.set=function(F,Q){var W=G(F,!0);return W[this._key]=Q,this},L.prototype.delete=function(F){var Q=G(F,!1);return Q!==void 0?delete Q[this._key]:!1},L.prototype.clear=function(){this._key=q()},L})();function q(){var L;do L="@@WeakMap@@"+ee();while(l.has(E,L));return E[L]=!0,L}function G(L,F){if(!r.call(L,N)){if(!F)return;Object.defineProperty(L,N,{value:l.create()})}return L[N]}function Te(L,F){for(var Q=0;Q<F;++Q)L[Q]=Math.random()*255|0;return L}function Ne(L){if(typeof Uint8Array=="function"){var F=new Uint8Array(L);return typeof crypto<"u"?crypto.getRandomValues(F):typeof msCrypto<"u"?msCrypto.getRandomValues(F):Te(F,L),F}return Te(new Array(L),L)}function ee(){var L=Ne(g);L[6]=L[6]&79|64,L[8]=L[8]&191|128;for(var F="",Q=0;Q<g;++Q){var W=L[Q];(Q===4||Q===6||Q===8)&&(F+="-"),W<16&&(F+="0"),F+=W.toString(16).toLowerCase()}return F}}function Sr(g){return g.__=void 0,delete g.__,g}})})(vl||(vl={}))});var Il=_(ws=>{"use strict";ws.byteLength=Eg;ws.toByteArray=bg;ws.fromByteArray=Ag;var Lt=[],Rt=[],gg=typeof Uint8Array<"u"?Uint8Array:Array,Bc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Mr=0,Pl=Bc.length;Mr<Pl;++Mr)Lt[Mr]=Bc[Mr],Rt[Bc.charCodeAt(Mr)]=Mr;var Mr,Pl;Rt[45]=62;Rt[95]=63;function Ol(o){var e=o.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=o.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function Eg(o){var e=Ol(o),t=e[0],r=e[1];return(t+r)*3/4-r}function Tg(o,e,t){return(e+t)*3/4-t}function bg(o){var e,t=Ol(o),r=t[0],n=t[1],i=new gg(Tg(o,r,n)),s=0,a=n>0?r-4:r,c;for(c=0;c<a;c+=4)e=Rt[o.charCodeAt(c)]<<18|Rt[o.charCodeAt(c+1)]<<12|Rt[o.charCodeAt(c+2)]<<6|Rt[o.charCodeAt(c+3)],i[s++]=e>>16&255,i[s++]=e>>8&255,i[s++]=e&255;return n===2&&(e=Rt[o.charCodeAt(c)]<<2|Rt[o.charCodeAt(c+1)]>>4,i[s++]=e&255),n===1&&(e=Rt[o.charCodeAt(c)]<<10|Rt[o.charCodeAt(c+1)]<<4|Rt[o.charCodeAt(c+2)]>>2,i[s++]=e>>8&255,i[s++]=e&255),i}function wg(o){return Lt[o>>18&63]+Lt[o>>12&63]+Lt[o>>6&63]+Lt[o&63]}function Ng(o,e,t){for(var r,n=[],i=e;i<t;i+=3)r=(o[i]<<16&16711680)+(o[i+1]<<8&65280)+(o[i+2]&255),n.push(wg(r));return n.join("")}function Ag(o){for(var e,t=o.length,r=t%3,n=[],i=16383,s=0,a=t-r;s<a;s+=i)n.push(Ng(o,s,s+i>a?a:s+i));return r===1?(e=o[t-1],n.push(Lt[e>>2]+Lt[e<<4&63]+"==")):r===2&&(e=(o[t-2]<<8)+o[t-1],n.push(Lt[e>>10]+Lt[e>>4&63]+Lt[e<<2&63]+"=")),n.join("")}});var $l=_(Uc=>{Uc.read=function(o,e,t,r,n){var i,s,a=n*8-r-1,c=(1<<a)-1,u=c>>1,l=-7,h=t?n-1:0,p=t?-1:1,d=o[e+h];for(h+=p,i=d&(1<<-l)-1,d>>=-l,l+=a;l>0;i=i*256+o[e+h],h+=p,l-=8);for(s=i&(1<<-l)-1,i>>=-l,l+=r;l>0;s=s*256+o[e+h],h+=p,l-=8);if(i===0)i=1-u;else{if(i===c)return s?NaN:(d?-1:1)*(1/0);s=s+Math.pow(2,r),i=i-u}return(d?-1:1)*s*Math.pow(2,i-r)};Uc.write=function(o,e,t,r,n,i){var s,a,c,u=i*8-n-1,l=(1<<u)-1,h=l>>1,p=n===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:i-1,m=r?1:-1,f=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=l):(s=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-s))<1&&(s--,c*=2),s+h>=1?e+=p/c:e+=p*Math.pow(2,1-h),e*c>=2&&(s++,c/=2),s+h>=l?(a=0,s=l):s+h>=1?(a=(e*c-1)*Math.pow(2,n),s=s+h):(a=e*Math.pow(2,h-1)*Math.pow(2,n),s=0));n>=8;o[t+d]=a&255,d+=m,a/=256,n-=8);for(s=s<<n|a,u+=n;u>0;o[t+d]=s&255,d+=m,s/=256,u-=8);o[t+d-m]|=f*128}});var xs=_(nn=>{"use strict";var Fc=Il(),tn=$l(),ql=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;nn.Buffer=k;nn.SlowBuffer=vg;nn.INSPECT_MAX_BYTES=50;var Ns=2147483647;nn.kMaxLength=Ns;k.TYPED_ARRAY_SUPPORT=xg();!k.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function xg(){try{let o=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(o,e),o.foo()===42}catch{return!1}}Object.defineProperty(k.prototype,"parent",{enumerable:!0,get:function(){if(k.isBuffer(this))return this.buffer}});Object.defineProperty(k.prototype,"offset",{enumerable:!0,get:function(){if(k.isBuffer(this))return this.byteOffset}});function Jt(o){if(o>Ns)throw new RangeError('The value "'+o+'" is invalid for option "size"');let e=new Uint8Array(o);return Object.setPrototypeOf(e,k.prototype),e}function k(o,e,t){if(typeof o=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return Vc(o)}return Bl(o,e,t)}k.poolSize=8192;function Bl(o,e,t){if(typeof o=="string")return Rg(o,e);if(ArrayBuffer.isView(o))return Sg(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(_t(o,ArrayBuffer)||o&&_t(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(_t(o,SharedArrayBuffer)||o&&_t(o.buffer,SharedArrayBuffer)))return Qc(o,e,t);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let r=o.valueOf&&o.valueOf();if(r!=null&&r!==o)return k.from(r,e,t);let n=Mg(o);if(n)return n;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return k.from(o[Symbol.toPrimitive]("string"),e,t);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}k.from=function(o,e,t){return Bl(o,e,t)};Object.setPrototypeOf(k.prototype,Uint8Array.prototype);Object.setPrototypeOf(k,Uint8Array);function Ul(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function Cg(o,e,t){return Ul(o),o<=0?Jt(o):e!==void 0?typeof t=="string"?Jt(o).fill(e,t):Jt(o).fill(e):Jt(o)}k.alloc=function(o,e,t){return Cg(o,e,t)};function Vc(o){return Ul(o),Jt(o<0?0:Wc(o)|0)}k.allocUnsafe=function(o){return Vc(o)};k.allocUnsafeSlow=function(o){return Vc(o)};function Rg(o,e){if((typeof e!="string"||e==="")&&(e="utf8"),!k.isEncoding(e))throw new TypeError("Unknown encoding: "+e);let t=Fl(o,e)|0,r=Jt(t),n=r.write(o,e);return n!==t&&(r=r.slice(0,n)),r}function jc(o){let e=o.length<0?0:Wc(o.length)|0,t=Jt(e);for(let r=0;r<e;r+=1)t[r]=o[r]&255;return t}function Sg(o){if(_t(o,Uint8Array)){let e=new Uint8Array(o);return Qc(e.buffer,e.byteOffset,e.byteLength)}return jc(o)}function Qc(o,e,t){if(e<0||o.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<e+(t||0))throw new RangeError('"length" is outside of buffer bounds');let r;return e===void 0&&t===void 0?r=new Uint8Array(o):t===void 0?r=new Uint8Array(o,e):r=new Uint8Array(o,e,t),Object.setPrototypeOf(r,k.prototype),r}function Mg(o){if(k.isBuffer(o)){let e=Wc(o.length)|0,t=Jt(e);return t.length===0||o.copy(t,0,0,e),t}if(o.length!==void 0)return typeof o.length!="number"||Gc(o.length)?Jt(0):jc(o);if(o.type==="Buffer"&&Array.isArray(o.data))return jc(o.data)}function Wc(o){if(o>=Ns)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Ns.toString(16)+" bytes");return o|0}function vg(o){return+o!=o&&(o=0),k.alloc(+o)}k.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==k.prototype};k.compare=function(e,t){if(_t(e,Uint8Array)&&(e=k.from(e,e.offset,e.byteLength)),_t(t,Uint8Array)&&(t=k.from(t,t.offset,t.byteLength)),!k.isBuffer(e)||!k.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0};k.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};k.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return k.alloc(0);let r;if(t===void 0)for(t=0,r=0;r<e.length;++r)t+=e[r].length;let n=k.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){let s=e[r];if(_t(s,Uint8Array))i+s.length>n.length?(k.isBuffer(s)||(s=k.from(s)),s.copy(n,i)):Uint8Array.prototype.set.call(n,s,i);else if(k.isBuffer(s))s.copy(n,i);else throw new TypeError('"list" argument must be an Array of Buffers');i+=s.length}return n};function Fl(o,e){if(k.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||_t(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);let t=o.length,r=arguments.length>2&&arguments[2]===!0;if(!r&&t===0)return 0;let n=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return t;case"utf8":case"utf-8":return kc(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return t*2;case"hex":return t>>>1;case"base64":return zl(o).length;default:if(n)return r?-1:kc(o).length;e=(""+e).toLowerCase(),n=!0}}k.byteLength=Fl;function Pg(o,e,t){let r=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((t===void 0||t>this.length)&&(t=this.length),t<=0)||(t>>>=0,e>>>=0,t<=e))return"";for(o||(o="utf8");;)switch(o){case"hex":return Fg(this,e,t);case"utf8":case"utf-8":return Ql(this,e,t);case"ascii":return Bg(this,e,t);case"latin1":case"binary":return Ug(this,e,t);case"base64":return Lg(this,e,t);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return jg(this,e,t);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),r=!0}}k.prototype._isBuffer=!0;function vr(o,e,t){let r=o[e];o[e]=o[t],o[t]=r}k.prototype.swap16=function(){let e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)vr(this,t,t+1);return this};k.prototype.swap32=function(){let e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)vr(this,t,t+3),vr(this,t+1,t+2);return this};k.prototype.swap64=function(){let e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)vr(this,t,t+7),vr(this,t+1,t+6),vr(this,t+2,t+5),vr(this,t+3,t+4);return this};k.prototype.toString=function(){let e=this.length;return e===0?"":arguments.length===0?Ql(this,0,e):Pg.apply(this,arguments)};k.prototype.toLocaleString=k.prototype.toString;k.prototype.equals=function(e){if(!k.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:k.compare(this,e)===0};k.prototype.inspect=function(){let e="",t=nn.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"};ql&&(k.prototype[ql]=k.prototype.inspect);k.prototype.compare=function(e,t,r,n,i){if(_t(e,Uint8Array)&&(e=k.from(e,e.offset,e.byteLength)),!k.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(t===void 0&&(t=0),r===void 0&&(r=e?e.length:0),n===void 0&&(n=0),i===void 0&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(t>>>=0,r>>>=0,n>>>=0,i>>>=0,this===e)return 0;let s=i-n,a=r-t,c=Math.min(s,a),u=this.slice(n,i),l=e.slice(t,r);for(let h=0;h<c;++h)if(u[h]!==l[h]){s=u[h],a=l[h];break}return s<a?-1:a<s?1:0};function jl(o,e,t,r,n){if(o.length===0)return-1;if(typeof t=="string"?(r=t,t=0):t>2147483647?t=2147483647:t<-2147483648&&(t=-2147483648),t=+t,Gc(t)&&(t=n?0:o.length-1),t<0&&(t=o.length+t),t>=o.length){if(n)return-1;t=o.length-1}else if(t<0)if(n)t=0;else return-1;if(typeof e=="string"&&(e=k.from(e,r)),k.isBuffer(e))return e.length===0?-1:Dl(o,e,t,r,n);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?n?Uint8Array.prototype.indexOf.call(o,e,t):Uint8Array.prototype.lastIndexOf.call(o,e,t):Dl(o,[e],t,r,n);throw new TypeError("val must be string, number or Buffer")}function Dl(o,e,t,r,n){let i=1,s=o.length,a=e.length;if(r!==void 0&&(r=String(r).toLowerCase(),r==="ucs2"||r==="ucs-2"||r==="utf16le"||r==="utf-16le")){if(o.length<2||e.length<2)return-1;i=2,s/=2,a/=2,t/=2}function c(l,h){return i===1?l[h]:l.readUInt16BE(h*i)}let u;if(n){let l=-1;for(u=t;u<s;u++)if(c(o,u)===c(e,l===-1?0:u-l)){if(l===-1&&(l=u),u-l+1===a)return l*i}else l!==-1&&(u-=u-l),l=-1}else for(t+a>s&&(t=s-a),u=t;u>=0;u--){let l=!0;for(let h=0;h<a;h++)if(c(o,u+h)!==c(e,h)){l=!1;break}if(l)return u}return-1}k.prototype.includes=function(e,t,r){return this.indexOf(e,t,r)!==-1};k.prototype.indexOf=function(e,t,r){return jl(this,e,t,r,!0)};k.prototype.lastIndexOf=function(e,t,r){return jl(this,e,t,r,!1)};function Og(o,e,t,r){t=Number(t)||0;let n=o.length-t;r?(r=Number(r),r>n&&(r=n)):r=n;let i=e.length;r>i/2&&(r=i/2);let s;for(s=0;s<r;++s){let a=parseInt(e.substr(s*2,2),16);if(Gc(a))return s;o[t+s]=a}return s}function Ig(o,e,t,r){return As(kc(e,o.length-t),o,t,r)}function $g(o,e,t,r){return As(Wg(e),o,t,r)}function qg(o,e,t,r){return As(zl(e),o,t,r)}function Dg(o,e,t,r){return As(Hg(e,o.length-t),o,t,r)}k.prototype.write=function(e,t,r,n){if(t===void 0)n="utf8",r=this.length,t=0;else if(r===void 0&&typeof t=="string")n=t,r=this.length,t=0;else if(isFinite(t))t=t>>>0,isFinite(r)?(r=r>>>0,n===void 0&&(n="utf8")):(n=r,r=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let i=this.length-t;if((r===void 0||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let s=!1;for(;;)switch(n){case"hex":return Og(this,e,t,r);case"utf8":case"utf-8":return Ig(this,e,t,r);case"ascii":case"latin1":case"binary":return $g(this,e,t,r);case"base64":return qg(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Dg(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}};k.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Lg(o,e,t){return e===0&&t===o.length?Fc.fromByteArray(o):Fc.fromByteArray(o.slice(e,t))}function Ql(o,e,t){t=Math.min(o.length,t);let r=[],n=e;for(;n<t;){let i=o[n],s=null,a=i>239?4:i>223?3:i>191?2:1;if(n+a<=t){let c,u,l,h;switch(a){case 1:i<128&&(s=i);break;case 2:c=o[n+1],(c&192)===128&&(h=(i&31)<<6|c&63,h>127&&(s=h));break;case 3:c=o[n+1],u=o[n+2],(c&192)===128&&(u&192)===128&&(h=(i&15)<<12|(c&63)<<6|u&63,h>2047&&(h<55296||h>57343)&&(s=h));break;case 4:c=o[n+1],u=o[n+2],l=o[n+3],(c&192)===128&&(u&192)===128&&(l&192)===128&&(h=(i&15)<<18|(c&63)<<12|(u&63)<<6|l&63,h>65535&&h<1114112&&(s=h))}}s===null?(s=65533,a=1):s>65535&&(s-=65536,r.push(s>>>10&1023|55296),s=56320|s&1023),r.push(s),n+=a}return _g(r)}var Ll=4096;function _g(o){let e=o.length;if(e<=Ll)return String.fromCharCode.apply(String,o);let t="",r=0;for(;r<e;)t+=String.fromCharCode.apply(String,o.slice(r,r+=Ll));return t}function Bg(o,e,t){let r="";t=Math.min(o.length,t);for(let n=e;n<t;++n)r+=String.fromCharCode(o[n]&127);return r}function Ug(o,e,t){let r="";t=Math.min(o.length,t);for(let n=e;n<t;++n)r+=String.fromCharCode(o[n]);return r}function Fg(o,e,t){let r=o.length;(!e||e<0)&&(e=0),(!t||t<0||t>r)&&(t=r);let n="";for(let i=e;i<t;++i)n+=Gg[o[i]];return n}function jg(o,e,t){let r=o.slice(e,t),n="";for(let i=0;i<r.length-1;i+=2)n+=String.fromCharCode(r[i]+r[i+1]*256);return n}k.prototype.slice=function(e,t){let r=this.length;e=~~e,t=t===void 0?r:~~t,e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),t<e&&(t=e);let n=this.subarray(e,t);return Object.setPrototypeOf(n,k.prototype),n};function Ke(o,e,t){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+e>t)throw new RangeError("Trying to access beyond buffer length")}k.prototype.readUintLE=k.prototype.readUIntLE=function(e,t,r){e=e>>>0,t=t>>>0,r||Ke(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return n};k.prototype.readUintBE=k.prototype.readUIntBE=function(e,t,r){e=e>>>0,t=t>>>0,r||Ke(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n};k.prototype.readUint8=k.prototype.readUInt8=function(e,t){return e=e>>>0,t||Ke(e,1,this.length),this[e]};k.prototype.readUint16LE=k.prototype.readUInt16LE=function(e,t){return e=e>>>0,t||Ke(e,2,this.length),this[e]|this[e+1]<<8};k.prototype.readUint16BE=k.prototype.readUInt16BE=function(e,t){return e=e>>>0,t||Ke(e,2,this.length),this[e]<<8|this[e+1]};k.prototype.readUint32LE=k.prototype.readUInt32LE=function(e,t){return e=e>>>0,t||Ke(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216};k.prototype.readUint32BE=k.prototype.readUInt32BE=function(e,t){return e=e>>>0,t||Ke(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])};k.prototype.readBigUInt64LE=ar(function(e){e=e>>>0,rn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&fi(e,this.length-8);let n=t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,i=this[++e]+this[++e]*2**8+this[++e]*2**16+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))});k.prototype.readBigUInt64BE=ar(function(e){e=e>>>0,rn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&fi(e,this.length-8);let n=t*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],i=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+r;return(BigInt(n)<<BigInt(32))+BigInt(i)});k.prototype.readIntLE=function(e,t,r){e=e>>>0,t=t>>>0,r||Ke(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n};k.prototype.readIntBE=function(e,t,r){e=e>>>0,t=t>>>0,r||Ke(e,t,this.length);let n=t,i=1,s=this[e+--n];for(;n>0&&(i*=256);)s+=this[e+--n]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*t)),s};k.prototype.readInt8=function(e,t){return e=e>>>0,t||Ke(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]};k.prototype.readInt16LE=function(e,t){e=e>>>0,t||Ke(e,2,this.length);let r=this[e]|this[e+1]<<8;return r&32768?r|4294901760:r};k.prototype.readInt16BE=function(e,t){e=e>>>0,t||Ke(e,2,this.length);let r=this[e+1]|this[e]<<8;return r&32768?r|4294901760:r};k.prototype.readInt32LE=function(e,t){return e=e>>>0,t||Ke(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24};k.prototype.readInt32BE=function(e,t){return e=e>>>0,t||Ke(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]};k.prototype.readBigInt64LE=ar(function(e){e=e>>>0,rn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&fi(e,this.length-8);let n=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)});k.prototype.readBigInt64BE=ar(function(e){e=e>>>0,rn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&fi(e,this.length-8);let n=(t<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+r)});k.prototype.readFloatLE=function(e,t){return e=e>>>0,t||Ke(e,4,this.length),tn.read(this,e,!0,23,4)};k.prototype.readFloatBE=function(e,t){return e=e>>>0,t||Ke(e,4,this.length),tn.read(this,e,!1,23,4)};k.prototype.readDoubleLE=function(e,t){return e=e>>>0,t||Ke(e,8,this.length),tn.read(this,e,!0,52,8)};k.prototype.readDoubleBE=function(e,t){return e=e>>>0,t||Ke(e,8,this.length),tn.read(this,e,!1,52,8)};function ft(o,e,t,r,n,i){if(!k.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>n||e<i)throw new RangeError('"value" argument is out of bounds');if(t+r>o.length)throw new RangeError("Index out of range")}k.prototype.writeUintLE=k.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t=t>>>0,r=r>>>0,!n){let a=Math.pow(2,8*r)-1;ft(this,e,t,r,a,0)}let i=1,s=0;for(this[t]=e&255;++s<r&&(i*=256);)this[t+s]=e/i&255;return t+r};k.prototype.writeUintBE=k.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t=t>>>0,r=r>>>0,!n){let a=Math.pow(2,8*r)-1;ft(this,e,t,r,a,0)}let i=r-1,s=1;for(this[t+i]=e&255;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+r};k.prototype.writeUint8=k.prototype.writeUInt8=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,1,255,0),this[t]=e&255,t+1};k.prototype.writeUint16LE=k.prototype.writeUInt16LE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,2,65535,0),this[t]=e&255,this[t+1]=e>>>8,t+2};k.prototype.writeUint16BE=k.prototype.writeUInt16BE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=e&255,t+2};k.prototype.writeUint32LE=k.prototype.writeUInt32LE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=e&255,t+4};k.prototype.writeUint32BE=k.prototype.writeUInt32BE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};function kl(o,e,t,r,n){Kl(e,r,n,o,t,7);let i=Number(e&BigInt(4294967295));o[t++]=i,i=i>>8,o[t++]=i,i=i>>8,o[t++]=i,i=i>>8,o[t++]=i;let s=Number(e>>BigInt(32)&BigInt(4294967295));return o[t++]=s,s=s>>8,o[t++]=s,s=s>>8,o[t++]=s,s=s>>8,o[t++]=s,t}function Vl(o,e,t,r,n){Kl(e,r,n,o,t,7);let i=Number(e&BigInt(4294967295));o[t+7]=i,i=i>>8,o[t+6]=i,i=i>>8,o[t+5]=i,i=i>>8,o[t+4]=i;let s=Number(e>>BigInt(32)&BigInt(4294967295));return o[t+3]=s,s=s>>8,o[t+2]=s,s=s>>8,o[t+1]=s,s=s>>8,o[t]=s,t+8}k.prototype.writeBigUInt64LE=ar(function(e,t=0){return kl(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});k.prototype.writeBigUInt64BE=ar(function(e,t=0){return Vl(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});k.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t=t>>>0,!n){let c=Math.pow(2,8*r-1);ft(this,e,t,r,c-1,-c)}let i=0,s=1,a=0;for(this[t]=e&255;++i<r&&(s*=256);)e<0&&a===0&&this[t+i-1]!==0&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r};k.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t=t>>>0,!n){let c=Math.pow(2,8*r-1);ft(this,e,t,r,c-1,-c)}let i=r-1,s=1,a=0;for(this[t+i]=e&255;--i>=0&&(s*=256);)e<0&&a===0&&this[t+i+1]!==0&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r};k.prototype.writeInt8=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=e&255,t+1};k.prototype.writeInt16LE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,2,32767,-32768),this[t]=e&255,this[t+1]=e>>>8,t+2};k.prototype.writeInt16BE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=e&255,t+2};k.prototype.writeInt32LE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,4,2147483647,-2147483648),this[t]=e&255,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4};k.prototype.writeInt32BE=function(e,t,r){return e=+e,t=t>>>0,r||ft(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};k.prototype.writeBigInt64LE=ar(function(e,t=0){return kl(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});k.prototype.writeBigInt64BE=ar(function(e,t=0){return Vl(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Wl(o,e,t,r,n,i){if(t+r>o.length)throw new RangeError("Index out of range");if(t<0)throw new RangeError("Index out of range")}function Hl(o,e,t,r,n){return e=+e,t=t>>>0,n||Wl(o,e,t,4,34028234663852886e22,-34028234663852886e22),tn.write(o,e,t,r,23,4),t+4}k.prototype.writeFloatLE=function(e,t,r){return Hl(this,e,t,!0,r)};k.prototype.writeFloatBE=function(e,t,r){return Hl(this,e,t,!1,r)};function Gl(o,e,t,r,n){return e=+e,t=t>>>0,n||Wl(o,e,t,8,17976931348623157e292,-17976931348623157e292),tn.write(o,e,t,r,52,8),t+8}k.prototype.writeDoubleLE=function(e,t,r){return Gl(this,e,t,!0,r)};k.prototype.writeDoubleBE=function(e,t,r){return Gl(this,e,t,!1,r)};k.prototype.copy=function(e,t,r,n){if(!k.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),!n&&n!==0&&(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r||e.length===0||this.length===0)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);let i=n-r;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i};k.prototype.fill=function(e,t,r,n){if(typeof e=="string"){if(typeof t=="string"?(n=t,t=0,r=this.length):typeof r=="string"&&(n=r,r=this.length),n!==void 0&&typeof n!="string")throw new TypeError("encoding must be a string");if(typeof n=="string"&&!k.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(e.length===1){let s=e.charCodeAt(0);(n==="utf8"&&s<128||n==="latin1")&&(e=s)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;t=t>>>0,r=r===void 0?this.length:r>>>0,e||(e=0);let i;if(typeof e=="number")for(i=t;i<r;++i)this[i]=e;else{let s=k.isBuffer(e)?e:k.from(e,n),a=s.length;if(a===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=s[i%a]}return this};var en={};function Hc(o,e,t){en[o]=class extends t{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(n){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:n,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}Hc("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);Hc("ERR_INVALID_ARG_TYPE",function(o,e){return`The "${o}" argument must be of type number. Received type ${typeof e}`},TypeError);Hc("ERR_OUT_OF_RANGE",function(o,e,t){let r=`The value of "${o}" is out of range.`,n=t;return Number.isInteger(t)&&Math.abs(t)>2**32?n=_l(String(t)):typeof t=="bigint"&&(n=String(t),(t>BigInt(2)**BigInt(32)||t<-(BigInt(2)**BigInt(32)))&&(n=_l(n)),n+="n"),r+=` It must be ${e}. Received ${n}`,r},RangeError);function _l(o){let e="",t=o.length,r=o[0]==="-"?1:0;for(;t>=r+4;t-=3)e=`_${o.slice(t-3,t)}${e}`;return`${o.slice(0,t)}${e}`}function Qg(o,e,t){rn(e,"offset"),(o[e]===void 0||o[e+t]===void 0)&&fi(e,o.length-(t+1))}function Kl(o,e,t,r,n,i){if(o>t||o<e){let s=typeof e=="bigint"?"n":"",a;throw i>3?e===0||e===BigInt(0)?a=`>= 0${s} and < 2${s} ** ${(i+1)*8}${s}`:a=`>= -(2${s} ** ${(i+1)*8-1}${s}) and < 2 ** ${(i+1)*8-1}${s}`:a=`>= ${e}${s} and <= ${t}${s}`,new en.ERR_OUT_OF_RANGE("value",a,o)}Qg(r,n,i)}function rn(o,e){if(typeof o!="number")throw new en.ERR_INVALID_ARG_TYPE(e,"number",o)}function fi(o,e,t){throw Math.floor(o)!==o?(rn(o,t),new en.ERR_OUT_OF_RANGE(t||"offset","an integer",o)):e<0?new en.ERR_BUFFER_OUT_OF_BOUNDS:new en.ERR_OUT_OF_RANGE(t||"offset",`>= ${t?1:0} and <= ${e}`,o)}var kg=/[^+/0-9A-Za-z-_]/g;function Vg(o){if(o=o.split("=")[0],o=o.trim().replace(kg,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function kc(o,e){e=e||1/0;let t,r=o.length,n=null,i=[];for(let s=0;s<r;++s){if(t=o.charCodeAt(s),t>55295&&t<57344){if(!n){if(t>56319){(e-=3)>-1&&i.push(239,191,189);continue}else if(s+1===r){(e-=3)>-1&&i.push(239,191,189);continue}n=t;continue}if(t<56320){(e-=3)>-1&&i.push(239,191,189),n=t;continue}t=(n-55296<<10|t-56320)+65536}else n&&(e-=3)>-1&&i.push(239,191,189);if(n=null,t<128){if((e-=1)<0)break;i.push(t)}else if(t<2048){if((e-=2)<0)break;i.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;i.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;i.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return i}function Wg(o){let e=[];for(let t=0;t<o.length;++t)e.push(o.charCodeAt(t)&255);return e}function Hg(o,e){let t,r,n,i=[];for(let s=0;s<o.length&&!((e-=2)<0);++s)t=o.charCodeAt(s),r=t>>8,n=t%256,i.push(n),i.push(r);return i}function zl(o){return Fc.toByteArray(Vg(o))}function As(o,e,t,r){let n;for(n=0;n<r&&!(n+t>=e.length||n>=o.length);++n)e[n+t]=o[n];return n}function _t(o,e){return o instanceof e||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===e.name}function Gc(o){return o!==o}var Gg=(function(){let o="0123456789abcdef",e=new Array(256);for(let t=0;t<16;++t){let r=t*16;for(let n=0;n<16;++n)e[r+n]=o[t]+o[n]}return e})();function ar(o){return typeof BigInt>"u"?Kg:o}function Kg(){throw new Error("BigInt not supported")}});var Or=_((PM,zc)=>{typeof Object.create=="function"?zc.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:zc.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}});var Xt=_((Jc,Yl)=>{var Os=xs(),Ut=Os.Buffer;function Jl(o,e){for(var t in o)e[t]=o[t]}Ut.from&&Ut.alloc&&Ut.allocUnsafe&&Ut.allocUnsafeSlow?Yl.exports=Os:(Jl(Os,Jc),Jc.Buffer=Ir);function Ir(o,e,t){return Ut(o,e,t)}Ir.prototype=Object.create(Ut.prototype);Jl(Ut,Ir);Ir.from=function(o,e,t){if(typeof o=="number")throw new TypeError("Argument must not be a number");return Ut(o,e,t)};Ir.alloc=function(o,e,t){if(typeof o!="number")throw new TypeError("Argument must be a number");var r=Ut(o);return e!==void 0?typeof t=="string"?r.fill(e,t):r.fill(e):r.fill(0),r};Ir.allocUnsafe=function(o){if(typeof o!="number")throw new TypeError("Argument must be a number");return Ut(o)};Ir.allocUnsafeSlow=function(o){if(typeof o!="number")throw new TypeError("Argument must be a number");return Os.SlowBuffer(o)}});var Zl=_((OM,Xl)=>{var zg={}.toString;Xl.exports=Array.isArray||function(o){return zg.call(o)=="[object Array]"}});var on=_((IM,eh)=>{"use strict";eh.exports=TypeError});var Yc=_(($M,th)=>{"use strict";th.exports=Object});var nh=_((qM,rh)=>{"use strict";rh.exports=Error});var sh=_((DM,ih)=>{"use strict";ih.exports=EvalError});var oh=_((LM,ah)=>{"use strict";ah.exports=RangeError});var uh=_((_M,ch)=>{"use strict";ch.exports=ReferenceError});var Xc=_((BM,lh)=>{"use strict";lh.exports=SyntaxError});var ph=_((UM,hh)=>{"use strict";hh.exports=URIError});var mh=_((FM,dh)=>{"use strict";dh.exports=Math.abs});var yh=_((jM,fh)=>{"use strict";fh.exports=Math.floor});var Eh=_((QM,gh)=>{"use strict";gh.exports=Math.max});var bh=_((kM,Th)=>{"use strict";Th.exports=Math.min});var Nh=_((VM,wh)=>{"use strict";wh.exports=Math.pow});var xh=_((WM,Ah)=>{"use strict";Ah.exports=Math.round});var Rh=_((HM,Ch)=>{"use strict";Ch.exports=Number.isNaN||function(e){return e!==e}});var Mh=_((GM,Sh)=>{"use strict";var Jg=Rh();Sh.exports=function(e){return Jg(e)||e===0?e:e<0?-1:1}});var Ph=_((KM,vh)=>{"use strict";vh.exports=Object.getOwnPropertyDescriptor});var cn=_((zM,Oh)=>{"use strict";var Is=Ph();if(Is)try{Is([],"length")}catch{Is=null}Oh.exports=Is});var Ti=_((JM,Ih)=>{"use strict";var $s=Object.defineProperty||!1;if($s)try{$s({},"a",{value:1})}catch{$s=!1}Ih.exports=$s});var Zc=_((YM,$h)=>{"use strict";$h.exports=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var e={},t=Symbol("test"),r=Object(t);if(typeof t=="string"||Object.prototype.toString.call(t)!=="[object Symbol]"||Object.prototype.toString.call(r)!=="[object Symbol]")return!1;var n=42;e[t]=n;for(var i in e)return!1;if(typeof Object.keys=="function"&&Object.keys(e).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(e).length!==0)return!1;var s=Object.getOwnPropertySymbols(e);if(s.length!==1||s[0]!==t||!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var a=Object.getOwnPropertyDescriptor(e,t);if(a.value!==n||a.enumerable!==!0)return!1}return!0}});var Lh=_((XM,Dh)=>{"use strict";var qh=typeof Symbol<"u"&&Symbol,Yg=Zc();Dh.exports=function(){return typeof qh!="function"||typeof Symbol!="function"||typeof qh("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:Yg()}});var eu=_((ZM,_h)=>{"use strict";_h.exports=typeof Reflect<"u"&&Reflect.getPrototypeOf||null});var tu=_((ev,Bh)=>{"use strict";var Xg=Yc();Bh.exports=Xg.getPrototypeOf||null});var jh=_((tv,Fh)=>{"use strict";var Zg="Function.prototype.bind called on incompatible ",eE=Object.prototype.toString,tE=Math.max,rE="[object Function]",Uh=function(e,t){for(var r=[],n=0;n<e.length;n+=1)r[n]=e[n];for(var i=0;i<t.length;i+=1)r[i+e.length]=t[i];return r},nE=function(e,t){for(var r=[],n=t||0,i=0;n<e.length;n+=1,i+=1)r[i]=e[n];return r},iE=function(o,e){for(var t="",r=0;r<o.length;r+=1)t+=o[r],r+1<o.length&&(t+=e);return t};Fh.exports=function(e){var t=this;if(typeof t!="function"||eE.apply(t)!==rE)throw new TypeError(Zg+t);for(var r=nE(arguments,1),n,i=function(){if(this instanceof n){var l=t.apply(this,Uh(r,arguments));return Object(l)===l?l:this}return t.apply(e,Uh(r,arguments))},s=tE(0,t.length-r.length),a=[],c=0;c<s;c++)a[c]="$"+c;if(n=Function("binder","return function ("+iE(a,",")+"){ return binder.apply(this,arguments); }")(i),t.prototype){var u=function(){};u.prototype=t.prototype,n.prototype=new u,u.prototype=null}return n}});var un=_((rv,Qh)=>{"use strict";var sE=jh();Qh.exports=Function.prototype.bind||sE});var qs=_((nv,kh)=>{"use strict";kh.exports=Function.prototype.call});var Ds=_((iv,Vh)=>{"use strict";Vh.exports=Function.prototype.apply});var Hh=_((sv,Wh)=>{"use strict";Wh.exports=typeof Reflect<"u"&&Reflect&&Reflect.apply});var ru=_((av,Gh)=>{"use strict";var aE=un(),oE=Ds(),cE=qs(),uE=Hh();Gh.exports=uE||aE.call(cE,oE)});var Ls=_((ov,Kh)=>{"use strict";var lE=un(),hE=on(),pE=qs(),dE=ru();Kh.exports=function(e){if(e.length<1||typeof e[0]!="function")throw new hE("a function is required");return dE(lE,pE,e)}});var ep=_((cv,Zh)=>{"use strict";var mE=Ls(),zh=cn(),Yh;try{Yh=[].__proto__===Array.prototype}catch(o){if(!o||typeof o!="object"||!("code"in o)||o.code!=="ERR_PROTO_ACCESS")throw o}var nu=!!Yh&&zh&&zh(Object.prototype,"__proto__"),Xh=Object,Jh=Xh.getPrototypeOf;Zh.exports=nu&&typeof nu.get=="function"?mE([nu.get]):typeof Jh=="function"?function(e){return Jh(e==null?e:Xh(e))}:!1});var iu=_((uv,ip)=>{"use strict";var tp=eu(),rp=tu(),np=ep();ip.exports=tp?function(e){return tp(e)}:rp?function(e){if(!e||typeof e!="object"&&typeof e!="function")throw new TypeError("getProto: not an object");return rp(e)}:np?function(e){return np(e)}:null});var ap=_((lv,sp)=>{"use strict";var fE=Function.prototype.call,yE=Object.prototype.hasOwnProperty,gE=un();sp.exports=gE.call(fE,yE)});var ou=_((hv,pp)=>{"use strict";var xe,EE=Yc(),TE=nh(),bE=sh(),wE=oh(),NE=uh(),dn=Xc(),pn=on(),AE=ph(),xE=mh(),CE=yh(),RE=Eh(),SE=bh(),ME=Nh(),vE=xh(),PE=Mh(),lp=Function,su=function(o){try{return lp('"use strict"; return ('+o+").constructor;")()}catch{}},bi=cn(),OE=Ti(),au=function(){throw new pn},IE=bi?(function(){try{return arguments.callee,au}catch{try{return bi(arguments,"callee").get}catch{return au}}})():au,ln=Lh()(),ze=iu(),$E=tu(),qE=eu(),hp=Ds(),wi=qs(),hn={},DE=typeof Uint8Array>"u"||!ze?xe:ze(Uint8Array),$r={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?xe:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?xe:ArrayBuffer,"%ArrayIteratorPrototype%":ln&&ze?ze([][Symbol.iterator]()):xe,"%AsyncFromSyncIteratorPrototype%":xe,"%AsyncFunction%":hn,"%AsyncGenerator%":hn,"%AsyncGeneratorFunction%":hn,"%AsyncIteratorPrototype%":hn,"%Atomics%":typeof Atomics>"u"?xe:Atomics,"%BigInt%":typeof BigInt>"u"?xe:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?xe:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?xe:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?xe:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":TE,"%eval%":eval,"%EvalError%":bE,"%Float16Array%":typeof Float16Array>"u"?xe:Float16Array,"%Float32Array%":typeof Float32Array>"u"?xe:Float32Array,"%Float64Array%":typeof Float64Array>"u"?xe:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?xe:FinalizationRegistry,"%Function%":lp,"%GeneratorFunction%":hn,"%Int8Array%":typeof Int8Array>"u"?xe:Int8Array,"%Int16Array%":typeof Int16Array>"u"?xe:Int16Array,"%Int32Array%":typeof Int32Array>"u"?xe:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":ln&&ze?ze(ze([][Symbol.iterator]())):xe,"%JSON%":typeof JSON=="object"?JSON:xe,"%Map%":typeof Map>"u"?xe:Map,"%MapIteratorPrototype%":typeof Map>"u"||!ln||!ze?xe:ze(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":EE,"%Object.getOwnPropertyDescriptor%":bi,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?xe:Promise,"%Proxy%":typeof Proxy>"u"?xe:Proxy,"%RangeError%":wE,"%ReferenceError%":NE,"%Reflect%":typeof Reflect>"u"?xe:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?xe:Set,"%SetIteratorPrototype%":typeof Set>"u"||!ln||!ze?xe:ze(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?xe:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":ln&&ze?ze(""[Symbol.iterator]()):xe,"%Symbol%":ln?Symbol:xe,"%SyntaxError%":dn,"%ThrowTypeError%":IE,"%TypedArray%":DE,"%TypeError%":pn,"%Uint8Array%":typeof Uint8Array>"u"?xe:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?xe:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?xe:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?xe:Uint32Array,"%URIError%":AE,"%WeakMap%":typeof WeakMap>"u"?xe:WeakMap,"%WeakRef%":typeof WeakRef>"u"?xe:WeakRef,"%WeakSet%":typeof WeakSet>"u"?xe:WeakSet,"%Function.prototype.call%":wi,"%Function.prototype.apply%":hp,"%Object.defineProperty%":OE,"%Object.getPrototypeOf%":$E,"%Math.abs%":xE,"%Math.floor%":CE,"%Math.max%":RE,"%Math.min%":SE,"%Math.pow%":ME,"%Math.round%":vE,"%Math.sign%":PE,"%Reflect.getPrototypeOf%":qE};if(ze)try{null.error}catch(o){op=ze(ze(o)),$r["%Error.prototype%"]=op}var op,LE=function o(e){var t;if(e==="%AsyncFunction%")t=su("async function () {}");else if(e==="%GeneratorFunction%")t=su("function* () {}");else if(e==="%AsyncGeneratorFunction%")t=su("async function* () {}");else if(e==="%AsyncGenerator%"){var r=o("%AsyncGeneratorFunction%");r&&(t=r.prototype)}else if(e==="%AsyncIteratorPrototype%"){var n=o("%AsyncGenerator%");n&&ze&&(t=ze(n.prototype))}return $r[e]=t,t},cp={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},Ni=un(),_s=ap(),_E=Ni.call(wi,Array.prototype.concat),BE=Ni.call(hp,Array.prototype.splice),up=Ni.call(wi,String.prototype.replace),Bs=Ni.call(wi,String.prototype.slice),UE=Ni.call(wi,RegExp.prototype.exec),FE=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,jE=/\\(\\)?/g,QE=function(e){var t=Bs(e,0,1),r=Bs(e,-1);if(t==="%"&&r!=="%")throw new dn("invalid intrinsic syntax, expected closing `%`");if(r==="%"&&t!=="%")throw new dn("invalid intrinsic syntax, expected opening `%`");var n=[];return up(e,FE,function(i,s,a,c){n[n.length]=a?up(c,jE,"$1"):s||i}),n},kE=function(e,t){var r=e,n;if(_s(cp,r)&&(n=cp[r],r="%"+n[0]+"%"),_s($r,r)){var i=$r[r];if(i===hn&&(i=LE(r)),typeof i>"u"&&!t)throw new pn("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:n,name:r,value:i}}throw new dn("intrinsic "+e+" does not exist!")};pp.exports=function(e,t){if(typeof e!="string"||e.length===0)throw new pn("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof t!="boolean")throw new pn('"allowMissing" argument must be a boolean');if(UE(/^%?[^%]*%?$/,e)===null)throw new dn("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=QE(e),n=r.length>0?r[0]:"",i=kE("%"+n+"%",t),s=i.name,a=i.value,c=!1,u=i.alias;u&&(n=u[0],BE(r,_E([0,1],u)));for(var l=1,h=!0;l<r.length;l+=1){var p=r[l],d=Bs(p,0,1),m=Bs(p,-1);if((d==='"'||d==="'"||d==="`"||m==='"'||m==="'"||m==="`")&&d!==m)throw new dn("property names with quotes must have matching quotes");if((p==="constructor"||!h)&&(c=!0),n+="."+p,s="%"+n+"%",_s($r,s))a=$r[s];else if(a!=null){if(!(p in a)){if(!t)throw new pn("base intrinsic for "+e+" exists, but the property is not available.");return}if(bi&&l+1>=r.length){var f=bi(a,p);h=!!f,h&&"get"in f&&!("originalValue"in f.get)?a=f.get:a=a[p]}else h=_s(a,p),a=a[p];h&&!c&&($r[s]=a)}}return a}});var cu=_((pv,fp)=>{"use strict";var dp=ou(),mp=Ls(),VE=mp([dp("%String.prototype.indexOf%")]);fp.exports=function(e,t){var r=dp(e,!!t);return typeof r=="function"&&VE(e,".prototype.")>-1?mp([r]):r}});var Tp=_((dv,Ep)=>{"use strict";var gp=Function.prototype.toString,mn=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,lu,Us;if(typeof mn=="function"&&typeof Object.defineProperty=="function")try{lu=Object.defineProperty({},"length",{get:function(){throw Us}}),Us={},mn(function(){throw 42},null,lu)}catch(o){o!==Us&&(mn=null)}else mn=null;var WE=/^\s*class\b/,hu=function(e){try{var t=gp.call(e);return WE.test(t)}catch{return!1}},uu=function(e){try{return hu(e)?!1:(gp.call(e),!0)}catch{return!1}},Fs=Object.prototype.toString,HE="[object Object]",GE="[object Function]",KE="[object GeneratorFunction]",zE="[object HTMLAllCollection]",JE="[object HTML document.all class]",YE="[object HTMLCollection]",XE=typeof Symbol=="function"&&!!Symbol.toStringTag,ZE=!(0 in[,]),pu=function(){return!1};typeof document=="object"&&(yp=document.all,Fs.call(yp)===Fs.call(document.all)&&(pu=function(e){if((ZE||!e)&&(typeof e>"u"||typeof e=="object"))try{var t=Fs.call(e);return(t===zE||t===JE||t===YE||t===HE)&&e("")==null}catch{}return!1}));var yp;Ep.exports=mn?function(e){if(pu(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;try{mn(e,null,lu)}catch(t){if(t!==Us)return!1}return!hu(e)&&uu(e)}:function(e){if(pu(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;if(XE)return uu(e);if(hu(e))return!1;var t=Fs.call(e);return t!==GE&&t!==KE&&!/^\[object HTML/.test(t)?!1:uu(e)}});var Np=_((mv,wp)=>{"use strict";var eT=Tp(),tT=Object.prototype.toString,bp=Object.prototype.hasOwnProperty,rT=function(e,t,r){for(var n=0,i=e.length;n<i;n++)bp.call(e,n)&&(r==null?t(e[n],n,e):t.call(r,e[n],n,e))},nT=function(e,t,r){for(var n=0,i=e.length;n<i;n++)r==null?t(e.charAt(n),n,e):t.call(r,e.charAt(n),n,e)},iT=function(e,t,r){for(var n in e)bp.call(e,n)&&(r==null?t(e[n],n,e):t.call(r,e[n],n,e))};function sT(o){return tT.call(o)==="[object Array]"}wp.exports=function(e,t,r){if(!eT(t))throw new TypeError("iterator must be a function");var n;arguments.length>=3&&(n=r),sT(e)?rT(e,t,n):typeof e=="string"?nT(e,t,n):iT(e,t,n)}});var xp=_((fv,Ap)=>{"use strict";Ap.exports=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"]});var Rp=_((yv,Cp)=>{"use strict";var du=xp(),aT=globalThis;Cp.exports=function(){for(var e=[],t=0;t<du.length;t++)typeof aT[du[t]]=="function"&&(e[e.length]=du[t]);return e}});var Pp=_((gv,vp)=>{"use strict";var Sp=Ti(),oT=Xc(),fn=on(),Mp=cn();vp.exports=function(e,t,r){if(!e||typeof e!="object"&&typeof e!="function")throw new fn("`obj` must be an object or a function`");if(typeof t!="string"&&typeof t!="symbol")throw new fn("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new fn("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new fn("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new fn("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new fn("`loose`, if provided, must be a boolean");var n=arguments.length>3?arguments[3]:null,i=arguments.length>4?arguments[4]:null,s=arguments.length>5?arguments[5]:null,a=arguments.length>6?arguments[6]:!1,c=!!Mp&&Mp(e,t);if(Sp)Sp(e,t,{configurable:s===null&&c?c.configurable:!s,enumerable:n===null&&c?c.enumerable:!n,value:r,writable:i===null&&c?c.writable:!i});else if(a||!n&&!i&&!s)e[t]=r;else throw new oT("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")}});var $p=_((Ev,Ip)=>{"use strict";var mu=Ti(),Op=function(){return!!mu};Op.hasArrayLengthDefineBug=function(){if(!mu)return null;try{return mu([],"length",{value:1}).length!==1}catch{return!0}};Ip.exports=Op});var Bp=_((Tv,_p)=>{"use strict";var cT=ou(),qp=Pp(),uT=$p()(),Dp=cn(),Lp=on(),lT=cT("%Math.floor%");_p.exports=function(e,t){if(typeof e!="function")throw new Lp("`fn` is not a function");if(typeof t!="number"||t<0||t>4294967295||lT(t)!==t)throw new Lp("`length` must be a positive 32-bit integer");var r=arguments.length>2&&!!arguments[2],n=!0,i=!0;if("length"in e&&Dp){var s=Dp(e,"length");s&&!s.configurable&&(n=!1),s&&!s.writable&&(i=!1)}return(n||i||!r)&&(uT?qp(e,"length",t,!0,!0):qp(e,"length",t)),e}});var Fp=_((bv,Up)=>{"use strict";var hT=un(),pT=Ds(),dT=ru();Up.exports=function(){return dT(hT,pT,arguments)}});var kp=_((wv,js)=>{"use strict";var mT=Bp(),jp=Ti(),fT=Ls(),Qp=Fp();js.exports=function(e){var t=fT(arguments),r=e.length-(arguments.length-1);return mT(t,1+(r>0?r:0),!0)};jp?jp(js.exports,"apply",{value:Qp}):js.exports.apply=Qp});var Wp=_((Nv,Vp)=>{"use strict";var yT=Zc();Vp.exports=function(){return yT()&&!!Symbol.toStringTag}});var Jp=_((Av,zp)=>{"use strict";var Vs=Np(),gT=Rp(),Hp=kp(),yu=cu(),ks=cn(),Qs=iu(),ET=yu("Object.prototype.toString"),Kp=Wp()(),Gp=globalThis,fu=gT(),gu=yu("String.prototype.slice"),TT=yu("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return-1},Ws={__proto__:null};Kp&&ks&&Qs?Vs(fu,function(o){var e=new Gp[o];if(Symbol.toStringTag in e&&Qs){var t=Qs(e),r=ks(t,Symbol.toStringTag);if(!r&&t){var n=Qs(t);r=ks(n,Symbol.toStringTag)}Ws["$"+o]=Hp(r.get)}}):Vs(fu,function(o){var e=new Gp[o],t=e.slice||e.set;t&&(Ws["$"+o]=Hp(t))});var bT=function(e){var t=!1;return Vs(Ws,function(r,n){if(!t)try{"$"+r(e)===n&&(t=gu(n,1))}catch{}}),t},wT=function(e){var t=!1;return Vs(Ws,function(r,n){if(!t)try{r(e),t=gu(n,1)}catch{}}),t};zp.exports=function(e){if(!e||typeof e!="object")return!1;if(!Kp){var t=gu(ET(e),8,-1);return TT(fu,t)>-1?t:t!=="Object"?!1:wT(e)}return ks?bT(e):null}});var Xp=_((xv,Yp)=>{"use strict";var NT=Jp();Yp.exports=function(e){return!!NT(e)}});var ed=_((Cv,Zp)=>{"use strict";var AT=on(),xT=cu(),CT=xT("TypedArray.prototype.buffer",!0),RT=Xp();Zp.exports=CT||function(e){if(!RT(e))throw new AT("Not a Typed Array");return e.buffer}});var nd=_((Rv,rd)=>{"use strict";var $t=Xt().Buffer,ST=Zl(),MT=ed(),vT=ArrayBuffer.isView||function(e){try{return MT(e),!0}catch{return!1}},PT=typeof Uint8Array<"u",td=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",OT=td&&($t.prototype instanceof Uint8Array||$t.TYPED_ARRAY_SUPPORT);rd.exports=function(e,t){if($t.isBuffer(e))return e.constructor&&!("isBuffer"in e)?$t.from(e):e;if(typeof e=="string")return $t.from(e,t);if(td&&vT(e)){if(e.byteLength===0)return $t.alloc(0);if(OT){var r=$t.from(e.buffer,e.byteOffset,e.byteLength);if(r.byteLength===e.byteLength)return r}var n=e instanceof Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=$t.from(n);if(i.length===e.byteLength)return i}if(PT&&e instanceof Uint8Array)return $t.from(e);var s=ST(e);if(s)for(var a=0;a<e.length;a+=1){var c=e[a];if(typeof c!="number"||c<0||c>255||~~c!==c)throw new RangeError("Array items must be numbers in the range 0-255.")}if(s||$t.isBuffer(e)&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e))return $t.from(e);throw new TypeError('The "data" argument must be a string, an Array, a Buffer, a Uint8Array, or a DataView.')}});var qr=_((Sv,id)=>{"use strict";var IT=Xt().Buffer,$T=nd();function Hs(o,e){this._block=IT.alloc(o),this._finalSize=e,this._blockSize=o,this._len=0}Hs.prototype.update=function(o,e){o=$T(o,e||"utf8");for(var t=this._block,r=this._blockSize,n=o.length,i=this._len,s=0;s<n;){for(var a=i%r,c=Math.min(n-s,r-a),u=0;u<c;u++)t[a+u]=o[s+u];i+=c,s+=c,i%r===0&&this._update(t)}return this._len+=n,this};Hs.prototype.digest=function(o){var e=this._len%this._blockSize;this._block[e]=128,this._block.fill(0,e+1),e>=this._finalSize&&(this._update(this._block),this._block.fill(0));var t=this._len*8;if(t<=4294967295)this._block.writeUInt32BE(t,this._blockSize-4);else{var r=(t&4294967295)>>>0,n=(t-r)/4294967296;this._block.writeUInt32BE(n,this._blockSize-8),this._block.writeUInt32BE(r,this._blockSize-4)}this._update(this._block);var i=this._hash();return o?i.toString(o):i};Hs.prototype._update=function(){throw new Error("_update must be implemented by subclass")};id.exports=Hs});var od=_((Mv,ad)=>{"use strict";var qT=Or(),sd=qr(),DT=Xt().Buffer,LT=[1518500249,1859775393,-1894007588,-899497514],_T=new Array(80);function Ai(){this.init(),this._w=_T,sd.call(this,64,56)}qT(Ai,sd);Ai.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function BT(o){return o<<5|o>>>27}function UT(o){return o<<30|o>>>2}function FT(o,e,t,r){return o===0?e&t|~e&r:o===2?e&t|e&r|t&r:e^t^r}Ai.prototype._update=function(o){for(var e=this._w,t=this._a|0,r=this._b|0,n=this._c|0,i=this._d|0,s=this._e|0,a=0;a<16;++a)e[a]=o.readInt32BE(a*4);for(;a<80;++a)e[a]=e[a-3]^e[a-8]^e[a-14]^e[a-16];for(var c=0;c<80;++c){var u=~~(c/20),l=BT(t)+FT(u,r,n,i)+s+e[c]+LT[u]|0;s=i,i=n,n=UT(r),r=t,t=l}this._a=t+this._a|0,this._b=r+this._b|0,this._c=n+this._c|0,this._d=i+this._d|0,this._e=s+this._e|0};Ai.prototype._hash=function(){var o=DT.allocUnsafe(20);return o.writeInt32BE(this._a|0,0),o.writeInt32BE(this._b|0,4),o.writeInt32BE(this._c|0,8),o.writeInt32BE(this._d|0,12),o.writeInt32BE(this._e|0,16),o};ad.exports=Ai});var ld=_((vv,ud)=>{"use strict";var jT=Or(),cd=qr(),QT=Xt().Buffer,kT=[1518500249,1859775393,-1894007588,-899497514],VT=new Array(80);function xi(){this.init(),this._w=VT,cd.call(this,64,56)}jT(xi,cd);xi.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function WT(o){return o<<1|o>>>31}function HT(o){return o<<5|o>>>27}function GT(o){return o<<30|o>>>2}function KT(o,e,t,r){return o===0?e&t|~e&r:o===2?e&t|e&r|t&r:e^t^r}xi.prototype._update=function(o){for(var e=this._w,t=this._a|0,r=this._b|0,n=this._c|0,i=this._d|0,s=this._e|0,a=0;a<16;++a)e[a]=o.readInt32BE(a*4);for(;a<80;++a)e[a]=WT(e[a-3]^e[a-8]^e[a-14]^e[a-16]);for(var c=0;c<80;++c){var u=~~(c/20),l=HT(t)+KT(u,r,n,i)+s+e[c]+kT[u]|0;s=i,i=n,n=GT(r),r=t,t=l}this._a=t+this._a|0,this._b=r+this._b|0,this._c=n+this._c|0,this._d=i+this._d|0,this._e=s+this._e|0};xi.prototype._hash=function(){var o=QT.allocUnsafe(20);return o.writeInt32BE(this._a|0,0),o.writeInt32BE(this._b|0,4),o.writeInt32BE(this._c|0,8),o.writeInt32BE(this._d|0,12),o.writeInt32BE(this._e|0,16),o};ud.exports=xi});var Eu=_((Pv,pd)=>{"use strict";var zT=Or(),hd=qr(),JT=Xt().Buffer,YT=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],XT=new Array(64);function Ci(){this.init(),this._w=XT,hd.call(this,64,56)}zT(Ci,hd);Ci.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function ZT(o,e,t){return t^o&(e^t)}function eb(o,e,t){return o&e|t&(o|e)}function tb(o){return(o>>>2|o<<30)^(o>>>13|o<<19)^(o>>>22|o<<10)}function rb(o){return(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7)}function nb(o){return(o>>>7|o<<25)^(o>>>18|o<<14)^o>>>3}function ib(o){return(o>>>17|o<<15)^(o>>>19|o<<13)^o>>>10}Ci.prototype._update=function(o){for(var e=this._w,t=this._a|0,r=this._b|0,n=this._c|0,i=this._d|0,s=this._e|0,a=this._f|0,c=this._g|0,u=this._h|0,l=0;l<16;++l)e[l]=o.readInt32BE(l*4);for(;l<64;++l)e[l]=ib(e[l-2])+e[l-7]+nb(e[l-15])+e[l-16]|0;for(var h=0;h<64;++h){var p=u+rb(s)+ZT(s,a,c)+YT[h]+e[h]|0,d=tb(t)+eb(t,r,n)|0;u=c,c=a,a=s,s=i+p|0,i=n,n=r,r=t,t=p+d|0}this._a=t+this._a|0,this._b=r+this._b|0,this._c=n+this._c|0,this._d=i+this._d|0,this._e=s+this._e|0,this._f=a+this._f|0,this._g=c+this._g|0,this._h=u+this._h|0};Ci.prototype._hash=function(){var o=JT.allocUnsafe(32);return o.writeInt32BE(this._a,0),o.writeInt32BE(this._b,4),o.writeInt32BE(this._c,8),o.writeInt32BE(this._d,12),o.writeInt32BE(this._e,16),o.writeInt32BE(this._f,20),o.writeInt32BE(this._g,24),o.writeInt32BE(this._h,28),o};pd.exports=Ci});var md=_((Ov,dd)=>{"use strict";var sb=Or(),ab=Eu(),ob=qr(),cb=Xt().Buffer,ub=new Array(64);function Gs(){this.init(),this._w=ub,ob.call(this,64,56)}sb(Gs,ab);Gs.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this};Gs.prototype._hash=function(){var o=cb.allocUnsafe(28);return o.writeInt32BE(this._a,0),o.writeInt32BE(this._b,4),o.writeInt32BE(this._c,8),o.writeInt32BE(this._d,12),o.writeInt32BE(this._e,16),o.writeInt32BE(this._f,20),o.writeInt32BE(this._g,24),o};dd.exports=Gs});var Tu=_((Iv,wd)=>{"use strict";var lb=Or(),bd=qr(),hb=Xt().Buffer,fd=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],pb=new Array(160);function Ri(){this.init(),this._w=pb,bd.call(this,128,112)}lb(Ri,bd);Ri.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function yd(o,e,t){return t^o&(e^t)}function gd(o,e,t){return o&e|t&(o|e)}function Ed(o,e){return(o>>>28|e<<4)^(e>>>2|o<<30)^(e>>>7|o<<25)}function Td(o,e){return(o>>>14|e<<18)^(o>>>18|e<<14)^(e>>>9|o<<23)}function db(o,e){return(o>>>1|e<<31)^(o>>>8|e<<24)^o>>>7}function mb(o,e){return(o>>>1|e<<31)^(o>>>8|e<<24)^(o>>>7|e<<25)}function fb(o,e){return(o>>>19|e<<13)^(e>>>29|o<<3)^o>>>6}function yb(o,e){return(o>>>19|e<<13)^(e>>>29|o<<3)^(o>>>6|e<<26)}function Je(o,e){return o>>>0<e>>>0?1:0}Ri.prototype._update=function(o){for(var e=this._w,t=this._ah|0,r=this._bh|0,n=this._ch|0,i=this._dh|0,s=this._eh|0,a=this._fh|0,c=this._gh|0,u=this._hh|0,l=this._al|0,h=this._bl|0,p=this._cl|0,d=this._dl|0,m=this._el|0,f=this._fl|0,A=this._gl|0,R=this._hl|0,I=0;I<32;I+=2)e[I]=o.readInt32BE(I*4),e[I+1]=o.readInt32BE(I*4+4);for(;I<160;I+=2){var C=e[I-30],U=e[I-30+1],J=db(C,U),ne=mb(U,C);C=e[I-4],U=e[I-4+1];var oe=fb(C,U),z=yb(U,C),O=e[I-14],he=e[I-14+1],S=e[I-32],$=e[I-32+1],T=ne+he|0,w=J+O+Je(T,ne)|0;T=T+z|0,w=w+oe+Je(T,z)|0,T=T+$|0,w=w+S+Je(T,$)|0,e[I]=w,e[I+1]=T}for(var P=0;P<160;P+=2){w=e[P],T=e[P+1];var v=gd(t,r,n),D=gd(l,h,p),j=Ed(t,l),Z=Ed(l,t),se=Td(s,m),me=Td(m,s),B=fd[P],fe=fd[P+1],ke=yd(s,a,c),ie=yd(m,f,A),Ee=R+me|0,Ae=u+se+Je(Ee,R)|0;Ee=Ee+ie|0,Ae=Ae+ke+Je(Ee,ie)|0,Ee=Ee+fe|0,Ae=Ae+B+Je(Ee,fe)|0,Ee=Ee+T|0,Ae=Ae+w+Je(Ee,T)|0;var we=Z+D|0,qe=j+v+Je(we,Z)|0;u=c,R=A,c=a,A=f,a=s,f=m,m=d+Ee|0,s=i+Ae+Je(m,d)|0,i=n,d=p,n=r,p=h,r=t,h=l,l=Ee+we|0,t=Ae+qe+Je(l,Ee)|0}this._al=this._al+l|0,this._bl=this._bl+h|0,this._cl=this._cl+p|0,this._dl=this._dl+d|0,this._el=this._el+m|0,this._fl=this._fl+f|0,this._gl=this._gl+A|0,this._hl=this._hl+R|0,this._ah=this._ah+t+Je(this._al,l)|0,this._bh=this._bh+r+Je(this._bl,h)|0,this._ch=this._ch+n+Je(this._cl,p)|0,this._dh=this._dh+i+Je(this._dl,d)|0,this._eh=this._eh+s+Je(this._el,m)|0,this._fh=this._fh+a+Je(this._fl,f)|0,this._gh=this._gh+c+Je(this._gl,A)|0,this._hh=this._hh+u+Je(this._hl,R)|0};Ri.prototype._hash=function(){var o=hb.allocUnsafe(64);function e(t,r,n){o.writeInt32BE(t,n),o.writeInt32BE(r,n+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),e(this._gh,this._gl,48),e(this._hh,this._hl,56),o};wd.exports=Ri});var Ad=_(($v,Nd)=>{"use strict";var gb=Or(),Eb=Tu(),Tb=qr(),bb=Xt().Buffer,wb=new Array(160);function Ks(){this.init(),this._w=wb,Tb.call(this,128,112)}gb(Ks,Eb);Ks.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this};Ks.prototype._hash=function(){var o=bb.allocUnsafe(48);function e(t,r,n){o.writeInt32BE(t,n),o.writeInt32BE(r,n+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),o};Nd.exports=Ks});var xd=_((qv,Zt)=>{"use strict";Zt.exports=function(e){var t=e.toLowerCase(),r=Zt.exports[t];if(!r)throw new Error(t+" is not supported (we accept pull requests)");return new r};Zt.exports.sha=od();Zt.exports.sha1=ld();Zt.exports.sha224=md();Zt.exports.sha256=Eu();Zt.exports.sha384=Ad();Zt.exports.sha512=Tu()});var Ld=_((Ru,Su)=>{(function(o,e){typeof Ru=="object"&&typeof Su<"u"?Su.exports=e():typeof define=="function"&&define.amd?define(e):(o=typeof globalThis<"u"?globalThis:o||self).dayjs=e()})(Ru,(function(){"use strict";var o=1e3,e=6e4,t=36e5,r="millisecond",n="second",i="minute",s="hour",a="day",c="week",u="month",l="quarter",h="year",p="date",d="Invalid Date",m=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,f=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,A={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function($){var T=["th","st","nd","rd"],w=$%100;return"["+$+(T[(w-20)%10]||T[w]||T[0])+"]"}},R=function($,T,w){var P=String($);return!P||P.length>=T?$:""+Array(T+1-P.length).join(w)+$},I={s:R,z:function($){var T=-$.utcOffset(),w=Math.abs(T),P=Math.floor(w/60),v=w%60;return(T<=0?"+":"-")+R(P,2,"0")+":"+R(v,2,"0")},m:function $(T,w){if(T.date()<w.date())return-$(w,T);var P=12*(w.year()-T.year())+(w.month()-T.month()),v=T.clone().add(P,u),D=w-v<0,j=T.clone().add(P+(D?-1:1),u);return+(-(P+(w-v)/(D?v-j:j-v))||0)},a:function($){return $<0?Math.ceil($)||0:Math.floor($)},p:function($){return{M:u,y:h,w:c,d:a,D:p,h:s,m:i,s:n,ms:r,Q:l}[$]||String($||"").toLowerCase().replace(/s$/,"")},u:function($){return $===void 0}},C="en",U={};U[C]=A;var J="$isDayjsObject",ne=function($){return $ instanceof he||!(!$||!$[J])},oe=function $(T,w,P){var v;if(!T)return C;if(typeof T=="string"){var D=T.toLowerCase();U[D]&&(v=D),w&&(U[D]=w,v=D);var j=T.split("-");if(!v&&j.length>1)return $(j[0])}else{var Z=T.name;U[Z]=T,v=Z}return!P&&v&&(C=v),v||!P&&C},z=function($,T){if(ne($))return $.clone();var w=typeof T=="object"?T:{};return w.date=$,w.args=arguments,new he(w)},O=I;O.l=oe,O.i=ne,O.w=function($,T){return z($,{locale:T.$L,utc:T.$u,x:T.$x,$offset:T.$offset})};var he=(function(){function $(w){this.$L=oe(w.locale,null,!0),this.parse(w),this.$x=this.$x||w.x||{},this[J]=!0}var T=$.prototype;return T.parse=function(w){this.$d=(function(P){var v=P.date,D=P.utc;if(v===null)return new Date(NaN);if(O.u(v))return new Date;if(v instanceof Date)return new Date(v);if(typeof v=="string"&&!/Z$/i.test(v)){var j=v.match(m);if(j){var Z=j[2]-1||0,se=(j[7]||"0").substring(0,3);return D?new Date(Date.UTC(j[1],Z,j[3]||1,j[4]||0,j[5]||0,j[6]||0,se)):new Date(j[1],Z,j[3]||1,j[4]||0,j[5]||0,j[6]||0,se)}}return new Date(v)})(w),this.init()},T.init=function(){var w=this.$d;this.$y=w.getFullYear(),this.$M=w.getMonth(),this.$D=w.getDate(),this.$W=w.getDay(),this.$H=w.getHours(),this.$m=w.getMinutes(),this.$s=w.getSeconds(),this.$ms=w.getMilliseconds()},T.$utils=function(){return O},T.isValid=function(){return this.$d.toString()!==d},T.isSame=function(w,P){var v=z(w);return this.startOf(P)<=v&&v<=this.endOf(P)},T.isAfter=function(w,P){return z(w)<this.startOf(P)},T.isBefore=function(w,P){return this.endOf(P)<z(w)},T.$g=function(w,P,v){return O.u(w)?this[P]:this.set(v,w)},T.unix=function(){return Math.floor(this.valueOf()/1e3)},T.valueOf=function(){return this.$d.getTime()},T.startOf=function(w,P){var v=this,D=!!O.u(P)||P,j=O.p(w),Z=function(Ae,we){var qe=O.w(v.$u?Date.UTC(v.$y,we,Ae):new Date(v.$y,we,Ae),v);return D?qe:qe.endOf(a)},se=function(Ae,we){return O.w(v.toDate()[Ae].apply(v.toDate("s"),(D?[0,0,0,0]:[23,59,59,999]).slice(we)),v)},me=this.$W,B=this.$M,fe=this.$D,ke="set"+(this.$u?"UTC":"");switch(j){case h:return D?Z(1,0):Z(31,11);case u:return D?Z(1,B):Z(0,B+1);case c:var ie=this.$locale().weekStart||0,Ee=(me<ie?me+7:me)-ie;return Z(D?fe-Ee:fe+(6-Ee),B);case a:case p:return se(ke+"Hours",0);case s:return se(ke+"Minutes",1);case i:return se(ke+"Seconds",2);case n:return se(ke+"Milliseconds",3);default:return this.clone()}},T.endOf=function(w){return this.startOf(w,!1)},T.$set=function(w,P){var v,D=O.p(w),j="set"+(this.$u?"UTC":""),Z=(v={},v[a]=j+"Date",v[p]=j+"Date",v[u]=j+"Month",v[h]=j+"FullYear",v[s]=j+"Hours",v[i]=j+"Minutes",v[n]=j+"Seconds",v[r]=j+"Milliseconds",v)[D],se=D===a?this.$D+(P-this.$W):P;if(D===u||D===h){var me=this.clone().set(p,1);me.$d[Z](se),me.init(),this.$d=me.set(p,Math.min(this.$D,me.daysInMonth())).$d}else Z&&this.$d[Z](se);return this.init(),this},T.set=function(w,P){return this.clone().$set(w,P)},T.get=function(w){return this[O.p(w)]()},T.add=function(w,P){var v,D=this;w=Number(w);var j=O.p(P),Z=function(B){var fe=z(D);return O.w(fe.date(fe.date()+Math.round(B*w)),D)};if(j===u)return this.set(u,this.$M+w);if(j===h)return this.set(h,this.$y+w);if(j===a)return Z(1);if(j===c)return Z(7);var se=(v={},v[i]=e,v[s]=t,v[n]=o,v)[j]||1,me=this.$d.getTime()+w*se;return O.w(me,this)},T.subtract=function(w,P){return this.add(-1*w,P)},T.format=function(w){var P=this,v=this.$locale();if(!this.isValid())return v.invalidDate||d;var D=w||"YYYY-MM-DDTHH:mm:ssZ",j=O.z(this),Z=this.$H,se=this.$m,me=this.$M,B=v.weekdays,fe=v.months,ke=v.meridiem,ie=function(we,qe,Se,ut){return we&&(we[qe]||we(P,D))||Se[qe].slice(0,ut)},Ee=function(we){return O.s(Z%12||12,we,"0")},Ae=ke||function(we,qe,Se){var ut=we<12?"AM":"PM";return Se?ut.toLowerCase():ut};return D.replace(f,(function(we,qe){return qe||(function(Se){switch(Se){case"YY":return String(P.$y).slice(-2);case"YYYY":return O.s(P.$y,4,"0");case"M":return me+1;case"MM":return O.s(me+1,2,"0");case"MMM":return ie(v.monthsShort,me,fe,3);case"MMMM":return ie(fe,me);case"D":return P.$D;case"DD":return O.s(P.$D,2,"0");case"d":return String(P.$W);case"dd":return ie(v.weekdaysMin,P.$W,B,2);case"ddd":return ie(v.weekdaysShort,P.$W,B,3);case"dddd":return B[P.$W];case"H":return String(Z);case"HH":return O.s(Z,2,"0");case"h":return Ee(1);case"hh":return Ee(2);case"a":return Ae(Z,se,!0);case"A":return Ae(Z,se,!1);case"m":return String(se);case"mm":return O.s(se,2,"0");case"s":return String(P.$s);case"ss":return O.s(P.$s,2,"0");case"SSS":return O.s(P.$ms,3,"0");case"Z":return j}return null})(we)||j.replace(":","")}))},T.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},T.diff=function(w,P,v){var D,j=this,Z=O.p(P),se=z(w),me=(se.utcOffset()-this.utcOffset())*e,B=this-se,fe=function(){return O.m(j,se)};switch(Z){case h:D=fe()/12;break;case u:D=fe();break;case l:D=fe()/3;break;case c:D=(B-me)/6048e5;break;case a:D=(B-me)/864e5;break;case s:D=B/t;break;case i:D=B/e;break;case n:D=B/o;break;default:D=B}return v?D:O.a(D)},T.daysInMonth=function(){return this.endOf(u).$D},T.$locale=function(){return U[this.$L]},T.locale=function(w,P){if(!w)return this.$L;var v=this.clone(),D=oe(w,P,!0);return D&&(v.$L=D),v},T.clone=function(){return O.w(this.$d,this)},T.toDate=function(){return new Date(this.valueOf())},T.toJSON=function(){return this.isValid()?this.toISOString():null},T.toISOString=function(){return this.$d.toISOString()},T.toString=function(){return this.$d.toUTCString()},$})(),S=he.prototype;return z.prototype=S,[["$ms",r],["$s",n],["$m",i],["$H",s],["$W",a],["$M",u],["$y",h],["$D",p]].forEach((function($){S[$[1]]=function(T){return this.$g(T,$[0],$[1])}})),z.extend=function($,T){return $.$i||($(T,he,z),$.$i=!0),z},z.locale=oe,z.isDayjs=ne,z.unix=function($){return z(1e3*$)},z.en=U[C],z.Ls=U,z.p={},z}))});var Ud=_((Ej,Bd)=>{var An=1e3,xn=An*60,Cn=xn*60,Br=Cn*24,Vb=Br*7,Wb=Br*365.25;Bd.exports=function(o,e){e=e||{};var t=typeof o;if(t==="string"&&o.length>0)return Hb(o);if(t==="number"&&isFinite(o))return e.long?Kb(o):Gb(o);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(o))};function Hb(o){if(o=String(o),!(o.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(o);if(e){var t=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return t*Wb;case"weeks":case"week":case"w":return t*Vb;case"days":case"day":case"d":return t*Br;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Cn;case"minutes":case"minute":case"mins":case"min":case"m":return t*xn;case"seconds":case"second":case"secs":case"sec":case"s":return t*An;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function Gb(o){var e=Math.abs(o);return e>=Br?Math.round(o/Br)+"d":e>=Cn?Math.round(o/Cn)+"h":e>=xn?Math.round(o/xn)+"m":e>=An?Math.round(o/An)+"s":o+"ms"}function Kb(o){var e=Math.abs(o);return e>=Br?ca(o,e,Br,"day"):e>=Cn?ca(o,e,Cn,"hour"):e>=xn?ca(o,e,xn,"minute"):e>=An?ca(o,e,An,"second"):o+" ms"}function ca(o,e,t,r){var n=e>=t*1.5;return Math.round(o/t)+" "+r+(n?"s":"")}});var jd=_((Tj,Fd)=>{function zb(o){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=n,t.enabled=a,t.humanize=Ud(),t.destroy=u,Object.keys(o).forEach(l=>{t[l]=o[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let h=0;for(let p=0;p<l.length;p++)h=(h<<5)-h+l.charCodeAt(p),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(l){let h,p=null,d,m;function f(...A){if(!f.enabled)return;let R=f,I=Number(new Date),C=I-(h||I);R.diff=C,R.prev=h,R.curr=I,h=I,A[0]=t.coerce(A[0]),typeof A[0]!="string"&&A.unshift("%O");let U=0;A[0]=A[0].replace(/%([a-zA-Z%])/g,(ne,oe)=>{if(ne==="%%")return"%";U++;let z=t.formatters[oe];if(typeof z=="function"){let O=A[U];ne=z.call(R,O),A.splice(U,1),U--}return ne}),t.formatArgs.call(R,A),(R.log||t.log).apply(R,A)}return f.namespace=l,f.useColors=t.useColors(),f.color=t.selectColor(l),f.extend=r,f.destroy=t.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(l)),m),set:A=>{p=A}}),typeof t.init=="function"&&t.init(f),f}function r(l,h){let p=t(this.namespace+(typeof h>"u"?":":h)+l);return p.log=this.log,p}function n(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let h=(typeof l=="string"?l:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let p of h)p[0]==="-"?t.skips.push(p.slice(1)):t.names.push(p)}function i(l,h){let p=0,d=0,m=-1,f=0;for(;p<l.length;)if(d<h.length&&(h[d]===l[p]||h[d]==="*"))h[d]==="*"?(m=d,f=p,d++):(p++,d++);else if(m!==-1)d=m+1,f++,p=f;else return!1;for(;d<h.length&&h[d]==="*";)d++;return d===h.length}function s(){let l=[...t.names,...t.skips.map(h=>"-"+h)].join(",");return t.enable(""),l}function a(l){for(let h of t.skips)if(i(l,h))return!1;for(let h of t.names)if(i(l,h))return!0;return!1}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Fd.exports=zb});var Qd=_((Et,ua)=>{Et.formatArgs=Yb;Et.save=Xb;Et.load=Zb;Et.useColors=Jb;Et.storage=ew();Et.destroy=(()=>{let o=!1;return()=>{o||(o=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();Et.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Jb(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let o;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(o=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(o[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Yb(o){if(o[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+o[0]+(this.useColors?"%c ":" ")+"+"+ua.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;o.splice(1,0,e,"color: inherit");let t=0,r=0;o[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(t++,n==="%c"&&(r=t))}),o.splice(r,0,e)}Et.log=console.debug||console.log||(()=>{});function Xb(o){try{o?Et.storage.setItem("debug",o):Et.storage.removeItem("debug")}catch{}}function Zb(){let o;try{o=Et.storage.getItem("debug")||Et.storage.getItem("DEBUG")}catch{}return!o&&typeof process<"u"&&"env"in process&&(o=process.env.DEBUG),o}function ew(){try{return localStorage}catch{}}ua.exports=jd()(Et);var{formatters:tw}=ua.exports;tw.j=function(o){try{return JSON.stringify(o)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var Gd=_((qu,Du)=>{(function(o,e){typeof qu=="object"&&typeof Du<"u"?Du.exports=e():typeof define=="function"&&define.amd?define(e):(o=typeof globalThis<"u"?globalThis:o||self).dayjs=e()})(qu,(function(){"use strict";var o=1e3,e=6e4,t=36e5,r="millisecond",n="second",i="minute",s="hour",a="day",c="week",u="month",l="quarter",h="year",p="date",d="Invalid Date",m=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,f=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,A={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function($){var T=["th","st","nd","rd"],w=$%100;return"["+$+(T[(w-20)%10]||T[w]||T[0])+"]"}},R=function($,T,w){var P=String($);return!P||P.length>=T?$:""+Array(T+1-P.length).join(w)+$},I={s:R,z:function($){var T=-$.utcOffset(),w=Math.abs(T),P=Math.floor(w/60),v=w%60;return(T<=0?"+":"-")+R(P,2,"0")+":"+R(v,2,"0")},m:function $(T,w){if(T.date()<w.date())return-$(w,T);var P=12*(w.year()-T.year())+(w.month()-T.month()),v=T.clone().add(P,u),D=w-v<0,j=T.clone().add(P+(D?-1:1),u);return+(-(P+(w-v)/(D?v-j:j-v))||0)},a:function($){return $<0?Math.ceil($)||0:Math.floor($)},p:function($){return{M:u,y:h,w:c,d:a,D:p,h:s,m:i,s:n,ms:r,Q:l}[$]||String($||"").toLowerCase().replace(/s$/,"")},u:function($){return $===void 0}},C="en",U={};U[C]=A;var J="$isDayjsObject",ne=function($){return $ instanceof he||!(!$||!$[J])},oe=function $(T,w,P){var v;if(!T)return C;if(typeof T=="string"){var D=T.toLowerCase();U[D]&&(v=D),w&&(U[D]=w,v=D);var j=T.split("-");if(!v&&j.length>1)return $(j[0])}else{var Z=T.name;U[Z]=T,v=Z}return!P&&v&&(C=v),v||!P&&C},z=function($,T){if(ne($))return $.clone();var w=typeof T=="object"?T:{};return w.date=$,w.args=arguments,new he(w)},O=I;O.l=oe,O.i=ne,O.w=function($,T){return z($,{locale:T.$L,utc:T.$u,x:T.$x,$offset:T.$offset})};var he=(function(){function $(w){this.$L=oe(w.locale,null,!0),this.parse(w),this.$x=this.$x||w.x||{},this[J]=!0}var T=$.prototype;return T.parse=function(w){this.$d=(function(P){var v=P.date,D=P.utc;if(v===null)return new Date(NaN);if(O.u(v))return new Date;if(v instanceof Date)return new Date(v);if(typeof v=="string"&&!/Z$/i.test(v)){var j=v.match(m);if(j){var Z=j[2]-1||0,se=(j[7]||"0").substring(0,3);return D?new Date(Date.UTC(j[1],Z,j[3]||1,j[4]||0,j[5]||0,j[6]||0,se)):new Date(j[1],Z,j[3]||1,j[4]||0,j[5]||0,j[6]||0,se)}}return new Date(v)})(w),this.init()},T.init=function(){var w=this.$d;this.$y=w.getFullYear(),this.$M=w.getMonth(),this.$D=w.getDate(),this.$W=w.getDay(),this.$H=w.getHours(),this.$m=w.getMinutes(),this.$s=w.getSeconds(),this.$ms=w.getMilliseconds()},T.$utils=function(){return O},T.isValid=function(){return this.$d.toString()!==d},T.isSame=function(w,P){var v=z(w);return this.startOf(P)<=v&&v<=this.endOf(P)},T.isAfter=function(w,P){return z(w)<this.startOf(P)},T.isBefore=function(w,P){return this.endOf(P)<z(w)},T.$g=function(w,P,v){return O.u(w)?this[P]:this.set(v,w)},T.unix=function(){return Math.floor(this.valueOf()/1e3)},T.valueOf=function(){return this.$d.getTime()},T.startOf=function(w,P){var v=this,D=!!O.u(P)||P,j=O.p(w),Z=function(Ae,we){var qe=O.w(v.$u?Date.UTC(v.$y,we,Ae):new Date(v.$y,we,Ae),v);return D?qe:qe.endOf(a)},se=function(Ae,we){return O.w(v.toDate()[Ae].apply(v.toDate("s"),(D?[0,0,0,0]:[23,59,59,999]).slice(we)),v)},me=this.$W,B=this.$M,fe=this.$D,ke="set"+(this.$u?"UTC":"");switch(j){case h:return D?Z(1,0):Z(31,11);case u:return D?Z(1,B):Z(0,B+1);case c:var ie=this.$locale().weekStart||0,Ee=(me<ie?me+7:me)-ie;return Z(D?fe-Ee:fe+(6-Ee),B);case a:case p:return se(ke+"Hours",0);case s:return se(ke+"Minutes",1);case i:return se(ke+"Seconds",2);case n:return se(ke+"Milliseconds",3);default:return this.clone()}},T.endOf=function(w){return this.startOf(w,!1)},T.$set=function(w,P){var v,D=O.p(w),j="set"+(this.$u?"UTC":""),Z=(v={},v[a]=j+"Date",v[p]=j+"Date",v[u]=j+"Month",v[h]=j+"FullYear",v[s]=j+"Hours",v[i]=j+"Minutes",v[n]=j+"Seconds",v[r]=j+"Milliseconds",v)[D],se=D===a?this.$D+(P-this.$W):P;if(D===u||D===h){var me=this.clone().set(p,1);me.$d[Z](se),me.init(),this.$d=me.set(p,Math.min(this.$D,me.daysInMonth())).$d}else Z&&this.$d[Z](se);return this.init(),this},T.set=function(w,P){return this.clone().$set(w,P)},T.get=function(w){return this[O.p(w)]()},T.add=function(w,P){var v,D=this;w=Number(w);var j=O.p(P),Z=function(B){var fe=z(D);return O.w(fe.date(fe.date()+Math.round(B*w)),D)};if(j===u)return this.set(u,this.$M+w);if(j===h)return this.set(h,this.$y+w);if(j===a)return Z(1);if(j===c)return Z(7);var se=(v={},v[i]=e,v[s]=t,v[n]=o,v)[j]||1,me=this.$d.getTime()+w*se;return O.w(me,this)},T.subtract=function(w,P){return this.add(-1*w,P)},T.format=function(w){var P=this,v=this.$locale();if(!this.isValid())return v.invalidDate||d;var D=w||"YYYY-MM-DDTHH:mm:ssZ",j=O.z(this),Z=this.$H,se=this.$m,me=this.$M,B=v.weekdays,fe=v.months,ke=v.meridiem,ie=function(we,qe,Se,ut){return we&&(we[qe]||we(P,D))||Se[qe].slice(0,ut)},Ee=function(we){return O.s(Z%12||12,we,"0")},Ae=ke||function(we,qe,Se){var ut=we<12?"AM":"PM";return Se?ut.toLowerCase():ut};return D.replace(f,(function(we,qe){return qe||(function(Se){switch(Se){case"YY":return String(P.$y).slice(-2);case"YYYY":return O.s(P.$y,4,"0");case"M":return me+1;case"MM":return O.s(me+1,2,"0");case"MMM":return ie(v.monthsShort,me,fe,3);case"MMMM":return ie(fe,me);case"D":return P.$D;case"DD":return O.s(P.$D,2,"0");case"d":return String(P.$W);case"dd":return ie(v.weekdaysMin,P.$W,B,2);case"ddd":return ie(v.weekdaysShort,P.$W,B,3);case"dddd":return B[P.$W];case"H":return String(Z);case"HH":return O.s(Z,2,"0");case"h":return Ee(1);case"hh":return Ee(2);case"a":return Ae(Z,se,!0);case"A":return Ae(Z,se,!1);case"m":return String(se);case"mm":return O.s(se,2,"0");case"s":return String(P.$s);case"ss":return O.s(P.$s,2,"0");case"SSS":return O.s(P.$ms,3,"0");case"Z":return j}return null})(we)||j.replace(":","")}))},T.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},T.diff=function(w,P,v){var D,j=this,Z=O.p(P),se=z(w),me=(se.utcOffset()-this.utcOffset())*e,B=this-se,fe=function(){return O.m(j,se)};switch(Z){case h:D=fe()/12;break;case u:D=fe();break;case l:D=fe()/3;break;case c:D=(B-me)/6048e5;break;case a:D=(B-me)/864e5;break;case s:D=B/t;break;case i:D=B/e;break;case n:D=B/o;break;default:D=B}return v?D:O.a(D)},T.daysInMonth=function(){return this.endOf(u).$D},T.$locale=function(){return U[this.$L]},T.locale=function(w,P){if(!w)return this.$L;var v=this.clone(),D=oe(w,P,!0);return D&&(v.$L=D),v},T.clone=function(){return O.w(this.$d,this)},T.toDate=function(){return new Date(this.valueOf())},T.toJSON=function(){return this.isValid()?this.toISOString():null},T.toISOString=function(){return this.$d.toISOString()},T.toString=function(){return this.$d.toUTCString()},$})(),S=he.prototype;return z.prototype=S,[["$ms",r],["$s",n],["$m",i],["$H",s],["$W",a],["$M",u],["$y",h],["$D",p]].forEach((function($){S[$[1]]=function(T){return this.$g(T,$[0],$[1])}})),z.extend=function($,T){return $.$i||($(T,he,z),$.$i=!0),z},z.locale=oe,z.isDayjs=ne,z.unix=function($){return z(1e3*$)},z.en=U[C],z.Ls=U,z.p={},z}))});var Ur=_((T8,Lu)=>{typeof Object.create=="function"?Lu.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:Lu.exports=function(e,t){if(t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}}});var Yd=_(Ta=>{"use strict";Ta.byteLength=ow;Ta.toByteArray=uw;Ta.fromByteArray=pw;var jt=[],Mt=[],aw=typeof Uint8Array<"u"?Uint8Array:Array,_u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Fr=0,zd=_u.length;Fr<zd;++Fr)jt[Fr]=_u[Fr],Mt[_u.charCodeAt(Fr)]=Fr;var Fr,zd;Mt[45]=62;Mt[95]=63;function Jd(o){var e=o.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=o.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function ow(o){var e=Jd(o),t=e[0],r=e[1];return(t+r)*3/4-r}function cw(o,e,t){return(e+t)*3/4-t}function uw(o){var e,t=Jd(o),r=t[0],n=t[1],i=new aw(cw(o,r,n)),s=0,a=n>0?r-4:r,c;for(c=0;c<a;c+=4)e=Mt[o.charCodeAt(c)]<<18|Mt[o.charCodeAt(c+1)]<<12|Mt[o.charCodeAt(c+2)]<<6|Mt[o.charCodeAt(c+3)],i[s++]=e>>16&255,i[s++]=e>>8&255,i[s++]=e&255;return n===2&&(e=Mt[o.charCodeAt(c)]<<2|Mt[o.charCodeAt(c+1)]>>4,i[s++]=e&255),n===1&&(e=Mt[o.charCodeAt(c)]<<10|Mt[o.charCodeAt(c+1)]<<4|Mt[o.charCodeAt(c+2)]>>2,i[s++]=e>>8&255,i[s++]=e&255),i}function lw(o){return jt[o>>18&63]+jt[o>>12&63]+jt[o>>6&63]+jt[o&63]}function hw(o,e,t){for(var r,n=[],i=e;i<t;i+=3)r=(o[i]<<16&16711680)+(o[i+1]<<8&65280)+(o[i+2]&255),n.push(lw(r));return n.join("")}function pw(o){for(var e,t=o.length,r=t%3,n=[],i=16383,s=0,a=t-r;s<a;s+=i)n.push(hw(o,s,s+i>a?a:s+i));return r===1?(e=o[t-1],n.push(jt[e>>2]+jt[e<<4&63]+"==")):r===2&&(e=(o[t-2]<<8)+o[t-1],n.push(jt[e>>10]+jt[e>>4&63]+jt[e<<2&63]+"=")),n.join("")}});var Xd=_(Bu=>{Bu.read=function(o,e,t,r,n){var i,s,a=n*8-r-1,c=(1<<a)-1,u=c>>1,l=-7,h=t?n-1:0,p=t?-1:1,d=o[e+h];for(h+=p,i=d&(1<<-l)-1,d>>=-l,l+=a;l>0;i=i*256+o[e+h],h+=p,l-=8);for(s=i&(1<<-l)-1,i>>=-l,l+=r;l>0;s=s*256+o[e+h],h+=p,l-=8);if(i===0)i=1-u;else{if(i===c)return s?NaN:(d?-1:1)*(1/0);s=s+Math.pow(2,r),i=i-u}return(d?-1:1)*s*Math.pow(2,i-r)};Bu.write=function(o,e,t,r,n,i){var s,a,c,u=i*8-n-1,l=(1<<u)-1,h=l>>1,p=n===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:i-1,m=r?1:-1,f=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=l):(s=Math.floor(Math.log(e)/Math.LN2),e*(c=Math.pow(2,-s))<1&&(s--,c*=2),s+h>=1?e+=p/c:e+=p*Math.pow(2,1-h),e*c>=2&&(s++,c/=2),s+h>=l?(a=0,s=l):s+h>=1?(a=(e*c-1)*Math.pow(2,n),s=s+h):(a=e*Math.pow(2,h-1)*Math.pow(2,n),s=0));n>=8;o[t+d]=a&255,d+=m,a/=256,n-=8);for(s=s<<n|a,u+=n;u>0;o[t+d]=s&255,d+=m,s/=256,u-=8);o[t+d-m]|=f*128}});var Na=_(Pn=>{"use strict";var Uu=Yd(),Mn=Xd(),Zd=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;Pn.Buffer=V;Pn.SlowBuffer=Ew;Pn.INSPECT_MAX_BYTES=50;var ba=2147483647;Pn.kMaxLength=ba;V.TYPED_ARRAY_SUPPORT=dw();!V.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function dw(){try{let o=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(o,e),o.foo()===42}catch{return!1}}Object.defineProperty(V.prototype,"parent",{enumerable:!0,get:function(){if(V.isBuffer(this))return this.buffer}});Object.defineProperty(V.prototype,"offset",{enumerable:!0,get:function(){if(V.isBuffer(this))return this.byteOffset}});function rr(o){if(o>ba)throw new RangeError('The value "'+o+'" is invalid for option "size"');let e=new Uint8Array(o);return Object.setPrototypeOf(e,V.prototype),e}function V(o,e,t){if(typeof o=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return ku(o)}return nm(o,e,t)}V.poolSize=8192;function nm(o,e,t){if(typeof o=="string")return fw(o,e);if(ArrayBuffer.isView(o))return yw(o);if(o==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o);if(Qt(o,ArrayBuffer)||o&&Qt(o.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Qt(o,SharedArrayBuffer)||o&&Qt(o.buffer,SharedArrayBuffer)))return ju(o,e,t);if(typeof o=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let r=o.valueOf&&o.valueOf();if(r!=null&&r!==o)return V.from(r,e,t);let n=gw(o);if(n)return n;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof o[Symbol.toPrimitive]=="function")return V.from(o[Symbol.toPrimitive]("string"),e,t);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof o)}V.from=function(o,e,t){return nm(o,e,t)};Object.setPrototypeOf(V.prototype,Uint8Array.prototype);Object.setPrototypeOf(V,Uint8Array);function im(o){if(typeof o!="number")throw new TypeError('"size" argument must be of type number');if(o<0)throw new RangeError('The value "'+o+'" is invalid for option "size"')}function mw(o,e,t){return im(o),o<=0?rr(o):e!==void 0?typeof t=="string"?rr(o).fill(e,t):rr(o).fill(e):rr(o)}V.alloc=function(o,e,t){return mw(o,e,t)};function ku(o){return im(o),rr(o<0?0:Vu(o)|0)}V.allocUnsafe=function(o){return ku(o)};V.allocUnsafeSlow=function(o){return ku(o)};function fw(o,e){if((typeof e!="string"||e==="")&&(e="utf8"),!V.isEncoding(e))throw new TypeError("Unknown encoding: "+e);let t=sm(o,e)|0,r=rr(t),n=r.write(o,e);return n!==t&&(r=r.slice(0,n)),r}function Fu(o){let e=o.length<0?0:Vu(o.length)|0,t=rr(e);for(let r=0;r<e;r+=1)t[r]=o[r]&255;return t}function yw(o){if(Qt(o,Uint8Array)){let e=new Uint8Array(o);return ju(e.buffer,e.byteOffset,e.byteLength)}return Fu(o)}function ju(o,e,t){if(e<0||o.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(o.byteLength<e+(t||0))throw new RangeError('"length" is outside of buffer bounds');let r;return e===void 0&&t===void 0?r=new Uint8Array(o):t===void 0?r=new Uint8Array(o,e):r=new Uint8Array(o,e,t),Object.setPrototypeOf(r,V.prototype),r}function gw(o){if(V.isBuffer(o)){let e=Vu(o.length)|0,t=rr(e);return t.length===0||o.copy(t,0,0,e),t}if(o.length!==void 0)return typeof o.length!="number"||Hu(o.length)?rr(0):Fu(o);if(o.type==="Buffer"&&Array.isArray(o.data))return Fu(o.data)}function Vu(o){if(o>=ba)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+ba.toString(16)+" bytes");return o|0}function Ew(o){return+o!=o&&(o=0),V.alloc(+o)}V.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==V.prototype};V.compare=function(e,t){if(Qt(e,Uint8Array)&&(e=V.from(e,e.offset,e.byteLength)),Qt(t,Uint8Array)&&(t=V.from(t,t.offset,t.byteLength)),!V.isBuffer(e)||!V.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let r=e.length,n=t.length;for(let i=0,s=Math.min(r,n);i<s;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0};V.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};V.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return V.alloc(0);let r;if(t===void 0)for(t=0,r=0;r<e.length;++r)t+=e[r].length;let n=V.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){let s=e[r];if(Qt(s,Uint8Array))i+s.length>n.length?(V.isBuffer(s)||(s=V.from(s)),s.copy(n,i)):Uint8Array.prototype.set.call(n,s,i);else if(V.isBuffer(s))s.copy(n,i);else throw new TypeError('"list" argument must be an Array of Buffers');i+=s.length}return n};function sm(o,e){if(V.isBuffer(o))return o.length;if(ArrayBuffer.isView(o)||Qt(o,ArrayBuffer))return o.byteLength;if(typeof o!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof o);let t=o.length,r=arguments.length>2&&arguments[2]===!0;if(!r&&t===0)return 0;let n=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return t;case"utf8":case"utf-8":return Qu(o).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return t*2;case"hex":return t>>>1;case"base64":return mm(o).length;default:if(n)return r?-1:Qu(o).length;e=(""+e).toLowerCase(),n=!0}}V.byteLength=sm;function Tw(o,e,t){let r=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((t===void 0||t>this.length)&&(t=this.length),t<=0)||(t>>>=0,e>>>=0,t<=e))return"";for(o||(o="utf8");;)switch(o){case"hex":return vw(this,e,t);case"utf8":case"utf-8":return om(this,e,t);case"ascii":return Sw(this,e,t);case"latin1":case"binary":return Mw(this,e,t);case"base64":return Cw(this,e,t);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return Pw(this,e,t);default:if(r)throw new TypeError("Unknown encoding: "+o);o=(o+"").toLowerCase(),r=!0}}V.prototype._isBuffer=!0;function jr(o,e,t){let r=o[e];o[e]=o[t],o[t]=r}V.prototype.swap16=function(){let e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)jr(this,t,t+1);return this};V.prototype.swap32=function(){let e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)jr(this,t,t+3),jr(this,t+1,t+2);return this};V.prototype.swap64=function(){let e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)jr(this,t,t+7),jr(this,t+1,t+6),jr(this,t+2,t+5),jr(this,t+3,t+4);return this};V.prototype.toString=function(){let e=this.length;return e===0?"":arguments.length===0?om(this,0,e):Tw.apply(this,arguments)};V.prototype.toLocaleString=V.prototype.toString;V.prototype.equals=function(e){if(!V.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:V.compare(this,e)===0};V.prototype.inspect=function(){let e="",t=Pn.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"};Zd&&(V.prototype[Zd]=V.prototype.inspect);V.prototype.compare=function(e,t,r,n,i){if(Qt(e,Uint8Array)&&(e=V.from(e,e.offset,e.byteLength)),!V.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(t===void 0&&(t=0),r===void 0&&(r=e?e.length:0),n===void 0&&(n=0),i===void 0&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(t>>>=0,r>>>=0,n>>>=0,i>>>=0,this===e)return 0;let s=i-n,a=r-t,c=Math.min(s,a),u=this.slice(n,i),l=e.slice(t,r);for(let h=0;h<c;++h)if(u[h]!==l[h]){s=u[h],a=l[h];break}return s<a?-1:a<s?1:0};function am(o,e,t,r,n){if(o.length===0)return-1;if(typeof t=="string"?(r=t,t=0):t>2147483647?t=2147483647:t<-2147483648&&(t=-2147483648),t=+t,Hu(t)&&(t=n?0:o.length-1),t<0&&(t=o.length+t),t>=o.length){if(n)return-1;t=o.length-1}else if(t<0)if(n)t=0;else return-1;if(typeof e=="string"&&(e=V.from(e,r)),V.isBuffer(e))return e.length===0?-1:em(o,e,t,r,n);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?n?Uint8Array.prototype.indexOf.call(o,e,t):Uint8Array.prototype.lastIndexOf.call(o,e,t):em(o,[e],t,r,n);throw new TypeError("val must be string, number or Buffer")}function em(o,e,t,r,n){let i=1,s=o.length,a=e.length;if(r!==void 0&&(r=String(r).toLowerCase(),r==="ucs2"||r==="ucs-2"||r==="utf16le"||r==="utf-16le")){if(o.length<2||e.length<2)return-1;i=2,s/=2,a/=2,t/=2}function c(l,h){return i===1?l[h]:l.readUInt16BE(h*i)}let u;if(n){let l=-1;for(u=t;u<s;u++)if(c(o,u)===c(e,l===-1?0:u-l)){if(l===-1&&(l=u),u-l+1===a)return l*i}else l!==-1&&(u-=u-l),l=-1}else for(t+a>s&&(t=s-a),u=t;u>=0;u--){let l=!0;for(let h=0;h<a;h++)if(c(o,u+h)!==c(e,h)){l=!1;break}if(l)return u}return-1}V.prototype.includes=function(e,t,r){return this.indexOf(e,t,r)!==-1};V.prototype.indexOf=function(e,t,r){return am(this,e,t,r,!0)};V.prototype.lastIndexOf=function(e,t,r){return am(this,e,t,r,!1)};function bw(o,e,t,r){t=Number(t)||0;let n=o.length-t;r?(r=Number(r),r>n&&(r=n)):r=n;let i=e.length;r>i/2&&(r=i/2);let s;for(s=0;s<r;++s){let a=parseInt(e.substr(s*2,2),16);if(Hu(a))return s;o[t+s]=a}return s}function ww(o,e,t,r){return wa(Qu(e,o.length-t),o,t,r)}function Nw(o,e,t,r){return wa(qw(e),o,t,r)}function Aw(o,e,t,r){return wa(mm(e),o,t,r)}function xw(o,e,t,r){return wa(Dw(e,o.length-t),o,t,r)}V.prototype.write=function(e,t,r,n){if(t===void 0)n="utf8",r=this.length,t=0;else if(r===void 0&&typeof t=="string")n=t,r=this.length,t=0;else if(isFinite(t))t=t>>>0,isFinite(r)?(r=r>>>0,n===void 0&&(n="utf8")):(n=r,r=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let i=this.length-t;if((r===void 0||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let s=!1;for(;;)switch(n){case"hex":return bw(this,e,t,r);case"utf8":case"utf-8":return ww(this,e,t,r);case"ascii":case"latin1":case"binary":return Nw(this,e,t,r);case"base64":return Aw(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return xw(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}};V.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Cw(o,e,t){return e===0&&t===o.length?Uu.fromByteArray(o):Uu.fromByteArray(o.slice(e,t))}function om(o,e,t){t=Math.min(o.length,t);let r=[],n=e;for(;n<t;){let i=o[n],s=null,a=i>239?4:i>223?3:i>191?2:1;if(n+a<=t){let c,u,l,h;switch(a){case 1:i<128&&(s=i);break;case 2:c=o[n+1],(c&192)===128&&(h=(i&31)<<6|c&63,h>127&&(s=h));break;case 3:c=o[n+1],u=o[n+2],(c&192)===128&&(u&192)===128&&(h=(i&15)<<12|(c&63)<<6|u&63,h>2047&&(h<55296||h>57343)&&(s=h));break;case 4:c=o[n+1],u=o[n+2],l=o[n+3],(c&192)===128&&(u&192)===128&&(l&192)===128&&(h=(i&15)<<18|(c&63)<<12|(u&63)<<6|l&63,h>65535&&h<1114112&&(s=h))}}s===null?(s=65533,a=1):s>65535&&(s-=65536,r.push(s>>>10&1023|55296),s=56320|s&1023),r.push(s),n+=a}return Rw(r)}var tm=4096;function Rw(o){let e=o.length;if(e<=tm)return String.fromCharCode.apply(String,o);let t="",r=0;for(;r<e;)t+=String.fromCharCode.apply(String,o.slice(r,r+=tm));return t}function Sw(o,e,t){let r="";t=Math.min(o.length,t);for(let n=e;n<t;++n)r+=String.fromCharCode(o[n]&127);return r}function Mw(o,e,t){let r="";t=Math.min(o.length,t);for(let n=e;n<t;++n)r+=String.fromCharCode(o[n]);return r}function vw(o,e,t){let r=o.length;(!e||e<0)&&(e=0),(!t||t<0||t>r)&&(t=r);let n="";for(let i=e;i<t;++i)n+=Lw[o[i]];return n}function Pw(o,e,t){let r=o.slice(e,t),n="";for(let i=0;i<r.length-1;i+=2)n+=String.fromCharCode(r[i]+r[i+1]*256);return n}V.prototype.slice=function(e,t){let r=this.length;e=~~e,t=t===void 0?r:~~t,e<0?(e+=r,e<0&&(e=0)):e>r&&(e=r),t<0?(t+=r,t<0&&(t=0)):t>r&&(t=r),t<e&&(t=e);let n=this.subarray(e,t);return Object.setPrototypeOf(n,V.prototype),n};function Xe(o,e,t){if(o%1!==0||o<0)throw new RangeError("offset is not uint");if(o+e>t)throw new RangeError("Trying to access beyond buffer length")}V.prototype.readUintLE=V.prototype.readUIntLE=function(e,t,r){e=e>>>0,t=t>>>0,r||Xe(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return n};V.prototype.readUintBE=V.prototype.readUIntBE=function(e,t,r){e=e>>>0,t=t>>>0,r||Xe(e,t,this.length);let n=this[e+--t],i=1;for(;t>0&&(i*=256);)n+=this[e+--t]*i;return n};V.prototype.readUint8=V.prototype.readUInt8=function(e,t){return e=e>>>0,t||Xe(e,1,this.length),this[e]};V.prototype.readUint16LE=V.prototype.readUInt16LE=function(e,t){return e=e>>>0,t||Xe(e,2,this.length),this[e]|this[e+1]<<8};V.prototype.readUint16BE=V.prototype.readUInt16BE=function(e,t){return e=e>>>0,t||Xe(e,2,this.length),this[e]<<8|this[e+1]};V.prototype.readUint32LE=V.prototype.readUInt32LE=function(e,t){return e=e>>>0,t||Xe(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216};V.prototype.readUint32BE=V.prototype.readUInt32BE=function(e,t){return e=e>>>0,t||Xe(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])};V.prototype.readBigUInt64LE=mr(function(e){e=e>>>0,vn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&Vi(e,this.length-8);let n=t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,i=this[++e]+this[++e]*2**8+this[++e]*2**16+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))});V.prototype.readBigUInt64BE=mr(function(e){e=e>>>0,vn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&Vi(e,this.length-8);let n=t*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],i=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+r;return(BigInt(n)<<BigInt(32))+BigInt(i)});V.prototype.readIntLE=function(e,t,r){e=e>>>0,t=t>>>0,r||Xe(e,t,this.length);let n=this[e],i=1,s=0;for(;++s<t&&(i*=256);)n+=this[e+s]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*t)),n};V.prototype.readIntBE=function(e,t,r){e=e>>>0,t=t>>>0,r||Xe(e,t,this.length);let n=t,i=1,s=this[e+--n];for(;n>0&&(i*=256);)s+=this[e+--n]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*t)),s};V.prototype.readInt8=function(e,t){return e=e>>>0,t||Xe(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]};V.prototype.readInt16LE=function(e,t){e=e>>>0,t||Xe(e,2,this.length);let r=this[e]|this[e+1]<<8;return r&32768?r|4294901760:r};V.prototype.readInt16BE=function(e,t){e=e>>>0,t||Xe(e,2,this.length);let r=this[e+1]|this[e]<<8;return r&32768?r|4294901760:r};V.prototype.readInt32LE=function(e,t){return e=e>>>0,t||Xe(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24};V.prototype.readInt32BE=function(e,t){return e=e>>>0,t||Xe(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]};V.prototype.readBigInt64LE=mr(function(e){e=e>>>0,vn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&Vi(e,this.length-8);let n=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)});V.prototype.readBigInt64BE=mr(function(e){e=e>>>0,vn(e,"offset");let t=this[e],r=this[e+7];(t===void 0||r===void 0)&&Vi(e,this.length-8);let n=(t<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(n)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+r)});V.prototype.readFloatLE=function(e,t){return e=e>>>0,t||Xe(e,4,this.length),Mn.read(this,e,!0,23,4)};V.prototype.readFloatBE=function(e,t){return e=e>>>0,t||Xe(e,4,this.length),Mn.read(this,e,!1,23,4)};V.prototype.readDoubleLE=function(e,t){return e=e>>>0,t||Xe(e,8,this.length),Mn.read(this,e,!0,52,8)};V.prototype.readDoubleBE=function(e,t){return e=e>>>0,t||Xe(e,8,this.length),Mn.read(this,e,!1,52,8)};function bt(o,e,t,r,n,i){if(!V.isBuffer(o))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>n||e<i)throw new RangeError('"value" argument is out of bounds');if(t+r>o.length)throw new RangeError("Index out of range")}V.prototype.writeUintLE=V.prototype.writeUIntLE=function(e,t,r,n){if(e=+e,t=t>>>0,r=r>>>0,!n){let a=Math.pow(2,8*r)-1;bt(this,e,t,r,a,0)}let i=1,s=0;for(this[t]=e&255;++s<r&&(i*=256);)this[t+s]=e/i&255;return t+r};V.prototype.writeUintBE=V.prototype.writeUIntBE=function(e,t,r,n){if(e=+e,t=t>>>0,r=r>>>0,!n){let a=Math.pow(2,8*r)-1;bt(this,e,t,r,a,0)}let i=r-1,s=1;for(this[t+i]=e&255;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+r};V.prototype.writeUint8=V.prototype.writeUInt8=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,1,255,0),this[t]=e&255,t+1};V.prototype.writeUint16LE=V.prototype.writeUInt16LE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,2,65535,0),this[t]=e&255,this[t+1]=e>>>8,t+2};V.prototype.writeUint16BE=V.prototype.writeUInt16BE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=e&255,t+2};V.prototype.writeUint32LE=V.prototype.writeUInt32LE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=e&255,t+4};V.prototype.writeUint32BE=V.prototype.writeUInt32BE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};function cm(o,e,t,r,n){dm(e,r,n,o,t,7);let i=Number(e&BigInt(4294967295));o[t++]=i,i=i>>8,o[t++]=i,i=i>>8,o[t++]=i,i=i>>8,o[t++]=i;let s=Number(e>>BigInt(32)&BigInt(4294967295));return o[t++]=s,s=s>>8,o[t++]=s,s=s>>8,o[t++]=s,s=s>>8,o[t++]=s,t}function um(o,e,t,r,n){dm(e,r,n,o,t,7);let i=Number(e&BigInt(4294967295));o[t+7]=i,i=i>>8,o[t+6]=i,i=i>>8,o[t+5]=i,i=i>>8,o[t+4]=i;let s=Number(e>>BigInt(32)&BigInt(4294967295));return o[t+3]=s,s=s>>8,o[t+2]=s,s=s>>8,o[t+1]=s,s=s>>8,o[t]=s,t+8}V.prototype.writeBigUInt64LE=mr(function(e,t=0){return cm(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});V.prototype.writeBigUInt64BE=mr(function(e,t=0){return um(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});V.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t=t>>>0,!n){let c=Math.pow(2,8*r-1);bt(this,e,t,r,c-1,-c)}let i=0,s=1,a=0;for(this[t]=e&255;++i<r&&(s*=256);)e<0&&a===0&&this[t+i-1]!==0&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r};V.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t=t>>>0,!n){let c=Math.pow(2,8*r-1);bt(this,e,t,r,c-1,-c)}let i=r-1,s=1,a=0;for(this[t+i]=e&255;--i>=0&&(s*=256);)e<0&&a===0&&this[t+i+1]!==0&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r};V.prototype.writeInt8=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=e&255,t+1};V.prototype.writeInt16LE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,2,32767,-32768),this[t]=e&255,this[t+1]=e>>>8,t+2};V.prototype.writeInt16BE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=e&255,t+2};V.prototype.writeInt32LE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,4,2147483647,-2147483648),this[t]=e&255,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4};V.prototype.writeInt32BE=function(e,t,r){return e=+e,t=t>>>0,r||bt(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};V.prototype.writeBigInt64LE=mr(function(e,t=0){return cm(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});V.prototype.writeBigInt64BE=mr(function(e,t=0){return um(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function lm(o,e,t,r,n,i){if(t+r>o.length)throw new RangeError("Index out of range");if(t<0)throw new RangeError("Index out of range")}function hm(o,e,t,r,n){return e=+e,t=t>>>0,n||lm(o,e,t,4,34028234663852886e22,-34028234663852886e22),Mn.write(o,e,t,r,23,4),t+4}V.prototype.writeFloatLE=function(e,t,r){return hm(this,e,t,!0,r)};V.prototype.writeFloatBE=function(e,t,r){return hm(this,e,t,!1,r)};function pm(o,e,t,r,n){return e=+e,t=t>>>0,n||lm(o,e,t,8,17976931348623157e292,-17976931348623157e292),Mn.write(o,e,t,r,52,8),t+8}V.prototype.writeDoubleLE=function(e,t,r){return pm(this,e,t,!0,r)};V.prototype.writeDoubleBE=function(e,t,r){return pm(this,e,t,!1,r)};V.prototype.copy=function(e,t,r,n){if(!V.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),!n&&n!==0&&(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r||e.length===0||this.length===0)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);let i=n-r;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(t,r,n):Uint8Array.prototype.set.call(e,this.subarray(r,n),t),i};V.prototype.fill=function(e,t,r,n){if(typeof e=="string"){if(typeof t=="string"?(n=t,t=0,r=this.length):typeof r=="string"&&(n=r,r=this.length),n!==void 0&&typeof n!="string")throw new TypeError("encoding must be a string");if(typeof n=="string"&&!V.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(e.length===1){let s=e.charCodeAt(0);(n==="utf8"&&s<128||n==="latin1")&&(e=s)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;t=t>>>0,r=r===void 0?this.length:r>>>0,e||(e=0);let i;if(typeof e=="number")for(i=t;i<r;++i)this[i]=e;else{let s=V.isBuffer(e)?e:V.from(e,n),a=s.length;if(a===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=s[i%a]}return this};var Sn={};function Wu(o,e,t){Sn[o]=class extends t{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${o}]`,this.stack,delete this.name}get code(){return o}set code(n){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:n,writable:!0})}toString(){return`${this.name} [${o}]: ${this.message}`}}}Wu("ERR_BUFFER_OUT_OF_BOUNDS",function(o){return o?`${o} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);Wu("ERR_INVALID_ARG_TYPE",function(o,e){return`The "${o}" argument must be of type number. Received type ${typeof e}`},TypeError);Wu("ERR_OUT_OF_RANGE",function(o,e,t){let r=`The value of "${o}" is out of range.`,n=t;return Number.isInteger(t)&&Math.abs(t)>2**32?n=rm(String(t)):typeof t=="bigint"&&(n=String(t),(t>BigInt(2)**BigInt(32)||t<-(BigInt(2)**BigInt(32)))&&(n=rm(n)),n+="n"),r+=` It must be ${e}. Received ${n}`,r},RangeError);function rm(o){let e="",t=o.length,r=o[0]==="-"?1:0;for(;t>=r+4;t-=3)e=`_${o.slice(t-3,t)}${e}`;return`${o.slice(0,t)}${e}`}function Ow(o,e,t){vn(e,"offset"),(o[e]===void 0||o[e+t]===void 0)&&Vi(e,o.length-(t+1))}function dm(o,e,t,r,n,i){if(o>t||o<e){let s=typeof e=="bigint"?"n":"",a;throw i>3?e===0||e===BigInt(0)?a=`>= 0${s} and < 2${s} ** ${(i+1)*8}${s}`:a=`>= -(2${s} ** ${(i+1)*8-1}${s}) and < 2 ** ${(i+1)*8-1}${s}`:a=`>= ${e}${s} and <= ${t}${s}`,new Sn.ERR_OUT_OF_RANGE("value",a,o)}Ow(r,n,i)}function vn(o,e){if(typeof o!="number")throw new Sn.ERR_INVALID_ARG_TYPE(e,"number",o)}function Vi(o,e,t){throw Math.floor(o)!==o?(vn(o,t),new Sn.ERR_OUT_OF_RANGE(t||"offset","an integer",o)):e<0?new Sn.ERR_BUFFER_OUT_OF_BOUNDS:new Sn.ERR_OUT_OF_RANGE(t||"offset",`>= ${t?1:0} and <= ${e}`,o)}var Iw=/[^+/0-9A-Za-z-_]/g;function $w(o){if(o=o.split("=")[0],o=o.trim().replace(Iw,""),o.length<2)return"";for(;o.length%4!==0;)o=o+"=";return o}function Qu(o,e){e=e||1/0;let t,r=o.length,n=null,i=[];for(let s=0;s<r;++s){if(t=o.charCodeAt(s),t>55295&&t<57344){if(!n){if(t>56319){(e-=3)>-1&&i.push(239,191,189);continue}else if(s+1===r){(e-=3)>-1&&i.push(239,191,189);continue}n=t;continue}if(t<56320){(e-=3)>-1&&i.push(239,191,189),n=t;continue}t=(n-55296<<10|t-56320)+65536}else n&&(e-=3)>-1&&i.push(239,191,189);if(n=null,t<128){if((e-=1)<0)break;i.push(t)}else if(t<2048){if((e-=2)<0)break;i.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;i.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;i.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return i}function qw(o){let e=[];for(let t=0;t<o.length;++t)e.push(o.charCodeAt(t)&255);return e}function Dw(o,e){let t,r,n,i=[];for(let s=0;s<o.length&&!((e-=2)<0);++s)t=o.charCodeAt(s),r=t>>8,n=t%256,i.push(n),i.push(r);return i}function mm(o){return Uu.toByteArray($w(o))}function wa(o,e,t,r){let n;for(n=0;n<r&&!(n+t>=e.length||n>=o.length);++n)e[n+t]=o[n];return n}function Qt(o,e){return o instanceof e||o!=null&&o.constructor!=null&&o.constructor.name!=null&&o.constructor.name===e.name}function Hu(o){return o!==o}var Lw=(function(){let o="0123456789abcdef",e=new Array(256);for(let t=0;t<16;++t){let r=t*16;for(let n=0;n<16;++n)e[r+n]=o[t]+o[n]}return e})();function mr(o){return typeof BigInt>"u"?_w:o}function _w(){throw new Error("BigInt not supported")}});var nr=_((Gu,ym)=>{var Aa=Na(),kt=Aa.Buffer;function fm(o,e){for(var t in o)e[t]=o[t]}kt.from&&kt.alloc&&kt.allocUnsafe&&kt.allocUnsafeSlow?ym.exports=Aa:(fm(Aa,Gu),Gu.Buffer=Qr);function Qr(o,e,t){return kt(o,e,t)}Qr.prototype=Object.create(kt.prototype);fm(kt,Qr);Qr.from=function(o,e,t){if(typeof o=="number")throw new TypeError("Argument must not be a number");return kt(o,e,t)};Qr.alloc=function(o,e,t){if(typeof o!="number")throw new TypeError("Argument must be a number");var r=kt(o);return e!==void 0?typeof t=="string"?r.fill(e,t):r.fill(e):r.fill(0),r};Qr.allocUnsafe=function(o){if(typeof o!="number")throw new TypeError("Argument must be a number");return kt(o)};Qr.allocUnsafeSlow=function(o){if(typeof o!="number")throw new TypeError("Argument must be a number");return Aa.SlowBuffer(o)}});var Em=_((x8,gm)=>{var Bw={}.toString;gm.exports=Array.isArray||function(o){return Bw.call(o)=="[object Array]"}});var On=_((C8,Tm)=>{"use strict";Tm.exports=TypeError});var Ku=_((R8,bm)=>{"use strict";bm.exports=Object});var Nm=_((S8,wm)=>{"use strict";wm.exports=Error});var xm=_((M8,Am)=>{"use strict";Am.exports=EvalError});var Rm=_((v8,Cm)=>{"use strict";Cm.exports=RangeError});var Mm=_((P8,Sm)=>{"use strict";Sm.exports=ReferenceError});var zu=_((O8,vm)=>{"use strict";vm.exports=SyntaxError});var Om=_((I8,Pm)=>{"use strict";Pm.exports=URIError});var $m=_(($8,Im)=>{"use strict";Im.exports=Math.abs});var Dm=_((q8,qm)=>{"use strict";qm.exports=Math.floor});var _m=_((D8,Lm)=>{"use strict";Lm.exports=Math.max});var Um=_((L8,Bm)=>{"use strict";Bm.exports=Math.min});var jm=_((_8,Fm)=>{"use strict";Fm.exports=Math.pow});var km=_((B8,Qm)=>{"use strict";Qm.exports=Math.round});var Wm=_((U8,Vm)=>{"use strict";Vm.exports=Number.isNaN||function(e){return e!==e}});var Gm=_((F8,Hm)=>{"use strict";var Uw=Wm();Hm.exports=function(e){return Uw(e)||e===0?e:e<0?-1:1}});var zm=_((j8,Km)=>{"use strict";Km.exports=Object.getOwnPropertyDescriptor});var In=_((Q8,Jm)=>{"use strict";var xa=zm();if(xa)try{xa([],"length")}catch{xa=null}Jm.exports=xa});var Wi=_((k8,Ym)=>{"use strict";var Ca=Object.defineProperty||!1;if(Ca)try{Ca({},"a",{value:1})}catch{Ca=!1}Ym.exports=Ca});var Ju=_((V8,Xm)=>{"use strict";Xm.exports=function(){if(typeof Symbol!="function"||typeof Object.getOwnPropertySymbols!="function")return!1;if(typeof Symbol.iterator=="symbol")return!0;var e={},t=Symbol("test"),r=Object(t);if(typeof t=="string"||Object.prototype.toString.call(t)!=="[object Symbol]"||Object.prototype.toString.call(r)!=="[object Symbol]")return!1;var n=42;e[t]=n;for(var i in e)return!1;if(typeof Object.keys=="function"&&Object.keys(e).length!==0||typeof Object.getOwnPropertyNames=="function"&&Object.getOwnPropertyNames(e).length!==0)return!1;var s=Object.getOwnPropertySymbols(e);if(s.length!==1||s[0]!==t||!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if(typeof Object.getOwnPropertyDescriptor=="function"){var a=Object.getOwnPropertyDescriptor(e,t);if(a.value!==n||a.enumerable!==!0)return!1}return!0}});var tf=_((W8,ef)=>{"use strict";var Zm=typeof Symbol<"u"&&Symbol,Fw=Ju();ef.exports=function(){return typeof Zm!="function"||typeof Symbol!="function"||typeof Zm("foo")!="symbol"||typeof Symbol("bar")!="symbol"?!1:Fw()}});var Yu=_((H8,rf)=>{"use strict";rf.exports=typeof Reflect<"u"&&Reflect.getPrototypeOf||null});var Xu=_((G8,nf)=>{"use strict";var jw=Ku();nf.exports=jw.getPrototypeOf||null});var of=_((K8,af)=>{"use strict";var Qw="Function.prototype.bind called on incompatible ",kw=Object.prototype.toString,Vw=Math.max,Ww="[object Function]",sf=function(e,t){for(var r=[],n=0;n<e.length;n+=1)r[n]=e[n];for(var i=0;i<t.length;i+=1)r[i+e.length]=t[i];return r},Hw=function(e,t){for(var r=[],n=t||0,i=0;n<e.length;n+=1,i+=1)r[i]=e[n];return r},Gw=function(o,e){for(var t="",r=0;r<o.length;r+=1)t+=o[r],r+1<o.length&&(t+=e);return t};af.exports=function(e){var t=this;if(typeof t!="function"||kw.apply(t)!==Ww)throw new TypeError(Qw+t);for(var r=Hw(arguments,1),n,i=function(){if(this instanceof n){var l=t.apply(this,sf(r,arguments));return Object(l)===l?l:this}return t.apply(e,sf(r,arguments))},s=Vw(0,t.length-r.length),a=[],c=0;c<s;c++)a[c]="$"+c;if(n=Function("binder","return function ("+Gw(a,",")+"){ return binder.apply(this,arguments); }")(i),t.prototype){var u=function(){};u.prototype=t.prototype,n.prototype=new u,u.prototype=null}return n}});var $n=_((z8,cf)=>{"use strict";var Kw=of();cf.exports=Function.prototype.bind||Kw});var Ra=_((J8,uf)=>{"use strict";uf.exports=Function.prototype.call});var Sa=_((Y8,lf)=>{"use strict";lf.exports=Function.prototype.apply});var pf=_((X8,hf)=>{"use strict";hf.exports=typeof Reflect<"u"&&Reflect&&Reflect.apply});var Zu=_((Z8,df)=>{"use strict";var zw=$n(),Jw=Sa(),Yw=Ra(),Xw=pf();df.exports=Xw||zw.call(Yw,Jw)});var Ma=_((eH,mf)=>{"use strict";var Zw=$n(),eN=On(),tN=Ra(),rN=Zu();mf.exports=function(e){if(e.length<1||typeof e[0]!="function")throw new eN("a function is required");return rN(Zw,tN,e)}});var bf=_((tH,Tf)=>{"use strict";var nN=Ma(),ff=In(),gf;try{gf=[].__proto__===Array.prototype}catch(o){if(!o||typeof o!="object"||!("code"in o)||o.code!=="ERR_PROTO_ACCESS")throw o}var el=!!gf&&ff&&ff(Object.prototype,"__proto__"),Ef=Object,yf=Ef.getPrototypeOf;Tf.exports=el&&typeof el.get=="function"?nN([el.get]):typeof yf=="function"?function(e){return yf(e==null?e:Ef(e))}:!1});var tl=_((rH,xf)=>{"use strict";var wf=Yu(),Nf=Xu(),Af=bf();xf.exports=wf?function(e){return wf(e)}:Nf?function(e){if(!e||typeof e!="object"&&typeof e!="function")throw new TypeError("getProto: not an object");return Nf(e)}:Af?function(e){return Af(e)}:null});var Rf=_((nH,Cf)=>{"use strict";var iN=Function.prototype.call,sN=Object.prototype.hasOwnProperty,aN=$n();Cf.exports=aN.call(iN,sN)});var il=_((iH,If)=>{"use strict";var Ce,oN=Ku(),cN=Nm(),uN=xm(),lN=Rm(),hN=Mm(),_n=zu(),Ln=On(),pN=Om(),dN=$m(),mN=Dm(),fN=_m(),yN=Um(),gN=jm(),EN=km(),TN=Gm(),Pf=Function,rl=function(o){try{return Pf('"use strict"; return ('+o+").constructor;")()}catch{}},Hi=In(),bN=Wi(),nl=function(){throw new Ln},wN=Hi?(function(){try{return arguments.callee,nl}catch{try{return Hi(arguments,"callee").get}catch{return nl}}})():nl,qn=tf()(),Ze=tl(),NN=Xu(),AN=Yu(),Of=Sa(),Gi=Ra(),Dn={},xN=typeof Uint8Array>"u"||!Ze?Ce:Ze(Uint8Array),kr={__proto__:null,"%AggregateError%":typeof AggregateError>"u"?Ce:AggregateError,"%Array%":Array,"%ArrayBuffer%":typeof ArrayBuffer>"u"?Ce:ArrayBuffer,"%ArrayIteratorPrototype%":qn&&Ze?Ze([][Symbol.iterator]()):Ce,"%AsyncFromSyncIteratorPrototype%":Ce,"%AsyncFunction%":Dn,"%AsyncGenerator%":Dn,"%AsyncGeneratorFunction%":Dn,"%AsyncIteratorPrototype%":Dn,"%Atomics%":typeof Atomics>"u"?Ce:Atomics,"%BigInt%":typeof BigInt>"u"?Ce:BigInt,"%BigInt64Array%":typeof BigInt64Array>"u"?Ce:BigInt64Array,"%BigUint64Array%":typeof BigUint64Array>"u"?Ce:BigUint64Array,"%Boolean%":Boolean,"%DataView%":typeof DataView>"u"?Ce:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":cN,"%eval%":eval,"%EvalError%":uN,"%Float16Array%":typeof Float16Array>"u"?Ce:Float16Array,"%Float32Array%":typeof Float32Array>"u"?Ce:Float32Array,"%Float64Array%":typeof Float64Array>"u"?Ce:Float64Array,"%FinalizationRegistry%":typeof FinalizationRegistry>"u"?Ce:FinalizationRegistry,"%Function%":Pf,"%GeneratorFunction%":Dn,"%Int8Array%":typeof Int8Array>"u"?Ce:Int8Array,"%Int16Array%":typeof Int16Array>"u"?Ce:Int16Array,"%Int32Array%":typeof Int32Array>"u"?Ce:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":qn&&Ze?Ze(Ze([][Symbol.iterator]())):Ce,"%JSON%":typeof JSON=="object"?JSON:Ce,"%Map%":typeof Map>"u"?Ce:Map,"%MapIteratorPrototype%":typeof Map>"u"||!qn||!Ze?Ce:Ze(new Map()[Symbol.iterator]()),"%Math%":Math,"%Number%":Number,"%Object%":oN,"%Object.getOwnPropertyDescriptor%":Hi,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":typeof Promise>"u"?Ce:Promise,"%Proxy%":typeof Proxy>"u"?Ce:Proxy,"%RangeError%":lN,"%ReferenceError%":hN,"%Reflect%":typeof Reflect>"u"?Ce:Reflect,"%RegExp%":RegExp,"%Set%":typeof Set>"u"?Ce:Set,"%SetIteratorPrototype%":typeof Set>"u"||!qn||!Ze?Ce:Ze(new Set()[Symbol.iterator]()),"%SharedArrayBuffer%":typeof SharedArrayBuffer>"u"?Ce:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":qn&&Ze?Ze(""[Symbol.iterator]()):Ce,"%Symbol%":qn?Symbol:Ce,"%SyntaxError%":_n,"%ThrowTypeError%":wN,"%TypedArray%":xN,"%TypeError%":Ln,"%Uint8Array%":typeof Uint8Array>"u"?Ce:Uint8Array,"%Uint8ClampedArray%":typeof Uint8ClampedArray>"u"?Ce:Uint8ClampedArray,"%Uint16Array%":typeof Uint16Array>"u"?Ce:Uint16Array,"%Uint32Array%":typeof Uint32Array>"u"?Ce:Uint32Array,"%URIError%":pN,"%WeakMap%":typeof WeakMap>"u"?Ce:WeakMap,"%WeakRef%":typeof WeakRef>"u"?Ce:WeakRef,"%WeakSet%":typeof WeakSet>"u"?Ce:WeakSet,"%Function.prototype.call%":Gi,"%Function.prototype.apply%":Of,"%Object.defineProperty%":bN,"%Object.getPrototypeOf%":NN,"%Math.abs%":dN,"%Math.floor%":mN,"%Math.max%":fN,"%Math.min%":yN,"%Math.pow%":gN,"%Math.round%":EN,"%Math.sign%":TN,"%Reflect.getPrototypeOf%":AN};if(Ze)try{null.error}catch(o){Sf=Ze(Ze(o)),kr["%Error.prototype%"]=Sf}var Sf,CN=function o(e){var t;if(e==="%AsyncFunction%")t=rl("async function () {}");else if(e==="%GeneratorFunction%")t=rl("function* () {}");else if(e==="%AsyncGeneratorFunction%")t=rl("async function* () {}");else if(e==="%AsyncGenerator%"){var r=o("%AsyncGeneratorFunction%");r&&(t=r.prototype)}else if(e==="%AsyncIteratorPrototype%"){var n=o("%AsyncGenerator%");n&&Ze&&(t=Ze(n.prototype))}return kr[e]=t,t},Mf={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},Ki=$n(),va=Rf(),RN=Ki.call(Gi,Array.prototype.concat),SN=Ki.call(Of,Array.prototype.splice),vf=Ki.call(Gi,String.prototype.replace),Pa=Ki.call(Gi,String.prototype.slice),MN=Ki.call(Gi,RegExp.prototype.exec),vN=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,PN=/\\(\\)?/g,ON=function(e){var t=Pa(e,0,1),r=Pa(e,-1);if(t==="%"&&r!=="%")throw new _n("invalid intrinsic syntax, expected closing `%`");if(r==="%"&&t!=="%")throw new _n("invalid intrinsic syntax, expected opening `%`");var n=[];return vf(e,vN,function(i,s,a,c){n[n.length]=a?vf(c,PN,"$1"):s||i}),n},IN=function(e,t){var r=e,n;if(va(Mf,r)&&(n=Mf[r],r="%"+n[0]+"%"),va(kr,r)){var i=kr[r];if(i===Dn&&(i=CN(r)),typeof i>"u"&&!t)throw new Ln("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:n,name:r,value:i}}throw new _n("intrinsic "+e+" does not exist!")};If.exports=function(e,t){if(typeof e!="string"||e.length===0)throw new Ln("intrinsic name must be a non-empty string");if(arguments.length>1&&typeof t!="boolean")throw new Ln('"allowMissing" argument must be a boolean');if(MN(/^%?[^%]*%?$/,e)===null)throw new _n("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=ON(e),n=r.length>0?r[0]:"",i=IN("%"+n+"%",t),s=i.name,a=i.value,c=!1,u=i.alias;u&&(n=u[0],SN(r,RN([0,1],u)));for(var l=1,h=!0;l<r.length;l+=1){var p=r[l],d=Pa(p,0,1),m=Pa(p,-1);if((d==='"'||d==="'"||d==="`"||m==='"'||m==="'"||m==="`")&&d!==m)throw new _n("property names with quotes must have matching quotes");if((p==="constructor"||!h)&&(c=!0),n+="."+p,s="%"+n+"%",va(kr,s))a=kr[s];else if(a!=null){if(!(p in a)){if(!t)throw new Ln("base intrinsic for "+e+" exists, but the property is not available.");return}if(Hi&&l+1>=r.length){var f=Hi(a,p);h=!!f,h&&"get"in f&&!("originalValue"in f.get)?a=f.get:a=a[p]}else h=va(a,p),a=a[p];h&&!c&&(kr[s]=a)}}return a}});var sl=_((sH,Df)=>{"use strict";var $f=il(),qf=Ma(),$N=qf([$f("%String.prototype.indexOf%")]);Df.exports=function(e,t){var r=$f(e,!!t);return typeof r=="function"&&$N(e,".prototype.")>-1?qf([r]):r}});var Uf=_((aH,Bf)=>{"use strict";var _f=Function.prototype.toString,Bn=typeof Reflect=="object"&&Reflect!==null&&Reflect.apply,ol,Oa;if(typeof Bn=="function"&&typeof Object.defineProperty=="function")try{ol=Object.defineProperty({},"length",{get:function(){throw Oa}}),Oa={},Bn(function(){throw 42},null,ol)}catch(o){o!==Oa&&(Bn=null)}else Bn=null;var qN=/^\s*class\b/,cl=function(e){try{var t=_f.call(e);return qN.test(t)}catch{return!1}},al=function(e){try{return cl(e)?!1:(_f.call(e),!0)}catch{return!1}},Ia=Object.prototype.toString,DN="[object Object]",LN="[object Function]",_N="[object GeneratorFunction]",BN="[object HTMLAllCollection]",UN="[object HTML document.all class]",FN="[object HTMLCollection]",jN=typeof Symbol=="function"&&!!Symbol.toStringTag,QN=!(0 in[,]),ul=function(){return!1};typeof document=="object"&&(Lf=document.all,Ia.call(Lf)===Ia.call(document.all)&&(ul=function(e){if((QN||!e)&&(typeof e>"u"||typeof e=="object"))try{var t=Ia.call(e);return(t===BN||t===UN||t===FN||t===DN)&&e("")==null}catch{}return!1}));var Lf;Bf.exports=Bn?function(e){if(ul(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;try{Bn(e,null,ol)}catch(t){if(t!==Oa)return!1}return!cl(e)&&al(e)}:function(e){if(ul(e))return!0;if(!e||typeof e!="function"&&typeof e!="object")return!1;if(jN)return al(e);if(cl(e))return!1;var t=Ia.call(e);return t!==LN&&t!==_N&&!/^\[object HTML/.test(t)?!1:al(e)}});var Qf=_((oH,jf)=>{"use strict";var kN=Uf(),VN=Object.prototype.toString,Ff=Object.prototype.hasOwnProperty,WN=function(e,t,r){for(var n=0,i=e.length;n<i;n++)Ff.call(e,n)&&(r==null?t(e[n],n,e):t.call(r,e[n],n,e))},HN=function(e,t,r){for(var n=0,i=e.length;n<i;n++)r==null?t(e.charAt(n),n,e):t.call(r,e.charAt(n),n,e)},GN=function(e,t,r){for(var n in e)Ff.call(e,n)&&(r==null?t(e[n],n,e):t.call(r,e[n],n,e))};function KN(o){return VN.call(o)==="[object Array]"}jf.exports=function(e,t,r){if(!kN(t))throw new TypeError("iterator must be a function");var n;arguments.length>=3&&(n=r),KN(e)?WN(e,t,n):typeof e=="string"?HN(e,t,n):GN(e,t,n)}});var Vf=_((cH,kf)=>{"use strict";kf.exports=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"]});var Hf=_((uH,Wf)=>{"use strict";var ll=Vf(),zN=globalThis;Wf.exports=function(){for(var e=[],t=0;t<ll.length;t++)typeof zN[ll[t]]=="function"&&(e[e.length]=ll[t]);return e}});var Jf=_((lH,zf)=>{"use strict";var Gf=Wi(),JN=zu(),Un=On(),Kf=In();zf.exports=function(e,t,r){if(!e||typeof e!="object"&&typeof e!="function")throw new Un("`obj` must be an object or a function`");if(typeof t!="string"&&typeof t!="symbol")throw new Un("`property` must be a string or a symbol`");if(arguments.length>3&&typeof arguments[3]!="boolean"&&arguments[3]!==null)throw new Un("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&typeof arguments[4]!="boolean"&&arguments[4]!==null)throw new Un("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&typeof arguments[5]!="boolean"&&arguments[5]!==null)throw new Un("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&typeof arguments[6]!="boolean")throw new Un("`loose`, if provided, must be a boolean");var n=arguments.length>3?arguments[3]:null,i=arguments.length>4?arguments[4]:null,s=arguments.length>5?arguments[5]:null,a=arguments.length>6?arguments[6]:!1,c=!!Kf&&Kf(e,t);if(Gf)Gf(e,t,{configurable:s===null&&c?c.configurable:!s,enumerable:n===null&&c?c.enumerable:!n,value:r,writable:i===null&&c?c.writable:!i});else if(a||!n&&!i&&!s)e[t]=r;else throw new JN("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.")}});var Zf=_((hH,Xf)=>{"use strict";var hl=Wi(),Yf=function(){return!!hl};Yf.hasArrayLengthDefineBug=function(){if(!hl)return null;try{return hl([],"length",{value:1}).length!==1}catch{return!0}};Xf.exports=Yf});var iy=_((pH,ny)=>{"use strict";var YN=il(),ey=Jf(),XN=Zf()(),ty=In(),ry=On(),ZN=YN("%Math.floor%");ny.exports=function(e,t){if(typeof e!="function")throw new ry("`fn` is not a function");if(typeof t!="number"||t<0||t>4294967295||ZN(t)!==t)throw new ry("`length` must be a positive 32-bit integer");var r=arguments.length>2&&!!arguments[2],n=!0,i=!0;if("length"in e&&ty){var s=ty(e,"length");s&&!s.configurable&&(n=!1),s&&!s.writable&&(i=!1)}return(n||i||!r)&&(XN?ey(e,"length",t,!0,!0):ey(e,"length",t)),e}});var ay=_((dH,sy)=>{"use strict";var eA=$n(),tA=Sa(),rA=Zu();sy.exports=function(){return rA(eA,tA,arguments)}});var uy=_((mH,$a)=>{"use strict";var nA=iy(),oy=Wi(),iA=Ma(),cy=ay();$a.exports=function(e){var t=iA(arguments),r=e.length-(arguments.length-1);return nA(t,1+(r>0?r:0),!0)};oy?oy($a.exports,"apply",{value:cy}):$a.exports.apply=cy});var hy=_((fH,ly)=>{"use strict";var sA=Ju();ly.exports=function(){return sA()&&!!Symbol.toStringTag}});var yy=_((yH,fy)=>{"use strict";var La=Qf(),aA=Hf(),py=uy(),dl=sl(),Da=In(),qa=tl(),oA=dl("Object.prototype.toString"),my=hy()(),dy=globalThis,pl=aA(),ml=dl("String.prototype.slice"),cA=dl("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return-1},_a={__proto__:null};my&&Da&&qa?La(pl,function(o){var e=new dy[o];if(Symbol.toStringTag in e&&qa){var t=qa(e),r=Da(t,Symbol.toStringTag);if(!r&&t){var n=qa(t);r=Da(n,Symbol.toStringTag)}_a["$"+o]=py(r.get)}}):La(pl,function(o){var e=new dy[o],t=e.slice||e.set;t&&(_a["$"+o]=py(t))});var uA=function(e){var t=!1;return La(_a,function(r,n){if(!t)try{"$"+r(e)===n&&(t=ml(n,1))}catch{}}),t},lA=function(e){var t=!1;return La(_a,function(r,n){if(!t)try{r(e),t=ml(n,1)}catch{}}),t};fy.exports=function(e){if(!e||typeof e!="object")return!1;if(!my){var t=ml(oA(e),8,-1);return cA(pl,t)>-1?t:t!=="Object"?!1:lA(e)}return Da?uA(e):null}});var Ey=_((gH,gy)=>{"use strict";var hA=yy();gy.exports=function(e){return!!hA(e)}});var by=_((EH,Ty)=>{"use strict";var pA=On(),dA=sl(),mA=dA("TypedArray.prototype.buffer",!0),fA=Ey();Ty.exports=mA||function(e){if(!fA(e))throw new pA("Not a Typed Array");return e.buffer}});var Ay=_((TH,Ny)=>{"use strict";var Dt=nr().Buffer,yA=Em(),gA=by(),EA=ArrayBuffer.isView||function(e){try{return gA(e),!0}catch{return!1}},TA=typeof Uint8Array<"u",wy=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u",bA=wy&&(Dt.prototype instanceof Uint8Array||Dt.TYPED_ARRAY_SUPPORT);Ny.exports=function(e,t){if(Dt.isBuffer(e))return e.constructor&&!("isBuffer"in e)?Dt.from(e):e;if(typeof e=="string")return Dt.from(e,t);if(wy&&EA(e)){if(e.byteLength===0)return Dt.alloc(0);if(bA){var r=Dt.from(e.buffer,e.byteOffset,e.byteLength);if(r.byteLength===e.byteLength)return r}var n=e instanceof Uint8Array?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=Dt.from(n);if(i.length===e.byteLength)return i}if(TA&&e instanceof Uint8Array)return Dt.from(e);var s=yA(e);if(s)for(var a=0;a<e.length;a+=1){var c=e[a];if(typeof c!="number"||c<0||c>255||~~c!==c)throw new RangeError("Array items must be numbers in the range 0-255.")}if(s||Dt.isBuffer(e)&&e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e))return Dt.from(e);throw new TypeError('The "data" argument must be a string, an Array, a Buffer, a Uint8Array, or a DataView.')}});var Vr=_((bH,xy)=>{"use strict";var wA=nr().Buffer,NA=Ay();function Ba(o,e){this._block=wA.alloc(o),this._finalSize=e,this._blockSize=o,this._len=0}Ba.prototype.update=function(o,e){o=NA(o,e||"utf8");for(var t=this._block,r=this._blockSize,n=o.length,i=this._len,s=0;s<n;){for(var a=i%r,c=Math.min(n-s,r-a),u=0;u<c;u++)t[a+u]=o[s+u];i+=c,s+=c,i%r===0&&this._update(t)}return this._len+=n,this};Ba.prototype.digest=function(o){var e=this._len%this._blockSize;this._block[e]=128,this._block.fill(0,e+1),e>=this._finalSize&&(this._update(this._block),this._block.fill(0));var t=this._len*8;if(t<=4294967295)this._block.writeUInt32BE(t,this._blockSize-4);else{var r=(t&4294967295)>>>0,n=(t-r)/4294967296;this._block.writeUInt32BE(n,this._blockSize-8),this._block.writeUInt32BE(r,this._blockSize-4)}this._update(this._block);var i=this._hash();return o?i.toString(o):i};Ba.prototype._update=function(){throw new Error("_update must be implemented by subclass")};xy.exports=Ba});var Sy=_((wH,Ry)=>{"use strict";var AA=Ur(),Cy=Vr(),xA=nr().Buffer,CA=[1518500249,1859775393,-1894007588,-899497514],RA=new Array(80);function zi(){this.init(),this._w=RA,Cy.call(this,64,56)}AA(zi,Cy);zi.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function SA(o){return o<<5|o>>>27}function MA(o){return o<<30|o>>>2}function vA(o,e,t,r){return o===0?e&t|~e&r:o===2?e&t|e&r|t&r:e^t^r}zi.prototype._update=function(o){for(var e=this._w,t=this._a|0,r=this._b|0,n=this._c|0,i=this._d|0,s=this._e|0,a=0;a<16;++a)e[a]=o.readInt32BE(a*4);for(;a<80;++a)e[a]=e[a-3]^e[a-8]^e[a-14]^e[a-16];for(var c=0;c<80;++c){var u=~~(c/20),l=SA(t)+vA(u,r,n,i)+s+e[c]+CA[u]|0;s=i,i=n,n=MA(r),r=t,t=l}this._a=t+this._a|0,this._b=r+this._b|0,this._c=n+this._c|0,this._d=i+this._d|0,this._e=s+this._e|0};zi.prototype._hash=function(){var o=xA.allocUnsafe(20);return o.writeInt32BE(this._a|0,0),o.writeInt32BE(this._b|0,4),o.writeInt32BE(this._c|0,8),o.writeInt32BE(this._d|0,12),o.writeInt32BE(this._e|0,16),o};Ry.exports=zi});var Py=_((NH,vy)=>{"use strict";var PA=Ur(),My=Vr(),OA=nr().Buffer,IA=[1518500249,1859775393,-1894007588,-899497514],$A=new Array(80);function Ji(){this.init(),this._w=$A,My.call(this,64,56)}PA(Ji,My);Ji.prototype.init=function(){return this._a=1732584193,this._b=4023233417,this._c=2562383102,this._d=271733878,this._e=3285377520,this};function qA(o){return o<<1|o>>>31}function DA(o){return o<<5|o>>>27}function LA(o){return o<<30|o>>>2}function _A(o,e,t,r){return o===0?e&t|~e&r:o===2?e&t|e&r|t&r:e^t^r}Ji.prototype._update=function(o){for(var e=this._w,t=this._a|0,r=this._b|0,n=this._c|0,i=this._d|0,s=this._e|0,a=0;a<16;++a)e[a]=o.readInt32BE(a*4);for(;a<80;++a)e[a]=qA(e[a-3]^e[a-8]^e[a-14]^e[a-16]);for(var c=0;c<80;++c){var u=~~(c/20),l=DA(t)+_A(u,r,n,i)+s+e[c]+IA[u]|0;s=i,i=n,n=LA(r),r=t,t=l}this._a=t+this._a|0,this._b=r+this._b|0,this._c=n+this._c|0,this._d=i+this._d|0,this._e=s+this._e|0};Ji.prototype._hash=function(){var o=OA.allocUnsafe(20);return o.writeInt32BE(this._a|0,0),o.writeInt32BE(this._b|0,4),o.writeInt32BE(this._c|0,8),o.writeInt32BE(this._d|0,12),o.writeInt32BE(this._e|0,16),o};vy.exports=Ji});var fl=_((AH,Iy)=>{"use strict";var BA=Ur(),Oy=Vr(),UA=nr().Buffer,FA=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],jA=new Array(64);function Yi(){this.init(),this._w=jA,Oy.call(this,64,56)}BA(Yi,Oy);Yi.prototype.init=function(){return this._a=1779033703,this._b=3144134277,this._c=1013904242,this._d=2773480762,this._e=1359893119,this._f=2600822924,this._g=528734635,this._h=1541459225,this};function QA(o,e,t){return t^o&(e^t)}function kA(o,e,t){return o&e|t&(o|e)}function VA(o){return(o>>>2|o<<30)^(o>>>13|o<<19)^(o>>>22|o<<10)}function WA(o){return(o>>>6|o<<26)^(o>>>11|o<<21)^(o>>>25|o<<7)}function HA(o){return(o>>>7|o<<25)^(o>>>18|o<<14)^o>>>3}function GA(o){return(o>>>17|o<<15)^(o>>>19|o<<13)^o>>>10}Yi.prototype._update=function(o){for(var e=this._w,t=this._a|0,r=this._b|0,n=this._c|0,i=this._d|0,s=this._e|0,a=this._f|0,c=this._g|0,u=this._h|0,l=0;l<16;++l)e[l]=o.readInt32BE(l*4);for(;l<64;++l)e[l]=GA(e[l-2])+e[l-7]+HA(e[l-15])+e[l-16]|0;for(var h=0;h<64;++h){var p=u+WA(s)+QA(s,a,c)+FA[h]+e[h]|0,d=VA(t)+kA(t,r,n)|0;u=c,c=a,a=s,s=i+p|0,i=n,n=r,r=t,t=p+d|0}this._a=t+this._a|0,this._b=r+this._b|0,this._c=n+this._c|0,this._d=i+this._d|0,this._e=s+this._e|0,this._f=a+this._f|0,this._g=c+this._g|0,this._h=u+this._h|0};Yi.prototype._hash=function(){var o=UA.allocUnsafe(32);return o.writeInt32BE(this._a,0),o.writeInt32BE(this._b,4),o.writeInt32BE(this._c,8),o.writeInt32BE(this._d,12),o.writeInt32BE(this._e,16),o.writeInt32BE(this._f,20),o.writeInt32BE(this._g,24),o.writeInt32BE(this._h,28),o};Iy.exports=Yi});var qy=_((xH,$y)=>{"use strict";var KA=Ur(),zA=fl(),JA=Vr(),YA=nr().Buffer,XA=new Array(64);function Ua(){this.init(),this._w=XA,JA.call(this,64,56)}KA(Ua,zA);Ua.prototype.init=function(){return this._a=3238371032,this._b=914150663,this._c=812702999,this._d=4144912697,this._e=4290775857,this._f=1750603025,this._g=1694076839,this._h=3204075428,this};Ua.prototype._hash=function(){var o=YA.allocUnsafe(28);return o.writeInt32BE(this._a,0),o.writeInt32BE(this._b,4),o.writeInt32BE(this._c,8),o.writeInt32BE(this._d,12),o.writeInt32BE(this._e,16),o.writeInt32BE(this._f,20),o.writeInt32BE(this._g,24),o};$y.exports=Ua});var yl=_((CH,jy)=>{"use strict";var ZA=Ur(),Fy=Vr(),ex=nr().Buffer,Dy=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591],tx=new Array(160);function Xi(){this.init(),this._w=tx,Fy.call(this,128,112)}ZA(Xi,Fy);Xi.prototype.init=function(){return this._ah=1779033703,this._bh=3144134277,this._ch=1013904242,this._dh=2773480762,this._eh=1359893119,this._fh=2600822924,this._gh=528734635,this._hh=1541459225,this._al=4089235720,this._bl=2227873595,this._cl=4271175723,this._dl=1595750129,this._el=2917565137,this._fl=725511199,this._gl=4215389547,this._hl=327033209,this};function Ly(o,e,t){return t^o&(e^t)}function _y(o,e,t){return o&e|t&(o|e)}function By(o,e){return(o>>>28|e<<4)^(e>>>2|o<<30)^(e>>>7|o<<25)}function Uy(o,e){return(o>>>14|e<<18)^(o>>>18|e<<14)^(e>>>9|o<<23)}function rx(o,e){return(o>>>1|e<<31)^(o>>>8|e<<24)^o>>>7}function nx(o,e){return(o>>>1|e<<31)^(o>>>8|e<<24)^(o>>>7|e<<25)}function ix(o,e){return(o>>>19|e<<13)^(e>>>29|o<<3)^o>>>6}function sx(o,e){return(o>>>19|e<<13)^(e>>>29|o<<3)^(o>>>6|e<<26)}function et(o,e){return o>>>0<e>>>0?1:0}Xi.prototype._update=function(o){for(var e=this._w,t=this._ah|0,r=this._bh|0,n=this._ch|0,i=this._dh|0,s=this._eh|0,a=this._fh|0,c=this._gh|0,u=this._hh|0,l=this._al|0,h=this._bl|0,p=this._cl|0,d=this._dl|0,m=this._el|0,f=this._fl|0,A=this._gl|0,R=this._hl|0,I=0;I<32;I+=2)e[I]=o.readInt32BE(I*4),e[I+1]=o.readInt32BE(I*4+4);for(;I<160;I+=2){var C=e[I-30],U=e[I-30+1],J=rx(C,U),ne=nx(U,C);C=e[I-4],U=e[I-4+1];var oe=ix(C,U),z=sx(U,C),O=e[I-14],he=e[I-14+1],S=e[I-32],$=e[I-32+1],T=ne+he|0,w=J+O+et(T,ne)|0;T=T+z|0,w=w+oe+et(T,z)|0,T=T+$|0,w=w+S+et(T,$)|0,e[I]=w,e[I+1]=T}for(var P=0;P<160;P+=2){w=e[P],T=e[P+1];var v=_y(t,r,n),D=_y(l,h,p),j=By(t,l),Z=By(l,t),se=Uy(s,m),me=Uy(m,s),B=Dy[P],fe=Dy[P+1],ke=Ly(s,a,c),ie=Ly(m,f,A),Ee=R+me|0,Ae=u+se+et(Ee,R)|0;Ee=Ee+ie|0,Ae=Ae+ke+et(Ee,ie)|0,Ee=Ee+fe|0,Ae=Ae+B+et(Ee,fe)|0,Ee=Ee+T|0,Ae=Ae+w+et(Ee,T)|0;var we=Z+D|0,qe=j+v+et(we,Z)|0;u=c,R=A,c=a,A=f,a=s,f=m,m=d+Ee|0,s=i+Ae+et(m,d)|0,i=n,d=p,n=r,p=h,r=t,h=l,l=Ee+we|0,t=Ae+qe+et(l,Ee)|0}this._al=this._al+l|0,this._bl=this._bl+h|0,this._cl=this._cl+p|0,this._dl=this._dl+d|0,this._el=this._el+m|0,this._fl=this._fl+f|0,this._gl=this._gl+A|0,this._hl=this._hl+R|0,this._ah=this._ah+t+et(this._al,l)|0,this._bh=this._bh+r+et(this._bl,h)|0,this._ch=this._ch+n+et(this._cl,p)|0,this._dh=this._dh+i+et(this._dl,d)|0,this._eh=this._eh+s+et(this._el,m)|0,this._fh=this._fh+a+et(this._fl,f)|0,this._gh=this._gh+c+et(this._gl,A)|0,this._hh=this._hh+u+et(this._hl,R)|0};Xi.prototype._hash=function(){var o=ex.allocUnsafe(64);function e(t,r,n){o.writeInt32BE(t,n),o.writeInt32BE(r,n+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),e(this._gh,this._gl,48),e(this._hh,this._hl,56),o};jy.exports=Xi});var ky=_((RH,Qy)=>{"use strict";var ax=Ur(),ox=yl(),cx=Vr(),ux=nr().Buffer,lx=new Array(160);function Fa(){this.init(),this._w=lx,cx.call(this,128,112)}ax(Fa,ox);Fa.prototype.init=function(){return this._ah=3418070365,this._bh=1654270250,this._ch=2438529370,this._dh=355462360,this._eh=1731405415,this._fh=2394180231,this._gh=3675008525,this._hh=1203062813,this._al=3238371032,this._bl=914150663,this._cl=812702999,this._dl=4144912697,this._el=4290775857,this._fl=1750603025,this._gl=1694076839,this._hl=3204075428,this};Fa.prototype._hash=function(){var o=ux.allocUnsafe(48);function e(t,r,n){o.writeInt32BE(t,n),o.writeInt32BE(r,n+4)}return e(this._ah,this._al,0),e(this._bh,this._bl,8),e(this._ch,this._cl,16),e(this._dh,this._dl,24),e(this._eh,this._el,32),e(this._fh,this._fl,40),o};Qy.exports=Fa});var Vy=_((SH,ir)=>{"use strict";ir.exports=function(e){var t=e.toLowerCase(),r=ir.exports[t];if(!r)throw new Error(t+" is not supported (we accept pull requests)");return new r};ir.exports.sha=Sy();ir.exports.sha1=Py();ir.exports.sha224=qy();ir.exports.sha256=fl();ir.exports.sha384=ky();ir.exports.sha512=yl()});var eg=_(()=>{var Zy;(function(o){(function(e){var t=typeof globalThis=="object"||typeof globalThis=="object"?globalThis:typeof self=="object"?self:typeof this=="object"?this:a(),r=n(o);typeof t.Reflect<"u"&&(r=n(t.Reflect,r)),e(r,t),typeof t.Reflect>"u"&&(t.Reflect=o);function n(c,u){return function(l,h){Object.defineProperty(c,l,{configurable:!0,writable:!0,value:h}),u&&u(l,h)}}function i(){try{return Function("return this;")()}catch{}}function s(){try{return(0,eval)("(function() { return this; })()")}catch{}}function a(){return i()||s()}})(function(e,t){var r=Object.prototype.hasOwnProperty,n=typeof Symbol=="function",i=n&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",s=n&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",a=typeof Object.create=="function",c={__proto__:[]}instanceof Array,u=!a&&!c,l={create:a?function(){return Sr(Object.create(null))}:c?function(){return Sr({__proto__:null})}:function(){return Sr({})},has:u?function(g,E){return r.call(g,E)}:function(g,E){return E in g},get:u?function(g,E){return r.call(g,E)?g[E]:void 0}:function(g,E){return g[E]}},h=Object.getPrototypeOf(Function),p=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:Oc(),d=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:Ic(),m=typeof WeakMap=="function"?WeakMap:$c(),f=n?Symbol.for("@reflect-metadata:registry"):void 0,A=Mc(),R=vc(A);function I(g,E,N,q){if(B(N)){if(!ut(g))throw new TypeError;if(!ii(E))throw new TypeError;return $(g,E)}else{if(!ut(g))throw new TypeError;if(!ie(E))throw new TypeError;if(!ie(q)&&!B(q)&&!fe(q))throw new TypeError;return fe(q)&&(q=void 0),N=Se(N),T(g,E,N,q)}}e("decorate",I);function C(g,E){function N(q,G){if(!ie(q))throw new TypeError;if(!B(G)&&!Rc(G))throw new TypeError;j(g,E,q,G)}return N}e("metadata",C);function U(g,E,N,q){if(!ie(N))throw new TypeError;return B(q)||(q=Se(q)),j(g,E,N,q)}e("defineMetadata",U);function J(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),w(g,E,N)}e("hasMetadata",J);function ne(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),P(g,E,N)}e("hasOwnMetadata",ne);function oe(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),v(g,E,N)}e("getMetadata",oe);function z(g,E,N){if(!ie(E))throw new TypeError;return B(N)||(N=Se(N)),D(g,E,N)}e("getOwnMetadata",z);function O(g,E){if(!ie(g))throw new TypeError;return B(E)||(E=Se(E)),Z(g,E)}e("getMetadataKeys",O);function he(g,E){if(!ie(g))throw new TypeError;return B(E)||(E=Se(E)),se(g,E)}e("getOwnMetadataKeys",he);function S(g,E,N){if(!ie(E))throw new TypeError;if(B(N)||(N=Se(N)),!ie(E))throw new TypeError;B(N)||(N=Se(N));var q=Ot(E,N,!1);return B(q)?!1:q.OrdinaryDeleteMetadata(g,E,N)}e("deleteMetadata",S);function $(g,E){for(var N=g.length-1;N>=0;--N){var q=g[N],G=q(E);if(!B(G)&&!fe(G)){if(!ii(G))throw new TypeError;E=G}}return E}function T(g,E,N,q){for(var G=g.length-1;G>=0;--G){var Te=g[G],Ne=Te(E,N,q);if(!B(Ne)&&!fe(Ne)){if(!ie(Ne))throw new TypeError;q=Ne}}return q}function w(g,E,N){var q=P(g,E,N);if(q)return!0;var G=Rr(E);return fe(G)?!1:w(g,G,N)}function P(g,E,N){var q=Ot(E,N,!1);return B(q)?!1:we(q.OrdinaryHasOwnMetadata(g,E,N))}function v(g,E,N){var q=P(g,E,N);if(q)return D(g,E,N);var G=Rr(E);if(!fe(G))return v(g,G,N)}function D(g,E,N){var q=Ot(E,N,!1);if(!B(q))return q.OrdinaryGetOwnMetadata(g,E,N)}function j(g,E,N,q){var G=Ot(N,q,!0);G.OrdinaryDefineOwnMetadata(g,E,N,q)}function Z(g,E){var N=se(g,E),q=Rr(g);if(q===null)return N;var G=Z(q,E);if(G.length<=0)return N;if(N.length<=0)return G;for(var Te=new d,Ne=[],ee=0,L=N;ee<L.length;ee++){var F=L[ee],Q=Te.has(F);Q||(Te.add(F),Ne.push(F))}for(var W=0,te=G;W<te.length;W++){var F=te[W],Q=Te.has(F);Q||(Te.add(F),Ne.push(F))}return Ne}function se(g,E){var N=Ot(g,E,!1);return N?N.OrdinaryOwnMetadataKeys(g,E):[]}function me(g){if(g===null)return 1;switch(typeof g){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return g===null?1:6;default:return 6}}function B(g){return g===void 0}function fe(g){return g===null}function ke(g){return typeof g=="symbol"}function ie(g){return typeof g=="object"?g!==null:typeof g=="function"}function Ee(g,E){switch(me(g)){case 0:return g;case 1:return g;case 2:return g;case 3:return g;case 4:return g;case 5:return g}var N=E===3?"string":E===5?"number":"default",q=si(g,i);if(q!==void 0){var G=q.call(g,N);if(ie(G))throw new TypeError;return G}return Ae(g,N==="default"?"number":N)}function Ae(g,E){if(E==="string"){var N=g.toString;if(xt(N)){var q=N.call(g);if(!ie(q))return q}var G=g.valueOf;if(xt(G)){var q=G.call(g);if(!ie(q))return q}}else{var G=g.valueOf;if(xt(G)){var q=G.call(g);if(!ie(q))return q}var Te=g.toString;if(xt(Te)){var q=Te.call(g);if(!ie(q))return q}}throw new TypeError}function we(g){return!!g}function qe(g){return""+g}function Se(g){var E=Ee(g,3);return ke(E)?E:qe(E)}function ut(g){return Array.isArray?Array.isArray(g):g instanceof Object?g instanceof Array:Object.prototype.toString.call(g)==="[object Array]"}function xt(g){return typeof g=="function"}function ii(g){return typeof g=="function"}function Rc(g){switch(me(g)){case 3:return!0;case 4:return!0;default:return!1}}function Cr(g,E){return g===E||g!==g&&E!==E}function si(g,E){var N=g[E];if(N!=null){if(!xt(N))throw new TypeError;return N}}function ai(g){var E=si(g,s);if(!xt(E))throw new TypeError;var N=E.call(g);if(!ie(N))throw new TypeError;return N}function oi(g){return g.value}function ci(g){var E=g.next();return E.done?!1:E}function ui(g){var E=g.return;E&&E.call(g)}function Rr(g){var E=Object.getPrototypeOf(g);if(typeof g!="function"||g===h||E!==h)return E;var N=g.prototype,q=N&&Object.getPrototypeOf(N);if(q==null||q===Object.prototype)return E;var G=q.constructor;return typeof G!="function"||G===g?E:G}function Sc(){var g;!B(f)&&typeof t.Reflect<"u"&&!(f in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(g=Pc(t.Reflect));var E,N,q,G=new m,Te={registerProvider:Ne,getProvider:L,setProvider:Q};return Te;function Ne(W){if(!Object.isExtensible(Te))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case g===W:break;case B(E):E=W;break;case E===W:break;case B(N):N=W;break;case N===W:break;default:q===void 0&&(q=new d),q.add(W);break}}function ee(W,te){if(!B(E)){if(E.isProviderFor(W,te))return E;if(!B(N)){if(N.isProviderFor(W,te))return E;if(!B(q))for(var de=ai(q);;){var be=ci(de);if(!be)return;var Ue=oi(be);if(Ue.isProviderFor(W,te))return ui(de),Ue}}}if(!B(g)&&g.isProviderFor(W,te))return g}function L(W,te){var de=G.get(W),be;return B(de)||(be=de.get(te)),B(be)&&(be=ee(W,te),B(be)||(B(de)&&(de=new p,G.set(W,de)),de.set(te,be))),be}function F(W){if(B(W))throw new TypeError;return E===W||N===W||!B(q)&&q.has(W)}function Q(W,te,de){if(!F(de))throw new Error("Metadata provider not registered.");var be=L(W,te);if(be!==de){if(!B(be))return!1;var Ue=G.get(W);B(Ue)&&(Ue=new p,G.set(W,Ue)),Ue.set(te,de)}return!0}}function Mc(){var g;return!B(f)&&ie(t.Reflect)&&Object.isExtensible(t.Reflect)&&(g=t.Reflect[f]),B(g)&&(g=Sc()),!B(f)&&ie(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,f,{enumerable:!1,configurable:!1,writable:!1,value:g}),g}function vc(g){var E=new m,N={isProviderFor:function(F,Q){var W=E.get(F);return B(W)?!1:W.has(Q)},OrdinaryDefineOwnMetadata:Ne,OrdinaryHasOwnMetadata:G,OrdinaryGetOwnMetadata:Te,OrdinaryOwnMetadataKeys:ee,OrdinaryDeleteMetadata:L};return A.registerProvider(N),N;function q(F,Q,W){var te=E.get(F),de=!1;if(B(te)){if(!W)return;te=new p,E.set(F,te),de=!0}var be=te.get(Q);if(B(be)){if(!W)return;if(be=new p,te.set(Q,be),!g.setProvider(F,Q,N))throw te.delete(Q),de&&E.delete(F),new Error("Wrong provider for target.")}return be}function G(F,Q,W){var te=q(Q,W,!1);return B(te)?!1:we(te.has(F))}function Te(F,Q,W){var te=q(Q,W,!1);if(!B(te))return te.get(F)}function Ne(F,Q,W,te){var de=q(W,te,!0);de.set(F,Q)}function ee(F,Q){var W=[],te=q(F,Q,!1);if(B(te))return W;for(var de=te.keys(),be=ai(de),Ue=0;;){var li=ci(be);if(!li)return W.length=Ue,W;var qc=oi(li);try{W[Ue]=qc}catch(Dc){try{ui(be)}finally{throw Dc}}Ue++}}function L(F,Q,W){var te=q(Q,W,!1);if(B(te)||!te.delete(F))return!1;if(te.size===0){var de=E.get(Q);B(de)||(de.delete(W),de.size===0&&E.delete(de))}return!0}}function Pc(g){var E=g.defineMetadata,N=g.hasOwnMetadata,q=g.getOwnMetadata,G=g.getOwnMetadataKeys,Te=g.deleteMetadata,Ne=new m,ee={isProviderFor:function(L,F){var Q=Ne.get(L);return!B(Q)&&Q.has(F)?!0:G(L,F).length?(B(Q)&&(Q=new d,Ne.set(L,Q)),Q.add(F),!0):!1},OrdinaryDefineOwnMetadata:E,OrdinaryHasOwnMetadata:N,OrdinaryGetOwnMetadata:q,OrdinaryOwnMetadataKeys:G,OrdinaryDeleteMetadata:Te};return ee}function Ot(g,E,N){var q=A.getProvider(g,E);if(!B(q))return q;if(N){if(A.setProvider(g,E,R))return R;throw new Error("Illegal state.")}}function Oc(){var g={},E=[],N=(function(){function ee(L,F,Q){this._index=0,this._keys=L,this._values=F,this._selector=Q}return ee.prototype["@@iterator"]=function(){return this},ee.prototype[s]=function(){return this},ee.prototype.next=function(){var L=this._index;if(L>=0&&L<this._keys.length){var F=this._selector(this._keys[L],this._values[L]);return L+1>=this._keys.length?(this._index=-1,this._keys=E,this._values=E):this._index++,{value:F,done:!1}}return{value:void 0,done:!0}},ee.prototype.throw=function(L){throw this._index>=0&&(this._index=-1,this._keys=E,this._values=E),L},ee.prototype.return=function(L){return this._index>=0&&(this._index=-1,this._keys=E,this._values=E),{value:L,done:!0}},ee})(),q=(function(){function ee(){this._keys=[],this._values=[],this._cacheKey=g,this._cacheIndex=-2}return Object.defineProperty(ee.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),ee.prototype.has=function(L){return this._find(L,!1)>=0},ee.prototype.get=function(L){var F=this._find(L,!1);return F>=0?this._values[F]:void 0},ee.prototype.set=function(L,F){var Q=this._find(L,!0);return this._values[Q]=F,this},ee.prototype.delete=function(L){var F=this._find(L,!1);if(F>=0){for(var Q=this._keys.length,W=F+1;W<Q;W++)this._keys[W-1]=this._keys[W],this._values[W-1]=this._values[W];return this._keys.length--,this._values.length--,Cr(L,this._cacheKey)&&(this._cacheKey=g,this._cacheIndex=-2),!0}return!1},ee.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=g,this._cacheIndex=-2},ee.prototype.keys=function(){return new N(this._keys,this._values,G)},ee.prototype.values=function(){return new N(this._keys,this._values,Te)},ee.prototype.entries=function(){return new N(this._keys,this._values,Ne)},ee.prototype["@@iterator"]=function(){return this.entries()},ee.prototype[s]=function(){return this.entries()},ee.prototype._find=function(L,F){if(!Cr(this._cacheKey,L)){this._cacheIndex=-1;for(var Q=0;Q<this._keys.length;Q++)if(Cr(this._keys[Q],L)){this._cacheIndex=Q;break}}return this._cacheIndex<0&&F&&(this._cacheIndex=this._keys.length,this._keys.push(L),this._values.push(void 0)),this._cacheIndex},ee})();return q;function G(ee,L){return ee}function Te(ee,L){return L}function Ne(ee,L){return[ee,L]}}function Ic(){var g=(function(){function E(){this._map=new p}return Object.defineProperty(E.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),E.prototype.has=function(N){return this._map.has(N)},E.prototype.add=function(N){return this._map.set(N,N),this},E.prototype.delete=function(N){return this._map.delete(N)},E.prototype.clear=function(){this._map.clear()},E.prototype.keys=function(){return this._map.keys()},E.prototype.values=function(){return this._map.keys()},E.prototype.entries=function(){return this._map.entries()},E.prototype["@@iterator"]=function(){return this.keys()},E.prototype[s]=function(){return this.keys()},E})();return g}function $c(){var g=16,E=l.create(),N=q();return(function(){function L(){this._key=q()}return L.prototype.has=function(F){var Q=G(F,!1);return Q!==void 0?l.has(Q,this._key):!1},L.prototype.get=function(F){var Q=G(F,!1);return Q!==void 0?l.get(Q,this._key):void 0},L.prototype.set=function(F,Q){var W=G(F,!0);return W[this._key]=Q,this},L.prototype.delete=function(F){var Q=G(F,!1);return Q!==void 0?delete Q[this._key]:!1},L.prototype.clear=function(){this._key=q()},L})();function q(){var L;do L="@@WeakMap@@"+ee();while(l.has(E,L));return E[L]=!0,L}function G(L,F){if(!r.call(L,N)){if(!F)return;Object.defineProperty(L,N,{value:l.create()})}return L[N]}function Te(L,F){for(var Q=0;Q<F;++Q)L[Q]=Math.random()*255|0;return L}function Ne(L){if(typeof Uint8Array=="function"){var F=new Uint8Array(L);return typeof crypto<"u"?crypto.getRandomValues(F):typeof msCrypto<"u"?msCrypto.getRandomValues(F):Te(F,L),F}return Te(new Array(L),L)}function ee(){var L=Ne(g);L[6]=L[6]&79|64,L[8]=L[8]&191|128;for(var F="",Q=0;Q<g;++Q){var W=L[Q];(Q===4||Q===6||Q===8)&&(F+="-"),W<16&&(F+="0"),F+=W.toString(16).toLowerCase()}return F}}function Sr(g){return g.__=void 0,delete g.__,g}})})(Zy||(Zy={}))});var ag=_((zne,sg)=>{var ti=1e3,ri=ti*60,ni=ri*60,Xr=ni*24,wx=Xr*7,Nx=Xr*365.25;sg.exports=function(o,e){e=e||{};var t=typeof o;if(t==="string"&&o.length>0)return Ax(o);if(t==="number"&&isFinite(o))return e.long?Cx(o):xx(o);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(o))};function Ax(o){if(o=String(o),!(o.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(o);if(e){var t=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return t*Nx;case"weeks":case"week":case"w":return t*wx;case"days":case"day":case"d":return t*Xr;case"hours":case"hour":case"hrs":case"hr":case"h":return t*ni;case"minutes":case"minute":case"mins":case"min":case"m":return t*ri;case"seconds":case"second":case"secs":case"sec":case"s":return t*ti;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function xx(o){var e=Math.abs(o);return e>=Xr?Math.round(o/Xr)+"d":e>=ni?Math.round(o/ni)+"h":e>=ri?Math.round(o/ri)+"m":e>=ti?Math.round(o/ti)+"s":o+"ms"}function Cx(o){var e=Math.abs(o);return e>=Xr?Tc(o,e,Xr,"day"):e>=ni?Tc(o,e,ni,"hour"):e>=ri?Tc(o,e,ri,"minute"):e>=ti?Tc(o,e,ti,"second"):o+" ms"}function Tc(o,e,t,r){var n=e>=t*1.5;return Math.round(o/t)+" "+r+(n?"s":"")}});var cg=_((Jne,og)=>{function Rx(o){t.debug=t,t.default=t,t.coerce=c,t.disable=s,t.enable=n,t.enabled=a,t.humanize=ag(),t.destroy=u,Object.keys(o).forEach(l=>{t[l]=o[l]}),t.names=[],t.skips=[],t.formatters={};function e(l){let h=0;for(let p=0;p<l.length;p++)h=(h<<5)-h+l.charCodeAt(p),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(l){let h,p=null,d,m;function f(...A){if(!f.enabled)return;let R=f,I=Number(new Date),C=I-(h||I);R.diff=C,R.prev=h,R.curr=I,h=I,A[0]=t.coerce(A[0]),typeof A[0]!="string"&&A.unshift("%O");let U=0;A[0]=A[0].replace(/%([a-zA-Z%])/g,(ne,oe)=>{if(ne==="%%")return"%";U++;let z=t.formatters[oe];if(typeof z=="function"){let O=A[U];ne=z.call(R,O),A.splice(U,1),U--}return ne}),t.formatArgs.call(R,A),(R.log||t.log).apply(R,A)}return f.namespace=l,f.useColors=t.useColors(),f.color=t.selectColor(l),f.extend=r,f.destroy=t.destroy,Object.defineProperty(f,"enabled",{enumerable:!0,configurable:!1,get:()=>p!==null?p:(d!==t.namespaces&&(d=t.namespaces,m=t.enabled(l)),m),set:A=>{p=A}}),typeof t.init=="function"&&t.init(f),f}function r(l,h){let p=t(this.namespace+(typeof h>"u"?":":h)+l);return p.log=this.log,p}function n(l){t.save(l),t.namespaces=l,t.names=[],t.skips=[];let h=(typeof l=="string"?l:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let p of h)p[0]==="-"?t.skips.push(p.slice(1)):t.names.push(p)}function i(l,h){let p=0,d=0,m=-1,f=0;for(;p<l.length;)if(d<h.length&&(h[d]===l[p]||h[d]==="*"))h[d]==="*"?(m=d,f=p,d++):(p++,d++);else if(m!==-1)d=m+1,f++,p=f;else return!1;for(;d<h.length&&h[d]==="*";)d++;return d===h.length}function s(){let l=[...t.names,...t.skips.map(h=>"-"+h)].join(",");return t.enable(""),l}function a(l){for(let h of t.skips)if(i(l,h))return!1;for(let h of t.names)if(i(l,h))return!0;return!1}function c(l){return l instanceof Error?l.stack||l.message:l}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}og.exports=Rx});var ug=_((At,bc)=>{At.formatArgs=Mx;At.save=vx;At.load=Px;At.useColors=Sx;At.storage=Ox();At.destroy=(()=>{let o=!1;return()=>{o||(o=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();At.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Sx(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let o;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(o=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(o[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Mx(o){if(o[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+o[0]+(this.useColors?"%c ":" ")+"+"+bc.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;o.splice(1,0,e,"color: inherit");let t=0,r=0;o[0].replace(/%[a-zA-Z%]/g,n=>{n!=="%%"&&(t++,n==="%c"&&(r=t))}),o.splice(r,0,e)}At.log=console.debug||console.log||(()=>{});function vx(o){try{o?At.storage.setItem("debug",o):At.storage.removeItem("debug")}catch{}}function Px(){let o;try{o=At.storage.getItem("debug")||At.storage.getItem("DEBUG")}catch{}return!o&&typeof process<"u"&&"env"in process&&(o=process.env.DEBUG),o}function Ox(){try{return localStorage}catch{}}bc.exports=cg()(At);var{formatters:Ix}=bc.exports;Ix.j=function(o){try{return JSON.stringify(o)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var fhe=It(_c());var Y2=It(_c());var di=class{static getInheritanceTree(e){let t=[e],r=n=>{let i=Object.getPrototypeOf(n);i&&i.name&&(t.push(i),r(i))};return r(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(r=>r.target&&t.indexOf(r.target)!==-1):e}};var mi=class{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(r=>(Array.isArray(e)?e.indexOf(r.target)!==-1:r.target===e)&&r.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterForeignKeys(e){return this.foreignKeys.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(r=>r.target===e&&r.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(r=>r.target===e&&r.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(r=>(Array.isArray(e)?e.indexOf(r.target)!==-1:r.target===e)&&r.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(r=>(Array.isArray(e)?e.indexOf(r.target)!==-1:r.target===e)&&r.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&di.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(r=>Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){let r=[];return e.forEach(n=>{(Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)&&(r.find(s=>s.propertyName===n.propertyName)||r.push(n))}),r}filterByTargetAndWithoutDuplicateRelationProperties(e,t){let r=[];return e.forEach(n=>{if(Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t){let s=r.findIndex(a=>a.propertyName===n.propertyName);if(Array.isArray(t)&&s!==-1&&t.indexOf(n.target)<t.indexOf(r[s].target)){let a=Object.create(r[s]);a.type=n.type,r[s]=a}else s===-1&&r.push(n)}}),r}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){let r=[];return e.forEach(n=>{(Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)&&(r.find(a=>a.prefix===n.prefix&&a.propertyName===n.propertyName)||r.push(n))}),r}};var Kc=It(xs());var Ct=class{static getGlobalVariable(){return typeof window<"u"?window:globalThis}static load(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: require("${e}").`);return""}static pathNormalize(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.normalize("${e}").`);return""}static pathExtname(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.extname("${e}").`);return""}static pathResolve(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.resolve("${e}").`);return""}static fileExist(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.existsSync("${e}").`);return!1}static dotenv(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: dotenv.config({ path: "${e}" }).`)}static getEnvVariable(e){}static readFileSync(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.readFileSync("${e}").`);return null}static appendFileSync(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.appendFileSync("${e}").`)}static writeFile(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.writeFile("${e}").`);return Promise.reject(null)}static highlightSql(e){return e}static logInfo(e,t){console.info(e+" ",t)}static logError(e,t){console.error(e+" ",t)}static logWarn(e,t){console.warn(e+" ",t)}static log(e){console.log(e)}static warn(e){return e}};Ct.type="browser";typeof window<"u"&&(window.Buffer=Kc.Buffer);typeof globalThis<"u"&&(globalThis.Buffer=Kc.Buffer);typeof globalThis<"u"&&typeof hi<"u"&&(globalThis.Buffer=xs().Buffer);var ae=class{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(let r of t)for(let n of Object.getOwnPropertyNames(r))e[n]=r[n]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}};var M=class extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}};var Yt=class extends M{constructor(){super("Locking not supported on given driver.")}};var Pr=class extends M{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}};var ue=class{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}};var yi=class extends M{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return ue.isEntitySchema(e)?e.options.name:typeof e=="function"||ae.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}};var gi=class extends M{constructor(e,t,r){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${r}.`)}};var sn=class extends M{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}};var Cs=class extends M{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}};var Bt=class extends M{constructor(){super("OUTPUT or RETURNING clause only supported by PostgreSQL, MariaDB, Microsoft SqlServer or Google Spanner.")}};var lt=class o extends M{constructor(e,t){super(e),Object.setPrototypeOf(this,o.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}};var Rs=class extends M{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}};var Ss=class extends M{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}};var or=class extends M{constructor(){super("The optimistic lock can be used only with getOne() method.")}};var Ms=class extends M{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}};var vs=class extends M{constructor(){super("An open transaction is required for pessimistic lock.")}};var an=class extends M{constructor(e,t){super(`Column type for ${e.constructor.name}#${t} is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.`)}};var Ps=class extends M{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}};var Ei=class{constructor(e){ae.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new M(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}};var ht=class{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;let[t,r]=e.split(".");return!(!t||!r||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}};var Cd=It(xd());function bu(o,e={}){let{segmentLength:t=4,separator:r="__",termLength:n=2}=e;return o.split(r).reduce((a,c)=>{let u=c.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),l=u.length>1?n:t,h=u.map(p=>p.substr(0,l)).join("");return a.push(h),a},[]).join(r)}function Rd(o,e={}){let t=(0,Cd.default)("sha1");t.update(o,"utf8");let r=t.digest("hex");return e.length&&e.length>0?r.slice(0,e.length):r}var zs=class{static isGreaterOrEqual(e,t){if(!e)return!1;let r=Sd(e),n=Sd(t);for(let i=0;i<r.length&&i<n.length;i++){if(r[i]>n[i])return!0;if(r[i]<n[i])return!1}return!0}};function Sd(o){return o.split(".").map(e=>parseInt(e,10))}var Y=class{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return zs.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){let r=this.parseConnectionUrl(e.url);t&&t.useSid&&r.database&&(r.sid=r.database);for(let n of Object.keys(r))typeof r[n]>"u"&&delete r[n];return Object.assign({},e,r)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){let r=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&r.database&&(r.sid=r.database);for(let n of Object.keys(r))typeof r[n]>"u"&&delete r[n];return Object.assign({},e,r)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...r){let n=t&&t.joiner?t.joiner:"_",i=r.length===1?r[0]:r.join(n);if(e&&e>0&&i.length>e){if(t&&t.shorten===!0){let s=bu(i);if(s.length<e)return s}return Rd(i,{length:e})}return i}static buildColumnAlias({maxAliasLength:e},t,...r){return typeof t=="string"?(r.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...r)}static parseConnectionUrl(e){let t=e.split(":")[0],r=e.indexOf("//"),n=e.substr(r+2),i=n.indexOf("/"),s=i!==-1?n.substr(0,i):n,a=i!==-1?n.substr(i+1):void 0;a&&a.indexOf("?")!==-1&&(a=a.substr(0,a.indexOf("?")));let c=s.lastIndexOf("@"),u=s.substr(0,c),l=s.substr(c+1),h=u,p="",d=u.indexOf(":");d!==-1&&(h=u.substr(0,d),p=u.substr(d+1));let[m,f]=l.split(":");return{type:t,host:m,username:decodeURIComponent(h),password:decodeURIComponent(p),port:f?parseInt(f):void 0,database:a||void 0}}static parseMongoDBConnectionUrl(e){let t=e.split(":")[0],r=e.indexOf("//"),n=e.substr(r+2),i=n.indexOf("/"),s=i!==-1?n.substr(0,i):n,a=i!==-1?n.substr(i+1):void 0,c="",u,l,h,p,d={};if(a&&a.indexOf("?")!==-1){c=a.substr(a.indexOf("?")+1,a.length);let J=c.split("&"),ne,oe;J.forEach(z=>{ne=z.split("=")[0],oe=z.split("=")[1],d[ne]=oe}),p=d.replicaSet,a=a.substr(0,a.indexOf("?"))}let m=s.lastIndexOf("@"),f=s.substr(0,m),A=s.substr(m+1),R=f,I="",C=f.indexOf(":");C!==-1&&(R=f.substr(0,C),I=f.substr(C+1)),p?h=A:[u,l]=A.split(":");let U={type:t,host:u,hostReplicaSet:h,username:decodeURIComponent(R),password:decodeURIComponent(I),port:l?parseInt(l):void 0,database:a||void 0};for(let[J,ne]of Object.entries(d))U[J]=ne;return U}};var yn=class{constructor(e,t,r){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,r&&ae.assign(this,r)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(let t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(r=>t.selection===this.alias.name+"."+r.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(ht.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(ht.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!ht.isAliasProperty(this.entityOrProperty))return;let t=this.queryExpressionMap.findAliasByName(this.parentAlias),r=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(r||t.metadata.parentEntityMetadata&&(r=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),r))return r;throw new M(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new M("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new M("Junction property is not defined.");let e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?Y.buildAlias(this.connection.driver,void 0,e,this.alias.name):Y.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}};var cr=class{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,ae.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");let t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new M(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){let[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}};var ur=class{constructor(e,t){this.expressionMap=e,ae.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){let[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value is a string representation of alias property");let[e,t]=this.relationName.split("."),n=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!n)throw new M(`Relation with property path ${t} in entity was not found.`);return n}get metadata(){if(!ht.isAliasProperty(this.relationName))throw new M("Given value is a string representation of alias property");let e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}};var Js=class o{constructor(e){this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=e.options?.timeTravelQueries||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){let e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,r)=>(t[this.mainAlias.name+"."+r]=e[r],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);let r=new Ei;return r.type=e.type,t&&(r.name=t),e.metadata&&(r.metadata=e.metadata),e.target&&!r.hasMetadata&&(r.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(r.tablePath=e.tablePath),e.subQuery&&(r.subQuery=e.subQuery),this.aliases.push(r),r}findAliasByName(e){let t=this.aliases.find(r=>r.name===e);if(!t)throw new M(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){let[t,r]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(r)}get relationMetadata(){if(!this.mainAlias)throw new M("Entity to work with is not specified!");let e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new M(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){let e=new o(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new Ei(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new yn(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new cr(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new ur(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.useIndex=this.useIndex,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}};var lr=class{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}};var yt=class{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((n,i)=>i.from(n),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((r,n)=>n.to(r),t):e.to(t)}};var Ie=class o{constructor(e,t,r=!0,n=!1,i,s){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=r,this._multipleParameters=n,this._getSql=i,this._objectLiteralParameters=s}get useParameter(){return ue.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return ue.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return ue.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return ue.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(ue.isFindOperator(this._value))return this._value}get getSql(){return ue.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof o?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&yt.transformTo(e,t)):yt.transformTo(e,this._value)}};function Md(o){return new Ie("in",o,!0,!0)}var Nb=/[.*+\-?^${}()|[\]\\]/g,vd=o=>o.replace(Nb,"\\$&");var Fe=class o{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,ue.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Js(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){o.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new M("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(r=>({selection:r})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),ue.isSelectQueryBuilder(this)?this:o.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",ue.isInsertQueryBuilder(this)?this:o.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){let r=t||e;if(e=ue.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){let n=this.createFromAlias(e);this.expressionMap.setMainAlias(n)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=r,ue.isUpdateQueryBuilder(this)?this:o.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",ue.isDeleteQueryBuilder(this)?this:o.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",ue.isSoftDeleteQueryBuilder(this)?this:o.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",ue.isSoftDeleteQueryBuilder(this)?this:o.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){let r=arguments.length===2?e:void 0,n=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=n,r){let i=this.createFromAlias(r);this.expressionMap.setMainAlias(i)}return ue.isRelationQueryBuilder(this)?this:o.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){let r=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!r.findRelationWithPropertyPath(i))}hasParameter(e){return this.parentQueryBuilder?.hasParameter(e)||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new M(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new M("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(let[t,r]of Object.entries(e))this.setParameter(t,r);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){let e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){let t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){let r=t.childEntityMetadatas.filter(n=>n.discriminatorColumn).map(n=>n.discriminatorValue);r.push(t.discriminatorValue),e.discriminatorColumnValues=r}}return e}printSql(){let[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){let e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){let[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner();try{return await r.query(e,t)}finally{r!==this.queryRunner&&await r.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,r){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:r||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new M('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){let r=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:r.tablePath})}else{if(typeof e=="string"){let i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}let r=e(this.subQuery());this.setParameters(r.getParameters());let n=r.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:n})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){let t={};for(let i of this.expressionMap.aliases){if(!i.hasMetadata)continue;let s=this.expressionMap.aliasNamePrefixingEnabled&&i.name?`${i.name}.`:"";t[s]||(t[s]={});for(let a of i.metadata.relations)a.joinColumns.length>0&&(t[s][a.propertyPath]=a.joinColumns[0].databaseName);for(let a of i.metadata.relations){let c=[...a.joinColumns,...a.inverseJoinColumns];for(let u of c){let l=`${a.propertyPath}.${u.referencedColumn.propertyPath}`;t[s][l]=u.databaseName}}for(let a of i.metadata.columns)t[s][a.databaseName]=a.databaseName;for(let a of i.metadata.columns)t[s][a.propertyName]=a.databaseName;for(let a of i.metadata.columns)t[s][a.propertyPath]=a.databaseName}let r=Object.keys(t),n=r.map(i=>vd(i)).join("|");return r.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${n?"("+n+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...i)=>{let s,a,c;if(n){if(s=i[0],a=i[1],c=i[3],t[i[2]][c])return`${a}${this.escape(i[2].substring(0,i[2].length-1))}.${this.escape(t[i[2]][c])}`}else if(s=i[0],a=i[1],c=i[2],t[""][c])return`${a}${this.escape(t[""][c])}`;return s})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){let e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){let n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&n.deleteDateColumn){let i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.deleteDateColumn.propertyName:n.deleteDateColumn.propertyName,s=`${this.replacePropertyNames(i)} IS NULL`;e.push(s)}if(n.discriminatorColumn&&n.parentEntityMetadata){let i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.discriminatorColumn.databaseName:n.discriminatorColumn.databaseName,s=`${this.replacePropertyNames(i)} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){let n=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(n)}let r="";return r+=this.createTimeTravelQuery(),e.length?e.length===1?r+=` WHERE ${e[0]}`:r+=` WHERE ( ${e.join(" ) AND ( ")} )`:r+="",r}createReturningExpression(e){let t=this.getReturningColumns(),r=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&r.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(n=>t.indexOf(n)===-1)),t.length){let n=t.map(i=>{let s=this.escape(i.databaseName);return r.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+s:this.escape(this.getMainTableName())+"."+s:s}).join(", ");return r.options.type==="oracle"&&(n+=" INTO "+t.map(i=>this.createParameter({type:r.columnTypeToNativeParameter(i.type),dir:r.oracle.BIND_OUT})).join(", ")),r.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(n+=" INTO @OutputTable"),n}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){let e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,r)=>{let n=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(r>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${n}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(r>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${n}${this.connection.options.isolateWhereStatements?")":""}`}return n}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";let{driver:r}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return r.options.type==="postgres"||r.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return r.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${Ie.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";let e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(r=>{let n=typeof r.queryBuilder=="string"?r.queryBuilder:"";if(typeof r.queryBuilder!="string"){if(r.queryBuilder.hasCommonTableExpressions())throw new M(`Nested CTEs aren't supported (CTE: ${r.alias})`);if(n=r.queryBuilder.getQuery(),!this.connection.driver.cteCapabilities.writable&&!ue.isSelectQueryBuilder(r.queryBuilder))throw new M(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${r.alias})`);this.setParameters(r.queryBuilder.getParameters())}let i=this.escape(r.alias);if(r.options.columnNames){let c=r.options.columnNames.map(u=>this.escape(u));if(ue.isSelectQueryBuilder(r.queryBuilder)&&r.queryBuilder.expressionMap.selects.length&&r.options.columnNames.length!==r.queryBuilder.expressionMap.selects.length)throw new M(`cte.options.columnNames length (${r.options.columnNames.length}) doesn't match subquery select list length ${r.queryBuilder.expressionMap.selects.length} (CTE: ${r.alias})`);i+=`(${c.join(", ")})`}let s=r.options.recursive&&e?"RECURSIVE":"",a="";return this.connection.driver.cteCapabilities.materializedHint&&r.options.materialized!==void 0&&(a=r.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[s,i,"AS",a,`(${n})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){let t=this.expressionMap.mainAlias.metadata,r=(Array.isArray(e)?e:[e]).map(n=>t.ensureEntityIdMap(n));if(!t.hasMultiplePrimaryKeys){let n=t.primaryColumns[0];if(!n.transformer&&!n.relationMetadata&&!n.embeddedMetadata)return{[n.propertyName]:Md(r.map(i=>n.getEntityValue(i,!1)))}}return new lr(n=>{for(let i of r)n.orWhere(new lr(s=>s.where(i)))})}getExistsCondition(e){let t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias,r=[],n=e.split(".");for(;n.length>1;){let a=n[0];if(!t?.hasMetadata)break;if(t.metadata.hasEmbeddedWithPropertyPath(a)){n.unshift(`${n.shift()}.${n.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(a)){let c=this.expressionMap.joinAttributes.find(u=>u.relationPropertyPath===a);if(!c?.alias){let u=r.length>0?`${r.join(".")}.${a}`:a;throw new Error(`Cannot find alias for relation at ${u}`)}t=c.alias,r.push(...a.split(".")),n.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);let i=n.join("."),s=t.metadata.findColumnsWithPropertyPath(i);if(!s.length)throw new lt(e,t.metadata);return[t,r,s]}createPropertyPath(e,t,r=""){let n=[];for(let i of Object.keys(t)){let s=r?`${r}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||ue.isFindOperator(t[i])){n.push(s);continue}if(e.hasEmbeddedWithPropertyPath(s)){let a=this.createPropertyPath(e,t[i],s);n.push(...a);continue}if(e.hasRelationWithPropertyPath(s)){let a=e.findRelationWithPropertyPath(s);if(a.relationType==="one-to-one"||a.relationType==="many-to-one"){let h=a.joinColumns.map(d=>d.referencedColumn).filter(d=>!!d);if(h.length>0&&h.every(d=>d.getEntityValue(t[i],!1))){n.push(s);continue}}if(a.relationType==="one-to-many"||a.relationType==="many-to-many")throw new Error(`Cannot query across ${a.relationType} for property ${s}`);let c=a.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(h=>h.getEntityValue(t[i],!1))){let h=c.map(p=>`${s}.${p.propertyPath}`);n.push(...h);continue}let l=this.createPropertyPath(a.inverseEntityMetadata,t[i]).map(h=>`${s}.${h}`);n.push(...l);continue}n.push(s)}return n}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){let t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(let r of t){let[n,i,s]=this.findColumnsForPropertyPath(r);for(let a of s){let c=e;for(let h of i){if(!c||!(h in c)){c={};break}c=c[h]}let u=this.expressionMap.aliasNamePrefixingEnabled?`${n.name}.${a.propertyPath}`:a.propertyPath,l=a.getEntityValue(c,!0);yield[u,l]}}}else for(let t of Object.keys(e)){let r=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,r]}}getWherePredicateCondition(e,t){if(ue.isFindOperator(t)){let r=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(let n of t.value)r.push(this.createParameter(n));else r.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...r]};if(t.type==="and"){let n=t.value;return{operator:t.type,parameters:n.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else if(t.type==="or"){let n=t.value;return{operator:t.type,parameters:n.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else return{operator:t.type,parameters:[e,...r]}}else if(t===null){let r=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(r==="sql-null")return{operator:"isNull",parameters:[e]};if(r==="throw")throw new M(`Null value encountered in property '${e}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}else if(t===void 0&&(this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new M(`Undefined value encountered in property '${e}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(ue.isBrackets(e)){let n=this.createQueryBuilder();return n.parentQueryBuilder=this,n.expressionMap.mainAlias=this.expressionMap.mainAlias,n.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,n.expressionMap.parameters=this.expressionMap.parameters,n.expressionMap.nativeParameters=this.expressionMap.nativeParameters,n.expressionMap.wheres=[],e.whereFactory(n),{operator:ue.isNotBrackets(e)?"not":"brackets",condition:n.expressionMap.wheres}}if(typeof e=="function")return e(this);let t=Array.isArray(e)?e:[e],r=[];for(let n of t){let i=[];for(let[s,a]of this.getPredicates(n))i.push({type:"and",condition:this.getWherePredicateCondition(s,a)});r.push({type:"or",condition:i})}return r.length===1?r[0].condition:r}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}};Fe.queryBuilderRegistry={};var Si=class{static from(e){let t=new this;return t.raw=e.records,t.affected=e.affected,t}};var Mi=class extends Fe{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner(),n=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);let i=await r.query(e,t,!0),s=Si.from(i);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),n&&await r.commitTransaction(),s}catch(i){if(n)try{await r.rollbackTransaction()}catch{}throw i}finally{r!==this.queryRunner&&await r.release()}}from(e,t){e=ue.isEntitySchema(e)?e.options.name:e;let r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new Bt;return this.expressionMap.returning=e,this}createDeleteExpression(){let e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),r=this.createReturningExpression("delete");return r===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${r}${t}`:this.connection.driver.options.type==="spanner"?`DELETE FROM ${e}${t} THEN RETURN ${r}`:`DELETE FROM ${e}${t} RETURNING ${r}`}};var rt=[];for(let o=0;o<256;++o)rt.push((o+256).toString(16).slice(1));function Pd(o,e=0){return(rt[o[e+0]]+rt[o[e+1]]+rt[o[e+2]]+rt[o[e+3]]+"-"+rt[o[e+4]]+rt[o[e+5]]+"-"+rt[o[e+6]]+rt[o[e+7]]+"-"+rt[o[e+8]]+rt[o[e+9]]+"-"+rt[o[e+10]]+rt[o[e+11]]+rt[o[e+12]]+rt[o[e+13]]+rt[o[e+14]]+rt[o[e+15]]).toLowerCase()}var wu,Ab=new Uint8Array(16);function Nu(){if(!wu){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");wu=crypto.getRandomValues.bind(crypto)}return wu(Ab)}var xb=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Au={randomUUID:xb};function Cb(o,e,t){if(Au.randomUUID&&!e&&!o)return Au.randomUUID();o=o||{};let r=o.random??o.rng?.()??Nu();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let n=0;n<16;++n)e[t+n]=r[n];return e}return Pd(r)}var xu=Cb;var gt=class{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}};var gn=class{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){let t=new this;return t.raw=e.raw,t}};var hr=class{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){let r=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(n,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,u,l)=>(c[this.expressionMap.extraReturningColumns[l].databaseName]=u[0],c),{}));let s=Array.isArray(e.raw)?e.raw[i]:e.raw,a=this.queryRunner.connection.driver.createGeneratedMap(r,s);a&&(this.queryRunner.manager.merge(r.target,n,a),e.generatedMaps.push(a))}else{let s=this.expressionMap.extraReturningColumns;if(s.length>0){let a=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!a)throw new M("Cannot update entity because entity id is not set in the entity.");let c=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(u=>r.targetName+"."+u.propertyPath)).addSelect(s.map(u=>r.targetName+"."+u.propertyPath)).from(r.target,r.targetName).where(a).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(r.target,n,c),e.generatedMaps.push(c))}}}))}async insert(e,t){let r=this.expressionMap.mainAlias.metadata,n=r.getInsertionReturningColumns(),i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");n=n.filter(a=>a.isGenerated?i===!0:!0);let s=t.map((a,c)=>{Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(this.queryRunner.connection.driver.options.type==="oracle"?e.raw=e.raw.reduce((h,p,d)=>(h[this.expressionMap.extraReturningColumns[d].databaseName]=p[0],h),{}):this.queryRunner.connection.driver.options.type==="spanner"&&(e.raw=e.raw[0]));let u=Array.isArray(e.raw)?e.raw[c]:e.raw,l=this.queryRunner.connection.driver.createGeneratedMap(r,u,c,t.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(r.target,l,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(r.target,a,l),l});if(n.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){let a=t.map(u=>{let l=r.getEntityIdMap(u);if(!l)throw new M("Cannot update entity because entity id is not set in the entity.");return l}),c=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(u=>r.targetName+"."+u.propertyPath)).addSelect(n.map(u=>r.targetName+"."+u.propertyPath)).from(r.target,r.targetName).where(a).setOption("create-pojo").getMany();t.forEach((u,l)=>{this.queryRunner.manager.merge(r.target,s[l],c[l]),this.queryRunner.manager.merge(r.target,u,c[l])})}t.forEach((a,c)=>{let u=r.getEntityIdMap(a);e.identifiers.push(u),e.generatedMaps.push(s[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}};var vi=class extends Fe{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let e=this.getValueSets();if(e.length===0)return new gn;let t=this.obtainQueryRunner(),r=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),r=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){let m=new gt;e.forEach(f=>{t.broadcaster.broadcastBeforeInsertEvent(m,this.expressionMap.mainAlias.metadata,f)}),await m.wait()}let n=null,i=null,s=new hr(t,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(let m of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(m));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),a.push(...this.expressionMap.extraReturningColumns.filter(m=>!a.includes(m)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),i="SELECT * FROM @OutputTable");let[c,u]=this.getQueryAndParameters(),h=[n,c,i].filter(m=>m!=null).join(`;

`),p=await t.query(h,u,!0),d=gn.from(p);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.insert(d,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){let m=new gt;e.forEach(f=>{t.broadcaster.broadcastAfterInsertEvent(m,this.expressionMap.mainAlias.metadata,f)}),await m.wait()}return r&&await t.commitTransaction(),d}catch(n){if(r)try{await t.rollbackTransaction()}catch{}throw n}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=ue.isEntitySchema(e)?e.options.name:e;let r=this.createFromAlias(e);return this.expressionMap.setMainAlias(r),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new Bt;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,r){let{where:n,parameters:i}=r?.overwriteCondition??{},s;if(n){let a=this.getWhereCondition(n);(Array.isArray(a)?a.length!==0:a)&&(s=[{type:"simple",condition:a}])}return i&&this.setParameters(i),Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:r?.skipUpdateIfNoValuesChanged,indexPredicate:r?.indexPredicate,upsertType:r?.upsertType,overwriteCondition:s},this):(this.expressionMap.onUpdate={conflict:e?.conflict_target,columns:e?.columns,overwrite:e?.overwrite,skipUpdateIfNoValuesChanged:r?.skipUpdateIfNoValuesChanged,upsertType:r?.upsertType,overwriteCondition:s},this)}createInsertExpression(){if((this.expressionMap.onUpdate||this.expressionMap.onIgnore)&&(this.expressionMap.onUpdate?.upsertType??"merge-into")==="merge-into"&&this.connection.driver.supportedUpsertTypes.includes("merge-into"))return this.createMergeExpression();let e=this.getTableName(this.getMainTableName()),t=this.alias!==this.getMainTableName()?this.escape(this.alias):e,r=this.createValuesExpression(),n=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression(),s="INSERT ";if(this.expressionMap.onUpdate?.upsertType==="primary-key"&&(s="UPSERT "),(Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),s+=`INTO ${e}`,this.alias!==this.getMainTableName()&&Y.isPostgresFamily(this.connection.driver)&&(s+=` AS "${this.alias}"`),i?s+=`(${i})`:!r&&(Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+="()"),n&&this.connection.driver.options.type==="mssql"&&(s+=` OUTPUT ${n}`),r?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?s+=` ${r}`:s+=` VALUES ${r}`:Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?s+=" VALUES ()":s+=" DEFAULT VALUES",this.expressionMap.onUpdate?.upsertType!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)s+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)s+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){let{overwrite:a,columns:c,conflict:u,skipUpdateIfNoValuesChanged:l,indexPredicate:h}=this.expressionMap.onUpdate,p="ON CONFLICT";if(Array.isArray(u)){if(p+=` ( ${u.map(m=>this.escape(m)).join(", ")} )`,h&&!Y.isPostgresFamily(this.connection.driver))throw new M("indexPredicate option is not supported by the current database driver");h&&Y.isPostgresFamily(this.connection.driver)&&(p+=` WHERE ( ${h} )`)}else u&&(p+=` ON CONSTRAINT ${this.escape(u)}`);let d=[];if(Array.isArray(a)?d.push(...a.map(m=>`${this.escape(m)} = EXCLUDED.${this.escape(m)}`)):c&&d.push(...c.map(m=>`${this.escape(m)} = :${m}`)),d.length>0&&(s+=` ${p} DO UPDATE SET `,d.push(...this.expressionMap.mainAlias.metadata.columns.filter(m=>m.isUpdateDate&&!a?.includes(m.databaseName)&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||Y.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(m=>`${this.escape(m.databaseName)} = DEFAULT`)),s+=d.join(", ")),Array.isArray(a)&&l){this.expressionMap.onUpdate.overwriteCondition??=[];let m=a.map(f=>({type:"or",condition:`${t}.${this.escape(f)} IS DISTINCT FROM EXCLUDED.${this.escape(f)}`}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:m})}Y.isPostgresFamily(this.connection.driver)&&this.expressionMap.onUpdate.overwriteCondition&&this.expressionMap.onUpdate.overwriteCondition.length>0&&(s+=` WHERE ${this.createUpsertConditionExpression()}`)}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){let{overwrite:a,columns:c}=this.expressionMap.onUpdate;Array.isArray(a)?(s+=" ON DUPLICATE KEY UPDATE ",s+=a.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),s+=" "):Array.isArray(c)&&(s+=" ON DUPLICATE KEY UPDATE ",s+=c.map(u=>`${this.escape(u)} = :${u}`).join(", "),s+=" ")}}else if(this.expressionMap.onUpdate)throw new M("onUpdate is not supported by the current database driver")}return n&&(Y.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||Y.isMySQLFamily(this.connection.driver))&&(s+=` RETURNING ${n}`),n&&this.connection.driver.options.type==="spanner"&&(s+=` THEN RETURN ${n}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(a=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(a.propertyPath)!==-1:a.isInsert).some(a=>this.isOverridingAutoIncrementBehavior(a))&&(s=`SET IDENTITY_INSERT ${e} ON; ${s}; SET IDENTITY_INSERT ${e} OFF`),s}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!Y.isSQLiteFamily(this.connection.driver)&&!Y.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){let e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){let t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(r=>this.escape(r)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){let e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let r="";return e.forEach((n,i)=>{t.forEach((s,a)=>{a===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?r+=" SELECT ":r+="("),r+=this.createColumnValueExpression(e,i,s),a===t.length-1?i===e.length-1?["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?r+=" FROM "+this.connection.driver.dummyTableName:r+=")":["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?r+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":r+="), ":r+=", "})}),r==="()"?"":r}else{let r="";return e.forEach((n,i)=>{Object.keys(n).forEach((a,c)=>{c===0&&(r+="(");let u=n[a];typeof u=="function"?r+=u():u===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||Y.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r+="NULL":r+="DEFAULT":u===null&&this.connection.driver.options.type==="spanner"||(r+=this.createParameter(u)),c===Object.keys(n).length-1?i===e.length-1?r+=")":r+="), ":r+=", "})}),r==="()"?"":r}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(ae.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new Ss}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}createMergeExpression(){if(!this.connection.driver.supportedUpsertTypes.includes("merge-into"))throw new M('Upsert type "merge-into" is not supported by current database driver');if(this.expressionMap.onUpdate?.upsertType&&this.expressionMap.onUpdate.upsertType!=="merge-into")throw new M(`Upsert type "${this.expressionMap.onUpdate.upsertType}" is not supported by current database driver`);let e=this.getTableName(this.getMainTableName()),t=this.escape(this.alias),r=this.getInsertedColumns(),n=this.createColumnNamesExpression(),i=`MERGE INTO ${e} ${this.escape(this.alias)}`,s=this.escape("mergeIntoSource"),a=this.createMergeIntoSourceExpression(s);if(i+=` ${a}`,this.expressionMap.onIgnore){let l=r.find(h=>h.isPrimary);l?i+=` ON (${t}.${this.escape(l.databaseName)} = ${s}.${this.escape(l.databaseName)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(h=>`(${h.columns.map(p=>`${t}.${this.escape(p.databaseName)} = ${s}.${this.escape(p.databaseName)}`).join(" AND ")})`).join(" OR ")})`}else if(this.expressionMap.onUpdate){let{conflict:l,indexPredicate:h}=this.expressionMap.onUpdate;if(h)throw new M('indexPredicate option is not supported by upsert type "merge-into"');Array.isArray(l)?i+=` ON (${l.map(p=>`${t}.${this.escape(p)} = ${s}.${this.escape(p)}`).join(" AND ")})`:l?i+=` ON (${t}.${this.escape(l)} = ${s}.${this.escape(l)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(p=>`(${p.columns.map(d=>`${t}.${this.escape(d.databaseName)} = ${s}.${this.escape(d.databaseName)}`).join(" AND ")})`).join(" OR ")})`}if(this.expressionMap.onUpdate){let{overwrite:l,columns:h,conflict:p,skipUpdateIfNoValuesChanged:d}=this.expressionMap.onUpdate,m="";if(Array.isArray(l)&&(m+=(l||h)?.filter(A=>!p?.includes(A)).map(A=>`${t}.${this.escape(A)} = ${s}.${this.escape(A)}`).join(", ")),Array.isArray(l)&&d){this.expressionMap.onUpdate.overwriteCondition??=[];let A=l.map(R=>({type:"or",condition:{operator:"notEqual",parameters:[`${t}.${this.escape(R)}`,`${s}.${this.escape(R)}`]}}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:A})}let f=this.createUpsertConditionExpression();m.trim()&&((this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap")&&f!=""?i+=` WHEN MATCHED AND ${f} THEN UPDATE SET ${m}`:(i+=` WHEN MATCHED THEN UPDATE SET ${m}`,f!=""&&(i+=` WHERE ${f}`)))}let c=this.createMergeIntoInsertValuesExpression(s),u=this.connection.driver.options.type==="mssql"?this.createReturningExpression("insert"):null;return i+=" WHEN NOT MATCHED THEN INSERT",n&&(i+=`(${n})`),c&&(i+=` VALUES ${c}`),u&&this.connection.driver.options.type==="mssql"&&(i+=` OUTPUT ${u}`),this.connection.driver.options.type==="mssql"&&(i+=";"),i}createMergeIntoSourceExpression(e){let t=this.getValueSets(),r=this.getInsertedColumns(),n="USING (";if(r.length>0)this.connection.driver.options.type==="mssql"&&(n+="VALUES "),t.forEach((i,s)=>{r.forEach((a,c)=>{c===0&&(this.connection.driver.options.type==="mssql"?n+="(":n+="SELECT ");let u=a.getEntityValue(i);u===void 0&&!(a.isGenerated&&a.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported())?a.default!==void 0&&a.default!==null?n+=this.connection.driver.normalizeDefault(a):n+="NULL":u===null?n+="NULL":n+=this.createColumnValueExpression(t,s,a),this.connection.driver.options.type!=="mssql"&&(n+=` AS ${this.escape(a.databaseName)}`),c===r.length-1?s===t.length-1?["oracle","sap"].includes(this.connection.driver.options.type)?n+=" FROM "+this.connection.driver.dummyTableName:this.connection.driver.options.type==="mssql"&&(n+=")"):["oracle","sap"].includes(this.connection.driver.options.type)&&t.length>1?n+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":this.connection.driver.options.type==="mssql"?n+="), ":n+=" UNION ALL ":n+=", "})});else throw new M('Upsert type "merge-into" is not supported without metadata tables');return n+=`) ${e}`,this.connection.driver.options.type==="mssql"&&(n+=` (${r.map(i=>this.escape(i.databaseName)).join(", ")})`),n}createMergeIntoInsertValuesExpression(e){let t=this.getInsertedColumns(),r="";if(t.length>0)t.forEach((n,i)=>{i===0&&(r+="("),n.isGenerated&&n.generationStrategy==="uuid"&&this.connection.driver.isUUIDGenerationSupported()||n.isGenerated&&n.generationStrategy!=="uuid"?r+="DEFAULT":r+=`${e}.${this.escape(n.databaseName)}`,i===t.length-1?r+=")":r+=", "});else throw new M('Upsert type "merge-into" is not supported without metadata tables');return r==="()"?"":r}createUpsertConditionExpression(){if(!this.expressionMap.onUpdate.overwriteCondition)return"";let e=[],t=this.createWhereClausesExpression(this.expressionMap.onUpdate.overwriteCondition);if(t.length>0&&t!=="1=1"&&e.push(t),this.expressionMap.mainAlias.hasMetadata){let n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&n.deleteDateColumn){let s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.deleteDateColumn.propertyName:n.deleteDateColumn.propertyName} IS NULL`;e.push(s)}if(n.discriminatorColumn&&n.parentEntityMetadata){let s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.discriminatorColumn.databaseName:n.discriminatorColumn.databaseName} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){let n=this.expressionMap.extraAppendedAndWhereCondition;e.push(n)}let r="";return e.length?e.length===1?r+=`${e[0]}`:r+=`( ${e.join(" ) AND ( ")} )`:r+="",r}createColumnValueExpression(e,t,r){let n=e[t],i="",s=r.getEntityValue(n);if(typeof s!="function"&&(s=this.connection.driver.preparePersistentValue(s,r)),r.isVersion&&s===void 0)i+="1";else if(r.isDiscriminator)i+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(r.isGenerated&&r.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&s===void 0)s=xu(),i+=this.createParameter(s),t in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[t]={}),r.setEntityValue(this.expressionMap.locallyGenerated[t],s);else if(s===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||Y.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r.default!==void 0&&r.default!==null?i+=this.connection.driver.normalizeDefault(r):this.connection.driver.options.type==="spanner"&&r.isGenerated&&r.generationStrategy==="uuid"?i+="GENERATE_UUID()":i+="NULL":i+="DEFAULT";else if(s===null&&(this.connection.driver.options.type==="spanner"||this.connection.driver.options.type==="oracle"))i+="NULL";else if(typeof s=="function")i+=s();else{this.connection.driver.options.type==="mssql"&&(s=this.connection.driver.parametrizeValue(r,s));let a=this.createParameter(s);if((Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.includes(r.type)){let u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";r.srid!=null?i+=`${u}(${a}, ${r.srid})`:i+=`${u}(${a})`}else Y.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.includes(r.type)?r.srid!=null?i+=`ST_SetSRID(ST_GeomFromGeoJSON(${a}), ${r.srid})::${r.type}`:i+=`ST_GeomFromGeoJSON(${a})::${r.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.includes(r.type)?i+=r.type+"::STGeomFromText("+a+", "+(r.srid||"0")+")":i+=a}return i}};var Pi=class{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){let t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){let r=t.joinColumns.reduce((n,i)=>{let s=ae.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(n,s),n},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(r).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){let r={};t.inverseRelation.joinColumns.forEach(c=>{r[c.propertyName]=null});let n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},s=[];n.forEach((c,u)=>{t.inverseRelation.joinColumns.map((l,h)=>{let p="joinColumn_"+u+"_"+h;i[p]=ae.isObject(c)?l.referencedColumn.getEntityValue(c):c,s.push(`${l.propertyPath} = :${p}`)})});let a=s.map(c=>"("+c+")").join(" OR ");if(!a)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).where(a).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new M("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");let r=this.expressionMap.of,n=t.inverseRelation.joinColumns.reduce((i,s)=>{let a=ae.isObject(r)?s.referencedColumn.getEntityValue(r):r;return s.setEntityValue(i,a),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).whereInIds(e).execute()}else{let r=t.junctionEntityMetadata,n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?n:i,a=t.isManyToManyOwner?i:n,c=[];if(s.forEach(u=>{a.forEach(l=>{let h={};r.ownerColumns.forEach(p=>{h[p.databaseName]=ae.isObject(u)?p.referencedColumn.getEntityValue(u):u}),r.inverseColumns.forEach(p=>{h[p.databaseName]=ae.isObject(l)?p.referencedColumn.getEntityValue(l):l}),c.push(h)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(u=>this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(u).execute())):await this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(c).execute()}}};var Ys=class{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){let t=this.expressionMap.relationMetadata;if(t.isOneToMany){let r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],n=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(u=>{i[u.propertyName]=null});let s={},a=[];r.forEach((u,l)=>{a.push(...n.map((h,p)=>[...t.inverseRelation.joinColumns.map((d,m)=>{let f="joinColumn_"+l+"_"+p+"_"+m;return s[f]=ae.isObject(u)?d.referencedColumn.getEntityValue(u):u,`${d.propertyPath} = :${f}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((d,m)=>{let f="primaryColumn_"+p+"_"+p+"_"+m;return s[f]=ae.isObject(h)?d.getEntityValue(h):h,`${d.propertyPath} = :${f}`})].join(" AND ")))});let c=a.map(u=>"("+u+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(c).setParameters(s).execute()}else{let r=t.junctionEntityMetadata,n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?n:i,a=t.isManyToManyOwner?i:n,c={},u=[];s.forEach((h,p)=>{u.push(...a.map((d,m)=>[...r.ownerColumns.map((f,A)=>{let R="firstValue_"+p+"_"+m+"_"+A;return c[R]=ae.isObject(h)?f.referencedColumn.getEntityValue(h):h,`${f.databaseName} = :${R}`}),...r.inverseColumns.map((f,A)=>{let R="secondValue_"+p+"_"+m+"_"+A;return c[R]=ae.isObject(d)?f.referencedColumn.getEntityValue(d):d,`${f.databaseName} = :${R}`})].join(" AND ")))});let l=u.map(h=>"("+h+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(r.tableName).where(l).setParameters(c).execute()}}};var Oi=class extends Fe{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){let t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new M("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new M(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!ae.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new M('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Pi(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;let t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new M("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new M(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!ae.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new M('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new Pi(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;let t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new M("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new M(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new Ys(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!ae.isObject(e)){let t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new M("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}};var ye=class o{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(r,n)=>e.slice(n*t,n*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((r,n)=>{let i=t(n),s=r.find(a=>a.id===i);return s||(s={id:i,items:[]},r.push(s)),s.items.push(n),r},[])}static uniq(e,t){return e.reduce((r,n)=>{let i=!1;if(typeof t=="function"){let s=t(n);i=!!r.find(a=>t(a)===s)}else typeof t=="string"?i=!!r.find(s=>s[t]===n[t]):i=r.indexOf(n)!==-1;return i||r.push(n),r},[])}static mergeDeep(e,...t){if(!t.length)return e;for(let r of t)o.merge(e,r);return e}static cloneObject(e){return e==null?e:Object.assign(Object.create(Object.getPrototypeOf(e)),e)}static deepCompare(...e){let t,r,n,i;if(e.length<1)return!0;for(t=1,r=e.length;t<r;t++)if(n=[],i=[],!o.compare2Objects(n,i,e[0],e[t]))return!1;return!0}static deepValue(e,t){let r=t.split(".");for(let n=0,i=r.length;n<i;n++)e=e[r[n]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:o.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let r of e){let n=r.split(".");if(!n.length)continue;(!t[n[0]]||t[n[0]]===!0)&&(t[n[0]]={});let i=t[n[0]];for(let[s,a]of n.entries())s!==0&&(i[a]?i=i[a]:s===n.length-1?(i[a]={},i=null):(i[a]={},i=i[a]))}return o.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:o.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(r=>t.includes(r))}static areMutuallyExclusive(...e){return!e.some(r=>{let n=e.filter(i=>i!==r);return r.some(i=>n.some(s=>s.includes(i)))})}static parseSqlCheckExpression(e,t){let r=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(r&&r.index){let i=e.substring(r.index+r[0].length),s="",a="",c=[];for(let u=0;u<i.length;u++){let l=i[u];switch(l){case",":s==""?(c.push(a),a=""):a+=l;break;case"'":s==l?i[u+1]===l?(a+=l,u+=1):s="":s=l;break;case")":if(s=="")return c.push(a),c;a+=l;break;default:s!=""&&(a+=l)}}}}static isCriteriaNullOrEmpty(e){return e==null||e===""||Array.isArray(e)&&e.length===0||o.isPlainObject(e)&&Object.keys(e).length===0}static isSinglePrimitiveCriteria(e){return typeof e=="string"||typeof e=="number"||e instanceof Date}static isPrimitiveCriteria(e){return Array.isArray(e)?e.every(t=>o.isSinglePrimitiveCriteria(t)):o.isSinglePrimitiveCriteria(e)}static compare2Objects(e,t,r,n){let i;if(Number.isNaN(r)&&Number.isNaN(n)||r===n)return!0;if(r===null||n===null||r===void 0||n===void 0)return!1;if((typeof r.equals=="function"||typeof r.equals=="function")&&r.equals(n))return!0;if(typeof r=="function"&&typeof n=="function"||r instanceof Date&&n instanceof Date||r instanceof RegExp&&n instanceof RegExp||typeof r=="string"&&typeof n=="string"||typeof r=="number"&&typeof n=="number")return r.toString()===n.toString();if(!(typeof r=="object"&&typeof n=="object")||Object.prototype.isPrototypeOf.call(r,n)||Object.prototype.isPrototypeOf.call(n,r)||r.constructor!==n.constructor||r.prototype!==n.prototype||e.indexOf(r)>-1||t.indexOf(n)>-1)return!1;for(i in n){if(n.hasOwnProperty(i)!==r.hasOwnProperty(i))return!1;if(typeof n[i]!=typeof r[i])return!1}for(i in r){if(n.hasOwnProperty(i)!==r.hasOwnProperty(i))return!1;if(typeof n[i]!=typeof r[i])return!1;switch(typeof r[i]){case"object":case"function":if(e.push(r),t.push(n),!o.compare2Objects(e,t,r[i],n[i]))return!1;e.pop(),t.pop();break;default:if(r[i]!==n[i])return!1;break}}return!0}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,r,n){if(n.has(r)){e[t]=n.get(r);return}if(!(r instanceof Promise)){if(!o.isPlainObject(r)&&!Array.isArray(r)){e[t]=r;return}e[t]||(e[t]=Array.isArray(r)?[]:{}),n.set(r,e[t]),o.merge(e[t],r,n),n.delete(r)}}static mergeObjectKey(e,t,r,n){if(n.has(r)){Object.assign(e,{[t]:n.get(r)});return}if(!(r instanceof Promise)){if(!o.isPlainObject(r)&&!Array.isArray(r)){Object.assign(e,{[t]:r});return}e[t]||Object.assign(e,{[t]:Array.isArray(r)?[]:{}}),n.set(r,e[t]),o.merge(e[t],r,n),n.delete(r)}}static merge(e,t,r=new Map){if(o.isPlainObject(e)&&o.isPlainObject(t))for(let[n,i]of Object.entries(t))n!=="__proto__"&&o.mergeObjectKey(e,n,i,r);if(Array.isArray(e)&&Array.isArray(t))for(let n=0;n<t.length;n++)o.mergeArrayKey(e,n,t[n],r)}};var Xs=class{constructor(e,t,r,n,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=r,this.rawRelationCountResults=n,this.queryRunner=i,this.pojo=this.expressionMap.options.includes("create-pojo"),this.selections=new Set(this.expressionMap.selects.map(s=>s.selection)),this.aliasCache=new Map,this.columnsCache=new Map}transform(e,t){let r=this.group(e,t),n=[];for(let i of r.values()){let s=this.transformRawResultsGroup(i,t);s!==void 0&&n.push(s)}return n}buildAlias(e,t){let r=this.aliasCache.get(e);r||(r=new Map,this.aliasCache.set(e,r));let n=r.get(t);return n||(n=Y.buildAlias(this.driver,void 0,e,t),r.set(t,n)),n}group(e,t){let r=new Map,n=[];t.metadata.tableType==="view"?n.push(...t.metadata.columns.map(i=>this.buildAlias(t.name,i.databaseName))):n.push(...t.metadata.primaryColumns.map(i=>this.buildAlias(t.name,i.databaseName)));for(let i of e){let s=n.map(c=>{let u=i[c];return Buffer.isBuffer(u)?u.toString("hex"):ae.isObject(u)?JSON.stringify(u):u}).join("_"),a=r.get(s);a?a.push(i):r.set(s,[i])}return r}transformRawResultsGroup(e,t){let r=t.metadata;if(r.discriminatorColumn){let l=e.map(p=>p[this.buildAlias(t.name,t.metadata.discriminatorColumn.databaseName)]),h=r.childEntityMetadatas.find(p=>typeof l.find(d=>d===p.discriminatorValue)<"u");h&&(r=h)}let n=r.create(this.queryRunner,{fromDeserializer:!0,pojo:this.pojo}),i=this.transformColumns(e,t,n,r),s=this.transformJoins(e,n,t,r),a=this.transformRelationIds(e,t,n,r),c=this.transformRelationCounts(e,t,n);if(i||r.primaryColumns.every(l=>l.isVirtual===!0)&&(s||a||c))return n}transformColumns(e,t,r,n){let i=!1,s=e[0];for(let[a,c]of this.getColumnsToProcess(t.name,n)){let u=s[a];u!==void 0&&(u!==null&&!c.isVirtualProperty&&(i=!0),c.setEntityValue(r,this.driver.prepareHydratedValue(u,c)))}return i}transformJoins(e,t,r,n){let i=!1;for(let s of this.expressionMap.joinAttributes){if(!s.metadata||!s.isSelected||s.relation&&!n.relations.find(c=>c===s.relation))continue;if(s.mapToProperty){if(s.mapToPropertyParentAlias!==r.name)continue}else if(!s.relation||s.parentAlias!==r.name||s.relationPropertyPath!==s.relation.propertyPath)continue;let a=this.transform(e,s.alias);a=s.isMany?a:a[0],a=!s.isMany&&a===void 0?null:a,a!==void 0&&(s.mapToPropertyPropertyName?t[s.mapToPropertyPropertyName]=a:s.relation.setEntityValue(t,a),i=!0)}return i}transformRelationIds(e,t,r,n){let i=!1;for(let[s,a]of this.rawRelationIdResults.entries()){if(a.relationIdAttribute.parentAlias!==t.name)continue;let c=a.relationIdAttribute.relation,u=this.createValueMapFromJoinColumns(c,a.relationIdAttribute.parentAlias,e);if(u==null)continue;this.prepareDataForTransformRelationIds();let l=this.hashEntityIds(c,u),h=this.relationIdMaps[s][l]||[],p=a.relationIdAttribute.mapToPropertyPropertyPath.split("."),d=(m,f,A)=>{let R=m.shift();if(R&&m.length===0)return f[R]=A,f;if(R&&m.length>0)d(m,f[R],A);else return f};c.isOneToOne||c.isManyToOne?h[0]!==void 0&&(d(p,r,h[0]),i=!0):(d(p,r,h),i=i||h.length>0)}return i}transformRelationCounts(e,t,r){let n=!1;for(let i of this.rawRelationCountResults){if(i.relationCountAttribute.parentAlias!==t.name)continue;let s=i.relationCountAttribute.relation,a;s.isOneToMany?a=s.inverseRelation.joinColumns[0].referencedColumn.databaseName:a=s.isOwning?s.joinColumns[0].referencedColumn.databaseName:s.inverseRelation.joinColumns[0].referencedColumn.databaseName;let c=e[0][this.buildAlias(t.name,a)];if(c!=null){r[i.relationCountAttribute.mapToPropertyPropertyName]=0;for(let u of i.results)u.parentId===c&&(r[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(u.cnt),n=!0)}}return n}getColumnsToProcess(e,t){let r=this.columnsCache.get(e);r||(r=new Map,this.columnsCache.set(e,r));let n=r.get(t);return n||(n=t.columns.filter(i=>!i.isVirtual&&(this.selections.has(e)||this.selections.has(`${e}.${i.propertyPath}`))&&!t.childEntityMetadatas.some(s=>s.target===i.target)).map(i=>[this.buildAlias(e,i.databaseName),i]),r.set(t,n)),n}createValueMapFromJoinColumns(e,t,r){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?n=e.joinColumns.map(i=>i):n=e.inverseRelation.inverseJoinColumns.map(i=>i),n.reduce((i,s)=>{for(let a of r)e.isManyToOne||e.isOneToOneOwner?i[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.databaseName)],s):i[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.referencedColumn.databaseName)],s.referencedColumn);return i},{})}extractEntityPrimaryIds(e,t){let r;return e.isManyToOne||e.isOneToOneOwner?r=e.entityMetadata.primaryColumns.map(n=>n):e.isOneToMany||e.isOneToOneNotOwner?r=e.inverseRelation.joinColumns.map(n=>n):e.isOwning?r=e.joinColumns.map(n=>n):r=e.inverseRelation.inverseJoinColumns.map(n=>n),r.reduce((n,i)=>(n[i.databaseName]=t[i.databaseName],n),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{let t=e.relationIdAttribute.relation,r;return t.isManyToOne||t.isOneToOneOwner?r=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?r=t.inverseEntityMetadata.primaryColumns:t.isOwning?r=t.inverseJoinColumns:r=t.inverseRelation.joinColumns,e.results.reduce((n,i)=>{let s=r.reduce((a,c)=>{let u=i[c.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(u=c.referencedColumn.createValueMap(u)),ye.mergeDeep(a,c.createValueMap(u))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(u=c.referencedColumn.referencedColumn.createValueMap(u)),ye.mergeDeep(a,c.referencedColumn.createValueMap(u)))},{});if(r.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?s=r[0].getEntityValue(s):s=r[0].referencedColumn.getEntityValue(s)),s!==void 0){let a=this.hashEntityIds(t,i);n[a]?n[a].push(s):n[a]=[s]}return n},{})}))}hashEntityIds(e,t){let r=this.extractEntityPrimaryIds(e,t);return JSON.stringify(r)}};var Zs=class{constructor(e,t,r){this.connection=e,this.queryRunner=t,this.relationIdAttributes=r}async load(e){let t=this.relationIdAttributes.map(async r=>{if(r.relation.isManyToOne||r.relation.isOneToOneOwner){if(r.queryBuilderFactory)throw new M("Additional condition can not be used with ManyToOne or OneToOne owner relations.");let n={},i=e.map(s=>{let a={},c=[];r.relation.joinColumns.forEach(l=>{a[l.databaseName]=this.connection.driver.prepareHydratedValue(s[Y.buildAlias(this.connection.driver,void 0,r.parentAlias,l.databaseName)],l.referencedColumn);let h=`${l.databaseName}:${a[l.databaseName]}`;c.indexOf(h)===-1&&c.push(h)}),r.relation.entityMetadata.primaryColumns.forEach(l=>{a[l.databaseName]=this.connection.driver.prepareHydratedValue(s[Y.buildAlias(this.connection.driver,void 0,r.parentAlias,l.databaseName)],l);let h=`${l.databaseName}:${a[l.databaseName]}`;c.indexOf(h)===-1&&c.push(h)}),c.sort();let u=c.join("::");return n[u]?null:(n[u]=!0,a)}).filter(s=>s);return{relationIdAttribute:r,results:i}}else if(r.relation.isOneToMany||r.relation.isOneToOneNotOwner){let n=r.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.joinColumns,s=n.inverseEntityMetadata.target,a=n.inverseEntityMetadata.tableName,c=r.alias||a,u={},l={},h=e.map((f,A)=>{let R=[],I={},C=i.map(J=>{let ne=J.databaseName+A,oe=f[Y.buildAlias(this.connection.driver,void 0,r.parentAlias,J.referencedColumn.databaseName)],z=`${c}:${J.propertyPath}:${oe}`;return R.indexOf(z)!==-1?"":(R.push(z),I[ne]=oe,c+"."+J.propertyPath+" = :"+ne)}).filter(J=>J).join(" AND ");R.sort();let U=R.join("::");return u[U]?"":(u[U]=!0,Object.assign(l,I),C)}).filter(f=>f).map(f=>"("+f+")").join(" OR ");if(!h)return{relationIdAttribute:r,results:[]};let p=this.connection.createQueryBuilder(this.queryRunner);ye.uniq([...i,...n.inverseRelation.entityMetadata.primaryColumns],f=>f.propertyPath).forEach(f=>{p.addSelect(c+"."+f.propertyPath,f.databaseName)}),p.from(s,c).where("("+h+")").setParameters(l),r.queryBuilderFactory&&r.queryBuilderFactory(p);let m=await p.getRawMany();return m.forEach(f=>{i.forEach(A=>{f[A.databaseName]=this.connection.driver.prepareHydratedValue(f[A.databaseName],A.referencedColumn)}),n.inverseRelation.entityMetadata.primaryColumns.forEach(A=>{f[A.databaseName]=this.connection.driver.prepareHydratedValue(f[A.databaseName],A)})}),{relationIdAttribute:r,results:m}}else{let n=r.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.inverseJoinColumns,s=n.isOwning?n.inverseJoinColumns:n.inverseRelation.joinColumns,a=r.junctionAlias,c=r.joinInverseSideMetadata.tableName,u=r.alias||c,l=n.isOwning?n.junctionEntityMetadata.tableName:n.inverseRelation.junctionEntityMetadata.tableName,h=e.map(C=>i.reduce((U,J)=>(U[J.propertyPath]=C[Y.buildAlias(this.connection.driver,void 0,r.parentAlias,J.referencedColumn.databaseName)],U),{}));if(h.length===0)return{relationIdAttribute:r,results:[]};let p={},d={},m=h.map((C,U)=>{let J=[],ne={},oe=Object.keys(C).map(O=>{let he=O+U,S=C[O],$=`${a}:${O}:${S}`;return J.indexOf($)!==-1?"":(J.push($),ne[he]=S,a+"."+O+" = :"+he)}).filter(O=>O).join(" AND ");J.sort();let z=J.join("::");return d[z]?"":(d[z]=!0,Object.assign(p,ne),oe)}).filter(C=>C),f=s.map(C=>a+"."+C.propertyPath+" = "+u+"."+C.referencedColumn.propertyPath).join(" AND "),A=m.map(C=>"("+C+" AND "+f+")").join(" OR "),R=this.connection.createQueryBuilder(this.queryRunner);s.forEach(C=>{R.addSelect(a+"."+C.propertyPath,C.databaseName).addOrderBy(a+"."+C.propertyPath)}),i.forEach(C=>{R.addSelect(a+"."+C.propertyPath,C.databaseName).addOrderBy(a+"."+C.propertyPath)}),R.from(c,u).innerJoin(l,a,A).setParameters(p),r.queryBuilderFactory&&r.queryBuilderFactory(R);let I=await R.getRawMany();return I.forEach(C=>{[...i,...s].forEach(U=>{C[U.databaseName]=this.connection.driver.prepareHydratedValue(C[U.databaseName],U.referencedColumn)})}),{relationIdAttribute:r,results:I}}});return Promise.all(t)}};var Ii=class{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,r){let n=Array.isArray(t)?t:[t],i=Array.isArray(r)?r:r?[r]:void 0;return e.isManyToMany?this.loadForManyToMany(e,n,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,n,i):this.loadForOneToManyAndOneToOneNotOwner(e,n,i)}async loadManyToManyRelationIdsAndGroup(e,t,r,n){let i=e.isManyToMany||e.isOneToMany,s=Array.isArray(t)?t:[t];if(!r&&(r=await this.connection.relationLoader.load(e,t,this.queryRunner,n),!r.length))return s.map(h=>({entity:h,related:i?[]:void 0}));let a=await this.load(e,t,r),c=Array.isArray(r)?r:[r],u=[],l=[];return e.isManyToManyOwner?(u=e.junctionEntityMetadata.inverseColumns.map(h=>h.referencedColumn),l=e.junctionEntityMetadata.ownerColumns.map(h=>h.referencedColumn)):e.isManyToManyNotOwner?(u=e.junctionEntityMetadata.ownerColumns.map(h=>h.referencedColumn),l=e.junctionEntityMetadata.inverseColumns.map(h=>h.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(u=e.joinColumns.map(h=>h.referencedColumn),l=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(u=e.inverseRelation.entityMetadata.primaryColumns,l=e.inverseRelation.joinColumns.map(h=>h.referencedColumn)),s.map(h=>{let p={entity:h,related:i?[]:void 0},d=a.filter(m=>l.every(f=>f.compareEntityValue(h,m[f.entityMetadata.name+"_"+f.propertyAliasName])));return d.length&&c.forEach(m=>{d.forEach(f=>{u.every(R=>R.compareEntityValue(m,f[Y.buildAlias(this.connection.driver,void 0,R.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+R.propertyPath.replace(".","_"))]))&&(i?p.related.push(m):p.related=m)})}),p})}loadForManyToMany(e,t,r){let n=e.junctionEntityMetadata,i=n.name,s=e.isOwning?n.ownerColumns:n.inverseColumns,a=e.isOwning?n.inverseColumns:n.ownerColumns,c=this.connection.createQueryBuilder(this.queryRunner);s.forEach(p=>{let d=Y.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+p.propertyPath,d)}),a.forEach(p=>{let d=Y.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+p.propertyPath,d)});let u="";if(s.length===1){let p=t.map(m=>s[0].referencedColumn.getEntityValue(m));p.every(m=>typeof m=="number")?u=`${i}.${s[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values1",p),u=i+"."+s[0].propertyPath+" IN (:...values1)")}else u="("+t.map((p,d)=>s.map(m=>{let f="entity1_"+d+"_"+m.propertyName;return c.setParameter(f,m.referencedColumn.getEntityValue(p)),i+"."+m.propertyPath+" = :"+f}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";let l="";if(r)if(a.length===1){let p=r.map(m=>a[0].referencedColumn.getEntityValue(m));p.every(m=>typeof m=="number")?l=`${i}.${a[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values2",p),l=i+"."+a[0].propertyPath+" IN (:...values2)")}else l="("+r.map((p,d)=>a.map(m=>{let f="entity2_"+d+"_"+m.propertyName;return c.setParameter(f,m.referencedColumn.getEntityValue(p)),i+"."+m.propertyPath+" = :"+f}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";let h=[u,l].filter(p=>p.length>0).join(" AND ");return c.from(n.target,i).where(h).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,r){let n=e.entityMetadata.targetName,i=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(u=>u===c));if(r&&i){let c=[];if(t.forEach(u=>{let l={};e.entityMetadata.primaryColumns.forEach(h=>{let p=h.entityMetadata.name+"_"+h.propertyPath.replace(".","_");l[p]=h.getEntityValue(u)}),r.forEach(h=>{e.joinColumns.forEach(p=>{let d=p.getEntityValue(u),m=p.referencedColumn.getEntityValue(h);if(!(d===void 0||m===void 0)&&d===m){let f=p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_");l[f]=m}})}),Object.keys(l).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(l)}),c.length===t.length)return Promise.resolve(c)}let s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{let u=Y.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));s.addSelect(n+"."+c.propertyPath,u)}),e.joinColumns.forEach(c=>{let u=Y.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));s.addSelect(n+"."+c.propertyPath,u)});let a="";if(e.entityMetadata.primaryColumns.length===1){let c=t.map(l=>e.entityMetadata.primaryColumns[0].getEntityValue(l));c.every(l=>typeof l=="number")?a=`${n}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(s.setParameter("values",c),a=n+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else a=t.map((c,u)=>e.entityMetadata.primaryColumns.map((l,h)=>{let p="entity"+u+"_"+h;return s.setParameter(p,l.getEntityValue(c)),n+"."+l.propertyPath+" = :"+p}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return s.from(e.entityMetadata.target,n).where(a).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,r){let n=e;if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(u=>e.joinColumns.indexOf(u)!==-1))return Promise.resolve(t.map(u=>{let l={};return e.joinColumns.forEach(function(h){let p=h.referencedColumn.getEntityValue(u),d=h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"),m=h.entityMetadata.name+"_"+n.propertyPath.replace(".","_")+"_"+h.propertyPath.replace(".","_");l[d]=p,l[m]=p}),l}));let i=e.entityMetadata.targetName,s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{let u=Y.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+n.propertyPath.replace(".","_")+"_"+c.propertyPath.replace(".","_"));s.addSelect(i+"."+c.propertyPath,u)}),e.joinColumns.forEach(c=>{let u=Y.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+c.referencedColumn.propertyPath.replace(".","_"));s.addSelect(i+"."+c.propertyPath,u)});let a="";if(e.joinColumns.length===1){let c=t.map(l=>e.joinColumns[0].referencedColumn.getEntityValue(l));c.every(l=>typeof l=="number")?a=`${i}.${e.joinColumns[0].propertyPath} IN (${c.join(", ")})`:(s.setParameter("values",c),a=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else a=t.map((c,u)=>e.joinColumns.map((l,h)=>{let p="entity"+u+"_"+h;return s.setParameter(p,l.referencedColumn.getEntityValue(c)),i+"."+l.propertyPath+" = :"+p}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return s.from(e.entityMetadata.target,i).where(a).getRawMany()}};var ea=class{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{let t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{let r=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(r)})})}metadataToAttribute(e,t){return new cr(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}};var ta=class{constructor(e,t,r){this.connection=e,this.queryRunner=t,this.relationCountAttributes=r}async load(e){let t=(n,i,s)=>s.indexOf(n)===i,r=this.relationCountAttributes.map(async n=>{if(n.relation.isOneToMany){let i=n.relation,s=i.inverseRelation,a=s.joinColumns[0].referencedColumn.propertyName,c=i.inverseEntityMetadata.target,u=i.inverseEntityMetadata.tableName,l=n.alias||u,h=s.propertyName,p=e.map(m=>m[n.parentAlias+"_"+a]).filter(m=>!!m);if(p=p.filter(t),p.length===0)return{relationCountAttribute:n,results:[]};let d=this.connection.createQueryBuilder(this.queryRunner);return d.select(l+"."+h,"parentId").addSelect("COUNT(*)","cnt").from(c,l).where(l+"."+h+" IN (:...ids)").addGroupBy(l+"."+h).setParameter("ids",p),n.queryBuilderFactory&&n.queryBuilderFactory(d),{relationCountAttribute:n,results:await d.getRawMany()}}else{let i,s,a,c;n.relation.isOwning?(i=n.relation.joinColumns[0].referencedColumn.databaseName,s=n.relation.inverseJoinColumns[0].referencedColumn.databaseName,a=n.relation.junctionEntityMetadata.columns[0],c=n.relation.junctionEntityMetadata.columns[1]):(i=n.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,s=n.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,a=n.relation.junctionEntityMetadata.columns[1],c=n.relation.junctionEntityMetadata.columns[0]);let u=e.map(A=>A[n.parentAlias+"_"+i]).filter(A=>!!A);if(u=u.filter(t),u.length===0)return{relationCountAttribute:n,results:[]};let l=n.junctionAlias,h=n.joinInverseSideMetadata.tableName,p=n.alias||h,d=n.relation.junctionEntityMetadata.tableName,m=l+"."+a.propertyName+" IN ("+u.map(A=>isNaN(A)?"'"+A+"'":A)+") AND "+l+"."+c.propertyName+" = "+p+"."+s,f=this.connection.createQueryBuilder(this.queryRunner);return f.select(l+"."+a.propertyName,"parentId").addSelect("COUNT("+f.escape(p)+"."+f.escape(s)+")","cnt").from(h,p).innerJoin(d,l,m).addGroupBy(l+"."+a.propertyName),n.queryBuilderFactory&&n.queryBuilderFactory(f),{relationCountAttribute:n,results:await f.getRawMany()}}});return Promise.all(r)}};var ra=class{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{let t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{let r=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(r)})})}metadataToAttribute(e,t){return new ur(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}};var Dr=class o{static isFindOneOptions(e){let t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){let t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t?.relations){let r=[...t.relations];if(o.applyRelationsRecursively(e,r,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),r.length>0)throw new Ms(r)}return e}static applyRelationsRecursively(e,t,r,n,i){let s=[];if(i){let a=new RegExp("^"+i.replace(".","\\.")+"\\.");s=t.filter(c=>c.match(a)).map(c=>n.findRelationWithPropertyPath(c.replace(a,""))).filter(c=>c)}else s=t.map(a=>n.findRelationWithPropertyPath(a)).filter(a=>a);s.forEach(a=>{let c=Y.buildAlias(e.connection.driver,{joiner:"__"},r,a.propertyPath),u=r+"."+a.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(a):e.leftJoinAndSelect(u,c),t.splice(t.indexOf(i?i+"."+a.propertyPath:a.propertyPath),1);let l,h;if(e.expressionMap.relationLoadStrategy==="query")l=a.inverseEntityMetadata,h=c;else{let p=e.expressionMap.joinAttributes.find(d=>d.entityOrProperty===u);l=p.metadata,h=p.alias.name}if(!h||!l)throw new lt(a.propertyPath,n);if(this.applyRelationsRecursively(e,t,h,l,i?i+"."+a.propertyPath:a.propertyPath),e.expressionMap.relationLoadStrategy==="join"){let p=n.relations.find(d=>d.propertyName===a.propertyPath);p&&this.joinEagerRelations(e,c,p.inverseEntityMetadata)}})}static joinEagerRelations(e,t,r){r.eagerRelations.forEach(n=>{let i=Y.buildAlias(e.connection.driver,{joiner:"__"},t,n.propertyName),s=!0;for(let u of e.expressionMap.joinAttributes)if(!(u.condition!==void 0||u.mapToProperty!==void 0||u.isMappingMany!==void 0||u.direction!=="LEFT"||u.entityOrProperty!==`${t}.${n.propertyPath}`)){s=!1,i=u.alias.name;break}let a=!!e.expressionMap.joinAttributes.find(u=>u.alias.name===i);s&&!a&&e.leftJoin(t+"."+n.propertyPath,i);let c=!0;for(let u of e.expressionMap.selects)if(!(u.aliasName!==void 0||u.virtual!==void 0||u.selection!==i)){c=!1;break}c&&e.addSelect(i),this.joinEagerRelations(e,i,n.inverseEntityMetadata)})}};var En=class o extends Fe{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){let e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(r=>({selection:r}));else if(typeof e=="function"){let r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(r=>({selection:r})));else if(typeof e=="function"){let r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){let r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}addFrom(e,t){let r=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(r),this}innerJoin(e,t,r,n){return this.join("INNER",e,t,r,n),this}leftJoin(e,t,r,n){return this.join("LEFT",e,t,r,n),this}innerJoinAndSelect(e,t,r,n){return this.addSelect(t),this.innerJoin(e,t,r,n),this}leftJoinAndSelect(e,t,r,n){return this.addSelect(t),this.leftJoin(e,t,r,n),this}innerJoinAndMapMany(e,t,r,n,i){return this.addSelect(r),this.join("INNER",t,r,n,i,e,!0),this}innerJoinAndMapOne(e,t,r,n,i,s){return this.addSelect(r),this.join("INNER",t,r,n,i,e,!1,s),this}leftJoinAndMapMany(e,t,r,n,i){return this.addSelect(r),this.join("LEFT",t,r,n,i,e,!0),this}leftJoinAndMapOne(e,t,r,n,i,s){return this.addSelect(r),this.join("LEFT",t,r,n,i,e,!1,s),this}loadRelationIdAndMap(e,t,r,n){let i=new cr(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof r=="string"&&(i.alias=r),typeof r=="object"&&r.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=n,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,r,n){let i=new ur(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=r,i.queryBuilderFactory=n,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",r){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new M('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new M('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new M('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new M('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new M('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new M('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new M('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new M('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,r){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=r,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new or;this.expressionMap.queryEntity=!1;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);let r=await this.loadRawResults(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;let r=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getOne(){let t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){let r=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){let n=r.updateDateColumn.getEntityValue(t);if(n.getTime()!==this.expressionMap.lockVersion.getTime())throw new gi(r.name,this.expressionMap.lockVersion,n)}else{let n=r.versionColumn.getEntityValue(t);if(n!==this.expressionMap.lockVersion)throw new gi(r.name,this.expressionMap.lockVersion,n)}}return t===void 0?null:t}async getOneOrFail(){let e=await this.getOne();if(!e)throw new yi(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new or;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new or;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;let r=await this.executeCountQuery(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new or;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;let r=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new or;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;let r=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let n=this.lazyCount(r);if(n===void 0){let s=this.expressionMap.cacheId;s&&(this.expressionMap.cacheId=`${s}-count`),n=await this.executeCountQuery(e)}let i=[r.entities,n];return t&&await e.commitTransaction(),i}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}lazyCount(e){let t=this.expressionMap.limit!==void 0&&this.expressionMap.limit!==null;if(this.expressionMap.joinAttributes.length>0&&t)return;let r=this.expressionMap.take!==void 0&&this.expressionMap.take!==null,n=t?this.expressionMap.limit:r?this.expressionMap.take:void 0;if(n!==void 0&&e.entities.length===n)return;let i=this.expressionMap.skip!==void 0&&this.expressionMap.skip!==null&&this.expressionMap.skip>0,s=this.expressionMap.offset!==void 0&&this.expressionMap.offset!==null&&this.expressionMap.offset>0;if(e.entities.length===0&&(i||s))return;let a=s?this.expressionMap.offset:i?this.expressionMap.skip:0;return e.entities.length+a}async stream(){this.expressionMap.queryEntity=!1;let[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner(),n=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),n=!0);let i=()=>{if(r!==this.queryRunner)return r.release()},s=r.stream(e,t,i,i);return n&&await r.commitTransaction(),s}catch(i){if(n)try{await r.rollbackTransaction()}catch{}throw i}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,r,n,i,s,a,c){i&&this.setParameters(i);let u=new yn(this.connection,this.expressionMap);u.direction=e,u.mapAsEntity=c,u.mapToProperty=s,u.isMappingMany=a,u.entityOrProperty=t,u.condition=n,this.expressionMap.joinAttributes.push(u);let l=u.metadata;if(l){if(l.deleteDateColumn&&!this.expressionMap.withDeleted){let h=`${r}.${l.deleteDateColumn.propertyName} IS NULL`;u.condition=u.condition?` ${u.condition} AND ${h}`:`${h}`}u.alias=this.expressionMap.createAlias({type:"join",name:r,metadata:l}),u.relation&&u.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:u.junctionAlias,metadata:u.relation.junctionEntityMetadata})}else{let h="";if(typeof t=="function"){let d=t(this.subQuery());this.setParameters(d.getParameters()),h=d.getQuery()}else h=t;let p=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";u.alias=this.expressionMap.createAlias({type:"join",name:r,tablePath:p===!1?t:void 0,subQuery:p===!0?h:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new M("Cannot build query because main alias is not set (call qb#from method)");let e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){let a=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,a)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,a))}this.expressionMap.joinAttributes.forEach(a=>{if(a.metadata)e.push(...this.buildEscapedEntityColumnSelects(a.alias.name,a.metadata)),t.push(...this.findEntityColumnSelects(a.alias.name,a.metadata));else if(this.expressionMap.selects.some(u=>u.selection===a.alias.name)){e.push({selection:this.escape(a.alias.name)+".*"});let u=this.expressionMap.selects.find(l=>l.selection===a.alias.name);t.push(u)}}),this.expressionMap.selects.filter(a=>t.indexOf(a)===-1).forEach(a=>e.push({selection:this.replacePropertyNames(a.selection),aliasName:a.aliasName})),e.length===0&&e.push({selection:"*"});let r="";this.expressionMap.useIndex&&Y.isMySQLFamily(this.connection.driver)&&(r=` USE INDEX (${this.expressionMap.useIndex})`);let n=this.expressionMap.aliases.filter(a=>a.type==="from"&&(a.tablePath||a.subQuery)).map(a=>a.subQuery?a.subQuery+" "+this.escape(a.name):this.getTableName(a.tablePath)+" "+this.escape(a.name)),i=this.createSelectDistinctExpression(),s=e.map(a=>a.selection+(a.aliasName?" AS "+this.escape(a.aliasName):"")).join(", ");return i+s+" FROM "+n.join(", ")+this.createTableLockExpression()+r}createSelectDistinctExpression(){let{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:r}=this.expressionMap,{driver:n}=this.connection,i="SELECT ";return r>0&&Y.isMySQLFamily(n)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),Y.isPostgresFamily(n)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(a=>this.replacePropertyNames(a)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{let r=t.relation,n=t.tablePath,i=t.alias.name,s=t.condition?" AND ("+t.condition+")":"",a=t.parentAlias;if(!a||!r){let c=t.alias.subQuery?t.alias.subQuery:this.getTableName(n);return" "+t.direction+" JOIN "+c+" "+this.escape(i)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(r.isManyToOne||r.isOneToOneOwner){let c=r.joinColumns.map(u=>i+"."+u.referencedColumn.propertyPath+"="+a+"."+r.propertyPath+"."+u.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c+s)}else if(r.isOneToMany||r.isOneToOneNotOwner){let c=r.inverseRelation.joinColumns.map(u=>(r.inverseEntityMetadata.tableType==="entity-child"&&r.inverseEntityMetadata.discriminatorColumn&&(s+=" AND "+i+"."+r.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+r.inverseEntityMetadata.discriminatorValue+"'"),i+"."+r.inverseRelation.propertyPath+"."+u.referencedColumn.propertyPath+"="+a+"."+u.referencedColumn.propertyPath)).join(" AND ");if(!c)throw new M(`Relation ${r.entityMetadata.name}.${r.propertyName} does not have join columns.`);return" "+t.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c+s)}else{let c=r.junctionEntityMetadata.tablePath,u=t.junctionAlias,l="",h="";return r.isOwning?(l=r.joinColumns.map(p=>u+"."+p.propertyPath+"="+a+"."+p.referencedColumn.propertyPath).join(" AND "),h=r.inverseJoinColumns.map(p=>i+"."+p.referencedColumn.propertyPath+"="+u+"."+p.propertyPath).join(" AND ")):(l=r.inverseRelation.inverseJoinColumns.map(p=>u+"."+p.propertyPath+"="+a+"."+p.referencedColumn.propertyPath).join(" AND "),h=r.inverseRelation.joinColumns.map(p=>i+"."+p.referencedColumn.propertyPath+"="+u+"."+p.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(c)+" "+this.escape(u)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l)+" "+t.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(h+s)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){let e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{let r=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,n=this.expressionMap.selects.find(i=>i.selection===t);if(n&&!n.aliasName&&t.indexOf(".")!==-1){let i=t.split("."),s=i[0],a=i.slice(1).join("."),c=this.expressionMap.aliases.find(u=>u.name===s);if(c){let u=c.metadata.findColumnWithPropertyPath(a);if(u){let l=Y.buildAlias(this.connection.driver,void 0,s,u.databaseName);return this.escape(l)+" "+r}}}return this.replacePropertyNames(t)+" "+r}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;e===void 0&&t===void 0&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take);let r=t!=null,n=e!=null;if(this.connection.driver.options.type==="mssql"){let i="";if((r||n)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(i=" ORDER BY (SELECT NULL)"),r&&n)return i+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(r)return i+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return i+" OFFSET "+e+" ROWS"}else if(Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(r&&n)return" LIMIT "+t+" OFFSET "+e;if(r)return" LIMIT "+t;if(n)throw new Ps}else if(Y.isSQLiteFamily(this.connection.driver)){if(r&&n)return" LIMIT "+t+" OFFSET "+e;if(r)return" LIMIT "+t;if(n)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(r&&n)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(r)return" FETCH NEXT "+t+" ROWS ONLY";if(n)return" OFFSET "+e+" ROWS"}else{if(r&&n)return" LIMIT "+t+" OFFSET "+e;if(r)return" LIMIT "+t;if(n)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){let e=this.connection.driver,t="";if(this.expressionMap.lockTables){if(!(Y.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new M("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new M("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let r="";switch(this.expressionMap.onLocked==="nowait"?r=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(r=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return Y.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+r:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(Y.isPostgresFamily(e))return" FOR SHARE"+t+r;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new Yt;case"pessimistic_write":if(Y.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+r;if(Y.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+r;if(e.options.type==="mssql")return"";throw new Yt;case"pessimistic_partial_write":if(Y.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(Y.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new Yt;case"pessimistic_write_or_fail":if(Y.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(Y.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new Yt;case"for_no_key_update":if(Y.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+r;throw new Yt;case"for_key_share":if(Y.isPostgresFamily(e))return" FOR KEY SHARE"+t+r;throw new Yt;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";let e=this.expressionMap.havings.map((t,r)=>{switch(t.type){case"and":return(r>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(r>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){let r=this.expressionMap.selects.some(u=>u.selection===e),n=[];if(r&&n.push(...t.columns.filter(u=>u.isSelect===!0)),n.push(...t.columns.filter(u=>this.expressionMap.selects.some(l=>l.selection===e+"."+u.propertyPath))),n.length===0)return[];let i=this.expressionMap.queryEntity?t.primaryColumns.filter(u=>n.indexOf(u)===-1):[],s=[...n,...i],a=[],c=this.escape(e);return s.forEach(u=>{let l=c+"."+this.escape(u.databaseName);u.isVirtualProperty&&u.query&&(l=`(${u.query(c)})`),this.connection.driver.spatialTypes.indexOf(u.type)!==-1&&((Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(l=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${l})`),Y.isPostgresFamily(this.connection.driver)&&(u.precision?l=`ST_AsGeoJSON(${l}, ${u.precision})::json`:l=`ST_AsGeoJSON(${l})::json`),this.connection.driver.options.type==="mssql"&&(l=`${l}.ToString()`));let h=this.expressionMap.selects.filter(p=>p.selection===e+"."+u.propertyPath);h.length?h.forEach(p=>{a.push({selection:l,aliasName:p.aliasName?p.aliasName:Y.buildAlias(this.connection.driver,void 0,e,u.databaseName),virtual:p.virtual})}):a.push({selection:l,aliasName:Y.buildAlias(this.connection.driver,void 0,e,u.databaseName),virtual:r})}),a}findEntityColumnSelects(e,t){return this.expressionMap.selects.filter(r=>r.selection===e||t.columns.some(n=>r.selection===e+"."+n.propertyPath))}computeCountExpression(){let e=this.expressionMap.mainAlias.name,r=this.expressionMap.mainAlias.metadata.primaryColumns,n=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||Y.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+r.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+"))";if(Y.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+r.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){let i=r.map(s=>`${n}.${this.escape(s.databaseName)}`).join(", '|;|', ");return r.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?r.length===1?`COUNT(DISTINCT(${n}.${this.escape(r[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${r.map(s=>`CAST(${n}.${this.escape(s.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+r.map(i=>`${n}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){let t=this.computeCountExpression(),r=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!r||!r[0]||!r[0].cnt?0:parseInt(r[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){let e=Array.isArray(this.findOptions.select)?ye.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){let e=Array.isArray(this.findOptions.relations)?ye.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){let e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{let r=this.expressionMap.aliases.find(n=>n.metadata.tableNameWithoutPrefix===t);if(!r)throw new M(`"${t}" is not part of this query`);return this.escape(r.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Dr.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new M('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new vs;if(this.expressionMap.lockMode==="optimistic"){let c=this.expressionMap.mainAlias.metadata;if(!c.versionColumn&&!c.updateDateColumn)throw new Rs(c.name)}let t=new Zs(this.connection,e,this.expressionMap.relationIdAttributes),r=new ta(this.connection,e,this.expressionMap.relationCountAttributes);new ea(this.expressionMap).transform(),new ra(this.expressionMap).transform();let s=[],a=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){let[c,u]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),l=this.expressionMap.mainAlias.metadata,h=this.expressionMap.mainAlias.name,p=l.primaryColumns.map(f=>{let A=this.escape("distinctAlias"),R=this.escape(Y.buildAlias(this.connection.driver,void 0,h,f.databaseName));u[R]||(u[R]="ASC");let I=Y.buildAlias(this.connection.driver,void 0,"ids_"+h,f.databaseName);return`${A}.${R} AS ${this.escape(I)}`}),d=this.clone(),m=d.expressionMap.timeTravel;if(s=await new o(this.connection,e).select(`DISTINCT ${p.join(", ")}`).addSelect(c).from(`(${d.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(m).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(u).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),s.length>0){let f="",A={};if(l.hasMultiplePrimaryKeys)f=s.map((R,I)=>l.primaryColumns.map(C=>{let U=`orm_distinct_ids_${I}_${C.databaseName}`,J=Y.buildAlias(this.connection.driver,void 0,"ids_"+h,C.databaseName);return A[U]=R[J],`${h}.${C.propertyPath}=:${U}`}).join(" AND ")).join(" OR ");else{let R=Y.buildAlias(this.connection.driver,void 0,"ids_"+h,l.primaryColumns[0].databaseName),I=s.map(U=>U[R]);I.every(U=>typeof U=="number")?f=`${h}.${l.primaryColumns[0].propertyPath} IN (${I.join(", ")})`:(A.orm_distinct_ids=I,f=h+"."+l.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}s=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:f}).setParameters(A).loadRawResults(e)}}else s=await this.loadRawResults(e);if(s.length>0){let c=await t.load(s),u=await r.load(s);a=new Xs(this.expressionMap,this.connection.driver,c,u,this.queryRunner).transform(s,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,a)}if(this.expressionMap.relationLoadStrategy==="query"){let c=new Ii(this.connection,e);await Promise.all(this.relationMetadatas.map(async u=>{let l=u.inverseEntityMetadata.target,h=u.inverseEntityMetadata.targetName,p=Array.isArray(this.findOptions.select)?ye.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,d=Array.isArray(this.findOptions.relations)?ye.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,m=this.createQueryBuilder(e).select(h).from(l,h).setFindOptions({select:p?ye.deepValue(p,u.propertyPath):void 0,order:this.findOptions.order?ye.deepValue(this.findOptions.order,u.propertyPath):void 0,relations:d?ye.deepValue(d,u.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(a.length>0){let f=await c.loadManyToManyRelationIdsAndGroup(u,a,void 0,m);a.forEach(A=>{let R=f.find(I=>I.entity===A);if(R){let I=R.related===void 0?null:R.related;u.setEntityValue(A,I)}})}}))}return{raw:s,entities:a}}createOrderByCombinedWithSelectExpression(e){let t=this.expressionMap.allOrderBys,r=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){let s=i.split("."),a=s[0],c=s.slice(1).join("."),l=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(Y.buildAlias(this.connection.driver,void 0,a,l.databaseName))}else return this.expressionMap.selects.find(s=>s.selection===i||s.aliasName===i)?this.escape(e)+"."+this.escape(i):""}).join(", "),n={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){let s=i.split("."),a=s[0],c=s.slice(1).join("."),l=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(c);n[this.escape(e)+"."+this.escape(Y.buildAlias(this.connection.driver,void 0,a,l.databaseName))]=t[i]}else this.expressionMap.selects.find(s=>s.selection===i||s.aliasName===i)?n[this.escape(e)+"."+this.escape(i)]=t[i]:n[i]=t[i]}),[r,n]}async loadRawResults(e){let[t,r]=this.getQueryAndParameters(),n=t+" -- PARAMETERS: "+JSON.stringify(r,(l,h)=>typeof h=="bigint"?h.toString():h),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{},s,a=i.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0,c=!1;if(this.connection.queryResultCache&&a)try{if(s=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:n,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),s&&!this.connection.queryResultCache.isExpired(s))return JSON.parse(s.result)}catch(l){if(!i.ignoreErrors)throw l;c=!0}let u=await e.query(t,r,!0);if(!c&&this.connection.queryResultCache&&a)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:n,time:Date.now(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(u.records)},s,e)}catch(l){if(!i.ignoreErrors)throw l}return u.records}mergeExpressionMap(e){return ae.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,r,n){for(let i in e){if(e[i]===void 0||e[i]===!1)continue;let s=n?n+"."+i:i,a=t.findColumnWithPropertyPathStrict(s),c=t.findEmbeddedWithPropertyPath(s),u=t.findRelationWithPropertyPath(s);if(!c&&!a&&!u)throw new lt(s,t);a?this.selects.push(r+"."+s):c&&this.buildSelect(e[i],t,r,s)}}buildRelations(e,t,r,n,i){e&&Object.keys(e).forEach(s=>{let a=e[s],c=i?i+"."+s:s,u=r.findEmbeddedWithPropertyPath(c),l=r.findRelationWithPropertyPath(c);if(!u&&!l)throw new lt(c,r);if(u)this.buildRelations(a,typeof t=="object"?ye.deepValue(t,u.propertyPath):void 0,r,n,c);else if(l){let h=n+"_"+c.replace(".","_");h=Y.buildAlias(this.connection.driver,{joiner:"__"},n,h),(a===!0||typeof a=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(l):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[s]=="object"?t[s]:void 0,alias:h,parentAlias:n,relationMetadata:l}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],l.inverseEntityMetadata,h))),typeof a=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(a,typeof t=="object"?ye.deepValue(t,l.propertyPath):void 0,l.inverseEntityMetadata,h,void 0)}})}buildEagerRelations(e,t,r,n,i){e&&Object.keys(e).forEach(s=>{let a=e[s],c=i?i+"."+s:s,u=r.findEmbeddedWithPropertyPath(c),l=r.findRelationWithPropertyPath(c);if(!u&&!l)throw new lt(c,r);if(u)this.buildEagerRelations(a,typeof t=="object"?ye.deepValue(t,u.propertyPath):void 0,r,n,c);else if(l){let h=n+"_"+c.replace(".","_");h=Y.buildAlias(this.connection.driver,{joiner:"__"},n,h),(a===!0||typeof a=="object")&&l.inverseEntityMetadata.eagerRelations.forEach(p=>{let d=h+"_"+p.propertyPath.replace(".","_");d=Y.buildAlias(this.connection.driver,{joiner:"__"},h,d),this.joins.find(f=>f.alias===d)||this.joins.push({type:"left",select:!0,alias:d,parentAlias:h,selection:void 0,relationMetadata:p}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],l.inverseEntityMetadata,h)}),typeof a=="object"&&this.buildEagerRelations(a,typeof t=="object"?ye.deepValue(t,l.propertyPath):void 0,l.inverseEntityMetadata,h,void 0)}})}buildOrder(e,t,r,n){for(let i in e){if(e[i]===void 0)continue;let s=n?n+"."+i:i,a=t.findColumnWithPropertyPathStrict(s),c=t.findEmbeddedWithPropertyPath(s),u=t.findRelationWithPropertyPath(s);if(!c&&!a&&!u)throw new lt(s,t);if(a){let l=typeof e[i]=="object"?e[i].direction:e[i];l=l==="DESC"||l==="desc"||l===-1?"DESC":"ASC";let h=typeof e[i]=="object"?e[i].nulls:void 0;h=h?.toLowerCase()==="first"?"NULLS FIRST":h?.toLowerCase()==="last"?"NULLS LAST":void 0;let p=`${r}.${s}`;this.addOrderBy(p,l,h)}else if(c)this.buildOrder(e[i],t,r,s);else if(u){let l=r+"_"+s.replace(".","_");l=Y.buildAlias(this.connection.driver,{joiner:"__"},r,l),this.joins.find(p=>p.alias===l)||this.joins.push({type:"left",select:!1,alias:l,parentAlias:r,selection:void 0,relationMetadata:u}),this.buildOrder(e[i],u.inverseEntityMetadata,l)}}}buildWhere(e,t,r,n){let i="";if(Array.isArray(e))e.length&&(i=e.map(s=>this.buildWhere(s,t,r,n)).filter(s=>!!s).map(s=>"("+s+")").join(" OR "));else{let s=[];for(let a in e){let c=e[a],u=n?n+"."+a:a,l=t.findColumnWithPropertyPathStrict(u),h=t.findEmbeddedWithPropertyPath(u),p=t.findRelationWithPropertyPath(u);if(!h&&!l&&!p)throw new lt(u,t);if(c===void 0){if((this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new M(`Undefined value encountered in property '${r}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);continue}if(c===null){let d=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(d==="ignore")continue;if(d==="throw")throw new M(`Null value encountered in property '${r}.${a}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}if(l){let d=`${r}.${u}`;if(l.isVirtualProperty&&l.query&&(d=`(${l.query(this.escape(r))})`),c===null){s.push(`${d} IS NULL`);continue}ue.isEqualOperator(e[a])&&(c=e[a].value),l.transformer&&(c instanceof Ie?c.transformValue(l.transformer):c=yt.transformTo(l.transformer,c)),this.connection.driver.options.type==="mssql"&&(c=this.connection.driver.parametrizeValues(l,c)),s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(d,c)))}else if(h){let d=this.buildWhere(e[a],t,r,u);d&&s.push(d)}else if(p){if(e[a]===null){let d=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(d==="sql-null")s.push(`${r}.${u} IS NULL`);else if(d==="throw")throw new M(`Null value encountered in property '${r}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`);continue}if(typeof e[a]=="object"&&Object.keys(e[a]).every(m=>e[a][m]===void 0))continue;if(ue.isFindOperator(e[a]))if(e[a].type==="moreThan"||e[a].type==="lessThan"||e[a].type==="moreThanOrEqual"||e[a].type==="lessThanOrEqual"){let d="";e[a].type==="moreThan"?d=">":e[a].type==="lessThan"?d="<":e[a].type==="moreThanOrEqual"?d=">=":e[a].type==="lessThanOrEqual"&&(d="<=");let m=this.subQuery();if(p.isManyToManyOwner)m.select("COUNT(*)").from(p.joinTableName,p.joinTableName).where(p.joinColumns.map(f=>`${p.joinTableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else if(p.isManyToManyNotOwner)m.select("COUNT(*)").from(p.inverseRelation.joinTableName,p.inverseRelation.joinTableName).where(p.inverseRelation.inverseJoinColumns.map(f=>`${p.inverseRelation.joinTableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else if(p.isOneToMany)m.select("COUNT(*)").from(p.inverseEntityMetadata.target,p.inverseEntityMetadata.tableName).where(p.inverseRelation.joinColumns.map(f=>`${p.inverseEntityMetadata.tableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(m.getSql()+" "+d+" "+parseInt(e[a].value))}else if(p.isManyToOne||p.isOneToOne&&p.isOneToOneOwner){let d=`${r}.${u}`;s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(d,e[a])))}else throw new Error("This relation isn't supported by given find operator");else{let d=r+"_"+p.propertyPath.replace(".","_");d=Y.buildAlias(this.connection.driver,{joiner:"__"},r,d),this.joins.find(A=>A.alias===d)||this.joins.push({type:"left",select:!1,selection:void 0,alias:d,parentAlias:r,relationMetadata:p});let f=this.buildWhere(e[a],p.inverseEntityMetadata,d);f&&s.push(f)}}}i=s.length?"("+s.join(") AND (")+")":s.join(" AND ")}return i.length?"("+i+")":i}};var Lr=class{constructor(){this.generatedMaps=[]}static from(e){let t=new this;return t.raw=e.records,t.affected=e.affected,t}};var na=class extends Fe{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));let r=new hr(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getSoftDeletionReturningColumns());let[n,i]=this.getQueryAndParameters(),s=await e.query(n,i,!0),a=Lr.from(s);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(a,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),a}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=ue.isEntitySchema(e)?e.options.name:e;let r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Bt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new M(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];let t=Array.isArray(e)?e:[e];return t.forEach(r=>{let n=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!n)throw new M("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(n)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){let e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new M(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new Cs(e);let t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new M('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new Pr;let r=this.createWhereExpression(),n=this.createReturningExpression("update");return n===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${n}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${r} RETURNING ${n}`}createOrderByExpression(){let e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(Y.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new sn}return""}};var $i=class extends Fe{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let r=null,n=null,i=new hr(e,this.expressionMap),s=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(let p of this.expressionMap.returning)s.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(p));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=i.getUpdationReturningColumns(),s.push(...this.expressionMap.extraReturningColumns.filter(p=>!s.includes(p)))),s.length>0&&this.connection.driver.options.type==="mssql"&&(r=this.connection.driver.buildTableVariableDeclaration("@OutputTable",s),n="SELECT * FROM @OutputTable");let[a,c]=this.getQueryAndParameters(),u=[r,a,n],l=await e.query(u.filter(p=>p!=null).join(`;

`),c,!0),h=Lr.from(l);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await i.update(h,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),h}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Bt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new M(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];let t=Array.isArray(e)?e:[e];return t.forEach(r=>{let n=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!n)throw new M("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(n)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){let e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,r={};for(let c in e)e[c]!==void 0&&(r[c]=e[c]);let n=[],i=[];if(t?(this.createPropertyPath(t,r).forEach(c=>{let u=t.findColumnsWithPropertyPath(c);if(u.length<=0)throw new lt(c,t);u.forEach(l=>{if(!l.isUpdate||i.includes(l))return;i.push(l);let h=l.getEntityValue(r);if(l.referencedColumn&&typeof h=="object"&&!(h instanceof Date)&&h!==null&&!Buffer.isBuffer(h)?h=l.referencedColumn.getEntityValue(h):typeof h!="function"&&(h=this.connection.driver.preparePersistentValue(h,l)),typeof h=="function")n.push(this.escape(l.databaseName)+" = "+h());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&h===null)n.push(this.escape(l.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(h=this.connection.driver.parametrizeValue(l,h));let p=this.createParameter(h),d=null;if((Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(l.type)!==-1){let f=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";l.srid!=null?d=`${f}(${p}, ${l.srid})`:d=`${f}(${p})`}else Y.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(l.type)!==-1?l.srid!=null?d=`ST_SetSRID(ST_GeomFromGeoJSON(${p}), ${l.srid})::${l.type}`:d=`ST_GeomFromGeoJSON(${p})::${l.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(l.type)!==-1?d=l.type+"::STGeomFromText("+p+", "+(l.srid||"0")+")":d=p;n.push(this.escape(l.databaseName)+" = "+d)}})}),(n.length>0||Object.keys(r).length===0)&&(t.versionColumn&&i.indexOf(t.versionColumn)===-1&&n.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&i.indexOf(t.updateDateColumn)===-1&&n.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(r).map(c=>{let u=r[c];if(typeof u=="function")n.push(this.escape(c)+" = "+u());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&u===null)n.push(this.escape(c)+" = NULL");else{let l=this.createParameter(u);n.push(this.escape(c)+" = "+l)}}),n.length<=0)throw new Pr;let s=this.createWhereExpression(),a=this.createReturningExpression("update");return a===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")} OUTPUT ${a}${s}`:this.connection.driver.options.type==="spanner"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s} THEN RETURN ${a}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s} RETURNING ${a}`}createOrderByExpression(){let e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(Y.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new sn}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new Pr}};function Od(){Fe.registerQueryBuilderClass("DeleteQueryBuilder",o=>new Mi(o)),Fe.registerQueryBuilderClass("InsertQueryBuilder",o=>new vi(o)),Fe.registerQueryBuilderClass("RelationQueryBuilder",o=>new Oi(o)),Fe.registerQueryBuilderClass("SelectQueryBuilder",o=>new En(o)),Fe.registerQueryBuilderClass("SoftDeleteQueryBuilder",o=>new na(o)),Fe.registerQueryBuilderClass("UpdateQueryBuilder",o=>new $i(o))}function $d(o,e){var t=Object.keys(o);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(o);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(o,n).enumerable})),t.push.apply(t,r)}return t}function qd(o){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$d(Object(t),!0).forEach(function(r){Pb(o,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(t)):$d(Object(t)).forEach(function(r){Object.defineProperty(o,r,Object.getOwnPropertyDescriptor(t,r))})}return o}function Pb(o,e,t){return e=Ob(e),e in o?Object.defineProperty(o,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[e]=t,o}function Ob(o){var e=Ib(o,"string");return typeof e=="symbol"?e:String(e)}function Ib(o,e){if(typeof o!="object"||o===null)return o;var t=o[Symbol.toPrimitive];if(t!==void 0){var r=t.call(o,e||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(o)}var v0=Dd({});function Dd(o){return e.withOptions=t=>Dd(qd(qd({},o),t)),e;function e(t,...r){let n=typeof t=="string"?[t]:t.raw,{alignValues:i=!1,escapeSpecialCharacters:s=Array.isArray(t),trimWhitespace:a=!0}=o,c="";for(let h=0;h<n.length;h++){let p=n[h];if(s&&(p=p.replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{")),c+=p,h<r.length){let d=i?$b(r[h],c):r[h];c+=d}}let u=c.split(`
`),l=null;for(let h of u){let p=h.match(/^(\s+)\S+/);if(p){let d=p[1].length;l?l=Math.min(l,d):l=d}}if(l!==null){let h=l;c=u.map(p=>p[0]===" "||p[0]==="	"?p.slice(h):p).join(`
`)}return a&&(c=c.trim()),s&&(c=c.replace(/\\n/g,`
`)),c}}function $b(o,e){if(typeof o!="string"||!o.includes(`
`))return o;let r=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(r){let n=r[1];return o.replace(/\n/g,`
${n}`)}return o}var _b=It(Ld());var wn;(function(o){o.VIEW="VIEW",o.MATERIALIZED_VIEW="MATERIALIZED_VIEW",o.GENERATED_COLUMN="GENERATED_COLUMN"})(wn||(wn={}));var AF=new class{constructor(){this.instances=[]}get(o){let e=this.instances.find(t=>t.type===o);return e||(e={type:o,object:new o},this.instances.push(e)),e.object}};var De=class{};De.AFTER_LOAD="after-load";De.BEFORE_INSERT="before-insert";De.AFTER_INSERT="after-insert";De.BEFORE_UPDATE="before-update";De.AFTER_UPDATE="after-update";De.BEFORE_REMOVE="before-remove";De.AFTER_REMOVE="after-remove";De.BEFORE_SOFT_REMOVE="before-soft-remove";De.AFTER_SOFT_REMOVE="after-soft-remove";De.BEFORE_RECOVER="before-recover";De.AFTER_RECOVER="after-recover";var rw=It(Qd());Od();function le(){let o=Ct.getGlobalVariable();return o.typeormMetadataArgsStorage||(o.typeormMetadataArgsStorage=new mi),o.typeormMetadataArgsStorage}function $u(o,e){return function(t,r){let n;typeof o=="string"||typeof o=="function"?n=o:o&&(e=o,n=o.type),e||(e={});let i=Reflect&&Reflect.getMetadata?Reflect.getMetadata("design:type",t,r):void 0;if(!n&&i&&(n=i),!e.type&&n&&(e.type=n),e.type==="hstore"&&!e.hstoreType&&(e.hstoreType=i===Object?"object":"string"),typeof o=="function")le().embeddeds.push({target:t.constructor,propertyName:r,isArray:i===Array||e.array===!0,prefix:e.prefix!==void 0?e.prefix:void 0,type:o});else{if(!e.type)throw new an(t,r);e.unique===!0&&le().uniques.push({target:t.constructor,columns:[r]}),le().columns.push({target:t.constructor,propertyName:r,mode:"regular",options:e}),e.generated&&le().generations.push({target:t.constructor,propertyName:r,strategy:typeof e.generated=="string"?e.generated:"increment"})}}}function Wd(o,e){let t={},r;return o?(typeof o=="string"&&(r=o),ae.isObject(o)&&(r="increment",Object.assign(t,o))):r="increment",ae.isObject(e)&&Object.assign(t,e),function(n,i){t.type||(r==="increment"||r==="identity"?t.type=Number:r==="uuid"?t.type="uuid":r==="rowid"&&(t.type="int")),t.primary=!0,le().columns.push({target:n.constructor,propertyName:i,mode:"regular",options:t}),le().generations.push({target:n.constructor,propertyName:i,strategy:r})}}function Hd(o,e){let t=(ae.isObject(o)?o:e)||{},r=typeof o=="string"?o:t.name;return function(n){le().tables.push({target:n,name:r,type:"regular",orderBy:t.orderBy?t.orderBy:void 0,engine:t.engine?t.engine:void 0,database:t.database?t.database:void 0,schema:t.schema?t.schema:void 0,synchronize:t.synchronize,withoutRowid:t.withoutRowid,comment:t.comment?t.comment:void 0})}}var St=class{id;name;email};pi([Wd("uuid")],St.prototype,"id",2),pi([$u({type:"text"})],St.prototype,"name",2),pi([$u({type:"text"})],St.prototype,"email",2),St=pi([Hd("User")],St);var y=class extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}};var la=class extends y{constructor(e,t=[]){super(`Wrong driver: "${e}" given. Supported drivers are: ${t.map(r=>`"${r}"`).join(", ")}.`)}};var ha=class{};var ji=class{},pa=class{},Rn=class{};var da=class{};var ma=class{},fa=class{},Qi=class{},ya=class{},ga=class{},Ea=class{};var Kd=It(Gd()),re=class{static normalizeHydratedDate(e){return e&&(typeof e=="string"?new Date(e):e)}static mixedDateToDateString(e){return e instanceof Date?this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate()):e}static mixedDateToDate(e,t=!1,r=!0){let n=typeof e=="string"?(0,Kd.default)(e).toDate():e;return t&&(n=new Date(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds(),n.getUTCMilliseconds())),r||n.setUTCMilliseconds(0),n}static mixedDateToTimeString(e,t=!1){return e instanceof Date?this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+(t?"":":"+this.formatZerolessValue(e.getSeconds())):e}static mixedTimeToDate(e){if(typeof e=="string"){let[t,r,n]=e.split(":"),i=new Date;return t&&i.setHours(parseInt(t)),r&&i.setMinutes(parseInt(r)),n&&i.setSeconds(parseInt(n)),i}return e}static mixedTimeToString(e,t=!1){return e=e instanceof Date?e.getHours()+":"+e.getMinutes()+(t?"":":"+e.getSeconds()):e,typeof e=="string"?e.split(":").map(r=>r.length===1?"0"+r:r).join(":"):e}static mixedDateToDatetimeString(e,t){if(typeof e=="string"&&(e=new Date(e)),e instanceof Date){let r=this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate())+" "+this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+":"+this.formatZerolessValue(e.getSeconds());t&&(r+=`.${this.formatMilliseconds(e.getMilliseconds())}`),e=r}return e}static mixedDateToUtcDatetimeString(e){return typeof e=="string"&&(e=new Date(e)),e instanceof Date?this.formatZerolessValue(e.getUTCFullYear(),4)+"-"+this.formatZerolessValue(e.getUTCMonth()+1)+"-"+this.formatZerolessValue(e.getUTCDate())+" "+this.formatZerolessValue(e.getUTCHours())+":"+this.formatZerolessValue(e.getUTCMinutes())+":"+this.formatZerolessValue(e.getUTCSeconds())+"."+this.formatMilliseconds(e.getUTCMilliseconds()):e}static simpleArrayToString(e){return Array.isArray(e)?e.map(t=>String(t)).join(","):e}static stringToSimpleArray(e){return typeof e=="string"?e.length>0?e.split(","):[]:e}static simpleJsonToString(e){return JSON.stringify(e)}static stringToSimpleJson(e){return typeof e=="string"?JSON.parse(e):e}static simpleEnumToString(e){return""+e}static stringToSimpleEnum(e,t){return t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0&&(e=parseInt(e)),e}static formatZerolessValue(e,t=2){return`${"0".repeat(t)}${e}`.slice(-t)}static formatMilliseconds(e){return e<10?"00"+e:e<100?"0"+e:String(e)}};var We=class o{constructor(e){this["@instanceof"]=Symbol.for("TableColumn"),this.isNullable=!1,this.isGenerated=!1,this.isPrimary=!1,this.isUnique=!1,this.isArray=!1,this.length="",this.zerofill=!1,this.unsigned=!1,e&&(this.name=e.name,this.type=e.type||"",this.length=e.length||"",this.width=e.width,this.charset=e.charset,this.collation=e.collation,this.precision=e.precision,this.scale=e.scale,this.zerofill=e.zerofill||!1,this.unsigned=this.zerofill?!0:e.unsigned||!1,this.default=e.default,this.onUpdate=e.onUpdate,this.isNullable=e.isNullable||!1,this.isGenerated=e.isGenerated||!1,this.generationStrategy=e.generationStrategy,this.generatedIdentity=e.generatedIdentity,this.isPrimary=e.isPrimary||!1,this.isUnique=e.isUnique||!1,this.isArray=e.isArray||!1,this.comment=e.comment,this.enum=e.enum,this.enumName=e.enumName,this.primaryKeyConstraintName=e.primaryKeyConstraintName,this.asExpression=e.asExpression,this.generatedType=e.generatedType,this.spatialFeatureType=e.spatialFeatureType,this.srid=e.srid)}clone(){return new o({name:this.name,type:this.type,length:this.length,width:this.width,charset:this.charset,collation:this.collation,precision:this.precision,scale:this.scale,zerofill:this.zerofill,unsigned:this.unsigned,enum:this.enum,enumName:this.enumName,primaryKeyConstraintName:this.primaryKeyConstraintName,asExpression:this.asExpression,generatedType:this.generatedType,default:this.default,onUpdate:this.onUpdate,isNullable:this.isNullable,isGenerated:this.isGenerated,generationStrategy:this.generationStrategy,generatedIdentity:this.generatedIdentity,isPrimary:this.isPrimary,isUnique:this.isUnique,isArray:this.isArray,comment:this.comment,spatialFeatureType:this.spatialFeatureType,srid:this.srid})}};var Oe=class o{constructor(e){this["@instanceof"]=Symbol.for("TableIndex"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.isUnique=!!e.isUnique,this.isSpatial=!!e.isSpatial,this.isConcurrent=!!e.isConcurrent,this.isFulltext=!!e.isFulltext,this.isNullFiltered=!!e.isNullFiltered,this.parser=e.parser,this.where=e.where?e.where:""}clone(){return new o({name:this.name,columnNames:[...this.columnNames],isUnique:this.isUnique,isSpatial:this.isSpatial,isConcurrent:this.isConcurrent,isFulltext:this.isFulltext,isNullFiltered:this.isNullFiltered,parser:this.parser,where:this.where})}static create(e){return new o({name:e.name,columnNames:e.columns.map(t=>t.databaseName),isUnique:e.isUnique,isSpatial:e.isSpatial,isConcurrent:e.isConcurrent,isFulltext:e.isFulltext,isNullFiltered:e.isNullFiltered,parser:e.parser,where:e.where})}};var Ye=class o{constructor(e){this["@instanceof"]=Symbol.for("TableForeignKey"),this.columnNames=[],this.referencedColumnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.referencedColumnNames=e.referencedColumnNames,this.referencedDatabase=e.referencedDatabase,this.referencedSchema=e.referencedSchema,this.referencedTableName=e.referencedTableName,this.onDelete=e.onDelete,this.onUpdate=e.onUpdate,this.deferrable=e.deferrable}clone(){return new o({name:this.name,columnNames:[...this.columnNames],referencedColumnNames:[...this.referencedColumnNames],referencedDatabase:this.referencedDatabase,referencedSchema:this.referencedSchema,referencedTableName:this.referencedTableName,onDelete:this.onDelete,onUpdate:this.onUpdate,deferrable:this.deferrable})}static create(e,t){return new o({name:e.name,columnNames:e.columnNames,referencedColumnNames:e.referencedColumnNames,referencedDatabase:e.referencedEntityMetadata.database,referencedSchema:e.referencedEntityMetadata.schema,referencedTableName:e.referencedTablePath,onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable})}};var dr=class{static createTableColumnOptions(e,t){return{name:e.databaseName,length:t.getColumnLength(e),width:e.width,charset:e.charset,collation:e.collation,precision:e.precision,scale:e.scale,zerofill:e.zerofill,unsigned:e.unsigned,asExpression:e.asExpression,generatedType:e.generatedType,default:t.normalizeDefault(e),onUpdate:e.onUpdate,comment:e.comment,isGenerated:e.isGenerated,generationStrategy:e.generationStrategy,generatedIdentity:e.generatedIdentity,isNullable:e.isNullable,type:t.normalizeType(e),isPrimary:e.isPrimary,isUnique:t.normalizeIsUnique(e),isArray:e.isArray||!1,enum:e.enum?e.enum.map(r=>r+""):e.enum,enumName:e.enumName,primaryKeyConstraintName:e.primaryKeyConstraintName,spatialFeatureType:e.spatialFeatureType,srid:e.srid}}};var Ve=class o{constructor(e){this["@instanceof"]=Symbol.for("TableUnique"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.deferrable=e.deferrable}clone(){return new o({name:this.name,columnNames:[...this.columnNames],deferrable:this.deferrable})}static create(e){return new o({name:e.name,columnNames:e.columns.map(t=>t.databaseName),deferrable:e.deferrable})}};var pt=class o{constructor(e){this["@instanceof"]=Symbol.for("TableCheck"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.expression=e.expression}clone(){return new o({name:this.name,columnNames:this.columnNames?[...this.columnNames]:[],expression:this.expression})}static create(e){return new o({name:e.name,expression:e.expression})}};var tr=class o{constructor(e){this["@instanceof"]=Symbol.for("TableExclusion"),this.name=e.name,this.expression=e.expression}clone(){return new o({name:this.name,expression:this.expression})}static create(e){return new o({name:e.name,expression:e.expression})}};var Me=class o{constructor(e){this["@instanceof"]=Symbol.for("Table"),this.columns=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.justCreated=!1,this.withoutRowid=!1,e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,e.columns&&(this.columns=e.columns.map(t=>new We(t))),e.indices&&(this.indices=e.indices.map(t=>new Oe(t))),e.foreignKeys&&(this.foreignKeys=e.foreignKeys.map(t=>new Ye({...t,referencedDatabase:t?.referencedDatabase||e.database,referencedSchema:t?.referencedSchema||e.schema}))),e.uniques&&(this.uniques=e.uniques.map(t=>new Ve(t))),e.checks&&(this.checks=e.checks.map(t=>new pt(t))),e.exclusions&&(this.exclusions=e.exclusions.map(t=>new tr(t))),e.justCreated!==void 0&&(this.justCreated=e.justCreated),e.withoutRowid&&(this.withoutRowid=e.withoutRowid),this.engine=e.engine,this.comment=e.comment)}get primaryColumns(){return this.columns.filter(e=>e.isPrimary)}clone(){return new o({schema:this.schema,database:this.database,name:this.name,columns:this.columns.map(e=>e.clone()),indices:this.indices.map(e=>e.clone()),foreignKeys:this.foreignKeys.map(e=>e.clone()),uniques:this.uniques.map(e=>e.clone()),checks:this.checks.map(e=>e.clone()),exclusions:this.exclusions.map(e=>e.clone()),justCreated:this.justCreated,withoutRowid:this.withoutRowid,engine:this.engine,comment:this.comment})}addColumn(e){this.columns.push(e)}removeColumn(e){let t=this.columns.find(r=>r.name===e.name);t&&this.columns.splice(this.columns.indexOf(t),1)}addUniqueConstraint(e){if(this.uniques.push(e),e.columnNames.length===1){let t=this.columns.find(r=>r.name===e.columnNames[0]);t&&(t.isUnique=!0)}}removeUniqueConstraint(e){let t=this.uniques.find(r=>r.name===e.name);if(t&&(this.uniques.splice(this.uniques.indexOf(t),1),t.columnNames.length===1)){let r=this.columns.find(n=>n.name===t.columnNames[0]);r&&(r.isUnique=!1)}}addCheckConstraint(e){this.checks.push(e)}removeCheckConstraint(e){let t=this.checks.find(r=>r.name===e.name);t&&this.checks.splice(this.checks.indexOf(t),1)}addExclusionConstraint(e){this.exclusions.push(e)}removeExclusionConstraint(e){let t=this.exclusions.find(r=>r.name===e.name);t&&this.exclusions.splice(this.exclusions.indexOf(t),1)}addForeignKey(e){this.foreignKeys.push(e)}removeForeignKey(e){let t=this.foreignKeys.find(r=>r.name===e.name);t&&this.foreignKeys.splice(this.foreignKeys.indexOf(t),1)}addIndex(e,t=!1){if(this.indices.push(e),e.columnNames.length===1&&e.isUnique&&t){let r=this.columns.find(n=>n.name===e.columnNames[0]);r&&(r.isUnique=!0)}}removeIndex(e,t=!1){let r=this.indices.find(n=>n.name===e.name);if(r&&(this.indices.splice(this.indices.indexOf(r),1),r.columnNames.length===1&&r.isUnique&&t)){let n=this.columns.find(i=>i.name===r.columnNames[0]);n&&(n.isUnique=this.indices.some(i=>i.columnNames.length===1&&i.columnNames[0]===n.name&&!!r.isUnique))}}findColumnByName(e){return this.columns.find(t=>t.name===e)}findColumnIndices(e){return this.indices.filter(t=>!!t.columnNames.find(r=>r===e.name))}findColumnForeignKeys(e){return this.foreignKeys.filter(t=>!!t.columnNames.find(r=>r===e.name))}findColumnUniques(e){return this.uniques.filter(t=>!!t.columnNames.find(r=>r===e.name))}findColumnChecks(e){return this.checks.filter(t=>!!t.columnNames.find(r=>r===e.name))}static create(e,t){let r=e.database===t.database?void 0:e.database,n=e.schema===t.options.schema?void 0:e.schema,i={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,n,r),withoutRowid:e.withoutRowid,engine:e.engine,columns:e.columns.filter(s=>s&&!s.isVirtualProperty).map(s=>dr.createTableColumnOptions(s,t)),indices:e.indices.filter(s=>s.synchronize===!0).map(s=>Oe.create(s)),uniques:e.uniques.map(s=>Ve.create(s)),checks:e.checks.map(s=>pt.create(s)),exclusions:e.exclusions.map(s=>tr.create(s)),comment:e.comment};return new o(i)}};var Tt=class o{constructor(e){this["@instanceof"]=Symbol.for("View"),this.indices=[],e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,this.expression=e.expression,this.materialized=!!e.materialized)}clone(){return new o({database:this.database,schema:this.schema,name:this.name,expression:this.expression,materialized:this.materialized})}addIndex(e){this.indices.push(e)}removeIndex(e){let t=this.indices.find(r=>r.name===e.name);t&&this.indices.splice(this.indices.indexOf(t),1)}static create(e,t){let r={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,e.schema,e.database),expression:e.expression,materialized:e.tableMetadataArgs.materialized};return new o(r)}};var ki=class{static viewMetadataCmp(e,t){return!e||!t?0:e.dependsOn&&(e.dependsOn.has(t.target)||e.dependsOn.has(t.name))?1:t.dependsOn&&(t.dependsOn.has(e.target)||t.dependsOn.has(e.name))?-1:0}};var Wy=It(Vy());function ja(o,e=!1){return e&&(o=" "+o),o.replace(/^([A-Z])|[\s-_](\w)/g,function(t,r,n){return n?n.toUpperCase():r.toLowerCase()})}function gl(o){return o.replace(/([A-Z])([A-Z])([a-z])/g,"$1_$2$3").replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}function Hy(o){return o.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function Qa(o,e={}){let{segmentLength:t=4,separator:r="__",termLength:n=2}=e;return o.split(r).reduce((a,c)=>{let u=c.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),l=u.length>1?n:t,h=u.map(p=>p.substr(0,l)).join("");return a.push(h),a},[]).join(r)}function Gy(o,e={}){let t=(0,Wy.default)("sha1");t.update(o,"utf8");let r=t.digest("hex");return e.length&&e.length>0?r.slice(0,e.length):r}var ka=class{static isGreaterOrEqual(e,t){if(!e)return!1;let r=Ky(e),n=Ky(t);for(let i=0;i<r.length&&i<n.length;i++){if(r[i]>n[i])return!0;if(r[i]<n[i])return!1}return!0}};function Ky(o){return o.split(".").map(e=>parseInt(e,10))}var H=class{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return ka.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres","cockroachdb"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){let r=this.parseConnectionUrl(e.url);t&&t.useSid&&r.database&&(r.sid=r.database);for(let n of Object.keys(r))typeof r[n]>"u"&&delete r[n];return Object.assign({},e,r)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){let r=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&r.database&&(r.sid=r.database);for(let n of Object.keys(r))typeof r[n]>"u"&&delete r[n];return Object.assign({},e,r)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...r){let n=t&&t.joiner?t.joiner:"_",i=r.length===1?r[0]:r.join(n);if(e&&e>0&&i.length>e){if(t&&t.shorten===!0){let s=Qa(i);if(s.length<e)return s}return Gy(i,{length:e})}return i}static buildColumnAlias({maxAliasLength:e},t,...r){return typeof t=="string"?(r.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t),this.buildAlias({maxAliasLength:e},t,...r)}static parseConnectionUrl(e){let t=e.split(":")[0],r=e.indexOf("//"),n=e.substr(r+2),i=n.indexOf("/"),s=i!==-1?n.substr(0,i):n,a=i!==-1?n.substr(i+1):void 0;a&&a.indexOf("?")!==-1&&(a=a.substr(0,a.indexOf("?")));let c=s.lastIndexOf("@"),u=s.substr(0,c),l=s.substr(c+1),h=u,p="",d=u.indexOf(":");d!==-1&&(h=u.substr(0,d),p=u.substr(d+1));let[m,f]=l.split(":");return{type:t,host:m,username:decodeURIComponent(h),password:decodeURIComponent(p),port:f?parseInt(f):void 0,database:a||void 0}}static parseMongoDBConnectionUrl(e){let t=e.split(":")[0],r=e.indexOf("//"),n=e.substr(r+2),i=n.indexOf("/"),s=i!==-1?n.substr(0,i):n,a=i!==-1?n.substr(i+1):void 0,c="",u,l,h,p,d={};if(a&&a.indexOf("?")!==-1){c=a.substr(a.indexOf("?")+1,a.length);let J=c.split("&"),ne,oe;J.forEach(z=>{ne=z.split("=")[0],oe=z.split("=")[1],d[ne]=oe}),p=d.replicaSet,a=a.substr(0,a.indexOf("?"))}let m=s.lastIndexOf("@"),f=s.substr(0,m),A=s.substr(m+1),R=f,I="",C=f.indexOf(":");C!==-1&&(R=f.substr(0,C),I=f.substr(C+1)),p?h=A:[u,l]=A.split(":");let U={type:t,host:u,hostReplicaSet:h,username:decodeURIComponent(R),password:decodeURIComponent(I),port:l?parseInt(l):void 0,database:a||void 0};for(let[J,ne]of Object.entries(d))U[J]=ne;return U}};var Vt=class{constructor(e){this.connection=e,this["@instanceof"]=Symbol.for("RdbmsSchemaBuilder")}async build(){this.queryRunner=this.connection.createQueryRunner(),this.currentDatabase=this.connection.driver.database,this.currentSchema=this.connection.driver.schema;let e=this.connection.driver.options.type!=="cockroachdb"&&this.connection.driver.options.type!=="spanner"&&this.connection.options.migrationsTransactionMode!=="none";await this.queryRunner.beforeMigration(),e&&await this.queryRunner.startTransaction();try{await this.createMetadataTableIfNecessary(this.queryRunner);let t=this.entityToSyncMetadatas.map(n=>this.getTablePath(n)),r=this.viewEntityToSyncMetadatas.map(n=>this.getTablePath(n));await this.queryRunner.getTables(t),await this.queryRunner.getViews(r),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),e&&await this.queryRunner.commitTransaction()}catch(t){try{e&&await this.queryRunner.rollbackTransaction()}catch{}throw t}finally{await this.queryRunner.afterMigration(),await this.queryRunner.release()}}async createMetadataTableIfNecessary(e){(this.viewEntityToSyncMetadatas.length>0||this.hasGeneratedColumns())&&await this.createTypeormMetadataTable(e)}async log(){this.queryRunner=this.connection.createQueryRunner();try{let e=this.entityToSyncMetadatas.map(r=>this.getTablePath(r)),t=this.viewEntityToSyncMetadatas.map(r=>this.getTablePath(r));return await this.queryRunner.getTables(e),await this.queryRunner.getViews(t),this.queryRunner.enableSqlMemory(),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),this.queryRunner.getMemorySql()}finally{this.queryRunner.disableSqlMemory(),await this.queryRunner.release()}}get entityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.synchronize&&e.tableType!=="entity-child"&&e.tableType!=="view")}get viewEntityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.tableType==="view"&&e.synchronize).sort(ki.viewMetadataCmp)}hasGeneratedColumns(){return this.connection.entityMetadatas.some(e=>e.columns.some(t=>t.generatedType))}async executeSchemaSyncOperationsInProperOrder(){await this.dropOldViews(),await this.dropOldForeignKeys(),await this.dropOldIndices(),await this.dropOldChecks(),await this.dropOldExclusions(),await this.dropCompositeUniqueConstraints(),await this.renameColumns(),await this.changeTableComment(),await this.createNewTables(),await this.dropRemovedColumns(),await this.addNewColumns(),await this.updatePrimaryKeys(),await this.updateExistColumns(),await this.createNewIndices(),await this.createNewChecks(),await this.createNewExclusions(),await this.createCompositeUniqueConstraints(),await this.createForeignKeys(),await this.createViews(),await this.createNewViewIndices()}getTablePath(e){let t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema||this.currentSchema,t.database||this.currentDatabase)}async dropOldForeignKeys(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=t.foreignKeys.filter(n=>{let i=e.foreignKeys.find(s=>n.name===s.name&&this.getTablePath(n)===this.getTablePath(s.referencedEntityMetadata));return!i||i.onDelete&&i.onDelete!==n.onDelete||i.onUpdate&&i.onUpdate!==n.onUpdate});r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${t.name}: ${r.map(n=>n.name).join(", ")}`),await this.queryRunner.dropForeignKeys(t,r))}}async renameTables(){}async renameColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t||e.columns.length!==t.columns.length)continue;let r=e.columns.filter(s=>!s.isVirtualProperty).filter(s=>!t.columns.find(a=>a.name===s.databaseName&&a.type===this.connection.driver.normalizeType(s)&&a.isNullable===s.isNullable&&a.isUnique===this.connection.driver.normalizeIsUnique(s)));if(r.length===0||r.length>1)continue;let n=t.columns.filter(s=>!e.columns.find(a=>!a.isVirtualProperty&&a.databaseName===s.name&&this.connection.driver.normalizeType(a)===s.type&&a.isNullable===s.isNullable&&this.connection.driver.normalizeIsUnique(a)===s.isUnique));if(n.length===0||n.length>1)continue;let i=n[0].clone();i.name=r[0].databaseName,this.connection.logger.logSchemaBuild(`renaming column "${n[0].name}" in "${t.name}" to "${i.name}"`),await this.queryRunner.renameColumn(t,n[0],i)}}async dropOldIndices(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=t.indices.filter(n=>{let i=e.indices.find(s=>s.name===n.name);return i?i.synchronize===!1?!1:i.isUnique!==n.isUnique||i.isSpatial!==n.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&i.isFulltext!==n.isFulltext||i.columns.length!==n.columnNames.length?!0:!i.columns.every(s=>n.columnNames.indexOf(s.databaseName)!==-1):!0}).map(async n=>{this.connection.logger.logSchemaBuild(`dropping an index: "${n.name}" from table ${t.name}`),await this.queryRunner.dropIndex(t,n)});await Promise.all(r)}if(this.connection.options.type==="postgres"){let e=this.queryRunner;for(let t of this.viewEntityToSyncMetadatas){let r=this.queryRunner.loadedViews.find(i=>this.getTablePath(i)===this.getTablePath(t));if(!r)continue;let n=r.indices.filter(i=>{let s=t.indices.find(a=>a.name===i.name);return s?s.synchronize===!1?!1:s.isUnique!==i.isUnique||s.isSpatial!==i.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&s.isFulltext!==i.isFulltext||s.columns.length!==i.columnNames.length?!0:!s.columns.every(a=>i.columnNames.indexOf(a.databaseName)!==-1):!0}).map(async i=>{this.connection.logger.logSchemaBuild(`dropping an index: "${i.name}" from view ${r.name}`),await e.dropViewIndex(r,i)});await Promise.all(n)}}}async dropOldChecks(){if(!(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=t.checks.filter(n=>!e.checks.find(i=>i.name===n.name));r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old check constraint: ${r.map(n=>`"${n.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropCheckConstraints(t,r))}}async dropCompositeUniqueConstraints(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=t.uniques.filter(n=>n.columnNames.length>1&&!e.uniques.find(i=>i.name===n.name));r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old unique constraint: ${r.map(n=>`"${n.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropUniqueConstraints(t,r))}}async dropOldExclusions(){if(this.connection.driver.options.type==="postgres")for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=t.exclusions.filter(n=>!e.exclusions.find(i=>i.name===n.name));r.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old exclusion constraint: ${r.map(n=>`"${n.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropExclusionConstraints(t,r))}}async changeTableComment(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(t&&(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="postgres")){let r=e.comment;await this.queryRunner.changeTableComment(t,r)}}}async createNewTables(){for(let e of this.entityToSyncMetadatas){if(this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e)))continue;this.connection.logger.logSchemaBuild(`creating a new table: ${this.getTablePath(e)}`);let r=Me.create(e,this.connection.driver);await this.queryRunner.createTable(r,!1,!1),this.queryRunner.loadedTables.push(r)}}async createViews(){for(let e of this.viewEntityToSyncMetadatas){if(this.queryRunner.loadedViews.find(n=>{let i=typeof n.expression=="string"?n.expression.trim():n.expression(this.connection).getQuery(),s=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.getTablePath(n)===this.getTablePath(e)&&i===s}))continue;this.connection.logger.logSchemaBuild(`creating a new view: ${this.getTablePath(e)}`);let r=Tt.create(e,this.connection.driver);await this.queryRunner.createView(r,!0),this.queryRunner.loadedViews.push(r)}}async dropOldViews(){let e=[],t=this.viewEntityToSyncMetadatas,r=new Map;for(let s of this.queryRunner.loadedViews){let a=t.find(c=>this.getTablePath(s)===this.getTablePath(c));a&&r.set(s,a)}for(let s of this.queryRunner.loadedViews){let a=r.get(s);if(!a)continue;let c=typeof s.expression=="string"?s.expression.trim():s.expression(this.connection).getQuery(),u=typeof a.expression=="string"?a.expression.trim():a.expression(this.connection).getQuery();c!==u&&(this.connection.logger.logSchemaBuild(`dropping an old view: ${s.name}`),e.push(s))}let n=s=>{let a=r.get(s),c=[s];if(!a)return c;for(let[u,l]of r.entries())u!==s&&l.dependsOn&&(l.dependsOn.has(a.target)||l.dependsOn.has(a.name))&&(c=c.concat(n(u)));return c},i=new Set(e.map(s=>n(s)).reduce((s,a)=>s.concat(a),[]).sort((s,a)=>ki.viewMetadataCmp(r.get(s),r.get(a))).reverse());for(let s of i)await this.queryRunner.dropView(s);this.queryRunner.loadedViews=this.queryRunner.loadedViews.filter(s=>!i.has(s))}async dropRemovedColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=t.columns.filter(n=>!e.columns.find(i=>i.isVirtualProperty||i.databaseName===n.name));r.length!==0&&(this.connection.logger.logSchemaBuild(`columns dropped in ${t.name}: `+r.map(n=>n.name).join(", ")),await this.queryRunner.dropColumns(t,r))}}async addNewColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let r=e.columns.filter(s=>!s.isVirtualProperty&&!t.columns.find(a=>a.name===s.databaseName));if(r.length===0)continue;let i=this.metadataColumnsToTableColumnOptions(r).map(s=>new We(s));i.length!==0&&(this.connection.logger.logSchemaBuild("new columns added: "+r.map(s=>s.databaseName).join(", ")),await this.queryRunner.addColumns(t,i))}}async updatePrimaryKeys(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;let r=e.columns.filter(i=>i.isPrimary);if(t.columns.filter(i=>i.isPrimary).length!==r.length&&r.length>1){let i=r.map(s=>new We(dr.createTableColumnOptions(s,this.connection.driver)));await this.queryRunner.updatePrimaryKeys(t,i)}}}async updateExistColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;let r=this.connection.driver.findChangedColumns(t.columns,e.columns);if(r.length===0)continue;for(let i of r)await this.dropColumnReferencedForeignKeys(this.getTablePath(e),i.databaseName);for(let i of r)await this.dropColumnCompositeIndices(this.getTablePath(e),i.databaseName);if(!(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="spanner"))for(let i of r)await this.dropColumnCompositeUniques(this.getTablePath(e),i.databaseName);let n=r.map(i=>{let s=t.columns.find(u=>u.name===i.databaseName),a=dr.createTableColumnOptions(i,this.connection.driver),c=new We(a);return{oldColumn:s,newColumn:c}});n.length!==0&&(this.connection.logger.logSchemaBuild(`columns changed in "${t.name}". updating: `+r.map(i=>i.databaseName).join(", ")),await this.queryRunner.changeColumns(t,n))}}async createNewIndices(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=e.indices.filter(n=>!t.indices.find(i=>i.name===n.name)&&n.synchronize===!0).map(n=>Oe.create(n));r.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${r.map(n=>`"${n.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createIndices(t,r))}}async createNewViewIndices(){if(this.connection.options.type!=="postgres"||!H.isPostgresFamily(this.connection.driver))return;let e=this.queryRunner;for(let t of this.viewEntityToSyncMetadatas){let r=this.queryRunner.loadedViews.find(i=>{let s=typeof i.expression=="string"?i.expression.trim():i.expression(this.connection).getQuery(),a=typeof t.expression=="string"?t.expression.trim():t.expression(this.connection).getQuery();return this.getTablePath(i)===this.getTablePath(t)&&s===a});if(!r||!r.materialized)continue;let n=t.indices.filter(i=>!r.indices.find(s=>s.name===i.name)&&i.synchronize===!0).map(i=>Oe.create(i));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${n.map(i=>`"${i.name}"`).join(", ")} in view "${r.name}"`),await e.createViewIndices(r,n))}}async createNewChecks(){if(!(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=e.checks.filter(n=>!t.checks.find(i=>i.name===n.name)).map(n=>pt.create(n));r.length!==0&&(this.connection.logger.logSchemaBuild(`adding new check constraints: ${r.map(n=>`"${n.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createCheckConstraints(t,r))}}async createCompositeUniqueConstraints(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=e.uniques.filter(n=>n.columns.length>1&&!t.uniques.find(i=>i.name===n.name)).map(n=>Ve.create(n));r.length!==0&&(this.connection.logger.logSchemaBuild(`adding new unique constraints: ${r.map(n=>`"${n.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createUniqueConstraints(t,r))}}async createNewExclusions(){if(this.connection.driver.options.type==="postgres")for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(n=>this.getTablePath(n)===this.getTablePath(e));if(!t)continue;let r=e.exclusions.filter(n=>!t.exclusions.find(i=>i.name===n.name)).map(n=>tr.create(n));r.length!==0&&(this.connection.logger.logSchemaBuild(`adding new exclusion constraints: ${r.map(n=>`"${n.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createExclusionConstraints(t,r))}}async createForeignKeys(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;let r=e.foreignKeys.filter(i=>!t.foreignKeys.find(s=>s.name===i.name&&this.getTablePath(s)===this.getTablePath(i.referencedEntityMetadata)));if(r.length===0)continue;let n=r.map(i=>Ye.create(i,this.connection.driver));this.connection.logger.logSchemaBuild(`creating a foreign keys: ${r.map(i=>i.name).join(", ")} on table "${t.name}"`),await this.queryRunner.createForeignKeys(t,n)}}async dropColumnReferencedForeignKeys(e,t){let r=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===e);if(!r)return;let n=[],i=r.foreignKeys.find(s=>s.columnNames.indexOf(t)!==-1);if(i){let s=r.clone();s.foreignKeys=[i],n.push(s),r.removeForeignKey(i)}for(let s of this.queryRunner.loadedTables){let a=s.foreignKeys.filter(c=>this.getTablePath(c)===e&&c.referencedColumnNames.indexOf(t)!==-1);if(a.length>0){let c=s.clone();c.foreignKeys=a,n.push(c),a.forEach(u=>s.removeForeignKey(u))}}if(n.length>0)for(let s of n)this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${s.name}: ${s.foreignKeys.map(a=>a.name).join(", ")}`),await this.queryRunner.dropForeignKeys(s,s.foreignKeys)}async dropColumnCompositeIndices(e,t){let r=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!r)return;let n=r.indices.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related indices of "${e}"."${t}": ${n.map(i=>i.name).join(", ")}`),await this.queryRunner.dropIndices(r,n))}async dropColumnCompositeUniques(e,t){let r=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!r)return;let n=r.uniques.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related unique constraints of "${e}"."${t}": ${n.map(i=>i.name).join(", ")}`),await this.queryRunner.dropUniqueConstraints(r,n))}metadataColumnsToTableColumnOptions(e){return e.map(t=>dr.createTableColumnOptions(t,this.connection.driver))}async createTypeormMetadataTable(e){let t=this.currentSchema,r=this.currentDatabase,n=this.connection.driver.buildTableName(this.connection.metadataTableName,t,r),i=this.connection.driver.options.type==="spanner";await e.createTable(new Me({database:r,schema:t,name:n,columns:[{name:"type",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataType}),isNullable:!1,isPrimary:i},{name:"database",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataDatabase}),isNullable:!0,isPrimary:i},{name:"schema",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataSchema}),isNullable:!0,isPrimary:i},{name:"table",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataTable}),isNullable:!0,isPrimary:i},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataName}),isNullable:!0,isPrimary:i},{name:"value",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataValue}),isNullable:!0,isPrimary:i}]}),!0)}};var K=class o{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(r,n)=>e.slice(n*t,n*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((r,n)=>{let i=t(n),s=r.find(a=>a.id===i);return s||(s={id:i,items:[]},r.push(s)),s.items.push(n),r},[])}static uniq(e,t){return e.reduce((r,n)=>{let i=!1;if(typeof t=="function"){let s=t(n);i=!!r.find(a=>t(a)===s)}else typeof t=="string"?i=!!r.find(s=>s[t]===n[t]):i=r.indexOf(n)!==-1;return i||r.push(n),r},[])}static mergeDeep(e,...t){if(!t.length)return e;for(let r of t)o.merge(e,r);return e}static cloneObject(e){return e==null?e:Object.assign(Object.create(Object.getPrototypeOf(e)),e)}static deepCompare(...e){let t,r,n,i;if(e.length<1)return!0;for(t=1,r=e.length;t<r;t++)if(n=[],i=[],!o.compare2Objects(n,i,e[0],e[t]))return!1;return!0}static deepValue(e,t){let r=t.split(".");for(let n=0,i=r.length;n<i;n++)e=e[r[n]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:o.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let r of e){let n=r.split(".");if(!n.length)continue;(!t[n[0]]||t[n[0]]===!0)&&(t[n[0]]={});let i=t[n[0]];for(let[s,a]of n.entries())s!==0&&(i[a]?i=i[a]:s===n.length-1?(i[a]={},i=null):(i[a]={},i=i[a]))}return o.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:o.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(r=>t.includes(r))}static areMutuallyExclusive(...e){return!e.some(r=>{let n=e.filter(i=>i!==r);return r.some(i=>n.some(s=>s.includes(i)))})}static parseSqlCheckExpression(e,t){let r=e.match(new RegExp(`"${t}" varchar CHECK\\s*\\(\\s*"${t}"\\s+IN\\s*`));if(r&&r.index){let i=e.substring(r.index+r[0].length),s="",a="",c=[];for(let u=0;u<i.length;u++){let l=i[u];switch(l){case",":s==""?(c.push(a),a=""):a+=l;break;case"'":s==l?i[u+1]===l?(a+=l,u+=1):s="":s=l;break;case")":if(s=="")return c.push(a),c;a+=l;break;default:s!=""&&(a+=l)}}}}static isCriteriaNullOrEmpty(e){return e==null||e===""||Array.isArray(e)&&e.length===0||o.isPlainObject(e)&&Object.keys(e).length===0}static isSinglePrimitiveCriteria(e){return typeof e=="string"||typeof e=="number"||e instanceof Date}static isPrimitiveCriteria(e){return Array.isArray(e)?e.every(t=>o.isSinglePrimitiveCriteria(t)):o.isSinglePrimitiveCriteria(e)}static compare2Objects(e,t,r,n){let i;if(Number.isNaN(r)&&Number.isNaN(n)||r===n)return!0;if(r===null||n===null||r===void 0||n===void 0)return!1;if((typeof r.equals=="function"||typeof r.equals=="function")&&r.equals(n))return!0;if(typeof r=="function"&&typeof n=="function"||r instanceof Date&&n instanceof Date||r instanceof RegExp&&n instanceof RegExp||typeof r=="string"&&typeof n=="string"||typeof r=="number"&&typeof n=="number")return r.toString()===n.toString();if(!(typeof r=="object"&&typeof n=="object")||Object.prototype.isPrototypeOf.call(r,n)||Object.prototype.isPrototypeOf.call(n,r)||r.constructor!==n.constructor||r.prototype!==n.prototype||e.indexOf(r)>-1||t.indexOf(n)>-1)return!1;for(i in n){if(n.hasOwnProperty(i)!==r.hasOwnProperty(i))return!1;if(typeof n[i]!=typeof r[i])return!1}for(i in r){if(n.hasOwnProperty(i)!==r.hasOwnProperty(i))return!1;if(typeof n[i]!=typeof r[i])return!1;switch(typeof r[i]){case"object":case"function":if(e.push(r),t.push(n),!o.compare2Objects(e,t,r[i],n[i]))return!1;e.pop(),t.pop();break;default:if(r[i]!==n[i])return!1;break}}return!0}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,r,n){if(n.has(r)){e[t]=n.get(r);return}if(!(r instanceof Promise)){if(!o.isPlainObject(r)&&!Array.isArray(r)){e[t]=r;return}e[t]||(e[t]=Array.isArray(r)?[]:{}),n.set(r,e[t]),o.merge(e[t],r,n),n.delete(r)}}static mergeObjectKey(e,t,r,n){if(n.has(r)){Object.assign(e,{[t]:n.get(r)});return}if(!(r instanceof Promise)){if(!o.isPlainObject(r)&&!Array.isArray(r)){Object.assign(e,{[t]:r});return}e[t]||Object.assign(e,{[t]:Array.isArray(r)?[]:{}}),n.set(r,e[t]),o.merge(e[t],r,n),n.delete(r)}}static merge(e,t,r=new Map){if(o.isPlainObject(e)&&o.isPlainObject(t))for(let[n,i]of Object.entries(t))n!=="__proto__"&&o.mergeObjectKey(e,n,i,r);if(Array.isArray(e)&&Array.isArray(t))for(let n=0;n<t.length;n++)o.mergeArrayKey(e,n,t[n],r)}};var ve=class{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((n,i)=>i.from(n),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((r,n)=>n.to(r),t):e.to(t)}};var Wr=class extends y{constructor(e){super(`Internal error. Subject ${e.metadata.targetName} must have an identifier to perform operation.`)}};var Va=class extends y{constructor(e){super(`Cannot create a "${e}" connection because connection to the database already established.`)}};var sr=class extends y{constructor(){super("Locking not supported on given driver.")}};var Wa=class extends y{constructor(e,t){super();let r=e.primaryColumns.reduce((n,i,s)=>(i.setEntityValue(n,s+1),n),{});this.message=`Cannot use given entity id "${t}" because "${e.targetName}" contains multiple primary columns, you must provide object in following form: ${JSON.stringify(r)} as an id.`}};var Ha=class extends y{constructor(e){super(`Cannot ${e}, given value must be instance of entity class, instead object literal is given. Or you must specify an entity target to method call.`)}};var Hr=class extends y{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}};var Ga=class extends y{constructor(e){super(`Tree repositories are not supported in ${e.options.type} driver.`)}};var Fn=class extends y{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} was not found. Did you forgot to put @EntityRepository decorator on it?`)}};var He=class extends y{constructor(){super("Transaction is not started yet, start transaction before committing or rolling it back.")}};var Ka=class extends y{constructor(){super("Transaction already started for the given connection, commit current transaction before starting a new one.")}};var X=class{static isObject(e){return e!==null&&typeof e=="object"}static isObjectWithName(e){return e!==null&&typeof e=="object"&&e.name!==void 0}static assign(e,...t){for(let r of t)for(let n of Object.getOwnPropertyNames(r))e[n]=r[n]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}};var x=class{static isMssqlParameter(e){return this.check(e,"MssqlParameter")}static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isMongoEntityManager(e){return this.check(e,"MongoEntityManager")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}};var Gr=class extends y{constructor(e,t){super(),this.entityClass=e,this.criteria=t,this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return x.isEntitySchema(e)?e.options.name:typeof e=="function"||X.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}};var za=class extends y{constructor(e){super(),this.message=`No metadata for "${this.stringifyTarget(e)}" was found.`}stringifyTarget(e){return x.isEntitySchema(e)?e.options.name:typeof e=="function"||X.isObject(e)&&"name"in e?e.name:e}};var Ja=class extends y{constructor(e,t){super(`Cannot ${e}, given value must be an entity, instead "${t}" is given.`)}};var Zi=class extends y{constructor(e,t,r){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${r}.`)}};var jn=class extends y{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}};var Ya=class extends y{constructor(e){super(`Custom entity repository ${typeof e=="function"?e.name:e.constructor.name}  cannot inherit Repository class without entity being set in the @EntityRepository decorator.`)}};var Qn=class extends y{constructor(){super("Database connection provided by a query runner was already released, cannot continue to use its querying methods anymore.")}};var es=class extends y{constructor(e){super(`Cannot attach entity "${e}" to its parent. Please make sure parent is saved in the database before saving children nodes.`)}};var kn=class extends y{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} does not have managed entity. Did you forget to specify entity for it @EntityRepository(MyEntity)? `)}};var Xa=class extends y{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}};var Za=class extends y{constructor(e){super(`Circular relations detected: ${e}. To resolve this issue you need to set nullable: true somewhere in this dependency structure.`)}};var Wt=class extends y{constructor(){super("OUTPUT or RETURNING clause only supported by PostgreSQL, MariaDB, Microsoft SqlServer or Google Spanner.")}};var eo=class extends y{constructor(e){super(`Entity "${e.name}" does not have a primary column. Primary column is required to have in all your entities. Use @PrimaryColumn decorator to add a primary column to your entity.`)}};var it=class o extends y{constructor(e,t){super(e),Object.setPrototypeOf(this,o.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}};var wt=class extends y{constructor(e,t){super(`${e} package has not been found installed. Please run "npm install ${t}".`)}};var to=class extends y{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}};var ro=class extends y{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}};var fr=class extends y{constructor(){super("The optimistic lock can be used only with getOne() method.")}};var no=class extends y{constructor(e){super(`Driver option (${e}) is not set. Please set it to perform connection to the database.`)}};var io=class extends y{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}};var so=class extends y{constructor(){super("An open transaction is required for pessimistic lock.")}};var ao=class extends y{constructor(e,t,r){super();let n=typeof t=="string"?t:t.name;this.message=`Data type "${n}" in "${e.entityMetadata.targetName}.${e.propertyName}" is not supported by "${r}" database.`}};var oo=class extends y{constructor(e){super(`Array initializations are not allowed in entity relations. Please remove array initialization (= []) from "${e.entityMetadata.targetName}#${e.propertyPath}". This is ORM requirement to make relations to work properly. Refer docs for more information.`)}};var Qe=class extends y{constructor(e,t,r){if(super(r.toString().replace(/^error: /,"").replace(/^Error: /,"").replace(/^Request/,"")),this.query=e,this.parameters=t,this.driverError=r,r){let{name:n,...i}=r;X.assign(this,{...i})}}};var co=class extends y{constructor(){super("Entity manager is not using single database connection and cannot be released. Only entity managers created by connection#createEntityManagerWithSingleDatabaseConnection methods have a single database connection and they should be released.")}};var uo=class extends y{constructor(e){super(`Removed entity "${e.metadata.name}" is also scheduled for update operation. Make sure you are not updating and removing same object (note that update or remove may be executed by cascade operations).`)}};var Pe=class extends y{constructor(){super("Query runner already released. Cannot run queries anymore.")}};var lo=class extends y{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}};var yr=class extends y{constructor(e){super(`Cannot execute operation on "${e}" connection because connection is not yet established.`)}};var ho=class extends y{constructor(e){super(`Option "${e}" is not set in your connection options, please define "${e}" option in your connection options or ormconfig.json`)}};var po=class extends y{constructor(e){let t=e.map(r=>`"${r.name}"`);super(`Migrations ${t.join(", ")} override the transaction mode, but the global transaction mode is "all"`)}};var Nt=class{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime","json"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=H.buildDriverOptions(this.options).database}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(r=>r?t(r):e())})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new Vt(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=ve.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?re.mixedDateToDateString(e):t.type==="time"?re.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?re.mixedDateToUtcDatetimeString(e):t.type==="json"||t.type==="simple-json"?re.simpleJsonToString(e):t.type==="simple-array"?re.simpleArrayToString(e):t.type==="simple-enum"?re.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?ve.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=re.normalizeHydratedDate(e)):t.type==="date"?e=re.mixedDateToDateString(e):t.type==="time"?e=re.mixedTimeToString(e):t.type==="json"||t.type==="simple-json"?e=re.stringToSimpleJson(e):t.type==="simple-array"?e=re.stringToSimpleArray(e):t.type==="simple-enum"?e=re.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ve.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,r){let n=Object.keys(r).map(i=>typeof r[i]=="boolean"?r[i]===!0?1:0:r[i]instanceof Date?re.mixedDateToUtcDatetimeString(r[i]):r[i]);return!t||!Object.keys(t).length?[e,n]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,s,a)=>{if(!t.hasOwnProperty(a))return i;let c=t[a];return s?c.map(u=>(n.push(u),this.createParameter(a,n.length-1))).join(", "):typeof c=="function"?c():typeof c=="number"?String(c):typeof c=="boolean"?(n.push(+c),this.createParameter(a,n.length-1)):c instanceof Date?(n.push(re.mixedDateToUtcDatetimeString(c)),this.createParameter(a,n.length-1)):(n.push(c),this.createParameter(a,n.length-1))}),[e,n])}escape(e){return'"'+e+'"'}buildTableName(e,t,r){return e}parseTableName(e){let t=this.database,r=void 0;if(x.isTable(e)||x.isView(e)){let i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||r,tableName:i.tableName}}if(x.isTableForeignKey(e)){let i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||r,tableName:i.tableName}}if(x.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||r,tableName:e.tableName};let n=e.split(".");return n.length===3?{database:n[0]||t,schema:n[1]||r,tableName:n[2]}:n.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(n[0])??t,schema:n[0],tableName:n[1]}:{database:t,schema:r,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){let t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,r,n){let i=e.generatedColumns.reduce((s,a)=>{let c;return a.generationStrategy==="increment"&&t&&(c=t-n+r+1),c?K.mergeDeep(s,a.createValueMap(c)):s},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(r=>{let n=e.find(s=>s.name===r.databaseName);return n?n.name!==r.databaseName||n.type!==this.normalizeType(r)||n.length!==r.length||n.precision!==r.precision||n.scale!==r.scale||this.normalizeDefault(r)!==n.default||n.isPrimary!==r.isPrimary||n.isNullable!==r.isNullable||n.generatedType!==r.generatedType||n.asExpression!==r.asExpression||n.isUnique!==this.normalizeIsUnique(r)||n.enum&&r.enum&&!K.isArraysEqual(n.enum,r.enum.map(s=>s+""))||r.generationStrategy!=="uuid"&&n.isGenerated!==r.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}async createDatabaseConnection(){throw new y("Do not use AbstractSqlite directly, it has to be used with one of the sqlite drivers")}loadDependencies(){}};var Le=class{constructor(){this.records=[]}};var _e=class{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}};var Be=class{constructor(e){this.queryRunner=e}async broadcast(e,...t){let r=new _e,n=this[`broadcast${e}Event`];typeof n=="function"&&n.call(this,r,...t),await r.wait()}broadcastBeforeInsertEvent(e,t,r){r&&t.beforeInsertListeners.length&&t.beforeInsertListeners.forEach(n=>{if(n.isAllowed(r)){let i=n.execute(r);i instanceof Promise&&e.promises.push(i),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(n=>{if(this.isAllowedSubscriber(n,t.target)&&n.beforeInsert){let i=n.beforeInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastBeforeUpdateEvent(e,t,r,n,i,s){r&&t.beforeUpdateListeners.length&&t.beforeUpdateListeners.forEach(a=>{if(a.isAllowed(r)){let c=a.execute(r);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.beforeUpdate){let c=a.beforeUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,updatedColumns:i||[],updatedRelations:s||[]});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastBeforeRemoveEvent(e,t,r,n,i){r&&t.beforeRemoveListeners.length&&t.beforeRemoveListeners.forEach(s=>{if(s.isAllowed(r)){let a=s.execute(r);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeRemove){let a=s.beforeRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,entityId:t.getEntityIdMixedMap(n??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeSoftRemoveEvent(e,t,r,n,i){r&&t.beforeSoftRemoveListeners.length&&t.beforeSoftRemoveListeners.forEach(s=>{if(s.isAllowed(r)){let a=s.execute(r);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeSoftRemove){let a=s.beforeSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,entityId:t.getEntityIdMixedMap(n??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastBeforeRecoverEvent(e,t,r,n,i){r&&t.beforeRecoverListeners.length&&t.beforeRecoverListeners.forEach(s=>{if(s.isAllowed(r)){let a=s.execute(r);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeRecover){let a=s.beforeRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,entityId:t.getEntityIdMixedMap(n??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterInsertEvent(e,t,r,n){r&&t.afterInsertListeners.length&&t.afterInsertListeners.forEach(i=>{if(i.isAllowed(r)){let s=i.execute(r);s instanceof Promise&&e.promises.push(s),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.afterInsert){let s=i.afterInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,entityId:t.getEntityIdMixedMap(n)});s instanceof Promise&&e.promises.push(s),e.count++}})}broadcastBeforeQueryEvent(e,t,r){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(n=>{if(n.beforeQuery){let i=n.beforeQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:r});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastAfterQueryEvent(e,t,r,n,i,s,a){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(c=>{if(c.afterQuery){let u=c.afterQuery({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,query:t,parameters:r,success:n,executionTime:i,rawResults:s,error:a});u instanceof Promise&&e.promises.push(u),e.count++}})}broadcastBeforeTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionStart){let r=t.beforeTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionStart){let r=t.afterTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastBeforeTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionCommit){let r=t.beforeTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionCommit){let r=t.afterTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastBeforeTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionRollback){let r=t.beforeTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionRollback){let r=t.afterTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterUpdateEvent(e,t,r,n,i,s){r&&t.afterUpdateListeners.length&&t.afterUpdateListeners.forEach(a=>{if(a.isAllowed(r)){let c=a.execute(r);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(a=>{if(this.isAllowedSubscriber(a,t.target)&&a.afterUpdate){let c=a.afterUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,updatedColumns:i||[],updatedRelations:s||[]});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastAfterRemoveEvent(e,t,r,n,i){r&&t.afterRemoveListeners.length&&t.afterRemoveListeners.forEach(s=>{if(s.isAllowed(r)){let a=s.execute(r);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterRemove){let a=s.afterRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,entityId:t.getEntityIdMixedMap(n??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterSoftRemoveEvent(e,t,r,n,i){r&&t.afterSoftRemoveListeners.length&&t.afterSoftRemoveListeners.forEach(s=>{if(s.isAllowed(r)){let a=s.execute(r);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterSoftRemove){let a=s.afterSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,entityId:t.getEntityIdMixedMap(n??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastAfterRecoverEvent(e,t,r,n,i){r&&t.afterRecoverListeners.length&&t.afterRecoverListeners.forEach(s=>{if(s.isAllowed(r)){let a=s.execute(r);a instanceof Promise&&e.promises.push(a),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterRecover){let a=s.afterRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:r,metadata:t,databaseEntity:n,entityId:t.getEntityIdMixedMap(n??i)});a instanceof Promise&&e.promises.push(a),e.count++}})}broadcastLoadEventsForAll(e,t,r){return this.broadcastLoadEvent(e,t,r)}broadcastLoadEvent(e,t,r){let n=this.queryRunner.connection.subscribers.filter(i=>this.isAllowedSubscriber(i,t.target)&&i.afterLoad);if(t.relations.length||t.afterLoadListeners.length||n.length){let i=r.filter(s=>!(s instanceof Promise));t.relations.length&&t.relations.forEach(s=>{i.forEach(a=>{if(s.isLazy&&!a.hasOwnProperty(s.propertyName))return;let c=s.getEntityValue(a);X.isObject(c)&&this.broadcastLoadEvent(e,s.inverseEntityMetadata,Array.isArray(c)?c:[c])})}),t.afterLoadListeners.length&&t.afterLoadListeners.forEach(s=>{i.forEach(a=>{if(s.isAllowed(a)){let c=s.execute(a);c instanceof Promise&&e.promises.push(c),e.count++}})}),n.forEach(s=>{i.forEach(a=>{let c=s.afterLoad(a,{entity:a,metadata:t,connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});c instanceof Promise&&e.promises.push(c),e.count++})})}}isAllowedSubscriber(e,t){return!e.listenTo||!e.listenTo()||e.listenTo()===Object||e.listenTo()===t||e.listenTo().isPrototypeOf(t)}};var b=class{constructor(e,t){this.query=e,this.parameters=t,this["@instanceof"]=Symbol.for("Query")}};var Kr=class{constructor(){this.upQueries=[],this.downQueries=[]}};function zy(o,e){var t=Object.keys(o);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(o);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(o,n).enumerable})),t.push.apply(t,r)}return t}function Jy(o){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zy(Object(t),!0).forEach(function(r){hx(o,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(t)):zy(Object(t)).forEach(function(r){Object.defineProperty(o,r,Object.getOwnPropertyDescriptor(t,r))})}return o}function hx(o,e,t){return e=px(e),e in o?Object.defineProperty(o,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):o[e]=t,o}function px(o){var e=dx(o,"string");return typeof e=="symbol"?e:String(e)}function dx(o,e){if(typeof o!="object"||o===null)return o;var t=o[Symbol.toPrimitive];if(t!==void 0){var r=t.call(o,e||"default");if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(o)}var mx=Xy({}),Yy=mx;function Xy(o){return e.withOptions=t=>Xy(Jy(Jy({},o),t)),e;function e(t,...r){let n=typeof t=="string"?[t]:t.raw,{alignValues:i=!1,escapeSpecialCharacters:s=Array.isArray(t),trimWhitespace:a=!0}=o,c="";for(let h=0;h<n.length;h++){let p=n[h];if(s&&(p=p.replace(/\\\n[ \t]*/g,"").replace(/\\`/g,"`").replace(/\\\$/g,"$").replace(/\\\{/g,"{")),c+=p,h<r.length){let d=i?fx(r[h],c):r[h];c+=d}}let u=c.split(`
`),l=null;for(let h of u){let p=h.match(/^(\s+)\S+/);if(p){let d=p[1].length;l?l=Math.min(l,d):l=d}}if(l!==null){let h=l;c=u.map(p=>p[0]===" "||p[0]==="	"?p.slice(h):p).join(`
`)}return a&&(c=c.trim()),s&&(c=c.replace(/\\n/g,`
`)),c}}function fx(o,e){if(typeof o!="string"||!o.includes(`
`))return o;let r=e.slice(e.lastIndexOf(`
`)+1).match(/^(\s+)/);if(r){let n=r[1];return o.replace(/\n/g,`
${n}`)}return o}function gr({driver:o,strings:e,expressions:t}){let r="",n=[],i=0;for(let[s,a]of t.entries()){if(r+=e[s],a===null){r+="NULL";continue}if(typeof a=="function"){let c=a();if(typeof c=="string"){r+=c;continue}if(Array.isArray(c)){if(c.length===0)throw new Error(`Expression ${s} in this sql tagged template is a function which returned an empty array. Empty arrays cannot safely be expanded into parameter lists.`);let u=c.map(()=>o.createParameter(`param_${i+1}`,i++));r+=u.join(", "),n.push(...c);continue}throw new Error(`Expression ${s} in this sql tagged template is a function which returned a value of type "${c===null?"null":typeof c}". Only array and string types are supported as function return values in sql tagged template expressions.`)}r+=o.createParameter(`param_${i+1}`,i++),n.push(a)}return r+=e[e.length-1],r=Yy(r),{query:r,parameters:n}}var Ht=class{constructor(){this.isReleased=!1,this.isTransactionActive=!1,this.data={},this.loadedTables=[],this.loadedViews=[],this.sqlMemoryMode=!1,this.sqlInMemory=new Kr,this.transactionDepth=0,this.cachedTablePaths={}}async sql(e,...t){let{query:r,parameters:n}=gr({driver:this.connection.driver,strings:e,expressions:t});return await this.query(r,n)}async beforeMigration(){}async afterMigration(){}async getTable(e){return this.loadedTables=await this.loadTables([e]),this.loadedTables.length>0?this.loadedTables[0]:void 0}async getTables(e){return e?(this.loadedTables=await this.loadTables(e),this.loadedTables):await this.loadTables(e)}async getView(e){return this.loadedViews=await this.loadViews([e]),this.loadedViews.length>0?this.loadedViews[0]:void 0}async getViews(e){return this.loadedViews=await this.loadViews(e),this.loadedViews}enableSqlMemory(){this.sqlInMemory=new Kr,this.sqlMemoryMode=!0}disableSqlMemory(){this.sqlInMemory=new Kr,this.sqlMemoryMode=!1}clearSqlMemory(){this.sqlInMemory=new Kr}getMemorySql(){return this.sqlInMemory}async executeMemoryUpSql(){for(let{query:e,parameters:t}of this.sqlInMemory.upQueries)await this.query(e,t)}async executeMemoryDownSql(){for(let{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())await this.query(e,t)}getReplicationMode(){return this.mode}async getCachedView(e){let t=this.loadedViews.find(n=>n.name===e);if(t)return t;let r=await this.loadViews([e]);if(r.length>0)return this.loadedViews.push(r[0]),r[0];throw new y(`View "${e}" does not exist.`)}async getCachedTable(e){if(e in this.cachedTablePaths){let r=this.cachedTablePaths[e],n=this.loadedTables.find(i=>this.getTablePath(i)===r);if(n)return n}let t=await this.loadTables([e]);if(t.length>0){let r=this.getTablePath(t[0]),n=this.loadedTables.find(i=>this.getTablePath(i)===r);return n||(this.cachedTablePaths[e]=this.getTablePath(t[0]),this.loadedTables.push(t[0]),t[0])}else throw new y(`Table "${e}" does not exist.`)}replaceCachedTable(e,t){let r=this.getTablePath(e),n=this.loadedTables.find(i=>this.getTablePath(i)===r);for(let[i,s]of Object.entries(this.cachedTablePaths))s===r&&(this.cachedTablePaths[i]=this.getTablePath(t));n&&(n.database=t.database,n.schema=t.schema,n.name=t.name,n.columns=t.columns,n.indices=t.indices,n.foreignKeys=t.foreignKeys,n.uniques=t.uniques,n.checks=t.checks,n.justCreated=t.justCreated,n.engine=t.engine,n.comment=t.comment)}getTablePath(e){let t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema,t.database)}getTypeormMetadataTableName(){let e=this.connection.driver.options;return this.connection.driver.buildTableName(this.connection.metadataTableName,e.schema,e.database)}selectTypeormMetadataSql({database:e,schema:t,table:r,type:n,name:i}){let s=this.connection.createQueryBuilder(),a=s.select().from(this.getTypeormMetadataTableName(),"t").where(`${s.escape("type")} = :type`,{type:n}).andWhere(`${s.escape("name")} = :name`,{name:i});e&&a.andWhere(`${s.escape("database")} = :database`,{database:e}),t&&a.andWhere(`${s.escape("schema")} = :schema`,{schema:t}),r&&a.andWhere(`${s.escape("table")} = :table`,{table:r});let[c,u]=a.getQueryAndParameters();return new b(c,u)}insertTypeormMetadataSql({database:e,schema:t,table:r,type:n,name:i,value:s}){let[a,c]=this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({database:e,schema:t,table:r,type:n,name:i,value:s}).getQueryAndParameters();return new b(a,c)}deleteTypeormMetadataSql({database:e,schema:t,table:r,type:n,name:i}){let s=this.connection.createQueryBuilder(),a=s.delete().from(this.getTypeormMetadataTableName()).where(`${s.escape("type")} = :type`,{type:n}).andWhere(`${s.escape("name")} = :name`,{name:i});e&&a.andWhere(`${s.escape("database")} = :database`,{database:e}),t&&a.andWhere(`${s.escape("schema")} = :schema`,{schema:t}),r&&a.andWhere(`${s.escape("table")} = :table`,{table:r});let[c,u]=a.getQueryAndParameters();return new b(c,u)}isColumnChanged(e,t,r,n,i=!0){return e.charset!==t.charset||e.collation!==t.collation||e.precision!==t.precision||e.scale!==t.scale||e.width!==t.width||e.zerofill!==t.zerofill||e.unsigned!==t.unsigned||e.asExpression!==t.asExpression||r&&e.default!==t.default||e.onUpdate!==t.onUpdate||e.isNullable!==t.isNullable||n&&e.comment!==t.comment||i&&this.isEnumChanged(e,t)}isEnumChanged(e,t){return!K.isArraysEqual(e.enum||[],t.enum||[])}isDefaultColumnLength(e,t,r){if(this.connection.hasMetadata(e.name)){let i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&this.connection.driver.getColumnLength(i))return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].length?this.connection.driver.dataTypeDefaults[t.type].length.toString()===r.toString():!1}isDefaultColumnPrecision(e,t,r){if(this.connection.hasMetadata(e.name)){let i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.precision!==null&&i.precision!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].precision!==null&&this.connection.driver.dataTypeDefaults[t.type].precision!==void 0?this.connection.driver.dataTypeDefaults[t.type].precision===r:!1}isDefaultColumnScale(e,t,r){if(this.connection.hasMetadata(e.name)){let i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.scale!==null&&i.scale!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].scale!==null&&this.connection.driver.dataTypeDefaults[t.type].scale!==void 0?this.connection.driver.dataTypeDefaults[t.type].scale===r:!1}async executeQueries(e,t){if(x.isQuery(e)&&(e=[e]),x.isQuery(t)&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(let{query:r,parameters:n}of e)await this.query(r,n)}generateIndexName(e,t){return this.connection.namingStrategy.indexName(e,t.columnNames,t.where)}};var ce;(function(o){o.VIEW="VIEW",o.MATERIALIZED_VIEW="MATERIALIZED_VIEW",o.GENERATED_COLUMN="GENERATED_COLUMN"})(ce||(ce={}));var st=class extends Ht{constructor(){super(),this.transactionPromise=null}connect(){return Promise.resolve(this.driver.databaseConnection)}release(){return this.loadedTables=[],this.clearSqlMemory(),Promise.resolve()}async startTransaction(e){if(this.driver.transactionSupport==="none")throw new y(`Transactions aren't supported by ${this.connection.driver.options.type}.`);if(this.isTransactionActive&&this.driver.transactionSupport==="simple")throw new Ka;if(e&&e!=="READ UNCOMMITTED"&&e!=="SERIALIZABLE")throw new y("SQLite only supports SERIALIZABLE and READ UNCOMMITTED isolation");this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(e&&(e==="READ UNCOMMITTED"?await this.query("PRAGMA read_uncommitted = true"):await this.query("PRAGMA read_uncommitted = false")),await this.query("BEGIN TRANSACTION")):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}stream(e,t,r,n){throw new y("Stream is not supported by sqlite driver.")}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return Promise.resolve(!1)}async getCurrentDatabase(){return Promise.resolve(void 0)}async hasSchema(e){throw new y("This driver does not support table schemas")}async getCurrentSchema(){return Promise.resolve(void 0)}async hasTable(e){let r=`SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = '${x.isTable(e)?e.name:e}'`;return!!(await this.query(r)).length}async hasColumn(e,t){let r=x.isTable(e)?e.name:e,n=`PRAGMA table_xinfo(${this.escapePath(r)})`;return!!(await this.query(n)).find(s=>s.name===t)}async createDatabase(e,t){return Promise.resolve()}async dropDatabase(e,t){return Promise.resolve()}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t){return Promise.resolve()}async createTable(e,t=!1,r=!0,n=!0){let i=[],s=[];if(t&&await this.hasTable(e))return Promise.resolve();i.push(this.createTableSql(e,r)),s.push(this.dropTableSql(e)),n&&e.indices.forEach(c=>{c.name||(c.name=this.connection.namingStrategy.indexName(e,c.columnNames,c.where)),i.push(this.createIndexSql(e,c)),s.push(this.dropIndexSql(c))});let a=e.columns.filter(c=>c.generatedType&&c.asExpression);for(let c of a){let u=this.insertTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:c.name,value:c.asExpression}),l=this.deleteTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:c.name});i.push(u),s.push(l)}await this.executeQueries(i,s)}async dropTable(e,t,r=!0,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();let i=r,s=x.isTable(e)?e:await this.getCachedTable(e),a=[],c=[];n&&s.indices.forEach(l=>{a.push(this.dropIndexSql(l)),c.push(this.createIndexSql(s,l))}),a.push(this.dropTableSql(s,t)),c.push(this.createTableSql(s,i));let u=s.columns.filter(l=>l.generatedType&&l.asExpression);for(let l of u){let h=this.deleteTypeormMetadataSql({table:s.name,type:ce.GENERATED_COLUMN,name:l.name}),p=this.insertTypeormMetadataSql({table:s.name,type:ce.GENERATED_COLUMN,name:l.name,value:l.asExpression});a.push(h),c.push(p)}await this.executeQueries(a,c)}async createView(e,t=!1){let r=[],n=[];r.push(this.createViewSql(e)),t&&r.push(this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),t&&n.push(this.deleteViewDefinitionSql(e)),await this.executeQueries(r,n)}async dropView(e){let t=x.isView(e)?e.name:e,r=await this.getCachedView(t),n=[],i=[];n.push(this.deleteViewDefinitionSql(r)),n.push(this.dropViewSql(r)),i.push(this.insertViewDefinitionSql(r)),i.push(this.createViewSql(r)),await this.executeQueries(n,i)}async renameTable(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();n.name=t;let i=new b(`ALTER TABLE ${this.escapePath(r.name)} RENAME TO ${this.escapePath(t)}`),s=new b(`ALTER TABLE ${this.escapePath(t)} RENAME TO ${this.escapePath(r.name)}`);await this.executeQueries(i,s),n.uniques.forEach(a=>{let c=this.connection.namingStrategy.uniqueConstraintName(r,a.columnNames);a.name===c&&(a.name=this.connection.namingStrategy.uniqueConstraintName(n,a.columnNames))}),n.foreignKeys.forEach(a=>{let c=this.connection.namingStrategy.foreignKeyName(r,a.columnNames,this.getTablePath(a),a.referencedColumnNames);a.name===c&&(a.name=this.connection.namingStrategy.foreignKeyName(n,a.columnNames,this.getTablePath(a),a.referencedColumnNames))}),n.indices.forEach(a=>{let c=this.connection.namingStrategy.indexName(r,a.columnNames,a.where);a.name===c&&(a.name=this.connection.namingStrategy.indexName(n,a.columnNames,a.where))}),r.name=n.name,await this.recreateTable(n,r)}async addColumn(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);return this.addColumns(r,[t])}async addColumns(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.addColumn(i)),await this.recreateTable(n,r)}async renameColumn(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=x.isTableColumn(t)?t:n.columns.find(a=>a.name===t);if(!i)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);let s;return x.isTableColumn(r)?s=r:(s=i.clone(),s.name=r),this.changeColumn(n,i,s)}async changeColumn(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=x.isTableColumn(t)?t:n.columns.find(s=>s.name===t);if(!i)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);await this.changeColumns(n,[{oldColumn:i,newColumn:r}])}async changeColumns(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>{i.newColumn.name!==i.oldColumn.name&&(n.findColumnUniques(i.oldColumn).forEach(a=>{let c=this.connection.namingStrategy.uniqueConstraintName(r,a.columnNames);a.columnNames.splice(a.columnNames.indexOf(i.oldColumn.name),1),a.columnNames.push(i.newColumn.name),a.name===c&&(a.name=this.connection.namingStrategy.uniqueConstraintName(n,a.columnNames))}),n.findColumnForeignKeys(i.oldColumn).forEach(a=>{let c=this.connection.namingStrategy.foreignKeyName(r,a.columnNames,this.getTablePath(a),a.referencedColumnNames);a.columnNames.splice(a.columnNames.indexOf(i.oldColumn.name),1),a.columnNames.push(i.newColumn.name),a.name===c&&(a.name=this.connection.namingStrategy.foreignKeyName(n,a.columnNames,this.getTablePath(a),a.referencedColumnNames))}),n.findColumnIndices(i.oldColumn).forEach(a=>{let c=this.connection.namingStrategy.indexName(r,a.columnNames,a.where);a.columnNames.splice(a.columnNames.indexOf(i.oldColumn.name),1),a.columnNames.push(i.newColumn.name),a.name===c&&(a.name=this.connection.namingStrategy.indexName(n,a.columnNames,a.where))}));let s=n.columns.find(a=>a.name===i.oldColumn.name);s&&(n.columns[n.columns.indexOf(s)]=i.newColumn)}),await this.recreateTable(n,r)}async dropColumn(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableColumn(t)?t:r.findColumnByName(t);if(!n)throw new y(`Column "${t}" was not found in table "${r.name}"`);await this.dropColumns(r,[n])}async dropColumns(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>{let s=x.isTableColumn(i)?i:r.findColumnByName(i);if(!s)throw new Error(`Column "${i}" was not found in table "${r.name}"`);n.removeColumn(s),n.findColumnUniques(s).forEach(a=>n.removeUniqueConstraint(a)),n.findColumnIndices(s).forEach(a=>n.removeIndex(a)),n.findColumnForeignKeys(s).forEach(a=>n.removeForeignKey(a))}),await this.recreateTable(n,r)}async createPrimaryKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();n.columns.forEach(i=>{t.find(s=>s===i.name)&&(i.isPrimary=!0)}),await this.recreateTable(n,r),r.columns.forEach(i=>{t.find(s=>s===i.name)&&(i.isPrimary=!0)})}async updatePrimaryKeys(e,t){await Promise.resolve()}async dropPrimaryKey(e){let t=x.isTable(e)?e:await this.getCachedTable(e),r=t.clone();r.primaryColumns.forEach(n=>{n.isPrimary=!1}),await this.recreateTable(r,t),t.primaryColumns.forEach(n=>{n.isPrimary=!1})}async createUniqueConstraint(e,t){await this.createUniqueConstraints(e,[t])}async createUniqueConstraints(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.addUniqueConstraint(i)),await this.recreateTable(n,r)}async dropUniqueConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableUnique(t)?t:r.uniques.find(i=>i.name===t);if(!n)throw new y(`Supplied unique constraint was not found in table ${r.name}`);await this.dropUniqueConstraints(r,[n])}async dropUniqueConstraints(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.removeUniqueConstraint(i)),await this.recreateTable(n,r)}async createCheckConstraint(e,t){await this.createCheckConstraints(e,[t])}async createCheckConstraints(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.addCheckConstraint(i)),await this.recreateTable(n,r)}async dropCheckConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableCheck(t)?t:r.checks.find(i=>i.name===t);if(!n)throw new y(`Supplied check constraint was not found in table ${r.name}`);await this.dropCheckConstraints(r,[n])}async dropCheckConstraints(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.removeCheckConstraint(i)),await this.recreateTable(n,r)}async createExclusionConstraint(e,t){throw new y("Sqlite does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new y("Sqlite does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new y("Sqlite does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new y("Sqlite does not support exclusion constraints.")}async createForeignKey(e,t){await this.createForeignKeys(e,[t])}async createForeignKeys(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.addForeignKey(i)),await this.recreateTable(n,r)}async dropForeignKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableForeignKey(t)?t:r.foreignKeys.find(i=>i.name===t);if(!n)throw new y(`Supplied foreign key was not found in table ${r.name}`);await this.dropForeignKeys(e,[n])}async dropForeignKeys(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone();t.forEach(i=>n.removeForeignKey(i)),await this.recreateTable(n,r)}async createIndex(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(r,t));let n=this.createIndexSql(r,t),i=this.dropIndexSql(t);await this.executeQueries(n,i),r.addIndex(t)}async createIndices(e,t){let r=t.map(n=>this.createIndex(e,n));await Promise.all(r)}async dropIndex(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableIndex(t)?t:r.indices.find(a=>a.name===t);if(!n)throw new y(`Supplied index ${t} was not found in table ${r.name}`);n.name||(n.name=this.generateIndexName(r,n));let i=this.dropIndexSql(n),s=this.createIndexSql(r,n);await this.executeQueries(i,s),r.removeIndex(n)}async dropIndices(e,t){let r=t.map(n=>this.dropIndex(e,n));await Promise.all(r)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)}`)}async clearDatabase(e){let t;e&&this.driver.getAttachedDatabaseHandleByRelativePath(e)&&(t=this.driver.getAttachedDatabaseHandleByRelativePath(e)),await this.query("PRAGMA foreign_keys = OFF");let r=this.isTransactionActive;r||await this.startTransaction();try{let n=t?`SELECT 'DROP VIEW "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'view'`:`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`,i=await this.query(n);await Promise.all(i.map(c=>this.query(c.query)));let s=t?`SELECT 'DROP TABLE "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`:`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`,a=await this.query(s);await Promise.all(a.map(c=>this.query(c.query))),r||await this.commitTransaction()}catch(n){try{r||await this.rollbackTransaction()}catch{}throw n}finally{await this.query("PRAGMA foreign_keys = ON")}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);let r=e.map(s=>"'"+s+"'").join(", "),n=`SELECT "t".* FROM "${this.getTypeormMetadataTableName()}" "t" INNER JOIN "sqlite_master" s ON "s"."name" = "t"."name" AND "s"."type" = 'view' WHERE "t"."type" = '${ce.VIEW}'`;return r.length>0&&(n+=` AND "t"."name" IN (${r})`),(await this.query(n)).map(s=>{let a=new Tt;return a.name=s.name,a.expression=s.value,a})}async loadTableRecords(e,t){let r,[n,i]=this.splitTablePath(e);return n&&this.driver.getAttachedDatabasePathRelativeByHandle(n)&&(r=this.driver.getAttachedDatabasePathRelativeByHandle(n)),this.query(`SELECT ${r?`'${r}'`:null} as database, ${n?`'${n}'`:null} as schema, * FROM ${n?`"${n}".`:""}${this.escapePath("sqlite_master")} WHERE "type" = '${t}' AND "${t==="table"?"name":"tbl_name"}" IN ('${i}')`)}async loadPragmaRecords(e,t){let[,r]=this.splitTablePath(e);return this.query(`PRAGMA ${t}("${r}")`)}async loadTables(e){if(e&&e.length===0)return[];let t=[],r;if(e){let n=e.filter(a=>a.split(".").length===1).map(a=>`'${a}'`),i=e.filter(a=>a.split(".").length>1),s=a=>{let c=[...i.map(u=>this.loadTableRecords(u,a))];return n.length&&c.push(this.query(`SELECT * FROM "sqlite_master" WHERE "type" = '${a}' AND "${a==="table"?"name":"tbl_name"}" IN (${n})`)),c};t=(await Promise.all(s("table"))).reduce((a,c)=>[...a,...c],[]).filter(Boolean),r=(await Promise.all(s("index"))).reduce((a,c)=>[...a,...c],[]).filter(Boolean)}else{t.push(...await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'table'`));let i=t.map(({name:s})=>`'${s}'`).join(", ");r=await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN (${i})`)}return t.length===0?[]:Promise.all(t.map(async n=>{let i=n.database&&this.driver.getAttachedDatabaseHandleByRelativePath(n.database)?`${this.driver.getAttachedDatabaseHandleByRelativePath(n.database)}.${n.name}`:n.name,s=n.sql,a=s.includes("WITHOUT ROWID"),c=new Me({name:i,withoutRowid:a}),[u,l,h]=await Promise.all([this.loadPragmaRecords(i,"table_xinfo"),this.loadPragmaRecords(i,"index_list"),this.loadPragmaRecords(i,"foreign_key_list")]),p,d=n.sql,m=d.toUpperCase().indexOf("AUTOINCREMENT");if(m!==-1){p=d.substr(0,m);let S=p.lastIndexOf(","),$=p.lastIndexOf("(");S!==-1?(p=p.substr(S),p=p.substr(0,p.lastIndexOf('"')),p=p.substr(p.indexOf('"')+1)):$!==-1&&(p=p.substr($),p=p.substr(0,p.lastIndexOf('"')),p=p.substr(p.indexOf('"')+1))}c.columns=await Promise.all(u.map(async S=>{let $=new We;if($.name=S.name,$.type=S.type.toLowerCase(),$.default=S.dflt_value!==null&&S.dflt_value!==void 0?S.dflt_value:void 0,$.isNullable=S.notnull===0,$.isPrimary=S.pk>0,$.comment="",$.isGenerated=p===S.name,$.isGenerated&&($.generationStrategy="increment"),S.hidden===2||S.hidden===3){$.generatedType=S.hidden===2?"VIRTUAL":"STORED";let w=this.selectTypeormMetadataSql({table:c.name,type:ce.GENERATED_COLUMN,name:$.name}),P=await this.query(w.query,w.parameters);P[0]&&P[0].value?$.asExpression=P[0].value:$.asExpression=""}$.type==="varchar"&&($.enum=K.parseSqlCheckExpression(s,$.name));let T=$.type.indexOf("(");if(T!==-1){let w=$.type,P=w.substr(0,T);if(this.driver.withLengthColumnTypes.find(v=>v===P)){let v=parseInt(w.substring(T+1,w.length-1));v&&($.length=v.toString(),$.type=P)}if(this.driver.withPrecisionColumnTypes.find(v=>v===P)){let v=new RegExp(`^${P}\\((\\d+),?\\s?(\\d+)?\\)`),D=w.match(v);D&&D[1]&&($.precision=+D[1]),this.driver.withScaleColumnTypes.find(j=>j===P)&&D&&D[2]&&($.scale=+D[2]),$.type=P}}return $}));let f,A=[],R=/CONSTRAINT "([^"]*)" FOREIGN KEY ?\((.*?)\) REFERENCES "([^"]*)"/g;for(;(f=R.exec(s))!==null;)A.push({name:f[1],columns:f[2].substr(1,f[2].length-2).split('", "'),referencedTableName:f[3]});let I=K.uniq(h,S=>S.id);c.foreignKeys=I.map(S=>{let $=h.filter(v=>v.id===S.id&&v.table===S.table),T=$.map(v=>v.from),w=$.map(v=>v.to),P=A.find(v=>v.referencedTableName===S.table&&v.columns.every(D=>T.indexOf(D)!==-1));return new Ye({name:P?.name,columnNames:T,referencedTableName:S.table,referencedColumnNames:w,onDelete:S.on_delete,onUpdate:S.on_update})});let C,U=[],J=/CONSTRAINT "([^"]*)" UNIQUE ?\((.*?)\)/g;for(;(C=J.exec(s))!==null;)U.push({name:C[1],columns:C[2].substr(1,C[2].length-2).split('", "')});let ne=l.filter(S=>S.origin==="u").map(S=>S.name).filter((S,$,T)=>T.indexOf(S)===$).map(async S=>{let $=l.find(v=>v.name===S),w=(await this.query(`PRAGMA index_info("${$.name}")`)).sort((v,D)=>parseInt(v.seqno)-parseInt(D.seqno)).map(v=>v.name);if(w.length===1){let v=c.columns.find(D=>!!w.find(j=>j===D.name));v&&(v.isUnique=!0)}let P=U.find(v=>v.columns.every(D=>w.indexOf(D)!==-1));return new Ve({name:P?P.name:this.connection.namingStrategy.uniqueConstraintName(c,w),columnNames:w})});c.uniques=await Promise.all(ne);let oe,z=/CONSTRAINT "([^"]*)" CHECK ?(\(.*?\))([,]|[)]$)/g;for(;(oe=z.exec(s))!==null;)c.checks.push(new pt({name:oe[1],expression:oe[2]}));let O=l.filter(S=>S.origin==="c").map(S=>S.name).filter((S,$,T)=>T.indexOf(S)===$).map(async S=>{let $=r.find(Z=>Z.name===S),T=/WHERE (.*)/.exec($.sql),w=l.find(Z=>Z.name===S),v=(await this.query(`PRAGMA index_info("${w.name}")`)).sort((Z,se)=>parseInt(Z.seqno)-parseInt(se.seqno)).map(Z=>Z.name),D=`${n.database?`${n.database}.`:""}${w.name}`,j=w.unique==="1"||w.unique===1;return new Oe({table:c,name:D,columnNames:v,isUnique:j,where:T?T[1]:void 0})}),he=await Promise.all(O);return c.indices=he.filter(S=>!!S),c}))}createTableSql(e,t,r){let n=e.columns.filter(d=>d.isPrimary),i=n.find(d=>d.isGenerated&&d.generationStrategy==="increment"),s=n.length>1;if(s&&i)throw new y("Sqlite does not support AUTOINCREMENT on composite primary key");let a=e.columns.map(d=>this.buildCreateColumnSql(d,s)).join(", "),[c]=this.splitTablePath(e.name),u=`CREATE TABLE ${this.escapePath(e.name)} (${a}`,[l,h]=this.splitTablePath(e.name),p=r?`${l?`${l}.`:""}${h.replace(/^temporary_/,"")}`:e.name;if(e.columns.filter(d=>d.isUnique).forEach(d=>{e.uniques.some(f=>f.columnNames.length===1&&f.columnNames[0]===d.name)||e.uniques.push(new Ve({name:this.connection.namingStrategy.uniqueConstraintName(e,[d.name]),columnNames:[d.name]}))}),e.uniques.length>0){let d=e.uniques.map(m=>{let f=m.name?m.name:this.connection.namingStrategy.uniqueConstraintName(p,m.columnNames),A=m.columnNames.map(R=>`"${R}"`).join(", ");return`CONSTRAINT "${f}" UNIQUE (${A})`}).join(", ");u+=`, ${d}`}if(e.checks.length>0){let d=e.checks.map(m=>`CONSTRAINT "${m.name?m.name:this.connection.namingStrategy.checkConstraintName(p,m.expression)}" CHECK (${m.expression})`).join(", ");u+=`, ${d}`}if(e.foreignKeys.length>0&&t){let d=e.foreignKeys.filter(m=>{let[f]=this.splitTablePath(m.referencedTableName);return f===c}).map(m=>{let[,f]=this.splitTablePath(m.referencedTableName),A=m.columnNames.map(C=>`"${C}"`).join(", ");m.name||(m.name=this.connection.namingStrategy.foreignKeyName(p,m.columnNames,this.getTablePath(m),m.referencedColumnNames));let R=m.referencedColumnNames.map(C=>`"${C}"`).join(", "),I=`CONSTRAINT "${m.name}" FOREIGN KEY (${A}) REFERENCES "${f}" (${R})`;return m.onDelete&&(I+=` ON DELETE ${m.onDelete}`),m.onUpdate&&(I+=` ON UPDATE ${m.onUpdate}`),m.deferrable&&(I+=` DEFERRABLE ${m.deferrable}`),I}).join(", ");u+=`, ${d}`}if(n.length>1){let d=n.map(m=>`"${m.name}"`).join(", ");u+=`, PRIMARY KEY (${d})`}return u+=")",e.withoutRowid&&(u+=" WITHOUT ROWID"),new b(u)}dropTableSql(e,t){let r=x.isTable(e)?e.name:e,n=t?`DROP TABLE IF EXISTS ${this.escapePath(r)}`:`DROP TABLE ${this.escapePath(r)}`;return new b(n)}createViewSql(e){return typeof e.expression=="string"?new b(`CREATE VIEW "${e.name}" AS ${e.expression}`):new b(`CREATE VIEW "${e.name}" AS ${e.expression(this.connection).getQuery()}`)}insertViewDefinitionSql(e){let t=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:ce.VIEW,name:e.name,value:t})}dropViewSql(e){let t=x.isView(e)?e.name:e;return new b(`DROP VIEW "${t}"`)}deleteViewDefinitionSql(e){let t=x.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:ce.VIEW,name:t})}createIndexSql(e,t){let r=t.columnNames.map(s=>`"${s}"`).join(", "),[n,i]=this.splitTablePath(e.name);return new b(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX ${n?`"${n}".`:""}${this.escapePath(t.name)} ON "${i}" (${r}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e){let t=x.isTableIndex(e)?e.name:e;return new b(`DROP INDEX ${this.escapePath(t)}`)}buildCreateColumnSql(e,t){let r='"'+e.name+'"';return x.isColumnMetadata(e)?r+=" "+this.driver.normalizeType(e):r+=" "+this.connection.driver.createFullType(e),e.enum&&(r+=' CHECK( "'+e.name+'" IN ('+e.enum.map(n=>"'"+n+"'").join(",")+") )"),e.isPrimary&&!t&&(r+=" PRIMARY KEY"),e.isGenerated===!0&&e.generationStrategy==="increment"&&(r+=" AUTOINCREMENT"),e.collation&&(r+=" COLLATE "+e.collation),e.isNullable!==!0&&(r+=" NOT NULL"),e.asExpression?r+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`:e.default!==void 0&&e.default!==null&&(r+=" DEFAULT ("+e.default+")"),r}async recreateTable(e,t,r=!0){let n=[],i=[];t.indices.forEach(u=>{n.push(this.dropIndexSql(u)),i.push(this.createIndexSql(t,u))});let[s,a]=this.splitTablePath(e.name),[,c]=this.splitTablePath(t.name);if(e.name=a=`${s?`${s}.`:""}temporary_${a}`,n.push(this.createTableSql(e,!0,!0)),i.push(this.dropTableSql(e)),r){let u=e.columns.filter(h=>!h.generatedType).map(h=>`"${h.name}"`),l=t.columns.filter(h=>!h.generatedType).map(h=>`"${h.name}"`);l.length<u.length?u=e.columns.filter(h=>{let p=t.columns.find(d=>d.name===h.name);return p&&p.generatedType?!1:!h.generatedType&&p}).map(h=>`"${h.name}"`):l.length>u.length&&(l=t.columns.filter(h=>!h.generatedType&&e.columns.find(p=>p.name===h.name)).map(h=>`"${h.name}"`)),n.push(new b(`INSERT INTO ${this.escapePath(e.name)}(${u.join(", ")}) SELECT ${l.join(", ")} FROM ${this.escapePath(t.name)}`)),i.push(new b(`INSERT INTO ${this.escapePath(t.name)}(${l.join(", ")}) SELECT ${u.join(", ")} FROM ${this.escapePath(e.name)}`))}n.push(this.dropTableSql(t)),i.push(this.createTableSql(t,!0)),n.push(new b(`ALTER TABLE ${this.escapePath(e.name)} RENAME TO ${this.escapePath(c)}`)),i.push(new b(`ALTER TABLE ${this.escapePath(t.name)} RENAME TO ${this.escapePath(a)}`)),e.name=t.name,e.indices.forEach(u=>{u.name||(u.name=this.connection.namingStrategy.indexName(e,u.columnNames,u.where)),n.push(this.createIndexSql(e,u)),i.push(this.dropIndexSql(u))}),t.columns.filter(u=>{let l=e.columns.find(h=>h.name===u.name);return u.generatedType&&u.asExpression&&(!l||!l.generatedType&&!l.asExpression)}).forEach(u=>{let l=this.deleteTypeormMetadataSql({table:t.name,type:ce.GENERATED_COLUMN,name:u.name}),h=this.insertTypeormMetadataSql({table:t.name,type:ce.GENERATED_COLUMN,name:u.name,value:u.asExpression});n.push(l),i.push(h)}),e.columns.filter(u=>u.generatedType&&u.asExpression&&!t.columns.some(l=>l.name===u.name)).forEach(u=>{let l=this.insertTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:u.name,value:u.asExpression}),h=this.deleteTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:u.name});n.push(l),i.push(h)}),e.columns.filter(u=>u.generatedType&&u.asExpression).forEach(u=>{let l=t.columns.find(f=>f.name===u.name&&f.generatedType&&u.generatedType&&f.asExpression!==u.asExpression);if(!l)return;let h=this.deleteTypeormMetadataSql({table:t.name,type:ce.GENERATED_COLUMN,name:l.name}),p=this.insertTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:u.name,value:u.asExpression});n.push(h),n.push(p);let d=this.insertTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:l.name,value:l.asExpression}),m=this.deleteTypeormMetadataSql({table:t.name,type:ce.GENERATED_COLUMN,name:u.name});i.push(d),i.push(m)}),await this.executeQueries(n,i),this.replaceCachedTable(t,e)}splitTablePath(e){return e.indexOf(".")!==-1?e.split("."):[void 0,e]}escapePath(e,t){return(x.isTable(e)||x.isView(e)?e.name:e).replace(/^\.+|\.+$/g,"").split(".").map(n=>t?n:`"${n}"`).join(".")}changeTableComment(e,t){throw new y("sqlit driver does not support change comment.")}};var mo=class extends st{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);let i=new _e,s=Date.now();try{let a=await new Promise((p,d)=>{n.executeSql(e,t,m=>p(m),m=>d(m))}),c=this.driver.options.maxQueryExecutionTime,l=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,l,a,void 0),c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);let h=new Le;if(e.substr(0,11)==="INSERT INTO")h.raw=a.insertId;else{let p=[];for(let d=0;d<a.rows.length;d++)p.push(a.rows.item(d));h.records=p,h.raw=p}return r?h:h.raw}catch(a){throw this.driver.connection.logger.logQueryError(a,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,a),new Qe(e,t,a)}finally{await i.wait()}}async startTransaction(){throw new y("Transactions are not supported by the Cordova driver")}async commitTransaction(){throw new y("Transactions are not supported by the Cordova driver")}async rollbackTransaction(){throw new y("Transactions are not supported by the Cordova driver")}async clearDatabase(){await this.query("PRAGMA foreign_keys = OFF");try{let t=await this.query(`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`),n=await this.query(`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`);await Promise.all(t.map(i=>this.query(i.query))),await Promise.all(n.map(i=>this.query(i.query)))}finally{await this.query("PRAGMA foreign_keys = ON")}}parametrize(e,t=0){return Object.keys(e).map((r,n)=>`"${r}"=?`)}};var fo=class extends Nt{constructor(e){super(e),this.transactionSupport="none",this.database=this.options.database,this.loadDependencies()}async disconnect(){return this.queryRunner=void 0,new Promise((e,t)=>{this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new mo(this)),this.queryRunner}async createDatabaseConnection(){let e=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{}),t=await new Promise((r,n)=>{this.sqlite.openDatabase(e,i=>r(i),i=>n(i))});return await new Promise((r,n)=>{t.executeSql("PRAGMA foreign_keys = ON",[],()=>r(),i=>n(i))}),t}loadDependencies(){try{let e=this.options.driver||window.sqlitePlugin;this.sqlite=e}catch{throw new wt("Cordova-SQLite","cordova-sqlite-storage")}}};var yo=class extends st{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);let i=new _e,s=Date.now();return new Promise(async(a,c)=>{try{n.executeSql(e,t,async u=>{let l=this.driver.options.maxQueryExecutionTime,p=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,p,u,void 0),l&&p>l&&this.driver.connection.logger.logQuerySlow(p,e,t,this),i.promises.length>0&&await Promise.all(i.promises);let d=new Le;if(u?.hasOwnProperty("rowsAffected")&&(d.affected=u.rowsAffected),u?.hasOwnProperty("rows")){let m=[];for(let f=0;f<u.rows.length;f++)m.push(u.rows.item(f));d.raw=m,d.records=m}e.substr(0,11)==="INSERT INTO"&&(d.raw=u.insertId),a(r?d:d.raw)},u=>{this.driver.connection.logger.logQueryError(u,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,u),c(new Qe(e,t,u))})}catch(u){c(u)}finally{await i.wait()}})}parametrize(e,t=0){return Object.keys(e).map((r,n)=>`"${r}"=?`)}};var go=class{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime"],this.supportedUpsertTypes=["on-conflict-do-update"],this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=this.options.database,this.loadDependencies()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new yo(this)),this.queryRunner}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(e,t)})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new Vt(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=ve.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?re.mixedDateToDateString(e):t.type==="time"?re.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?re.mixedDateToUtcDatetimeString(e):t.type==="simple-array"?re.simpleArrayToString(e):t.type==="simple-json"?re.simpleJsonToString(e):t.type==="simple-enum"?re.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?ve.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=re.normalizeHydratedDate(e)):t.type==="date"?e=re.mixedDateToDateString(e):t.type==="time"?e=re.mixedTimeToString(e):t.type==="simple-array"?e=re.stringToSimpleArray(e):t.type==="simple-json"?e=re.stringToSimpleJson(e):t.type==="simple-enum"?e=re.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ve.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,r){let n=Object.keys(r).map(i=>typeof r[i]=="boolean"?r[i]===!0?1:0:r[i]instanceof Date?re.mixedDateToUtcDatetimeString(r[i]):r[i]);return!t||!Object.keys(t).length?[e,n]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,s,a)=>{if(!t.hasOwnProperty(a))return i;let c=t[a];return s?c.map(u=>(n.push(u),this.createParameter(a,n.length-1))).join(", "):typeof c=="function"?c():typeof c=="number"?String(c):typeof c=="boolean"?(n.push(+c),this.createParameter(a,n.length-1)):c instanceof Date?(n.push(re.mixedDateToUtcDatetimeString(c)),this.createParameter(a,n.length-1)):(n.push(c),this.createParameter(a,n.length-1))}),[e,n])}escape(e){return'"'+e+'"'}buildTableName(e,t,r){return e}parseTableName(e){let t=this.database,r=void 0;if(x.isTable(e)||x.isView(e)){let i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||r,tableName:i.tableName}}if(x.isTableForeignKey(e)){let i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||r,tableName:i.tableName}}if(x.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||r,tableName:e.tableName};let n=e.split(".");return n.length===3?{database:n[0]||t,schema:n[1]||r,tableName:n[2]}:n.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(n[0])??t,schema:n[0],tableName:n[1]}:{database:t,schema:r,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){let t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,r,n){let i=e.generatedColumns.reduce((s,a)=>{let c;return a.generationStrategy==="increment"&&t&&(c=t-n+r+1),c?K.mergeDeep(s,a.createValueMap(c)):s},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(r=>{let n=e.find(s=>s.name===r.databaseName);return n?n.name!==r.databaseName||n.type!==this.normalizeType(r)||n.length!==r.length||n.precision!==r.precision||n.scale!==r.scale||this.normalizeDefault(r)!==n.default||n.isPrimary!==r.isPrimary||n.isNullable!==r.isNullable||n.generatedType!==r.generatedType||n.asExpression!==r.asExpression||n.isUnique!==this.normalizeIsUnique(r)||n.enum&&r.enum&&!K.isArraysEqual(n.enum,r.enum.map(s=>s+""))||r.generationStrategy!=="uuid"&&n.isGenerated!==r.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}createDatabaseConnection(){return new Promise((e,t)=>{let r=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{});this.sqlite.openDatabase(r,n=>{let i=n;i.executeSql("PRAGMA foreign_keys = ON",[],s=>{e(i)},s=>{t(s)})},n=>{t(n)})})}loadDependencies(){try{let e=this.options.driver||hi("react-native-sqlite-storage");this.sqlite=e}catch{throw new wt("React-Native","react-native-sqlite-storage")}}};var Eo=class extends st{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=this.driver.connection,i=await this.connect();return new Promise((s,a)=>{let c=e.substr(0,11)==="INSERT INTO";n.logger.logQuery(e,t,this);let u=(h,p)=>{let d=this.driver.options.maxQueryExecutionTime,f=Date.now()-l;d&&f>d&&n.logger.logQuerySlow(f,e,t,this),h&&(n.logger.logQueryError(h,e,t,this),a(new Qe(e,t,h)));let A=new Le;A.raw=p,!c&&Array.isArray(p)&&(A.records=p),s(r?A:A.raw)},l=Date.now();c?i.execSQL(e,t,u):i.all(e,t,u)})}parametrize(e,t=0){return Object.keys(e).map((r,n)=>`"${r}"=?`)}};var To=class extends Nt{constructor(e){super(e),this.connection=e,this.options=e.options,this.database=this.options.database,this.driver=this.options.driver,this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close().then(e).catch(t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Eo(this)),this.queryRunner}normalizeType(e){return e.type===Buffer?"blob":super.normalizeType(e)}createDatabaseConnection(){return new Promise((e,t)=>{let r=Object.assign({},{readOnly:this.options.readOnly,key:this.options.key,multithreading:this.options.multithreading,migrate:this.options.migrate,iosFlags:this.options.iosFlags,androidFlags:this.options.androidFlags},this.options.extra||{});new this.sqlite(this.options.database,r,(n,i)=>{if(n)return t(n);i.resultType(this.sqlite.RESULTSASOBJECT),i.execSQL("PRAGMA foreign_keys = ON",[],(s,a)=>{if(s)return t(s);e(i)})})})}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new wt("Nativescript","nativescript-sqlite")}};var bo=class extends st{constructor(e){super(),this.isDirty=!1,this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async flush(){this.isDirty&&(await this.driver.autoSave(),this.isDirty=!1)}async release(){return await this.flush(),super.release()}async commitTransaction(){await super.commitTransaction(),this.isTransactionActive||await this.flush()}async query(e,t=[],r=!1){if(this.isReleased)throw new Pe;let n=e.trim().split(" ",1)[0],i=this.driver.databaseConnection;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);let s=new _e,a=Date.now(),c;try{c=i.prepare(e),t&&(t=t.map(m=>typeof m<"u"?m:null),c.bind(t));let u=this.driver.options.maxQueryExecutionTime,h=Date.now()-a;u&&h>u&&this.driver.connection.logger.logQuerySlow(h,e,t,this);let p=[];for(;c.step();)p.push(c.getAsObject());this.broadcaster.broadcastAfterQueryEvent(s,e,t,!0,h,p,void 0);let d=new Le;return d.affected=i.getRowsModified(),d.records=p,d.raw=p,c.free(),n!=="SELECT"&&(this.isDirty=!0),r?d:d.raw}catch(u){throw c&&c.free(),this.driver.connection.logger.logQueryError(u,e,t,this),this.broadcaster.broadcastAfterQueryEvent(s,e,t,!1,void 0,void 0,u),new Qe(e,t,u)}finally{await s.wait()}}};var El=It(Na());var ge=class{static getGlobalVariable(){return typeof window<"u"?window:globalThis}static load(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: require("${e}").`);return""}static pathNormalize(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.normalize("${e}").`);return""}static pathExtname(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.extname("${e}").`);return""}static pathResolve(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: path.resolve("${e}").`);return""}static fileExist(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.existsSync("${e}").`);return!1}static dotenv(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: dotenv.config({ path: "${e}" }).`)}static getEnvVariable(e){}static readFileSync(e){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.readFileSync("${e}").`);return null}static appendFileSync(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.appendFileSync("${e}").`)}static writeFile(e,t){if(this.type==="browser")throw new Error(`This option/function is not supported in the browser environment. Failed operation: fs.writeFile("${e}").`);return Promise.reject(null)}static highlightSql(e){return e}static logInfo(e,t){console.info(e+" ",t)}static logError(e,t){console.error(e+" ",t)}static logWarn(e,t){console.warn(e+" ",t)}static log(e){console.log(e)}static warn(e){return e}};ge.type="browser";typeof window<"u"&&(window.Buffer=El.Buffer);typeof globalThis<"u"&&(globalThis.Buffer=El.Buffer);typeof globalThis<"u"&&typeof hi<"u"&&(globalThis.Buffer=Na().Buffer);var wo=class extends Nt{constructor(e){if(super(e),this.options.autoSave&&!this.options.location&&!this.options.autoSaveCallback)throw new no("location or autoSaveCallback");this.loadDependencies()}async connect(){this.databaseConnection=await this.createDatabaseConnection()}async disconnect(){this.queryRunner=void 0,this.databaseConnection.close()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new bo(this)),this.queryRunner}async load(e,t=!0){if(typeof e=="string")if(ge.type==="node")if(ge.fileExist(e)){let r=ge.readFileSync(e);return this.createDatabaseConnectionWithImport(r)}else{if(t)throw new y(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else{let r=null;if(this.options.useLocalForage)if(window.localforage)r=await window.localforage.getItem(e);else throw new y("localforage is not defined - please import localforage.js into your site");else r=ge.getGlobalVariable().localStorage.getItem(e);if(r!=null)return this.createDatabaseConnectionWithImport(JSON.parse(r));if(t)throw new y(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else return this.createDatabaseConnectionWithImport(e)}async save(e){if(!e&&!this.options.location)throw new y("No location is set, specify a location parameter or add the location option to your configuration");let t="";if(e?t=e:this.options.location&&(t=this.options.location),ge.type==="node")try{let r=Buffer.from(this.databaseConnection.export());await ge.writeFile(t,r)}catch(r){throw new y(`Could not save database, error: ${r}`)}else{let r=this.databaseConnection.export(),n=[].slice.call(r);if(this.options.useLocalForage)if(window.localforage)await window.localforage.setItem(t,JSON.stringify(n));else throw new y("localforage is not defined - please import localforage.js into your site");else ge.getGlobalVariable().localStorage.setItem(t,JSON.stringify(n))}}async autoSave(){this.options.autoSave&&!this.queryRunner?.isTransactionActive&&(this.options.autoSaveCallback?await this.options.autoSaveCallback(this.export()):await this.save())}export(){return this.databaseConnection.export()}createGeneratedMap(e,t){let r=e.generatedColumns.reduce((n,i)=>{if(i.isPrimary&&i.generationStrategy==="increment"){let s="SELECT last_insert_rowid()";try{let a=this.databaseConnection.exec(s);return this.connection.logger.logQuery(s),K.mergeDeep(n,i.createValueMap(a[0].values[0][0]))}catch(a){this.connection.logger.logQueryError(a,s,[])}}return n},{});return Object.keys(r).length>0?r:void 0}createDatabaseConnection(){return this.options.location?this.load(this.options.location,!1):this.createDatabaseConnectionWithImport(this.options.database)}async createDatabaseConnectionWithImport(e){let r=typeof this.sqlite.Database=="function"?this.sqlite:await this.sqlite(this.options.sqlJsConfig);return e&&e.length>0?this.databaseConnection=new r.Database(e):this.databaseConnection=new r.Database,this.databaseConnection.exec("PRAGMA foreign_keys = ON"),this.databaseConnection}loadDependencies(){if(ge.type==="browser"){let e=this.options.driver||window.SQL;this.sqlite=e}else try{let e=this.options.driver||ge.load("sql.js");this.sqlite=e}catch{throw new wt("sql.js","sql.js")}}};var No=class extends st{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.connect(),i=new _e;this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);let s=Date.now(),a=await n.prepareAsync(e);try{let c=await a.executeAsync(t),u=this.driver.options.maxQueryExecutionTime,h=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,h,c,void 0),await i.wait(),u&&h>u&&this.driver.connection.logger.logQuerySlow(h,e,t,this);let p=new Le;return p.affected=c.changes,p.records=await c.getAllAsync(),p.raw=e.startsWith("INSERT INTO")?c.lastInsertRowId:p.records,r?p:p.raw}catch(c){throw this.driver.connection.logger.logQueryError(c,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,0,void 0,c),await i.wait(),new Qe(e,t,c)}finally{await i.wait(),await a.finalizeAsync()}}};var Ao=class extends Nt{constructor(e){super(e),this.sqlite=this.options.driver}async disconnect(){this.queryRunner=void 0,await this.databaseConnection.closeAsync(),this.databaseConnection=void 0}createQueryRunner(){return this.queryRunner||(this.queryRunner=new No(this)),this.queryRunner}async createDatabaseConnection(){return this.databaseConnection=await this.sqlite.openDatabaseAsync(this.options.database),await this.databaseConnection.runAsync("PRAGMA foreign_keys = ON"),this.databaseConnection}};var xo=class extends st{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async startTransaction(){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(e){throw this.isTransactionActive=!1,e}this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive&&typeof this.transaction>"u")throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transaction=void 0,this.isTransactionActive=!1,this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async beforeMigration(){let e=await this.connect();return new Promise((t,r)=>{e.exec([{sql:"PRAGMA foreign_keys = OFF",args:[]}],!1,n=>n?r(n):t())})}async afterMigration(){let e=await this.connect();return new Promise((t,r)=>{e.exec([{sql:"PRAGMA foreign_keys = ON",args:[]}],!1,n=>n?r(n):t())})}async query(e,t,r=!1){if(this.isReleased)throw new Pe;return new Promise(async(n,i)=>{let s=await this.connect(),a=new _e;this.driver.connection.logger.logQuery(e,t,this),this.broadcaster.broadcastBeforeQueryEvent(a,e,t);let c=Date.now();s.transaction(async u=>{typeof this.transaction>"u"&&(await this.startTransaction(),this.transaction=u),this.transaction.executeSql(e,t,async(l,h)=>{let p=this.driver.options.maxQueryExecutionTime,m=Date.now()-c;this.broadcaster.broadcastAfterQueryEvent(a,e,t,!0,m,h,void 0),await a.wait(),p&&m>p&&this.driver.connection.logger.logQuerySlow(m,e,t,this);let f=new Le;if(h?.hasOwnProperty("rowsAffected")&&(f.affected=h.rowsAffected),h?.hasOwnProperty("rows")){let A=[];for(let R=0;R<h.rows.length;R++)A.push(h.rows.item(R));f.raw=A,f.records=A}e.startsWith("INSERT INTO")&&(f.raw=h.insertId),n(r?f:f.raw)},async(l,h)=>{this.driver.connection.logger.logQueryError(h,e,t,this),this.broadcaster.broadcastAfterQueryEvent(a,e,t,!1,void 0,void 0,h),await a.wait(),i(new Qe(e,t,h))})},async u=>{await this.rollbackTransaction(),i(u)},()=>{this.isTransactionActive=!1,this.transaction=void 0})})}};var Co=class extends Nt{constructor(e){super(e),this.database=this.options.database,this.sqlite=this.options.driver}async disconnect(){return new Promise((e,t)=>{try{this.queryRunner=void 0,this.databaseConnection._db.close(),this.databaseConnection=void 0,e()}catch(r){t(r)}})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new xo(this)),this.queryRunner}createDatabaseConnection(){return new Promise((e,t)=>{try{let r=this.sqlite.openDatabase(this.options.database);r.transaction(n=>{n.executeSql("PRAGMA foreign_keys = ON",[],(i,s)=>{e(r)},(i,s)=>{t({transaction:i,error:s})})},n=>{t(n)})}catch(r){t(r)}})}};var Ro=class{constructor(e){this.connection=e}create(){return this.isLegacyDriver?new Co(this.connection):new Ao(this.connection)}get isLegacyDriver(){return!("openDatabaseAsync"in this.connection.options.driver)}};var So=class extends Ht{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.client=t,this.broadcaster=new Be(this)}async connect(){return{}}release(){return this.isReleased=!0,this.databaseConnection&&this.databaseConnection.release(),Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.client.query(e,t),i=new Le;return i.raw=n,n?.hasOwnProperty("records")&&Array.isArray(n.records)&&(i.records=n.records),n?.hasOwnProperty("numberOfRecordsUpdated")&&(i.affected=n.numberOfRecordsUpdated),r?i:i.raw}stream(e,t,r,n){if(this.isReleased)throw new Pe;return new Promise(async(i,s)=>{try{let c=(await this.connect()).query(e,t);r&&c.on("end",r),n&&c.on("error",n),i(c)}catch(a){s(a)}})}async getDatabases(){return Promise.resolve([])}async getSchemas(e){throw new y("MySql driver does not support table schemas")}async hasDatabase(e){return!!(await this.query(`SELECT * FROM \`INFORMATION_SCHEMA\`.\`SCHEMATA\` WHERE \`SCHEMA_NAME\` = '${e}'`)).length}async getCurrentDatabase(){return(await this.query("SELECT DATABASE() AS `db_name`"))[0].db_name}async hasSchema(e){throw new y("MySql driver does not support table schemas")}async getCurrentSchema(){return(await this.query("SELECT SCHEMA() AS `schema_name`"))[0].schema_name}async hasTable(e){let t=this.driver.parseTableName(e),r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${t.database}' AND \`TABLE_NAME\` = '${t.tableName}'`;return!!(await this.query(r)).length}async hasColumn(e,t){let r=this.driver.parseTableName(e),n=x.isTableColumn(t)?t.name:t,i=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_SCHEMA\` = '${r.database}' AND \`TABLE_NAME\` = '${r.tableName}' AND \`COLUMN_NAME\` = '${n}'`;return!!(await this.query(i)).length}async createDatabase(e,t){let r=t?`CREATE DATABASE IF NOT EXISTS \`${e}\``:`CREATE DATABASE \`${e}\``,n=`DROP DATABASE \`${e}\``;await this.executeQueries(new b(r),new b(n))}async dropDatabase(e,t){let r=t?`DROP DATABASE IF EXISTS \`${e}\``:`DROP DATABASE \`${e}\``,n=`CREATE DATABASE \`${e}\``;await this.executeQueries(new b(r),new b(n))}async createSchema(e,t){throw new y("Schema create queries are not supported by MySql driver.")}async dropSchema(e,t){throw new y("Schema drop queries are not supported by MySql driver.")}async createTable(e,t=!1,r=!0){if(t&&await this.hasTable(e))return Promise.resolve();let n=[],i=[];return n.push(this.createTableSql(e,r)),i.push(this.dropTableSql(e)),e.indices.forEach(s=>i.push(this.dropIndexSql(e,s))),r&&e.foreignKeys.forEach(s=>i.push(this.dropForeignKeySql(e,s))),this.executeQueries(n,i)}async dropTable(e,t,r=!0){if(t&&!await this.hasTable(e))return Promise.resolve();let n=r,i=this.getTablePath(e),s=await this.getCachedTable(i),a=[],c=[];r&&s.foreignKeys.forEach(u=>a.push(this.dropForeignKeySql(s,u))),s.indices.forEach(u=>a.push(this.dropIndexSql(s,u))),a.push(this.dropTableSql(s)),c.push(this.createTableSql(s,n)),await this.executeQueries(a,c)}async createView(e,t=!1){let r=[],n=[];r.push(this.createViewSql(e)),t&&r.push(await this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),t&&n.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(r,n)}async dropView(e){let t=x.isView(e)?e.name:e,r=await this.getCachedView(t),n=[],i=[];n.push(await this.deleteViewDefinitionSql(r)),n.push(this.dropViewSql(r)),i.push(await this.insertViewDefinitionSql(r)),i.push(this.createViewSql(r)),await this.executeQueries(n,i)}async renameTable(e,t){let r=[],n=[],i=x.isTable(e)?e:await this.getCachedTable(e),s=i.clone(),{database:a}=this.driver.parseTableName(i);s.name=a?`${a}.${t}`:t,r.push(new b(`RENAME TABLE ${this.escapePath(i)} TO ${this.escapePath(s)}`)),n.push(new b(`RENAME TABLE ${this.escapePath(s)} TO ${this.escapePath(i)}`)),s.indices.forEach(c=>{let u=c.columnNames.map(p=>`\`${p}\``).join(", "),l=this.connection.namingStrategy.indexName(s,c.columnNames,c.where),h="";c.isUnique&&(h+="UNIQUE "),c.isSpatial&&(h+="SPATIAL "),c.isFulltext&&(h+="FULLTEXT "),r.push(new b(`ALTER TABLE ${this.escapePath(s)} DROP INDEX \`${c.name}\`, ADD ${h}INDEX \`${l}\` (${u})`)),n.push(new b(`ALTER TABLE ${this.escapePath(s)} DROP INDEX \`${l}\`, ADD ${h}INDEX \`${c.name}\` (${u})`)),c.name=l}),s.foreignKeys.forEach(c=>{let u=c.columnNames.map(m=>`\`${m}\``).join(", "),l=c.referencedColumnNames.map(m=>`\`${m}\``).join(","),h=this.connection.namingStrategy.foreignKeyName(s,c.columnNames),p=`ALTER TABLE ${this.escapePath(s)} DROP FOREIGN KEY \`${c.name}\`, ADD CONSTRAINT \`${h}\` FOREIGN KEY (${u}) REFERENCES ${this.escapePath(this.getTablePath(c))}(${l})`;c.onDelete&&(p+=` ON DELETE ${c.onDelete}`),c.onUpdate&&(p+=` ON UPDATE ${c.onUpdate}`);let d=`ALTER TABLE ${this.escapePath(s)} DROP FOREIGN KEY \`${h}\`, ADD CONSTRAINT \`${c.name}\` FOREIGN KEY (${u}) REFERENCES ${this.escapePath(this.getTablePath(c))}(${l})`;c.onDelete&&(d+=` ON DELETE ${c.onDelete}`),c.onUpdate&&(d+=` ON UPDATE ${c.onUpdate}`),r.push(new b(p)),n.push(new b(d)),c.name=h}),await this.executeQueries(r,n),i.name=s.name,this.replaceCachedTable(i,s)}async addColumn(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone(),i=[],s=[],a=n.primaryColumns.length>0;if(i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(t,a,!1)}`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN \`${t.name}\``)),t.isPrimary&&a){let u=n.columns.find(p=>p.isGenerated&&p.generationStrategy==="increment");if(u){let p=u.clone();p.isGenerated=!1,p.generationStrategy=void 0,i.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(p,!0)}`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(t,!0)}`))}let l=n.primaryColumns,h=l.map(p=>`\`${p.name}\``).join(", ");if(i.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${h})`)),l.push(t),h=l.map(p=>`\`${p.name}\``).join(", "),i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${h})`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),u){let p=u.clone();p.isGenerated=!1,p.generationStrategy=void 0,i.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(t,!0)}`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${t.name}\` ${this.buildCreateColumnSql(p,!0)}`))}}let c=n.indices.find(u=>u.columnNames.length===1&&u.columnNames[0]===t.name);if(c)i.push(this.createIndexSql(r,c)),s.push(this.dropIndexSql(r,c));else if(t.isUnique){let u=new Oe({name:this.connection.namingStrategy.indexName(r,[t.name]),columnNames:[t.name],isUnique:!0});n.indices.push(u),n.uniques.push(new Ve({name:u.name,columnNames:u.columnNames})),i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD UNIQUE INDEX \`${u.name}\` (\`${t.name}\`)`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${u.name}\``))}await this.executeQueries(i,s),n.addColumn(t),this.replaceCachedTable(r,n)}async addColumns(e,t){for(let r of t)await this.addColumn(e,r)}async renameColumn(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=x.isTableColumn(t)?t:n.columns.find(a=>a.name===t);if(!i)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);let s;x.isTableColumn(r)?s=r:(s=i.clone(),s.name=r),await this.changeColumn(n,i,s)}async changeColumn(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),s=[],a=[],c=x.isTableColumn(t)?t:n.columns.find(u=>u.name===t);if(!c)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);if(r.isGenerated!==c.isGenerated&&r.generationStrategy!=="uuid"||c.type!==r.type||c.length!==r.length||c.generatedType!==r.generatedType)await this.dropColumn(n,c),await this.addColumn(n,r),i=n.clone();else{if(r.name!==c.name){s.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${c.name}\` \`${r.name}\` ${this.buildCreateColumnSql(c,!0,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${r.name}\` \`${c.name}\` ${this.buildCreateColumnSql(c,!0,!0)}`)),i.findColumnIndices(c).forEach(l=>{l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(r.name);let h=l.columnNames.map(m=>`\`${m}\``).join(", "),p=this.connection.namingStrategy.indexName(i,l.columnNames,l.where),d="";l.isUnique&&(d+="UNIQUE "),l.isSpatial&&(d+="SPATIAL "),l.isFulltext&&(d+="FULLTEXT "),s.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${l.name}\`, ADD ${d}INDEX \`${p}\` (${h})`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${p}\`, ADD ${d}INDEX \`${l.name}\` (${h})`)),l.name=p}),i.findColumnForeignKeys(c).forEach(l=>{l.columnNames.splice(l.columnNames.indexOf(c.name),1),l.columnNames.push(r.name);let h=l.columnNames.map(A=>`\`${A}\``).join(", "),p=l.referencedColumnNames.map(A=>`\`${A}\``).join(","),d=this.connection.namingStrategy.foreignKeyName(i,l.columnNames),m=`ALTER TABLE ${this.escapePath(n)} DROP FOREIGN KEY \`${l.name}\`, ADD CONSTRAINT \`${d}\` FOREIGN KEY (${h}) REFERENCES ${this.escapePath(this.getTablePath(l))}(${p})`;l.onDelete&&(m+=` ON DELETE ${l.onDelete}`),l.onUpdate&&(m+=` ON UPDATE ${l.onUpdate}`);let f=`ALTER TABLE ${this.escapePath(n)} DROP FOREIGN KEY \`${d}\`, ADD CONSTRAINT \`${l.name}\` FOREIGN KEY (${h}) REFERENCES ${this.escapePath(this.getTablePath(l))}(${p})`;l.onDelete&&(f+=` ON DELETE ${l.onDelete}`),l.onUpdate&&(f+=` ON UPDATE ${l.onUpdate}`),s.push(new b(m)),a.push(new b(f)),l.name=d});let u=i.columns.find(l=>l.name===c.name);i.columns[i.columns.indexOf(u)].name=r.name,c.name=r.name}if(this.isColumnChanged(c,r,!0)&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(r,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${r.name}\` ${this.buildCreateColumnSql(c,!0)}`))),r.isPrimary!==c.isPrimary){let u=i.columns.find(h=>h.isGenerated&&h.generationStrategy==="increment");if(u){let h=u.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${u.name}\` ${this.buildCreateColumnSql(h,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(u,!0)}`))}let l=i.primaryColumns;if(l.length>0){let h=l.map(p=>`\`${p.name}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${h})`))}if(r.isPrimary===!0){l.push(r);let h=i.columns.find(d=>d.name===r.name);h.isPrimary=!0;let p=l.map(d=>`\`${d.name}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${p})`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`))}else{let h=l.find(d=>d.name===r.name);l.splice(l.indexOf(h),1);let p=i.columns.find(d=>d.name===r.name);if(p.isPrimary=!1,l.length>0){let d=l.map(m=>`\`${m.name}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD PRIMARY KEY (${d})`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP PRIMARY KEY`))}}if(u){let h=u.clone();h.isGenerated=!1,h.generationStrategy=void 0,s.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(u,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} CHANGE \`${u.name}\` ${this.buildCreateColumnSql(h,!0)}`))}}if(r.isUnique!==c.isUnique)if(r.isUnique===!0){let u=new Oe({name:this.connection.namingStrategy.indexName(n,[r.name]),columnNames:[r.name],isUnique:!0});i.indices.push(u),i.uniques.push(new Ve({name:u.name,columnNames:u.columnNames})),s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${u.name}\` (\`${r.name}\`)`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${u.name}\``))}else{let u=i.indices.find(h=>h.columnNames.length===1&&h.isUnique===!0&&!!h.columnNames.find(p=>p===r.name));i.indices.splice(i.indices.indexOf(u),1);let l=i.uniques.find(h=>h.name===u.name);i.uniques.splice(i.uniques.indexOf(l),1),s.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP INDEX \`${u.name}\``)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD UNIQUE INDEX \`${u.name}\` (\`${r.name}\`)`))}}await this.executeQueries(s,a),this.replaceCachedTable(n,i)}async changeColumns(e,t){for(let{oldColumn:r,newColumn:n}of t)await this.changeColumn(e,r,n)}async dropColumn(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableColumn(t)?t:r.findColumnByName(t);if(!n)throw new y(`Column "${t}" was not found in table "${r.name}"`);let i=r.clone(),s=[],a=[];if(n.isPrimary){let u=i.columns.find(p=>p.isGenerated&&p.generationStrategy==="increment");if(u){let p=u.clone();p.isGenerated=!1,p.generationStrategy=void 0,s.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${u.name}\` ${this.buildCreateColumnSql(p,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(u,!0)}`))}let l=i.primaryColumns.map(p=>`\`${p.name}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`)),a.push(new b(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${l})`));let h=i.findColumnByName(n.name);if(h.isPrimary=!1,i.primaryColumns.length>0){let p=i.primaryColumns.map(d=>`\`${d.name}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(i)} ADD PRIMARY KEY (${p})`)),a.push(new b(`ALTER TABLE ${this.escapePath(i)} DROP PRIMARY KEY`))}if(u&&u.name!==n.name){let p=u.clone();p.isGenerated=!1,p.generationStrategy=void 0,s.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(u,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${u.name}\` ${this.buildCreateColumnSql(p,!0)}`))}}let c=i.indices.find(u=>u.columnNames.length===1&&u.columnNames[0]===n.name);if(c)i.indices.splice(i.indices.indexOf(c),1),s.push(this.dropIndexSql(r,c)),a.push(this.createIndexSql(r,c));else if(n.isUnique){let u=this.connection.namingStrategy.uniqueConstraintName(r,[n.name]),l=i.uniques.find(d=>d.name===u);l&&i.uniques.splice(i.uniques.indexOf(l),1);let h=this.connection.namingStrategy.indexName(r,[n.name]),p=i.indices.find(d=>d.name===h);p&&i.indices.splice(i.indices.indexOf(p),1),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP INDEX \`${h}\``)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD UNIQUE INDEX \`${h}\` (\`${n.name}\`)`))}s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN \`${n.name}\``)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(n,!0)}`)),await this.executeQueries(s,a),i.removeColumn(n),this.replaceCachedTable(r,i)}async dropColumns(e,t){for(let r of[...t])await this.dropColumn(e,r)}async createPrimaryKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone(),i=this.createPrimaryKeySql(r,t),s=this.dropPrimaryKeySql(r);await this.executeQueries(i,s),n.columns.forEach(a=>{t.find(c=>c===a.name)&&(a.isPrimary=!0)}),this.replaceCachedTable(r,n)}async updatePrimaryKeys(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone(),i=t.map(p=>p.name),s=[],a=[],c=n.columns.find(p=>p.isGenerated&&p.generationStrategy==="increment");if(c){let p=c.clone();p.isGenerated=!1,p.generationStrategy=void 0,s.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${c.name}\` ${this.buildCreateColumnSql(p,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(c,!0)}`))}let u=n.primaryColumns;if(u.length>0){let p=u.map(d=>`\`${d.name}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${p})`))}n.columns.filter(p=>i.indexOf(p.name)!==-1).forEach(p=>p.isPrimary=!0);let l=i.map(p=>`\`${p}\``).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD PRIMARY KEY (${l})`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP PRIMARY KEY`));let h=c||t.find(p=>p.isGenerated&&p.generationStrategy==="increment");if(h){let p=h.clone();p.isGenerated=!1,p.generationStrategy=void 0,s.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${p.name}\` ${this.buildCreateColumnSql(h,!0)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} CHANGE \`${h.name}\` ${this.buildCreateColumnSql(p,!0)}`));let d=n.columns.find(m=>m.name===h.name);d.isGenerated=!0,d.generationStrategy="increment"}await this.executeQueries(s,a),this.replaceCachedTable(r,n)}async dropPrimaryKey(e){let t=x.isTable(e)?e:await this.getCachedTable(e),r=this.dropPrimaryKeySql(t),n=this.createPrimaryKeySql(t,t.primaryColumns.map(i=>i.name));await this.executeQueries(r,n),t.primaryColumns.forEach(i=>{i.isPrimary=!1})}async createUniqueConstraint(e,t){throw new y("MySql does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new y("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new y("MySql does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new y("MySql does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){throw new y("MySql does not support check constraints.")}async createCheckConstraints(e,t){throw new y("MySql does not support check constraints.")}async dropCheckConstraint(e,t){throw new y("MySql does not support check constraints.")}async dropCheckConstraints(e,t){throw new y("MySql does not support check constraints.")}async createExclusionConstraint(e,t){throw new y("MySql does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new y("MySql does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new y("MySql does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new y("MySql does not support exclusion constraints.")}async createForeignKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(r,t.columnNames));let n=this.createForeignKeySql(r,t),i=this.dropForeignKeySql(r,t);await this.executeQueries(n,i),r.addForeignKey(t)}async createForeignKeys(e,t){let r=t.map(n=>this.createForeignKey(e,n));await Promise.all(r)}async dropForeignKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableForeignKey(t)?t:r.foreignKeys.find(a=>a.name===t);if(!n)throw new y(`Supplied foreign key was not found in table ${r.name}`);let i=this.dropForeignKeySql(r,n),s=this.createForeignKeySql(r,n);await this.executeQueries(i,s),r.removeForeignKey(n)}async dropForeignKeys(e,t){let r=t.map(n=>this.dropForeignKey(e,n));await Promise.all(r)}async createIndex(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(r,t));let n=this.createIndexSql(r,t),i=this.dropIndexSql(r,t);await this.executeQueries(n,i),r.addIndex(t,!0)}async createIndices(e,t){let r=t.map(n=>this.createIndex(e,n));await Promise.all(r)}async dropIndex(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableIndex(t)?t:r.indices.find(a=>a.name===t);if(!n)throw new y(`Supplied index ${t} was not found in table ${r.name}`);n.name||(n.name=this.generateIndexName(r,n));let i=this.dropIndexSql(r,n),s=this.createIndexSql(r,n);await this.executeQueries(i,s),r.removeIndex(n,!0)}async dropIndices(e,t){let r=t.map(n=>this.dropIndex(e,n));await Promise.all(r)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(e){let t=e||this.driver.database;if(t){if(!await this.hasDatabase(t))return Promise.resolve()}else throw new y("Can not clear database. No database is specified");let r=this.isTransactionActive;r||await this.startTransaction();try{let n=`SELECT concat('DROP VIEW IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`VIEWS\` WHERE \`TABLE_SCHEMA\` = '${t}'`,i=await this.query(n);await Promise.all(i.map(l=>this.query(l.query)));let s="SET FOREIGN_KEY_CHECKS = 0;",a=`SELECT concat('DROP TABLE IF EXISTS \`', table_schema, '\`.\`', table_name, '\`') AS \`query\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_SCHEMA\` = '${t}'`,c="SET FOREIGN_KEY_CHECKS = 1;";await this.query(s);let u=await this.query(a);await Promise.all(u.map(l=>this.query(l.query))),await this.query(c),r||await this.commitTransaction()}catch(n){try{r||await this.rollbackTransaction()}catch{}throw n}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);let r=await this.getCurrentDatabase(),n=e.map(a=>{let{database:c,tableName:u}=this.driver.parseTableName(a);return c||(c=r),`(\`t\`.\`schema\` = '${c}' AND \`t\`.\`name\` = '${u}')`}).join(" OR "),i=`SELECT \`t\`.*, \`v\`.\`check_option\` FROM ${this.escapePath(this.getTypeormMetadataTableName())} \`t\` INNER JOIN \`information_schema\`.\`views\` \`v\` ON \`v\`.\`table_schema\` = \`t\`.\`schema\` AND \`v\`.\`table_name\` = \`t\`.\`name\` WHERE \`t\`.\`type\` = '${ce.VIEW}' ${n?`AND (${n})`:""}`;return(await this.query(i)).map(a=>{let c=new Tt,u=a.schema===r?void 0:a.schema;return c.database=a.schema,c.name=this.driver.buildTableName(a.name,void 0,u),c.expression=a.value,c})}async loadTables(e){if(e&&e.length===0)return[];let t=[],r=await this.getCurrentDatabase();if(!e)t.push(...await this.query("SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES`"));else{let I="SELECT TABLE_NAME, TABLE_SCHEMA FROM `INFORMATION_SCHEMA`.`TABLES` WHERE "+e.map(C=>{let[U,J]=C.split(".");return J||(J=U,U=this.driver.database||r),`(\`TABLE_SCHEMA\` = '${U}' AND \`TABLE_NAME\` = '${J}')`}).join(" OR ");t.push(...await this.query(I))}if(t.length===0)return[];let n=t.map(({TABLE_NAME:R,TABLE_SCHEMA:I})=>`(\`TABLE_SCHEMA\` = '${I}' AND \`TABLE_NAME\` = '${R}')`).join(" OR "),i="SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE "+n,s=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` WHERE \`CONSTRAINT_NAME\` = 'PRIMARY' AND (${n})`,a="SELECT `SCHEMA_NAME`, `DEFAULT_CHARACTER_SET_NAME` as `CHARSET`, `DEFAULT_COLLATION_NAME` AS `COLLATION` FROM `INFORMATION_SCHEMA`.`SCHEMATA`",u=`SELECT \`s\`.* FROM \`INFORMATION_SCHEMA\`.\`STATISTICS\` \`s\` LEFT JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`rc\` ON \`s\`.\`INDEX_NAME\` = \`rc\`.\`CONSTRAINT_NAME\` WHERE (${t.map(({TABLE_NAME:R,TABLE_SCHEMA:I})=>`(\`s\`.\`TABLE_SCHEMA\` = '${I}' AND \`s\`.\`TABLE_NAME\` = '${R}')`).join(" OR ")}) AND \`s\`.\`INDEX_NAME\` != 'PRIMARY' AND \`rc\`.\`CONSTRAINT_NAME\` IS NULL`,h="SELECT `kcu`.`TABLE_SCHEMA`, `kcu`.`TABLE_NAME`, `kcu`.`CONSTRAINT_NAME`, `kcu`.`COLUMN_NAME`, `kcu`.`REFERENCED_TABLE_SCHEMA`, `kcu`.`REFERENCED_TABLE_NAME`, `kcu`.`REFERENCED_COLUMN_NAME`, `rc`.`DELETE_RULE` `ON_DELETE`, `rc`.`UPDATE_RULE` `ON_UPDATE` FROM `INFORMATION_SCHEMA`.`KEY_COLUMN_USAGE` `kcu` INNER JOIN `INFORMATION_SCHEMA`.`REFERENTIAL_CONSTRAINTS` `rc` ON `rc`.`constraint_name` = `kcu`.`constraint_name` WHERE "+t.map(({TABLE_NAME:R,TABLE_SCHEMA:I})=>`(\`kcu\`.\`TABLE_SCHEMA\` = '${I}' AND \`kcu\`.\`TABLE_NAME\` = '${R}')`).join(" OR "),[p,d,m,f,A]=await Promise.all([this.query(i),this.query(s),this.query(a),this.query(u),this.query(h)]);return t.map(R=>{let I=new Me,C=m.find(O=>O.SCHEMA_NAME===R.TABLE_SCHEMA),U=C.COLLATION,J=C.CHARSET,ne=R.TABLE_SCHEMA===r?void 0:R.TABLE_SCHEMA;I.database=R.TABLE_SCHEMA,I.name=this.driver.buildTableName(R.TABLE_NAME,void 0,ne),I.columns=p.filter(O=>O.TABLE_NAME===R.TABLE_NAME&&O.TABLE_SCHEMA===R.TABLE_SCHEMA).map(O=>{let he=f.filter(P=>P.TABLE_NAME===R.TABLE_NAME&&P.TABLE_SCHEMA===R.TABLE_SCHEMA&&P.COLUMN_NAME===O.COLUMN_NAME&&parseInt(P.NON_UNIQUE,10)===0),S=this.connection.entityMetadatas.find(P=>this.getTablePath(I)===this.getTablePath(P)),$=he.length>0&&S&&S.indices.some(P=>he.some(v=>P.name===v.INDEX_NAME&&P.synchronize===!1)),T=he.every(P=>f.some(v=>v.INDEX_NAME===P.INDEX_NAME&&v.COLUMN_NAME!==O.COLUMN_NAME)),w=new We;if(w.name=O.COLUMN_NAME,w.type=O.DATA_TYPE.toLowerCase(),w.zerofill=O.COLUMN_TYPE.includes("zerofill"),w.unsigned=w.zerofill||O.COLUMN_TYPE.includes("unsigned"),this.driver.unsignedColumnTypes.includes(w.type)){let P=O.COLUMN_TYPE.substring(O.COLUMN_TYPE.indexOf("(")+1,O.COLUMN_TYPE.indexOf(")"));w.width=P&&!this.isDefaultColumnWidth(I,w,parseInt(P))?parseInt(P):void 0}if(O.COLUMN_DEFAULT===null||O.COLUMN_DEFAULT===void 0?w.default=void 0:w.default=O.COLUMN_DEFAULT==="CURRENT_TIMESTAMP"?O.COLUMN_DEFAULT:`'${O.COLUMN_DEFAULT}'`,O.EXTRA.indexOf("on update")!==-1&&(w.onUpdate=O.EXTRA.substring(O.EXTRA.indexOf("on update")+10)),O.GENERATION_EXPRESSION&&(w.asExpression=O.GENERATION_EXPRESSION,w.generatedType=O.EXTRA.indexOf("VIRTUAL")!==-1?"VIRTUAL":"STORED"),w.isUnique=he.length>0&&!$&&!T,w.isNullable=O.IS_NULLABLE==="YES",w.isPrimary=d.some(P=>P.TABLE_NAME===O.TABLE_NAME&&P.TABLE_SCHEMA===O.TABLE_SCHEMA&&P.COLUMN_NAME===O.COLUMN_NAME),w.zerofill=O.COLUMN_TYPE.indexOf("zerofill")!==-1,w.isGenerated=O.EXTRA.indexOf("auto_increment")!==-1,w.isGenerated&&(w.generationStrategy="increment"),w.comment=typeof O.COLUMN_COMMENT=="string"&&O.COLUMN_COMMENT.length===0?void 0:O.COLUMN_COMMENT,O.CHARACTER_SET_NAME&&(w.charset=O.CHARACTER_SET_NAME===J?void 0:O.CHARACTER_SET_NAME),O.COLLATION_NAME&&(w.collation=O.COLLATION_NAME===U?void 0:O.COLLATION_NAME),this.driver.withLengthColumnTypes.indexOf(w.type)!==-1&&O.CHARACTER_MAXIMUM_LENGTH){let P=O.CHARACTER_MAXIMUM_LENGTH.toString();w.length=this.isDefaultColumnLength(I,w,P)?"":P}if((w.type==="decimal"||w.type==="double"||w.type==="float")&&(O.NUMERIC_PRECISION!==null&&!this.isDefaultColumnPrecision(I,w,O.NUMERIC_PRECISION)&&(w.precision=parseInt(O.NUMERIC_PRECISION)),O.NUMERIC_SCALE!==null&&!this.isDefaultColumnScale(I,w,O.NUMERIC_SCALE)&&(w.scale=parseInt(O.NUMERIC_SCALE))),w.type==="enum"||w.type==="simple-enum"||w.type==="set"){let P=O.COLUMN_TYPE,v=P.substring(P.indexOf("(")+1,P.lastIndexOf(")")).split(",");w.enum=v.map(D=>D.substring(1,D.length-1)),w.length=""}return(w.type==="datetime"||w.type==="time"||w.type==="timestamp")&&O.DATETIME_PRECISION!==null&&O.DATETIME_PRECISION!==void 0&&!this.isDefaultColumnPrecision(I,w,parseInt(O.DATETIME_PRECISION))&&(w.precision=parseInt(O.DATETIME_PRECISION)),w});let oe=K.uniq(A.filter(O=>O.TABLE_NAME===R.TABLE_NAME&&O.TABLE_SCHEMA===R.TABLE_SCHEMA),O=>O.CONSTRAINT_NAME);I.foreignKeys=oe.map(O=>{let he=A.filter(T=>T.CONSTRAINT_NAME===O.CONSTRAINT_NAME),S=O.REFERENCED_TABLE_SCHEMA===r?void 0:O.REFERENCED_TABLE_SCHEMA,$=this.driver.buildTableName(O.REFERENCED_TABLE_NAME,void 0,S);return new Ye({name:O.CONSTRAINT_NAME,columnNames:he.map(T=>T.COLUMN_NAME),referencedDatabase:O.REFERENCED_TABLE_SCHEMA,referencedTableName:$,referencedColumnNames:he.map(T=>T.REFERENCED_COLUMN_NAME),onDelete:O.ON_DELETE,onUpdate:O.ON_UPDATE})});let z=K.uniq(f.filter(O=>O.TABLE_NAME===R.TABLE_NAME&&O.TABLE_SCHEMA===R.TABLE_SCHEMA),O=>O.INDEX_NAME);return I.indices=z.map(O=>{let he=f.filter($=>$.TABLE_SCHEMA===O.TABLE_SCHEMA&&$.TABLE_NAME===O.TABLE_NAME&&$.INDEX_NAME===O.INDEX_NAME),S=parseInt(O.NON_UNIQUE,10);return new Oe({table:I,name:O.INDEX_NAME,columnNames:he.map($=>$.COLUMN_NAME),isUnique:S===0,isSpatial:O.INDEX_TYPE==="SPATIAL",isFulltext:O.INDEX_TYPE==="FULLTEXT"})}),I})}createTableSql(e,t){let r=e.columns.map(i=>this.buildCreateColumnSql(i,!0)).join(", "),n=`CREATE TABLE ${this.escapePath(e)} (${r}`;if(e.columns.filter(i=>i.isUnique).forEach(i=>{let s=e.indices.some(c=>c.columnNames.length===1&&!!c.isUnique&&c.columnNames.indexOf(i.name)!==-1),a=e.uniques.some(c=>c.columnNames.length===1&&c.columnNames.indexOf(i.name)!==-1);!s&&!a&&e.indices.push(new Oe({name:this.connection.namingStrategy.uniqueConstraintName(e,[i.name]),columnNames:[i.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(i=>{e.indices.some(a=>a.name===i.name)||e.indices.push(new Oe({name:i.name,columnNames:i.columnNames,isUnique:!0}))}),e.indices.length>0){let i=e.indices.map(s=>{let a=s.columnNames.map(u=>`\`${u}\``).join(", ");s.name||(s.name=this.connection.namingStrategy.indexName(e,s.columnNames,s.where));let c="";return s.isUnique&&(c+="UNIQUE "),s.isSpatial&&(c+="SPATIAL "),s.isFulltext&&(c+="FULLTEXT "),`${c}INDEX \`${s.name}\` (${a})`}).join(", ");n+=`, ${i}`}if(e.foreignKeys.length>0&&t){let i=e.foreignKeys.map(s=>{let a=s.columnNames.map(l=>`\`${l}\``).join(", ");s.name||(s.name=this.connection.namingStrategy.foreignKeyName(e,s.columnNames));let c=s.referencedColumnNames.map(l=>`\`${l}\``).join(", "),u=`CONSTRAINT \`${s.name}\` FOREIGN KEY (${a}) REFERENCES ${this.escapePath(this.getTablePath(s))} (${c})`;return s.onDelete&&(u+=` ON DELETE ${s.onDelete}`),s.onUpdate&&(u+=` ON UPDATE ${s.onUpdate}`),u}).join(", ");n+=`, ${i}`}if(e.primaryColumns.length>0){let i=e.primaryColumns.map(s=>`\`${s.name}\``).join(", ");n+=`, PRIMARY KEY (${i})`}return n+=`) ENGINE=${e.engine||"InnoDB"}`,new b(n)}dropTableSql(e){return new b(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){return typeof e.expression=="string"?new b(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression}`):new b(`CREATE VIEW ${this.escapePath(e)} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){let t=await this.getCurrentDatabase(),r=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:ce.VIEW,schema:t,name:e.name,value:r})}dropViewSql(e){return new b(`DROP VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){let t=await this.getCurrentDatabase(),r=x.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:ce.VIEW,schema:t,name:r})}createIndexSql(e,t){let r=t.columnNames.map(i=>`\`${i}\``).join(", "),n="";return t.isUnique&&(n+="UNIQUE "),t.isSpatial&&(n+="SPATIAL "),t.isFulltext&&(n+="FULLTEXT "),new b(`CREATE ${n}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${r})`)}dropIndexSql(e,t){let r=x.isTableIndex(t)?t.name:t;return new b(`DROP INDEX \`${r}\` ON ${this.escapePath(e)}`)}createPrimaryKeySql(e,t){let r=t.map(n=>`\`${n}\``).join(", ");return new b(`ALTER TABLE ${this.escapePath(e)} ADD PRIMARY KEY (${r})`)}dropPrimaryKeySql(e){return new b(`ALTER TABLE ${this.escapePath(e)} DROP PRIMARY KEY`)}createForeignKeySql(e,t){let r=t.columnNames.map(s=>`\`${s}\``).join(", "),n=t.referencedColumnNames.map(s=>`\`${s}\``).join(","),i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${r}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${n})`;return t.onDelete&&(i+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(i+=` ON UPDATE ${t.onUpdate}`),new b(i)}dropForeignKeySql(e,t){let r=x.isTableForeignKey(t)?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP FOREIGN KEY \`${r}\``)}escapeComment(e){return!e||e.length===0?"''":(e=e.replace(/\\/g,"\\\\").replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){let{database:t,tableName:r}=this.driver.parseTableName(e);return t&&t!==this.driver.database?`\`${t}\`.\`${r}\``:`\`${r}\``}buildCreateColumnSql(e,t,r=!1){let n="";return r?n=this.connection.driver.createFullType(e):n=`\`${e.name}\` ${this.connection.driver.createFullType(e)}`,e.asExpression&&(n+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`),e.zerofill?n+=" ZEROFILL":e.unsigned&&(n+=" UNSIGNED"),e.enum&&(n+=` (${e.enum.map(i=>"'"+i+"'").join(", ")})`),e.charset&&(n+=` CHARACTER SET "${e.charset}"`),e.collation&&(n+=` COLLATE "${e.collation}"`),e.isNullable||(n+=" NOT NULL"),e.isNullable&&(n+=" NULL"),e.isPrimary&&!t&&(n+=" PRIMARY KEY"),e.isGenerated&&e.generationStrategy==="increment"&&(n+=" AUTO_INCREMENT"),e.comment&&(n+=` COMMENT ${this.escapeComment(e.comment)}`),e.default!==void 0&&e.default!==null&&(n+=` DEFAULT ${e.default}`),e.onUpdate&&(n+=` ON UPDATE ${e.onUpdate}`),n}isDefaultColumnWidth(e,t,r){if(this.connection.hasMetadata(e.name)){let s=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(s&&s.width)return!1}let n=this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].width;if(n){let s=["int","tinyint","smallint","mediumint"].indexOf(t.type)!==-1;return t.unsigned&&s?n-1===r:n===r}return!1}changeTableComment(e,t){throw new y("aurora-mysql driver does not support change table comment.")}};var Mo=class{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["bit","int","integer","tinyint","smallint","mediumint","bigint","float","double","double precision","real","decimal","dec","numeric","fixed","bool","boolean","date","datetime","timestamp","time","year","char","nchar","national char","varchar","nvarchar","national varchar","blob","text","tinyblob","tinytext","mediumblob","mediumtext","longblob","longtext","enum","set","binary","varbinary","json","geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.supportedUpsertTypes=["on-duplicate-key-update"],this.spatialTypes=["geometry","point","linestring","polygon","multipoint","multilinestring","multipolygon","geometrycollection"],this.withLengthColumnTypes=["char","varchar","nvarchar","binary","varbinary"],this.unsignedColumnTypes=["tinyint","smallint","mediumint","int","integer","bigint"],this.withPrecisionColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real","time","datetime","timestamp"],this.withScaleColumnTypes=["decimal","dec","numeric","fixed","float","double","double precision","real"],this.mappedDataTypes={createDate:"datetime",createDatePrecision:6,createDateDefault:"CURRENT_TIMESTAMP(6)",updateDate:"datetime",updateDatePrecision:6,updateDateDefault:"CURRENT_TIMESTAMP(6)",deleteDate:"datetime",deleteDatePrecision:6,deleteDateNullable:!0,version:"int",treeLevel:"int",migrationId:"int",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.dataTypeDefaults={varchar:{length:255},nvarchar:{length:255},"national varchar":{length:255},char:{length:1},binary:{length:1},varbinary:{length:255},decimal:{precision:10,scale:0},dec:{precision:10,scale:0},numeric:{precision:10,scale:0},fixed:{precision:10,scale:0},float:{precision:12},double:{precision:22},time:{precision:0},datetime:{precision:0},timestamp:{precision:0},bit:{width:1},int:{width:11},integer:{width:11},tinyint:{width:4},smallint:{width:6},mediumint:{width:9},bigint:{width:20}},this.maxAliasLength=63,this.cteCapabilities={enabled:!1},this.connection=e,this.options=e.options,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,r)=>this.connection.logger.logQuery(t,r),this.options.serviceConfigOptions,this.options.formatOptions),this.database=H.buildDriverOptions(this.options).database}async connect(){if(!this.database){let e=this.createQueryRunner("master");this.database=await e.getCurrentDatabase(),await e.release()}}afterConnect(){return Promise.resolve()}async disconnect(){}createSchemaBuilder(){return new Vt(this.connection)}createQueryRunner(e){return new So(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,r)=>this.connection.logger.logQuery(t,r),this.options.serviceConfigOptions,this.options.formatOptions))}escapeQueryWithParameters(e,t,r){let n=Object.keys(r).map(i=>r[i]);return!t||!Object.keys(t).length?[e,n]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,s,a)=>{if(!t.hasOwnProperty(a))return i;let c=t[a];return s?c.map(u=>(n.push(u),this.createParameter(a,n.length-1))).join(", "):typeof c=="function"?c():(n.push(c),this.createParameter(a,n.length-1))}),[e,n])}escape(e){return"`"+e+"`"}buildTableName(e,t,r){let n=[e];return r&&n.unshift(r),n.join(".")}parseTableName(e){let t=this.database,r=void 0;if(x.isTable(e)||x.isView(e)){let i=this.parseTableName(e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||r,tableName:i.tableName}}if(x.isTableForeignKey(e)){let i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||r,tableName:i.tableName}}if(x.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||r,tableName:e.tableName};let n=e.split(".");return{database:(n.length>1?n[0]:void 0)||t,schema:r,tableName:n.length>1?n[1]:n[0]}}preparePersistentValue(e,t){return t.transformer&&(e=ve.transformTo(t.transformer,e)),!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.preparePersistentValue(e,t):e==null?e:t.type===Boolean?e===!0?1:0:t.type==="date"?re.mixedDateToDateString(e):t.type==="time"?re.mixedDateToTimeString(e):t.type==="json"?JSON.stringify(e):t.type==="timestamp"||t.type==="datetime"||t.type===Date?re.mixedDateToDate(e):t.type==="simple-array"||t.type==="set"?re.simpleArrayToString(e):t.type==="simple-json"?re.simpleJsonToString(e):t.type==="enum"||t.type==="simple-enum"?""+e:e}prepareHydratedValue(e,t){return e==null?t.transformer?ve.transformFrom(t.transformer,e):e:!this.options.formatOptions||this.options.formatOptions.castParameters!==!1?this.client.prepareHydratedValue(e,t):(t.type===Boolean||t.type==="bool"||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?e=re.normalizeHydratedDate(e):t.type==="date"?e=re.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type==="time"?e=re.mixedTimeToString(e):t.type==="simple-array"||t.type==="set"?e=re.stringToSimpleArray(e):t.type==="simple-json"?e=re.stringToSimpleJson(e):(t.type==="enum"||t.type==="simple-enum")&&t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0?e=parseInt(e):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ve.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number||e.type==="integer"?"int":e.type===String?"varchar":e.type===Date?"datetime":e.type===Buffer?"blob":e.type===Boolean?"tinyint":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"enum":e.type==="double precision"||e.type==="real"?"double":e.type==="dec"||e.type==="numeric"||e.type==="fixed"?"decimal":e.type==="bool"||e.type==="boolean"?"tinyint":e.type==="nvarchar"||e.type==="national varchar"?"varchar":e.type==="nchar"||e.type==="national char"?"char":e.type||""}normalizeDefault(e){let t=e.default;if(t!==null){if((e.type==="enum"||e.type==="simple-enum")&&t!==void 0)return`'${t}'`;if(e.type==="set"&&t!==void 0)return`'${re.simpleArrayToString(t)}'`;if(typeof t=="number")return`${t}`;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!==void 0)return`${t}`}}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"varchar":case"nvarchar":case"national varchar":return"255";case"varbinary":return"255";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t+=" array"),t}obtainMasterConnection(){return new Promise((e,t)=>{this.poolCluster?this.poolCluster.getConnection("MASTER",(r,n)=>{r?t(r):e(this.prepareDbConnection(n))}):this.pool?this.pool.getConnection((r,n)=>{r?t(r):e(this.prepareDbConnection(n))}):t(new y("Connection is not established with mysql database"))})}obtainSlaveConnection(){return this.poolCluster?new Promise((e,t)=>{this.poolCluster.getConnection("SLAVE*",(r,n)=>{r?t(r):e(this.prepareDbConnection(n))})}):this.obtainMasterConnection()}createGeneratedMap(e,t,r){let n=e.generatedColumns.reduce((i,s)=>{let a;return s.generationStrategy==="increment"&&t.insertId&&(a=t.insertId+r),K.mergeDeep(i,s.createValueMap(a))},{});return Object.keys(n).length>0?n:void 0}findChangedColumns(e,t){return t.filter(r=>{let n=e.find(s=>s.name===r.databaseName);if(!n)return!1;let i=r.length;return!i&&r.generationStrategy==="uuid"&&(i=this.getColumnLength(r)),n.name!==r.databaseName||n.type!==this.normalizeType(r)||n.length!==i||n.width!==r.width||n.precision!==r.precision||n.scale!==r.scale||n.zerofill!==r.zerofill||n.unsigned!==r.unsigned||n.asExpression!==r.asExpression||n.generatedType!==r.generatedType||n.comment!==this.escapeComment(r.comment)||!this.compareDefaultValues(this.normalizeDefault(r),n.default)||n.enum&&r.enum&&!K.isArraysEqual(n.enum,r.enum.map(s=>s+""))||n.onUpdate!==r.onUpdate||n.isPrimary!==r.isPrimary||n.isNullable!==r.isNullable||n.isUnique!==this.normalizeIsUnique(r)||r.generationStrategy!=="uuid"&&n.isGenerated!==r.isGenerated})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!0}createParameter(e,t){return"?"}loadDependencies(){let e=this.options.driver||ge.load("typeorm-aurora-data-api-driver");this.DataApiDriver=e,this.DataApiDriver=this.DataApiDriver.default||this.DataApiDriver}createConnectionOptions(e,t){return t=Object.assign({},t,H.buildDriverOptions(t)),Object.assign({},{resourceArn:e.resourceArn,secretArn:e.secretArn,database:e.database,region:e.region,type:e.type},{host:t.host,user:t.username,password:t.password,database:t.database,port:t.port,ssl:e.ssl},e.extra||{})}async createPool(e){return{}}prepareDbConnection(e){let{logger:t}=this.connection;return e.listeners("error").length===0&&e.on("error",r=>t.log("warn",`MySQL connection raised an error. ${r}`)),e}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}};var vo=class extends Ht{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new Be(this)}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;let r=n=>this.releasePostgresConnection(n);return this.releaseCallback=n=>{this.databaseConnection.removeListener("error",r),t(n)},this.databaseConnection.on("error",r),this.databaseConnection}):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>{this.driver.connectedQueryRunners.push(this),this.databaseConnection=e;let r=n=>this.releasePostgresConnection(n);return this.releaseCallback=n=>{this.databaseConnection.removeListener("error",r),t(n)},this.databaseConnection.on("error",r),this.databaseConnection}),this.databaseConnectionPromise)}async releasePostgresConnection(e){if(this.isReleased)return;this.isReleased=!0,this.releaseCallback&&(this.releaseCallback(e),this.releaseCallback=void 0);let t=this.driver.connectedQueryRunners.indexOf(this);t!==-1&&this.driver.connectedQueryRunners.splice(t,1)}release(){return this.releasePostgresConnection()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(await this.query("START TRANSACTION"),e&&await this.query("SET TRANSACTION ISOLATION LEVEL "+e)):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.connect();this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);let i=new _e;try{let s=Date.now(),a=await n.query(e,t),c=this.driver.options.maxQueryExecutionTime,l=Date.now()-s;this.broadcaster.broadcastAfterQueryEvent(i,e,t,!0,l,a,void 0),c&&l>c&&this.driver.connection.logger.logQuerySlow(l,e,t,this);let h=new Le;if(a){switch(a.hasOwnProperty("rows")&&(h.records=a.rows),a.hasOwnProperty("rowCount")&&(h.affected=a.rowCount),a.command){case"DELETE":case"UPDATE":h.raw=[a.rows,a.rowCount];break;default:h.raw=a.rows}if(!r)return h.raw}return h}catch(s){throw this.driver.connection.logger.logQueryError(s,e,t,this),this.broadcaster.broadcastAfterQueryEvent(i,e,t,!1,void 0,void 0,s),new Qe(e,t,s)}finally{await i.wait()}}async stream(e,t,r,n){let i=this.driver.loadStreamDependency();if(this.isReleased)throw new Pe;let s=await this.connect();this.driver.connection.logger.logQuery(e,t,this);let a=s.query(new i(e,t));return r&&a.on("end",r),n&&a.on("error",n),a}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return!!(await this.query(`SELECT * FROM pg_database WHERE datname='${e}';`)).length}async getCurrentDatabase(){return(await this.query("SELECT * FROM current_database()"))[0].current_database}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){return(await this.query("SELECT * FROM current_schema()"))[0].current_schema}async hasTable(e){let t=this.driver.parseTableName(e);t.schema||(t.schema=await this.getCurrentSchema());let r=`SELECT * FROM "information_schema"."tables" WHERE "table_schema" = '${t.schema}' AND "table_name" = '${t.tableName}'`;return!!(await this.query(r)).length}async hasColumn(e,t){let r=this.driver.parseTableName(e);r.schema||(r.schema=await this.getCurrentSchema());let n=`SELECT * FROM "information_schema"."columns" WHERE "table_schema" = '${r.schema}' AND "table_name" = '${r.tableName}' AND "column_name" = '${t}'`;return!!(await this.query(n)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();let r=`CREATE DATABASE "${e}"`,n=`DROP DATABASE "${e}"`;await this.executeQueries(new b(r),new b(n))}async dropDatabase(e,t){let r=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,n=`CREATE DATABASE "${e}"`;await this.executeQueries(new b(r),new b(n))}async createSchema(e,t){let r=e.indexOf(".")===-1?e:e.split(".")[1],n=t?`CREATE SCHEMA IF NOT EXISTS "${r}"`:`CREATE SCHEMA "${r}"`,i=`DROP SCHEMA "${r}" CASCADE`;await this.executeQueries(new b(n),new b(i))}async dropSchema(e,t,r){let n=e.indexOf(".")===-1?e:e.split(".")[1],i=t?`DROP SCHEMA IF EXISTS "${n}" ${r?"CASCADE":""}`:`DROP SCHEMA "${n}" ${r?"CASCADE":""}`,s=`CREATE SCHEMA "${n}"`;await this.executeQueries(new b(i),new b(s))}async createTable(e,t=!1,r=!0,n=!0){if(t&&await this.hasTable(e))return Promise.resolve();let i=[],s=[],a=e.columns.filter(l=>l.type==="enum"||l.type==="simple-enum"),c=[];for(let l of a){let h=await this.hasEnumType(e,l),p=this.buildEnumName(e,l);!h&&c.indexOf(p)===-1&&(c.push(p),i.push(this.createEnumTypeSql(e,l,p)),s.push(this.dropEnumTypeSql(e,l,p)))}let u=e.columns.filter(l=>l.generatedType==="STORED"&&l.asExpression);for(let l of u){let h=(await this.getTableNameWithSchema(e.name)).split("."),p=h[1],d=h[0],m=this.insertTypeormMetadataSql({database:this.driver.database,schema:d,table:p,type:ce.GENERATED_COLUMN,name:l.name,value:l.asExpression}),f=this.deleteTypeormMetadataSql({database:this.driver.database,schema:d,table:p,type:ce.GENERATED_COLUMN,name:l.name});i.push(m),s.push(f)}i.push(this.createTableSql(e,r)),s.push(this.dropTableSql(e)),r&&e.foreignKeys.forEach(l=>s.push(this.dropForeignKeySql(e,l))),n&&e.indices.forEach(l=>{l.name||(l.name=this.connection.namingStrategy.indexName(e,l.columnNames,l.where)),i.push(this.createIndexSql(e,l)),s.push(this.dropIndexSql(e,l))}),e.comment&&(i.push(new b("COMMENT ON TABLE "+this.escapePath(e)+" IS '"+e.comment+"'")),s.push(new b("COMMENT ON TABLE "+this.escapePath(e)+" IS NULL"))),await this.executeQueries(i,s)}async dropTable(e,t,r=!0,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();let i=r,s=this.getTablePath(e),a=await this.getCachedTable(s),c=[],u=[];n&&a.indices.forEach(h=>{c.push(this.dropIndexSql(a,h)),u.push(this.createIndexSql(a,h))}),r&&a.foreignKeys.forEach(h=>c.push(this.dropForeignKeySql(a,h))),c.push(this.dropTableSql(a)),u.push(this.createTableSql(a,i));let l=a.columns.filter(h=>h.generatedType&&h.asExpression);for(let h of l){let p=(await this.getTableNameWithSchema(a.name)).split("."),d=p[1],m=p[0],f=this.deleteTypeormMetadataSql({database:this.driver.database,schema:m,table:d,type:ce.GENERATED_COLUMN,name:h.name}),A=this.insertTypeormMetadataSql({database:this.driver.database,schema:m,table:d,type:ce.GENERATED_COLUMN,name:h.name,value:h.asExpression});c.push(f),u.push(A)}await this.executeQueries(c,u)}async createView(e,t=!1){let r=[],n=[];r.push(this.createViewSql(e)),t&&r.push(await this.insertViewDefinitionSql(e)),n.push(this.dropViewSql(e)),t&&n.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(r,n)}async dropView(e){let t=x.isView(e)?e.name:e,r=await this.getCachedView(t),n=[],i=[];n.push(await this.deleteViewDefinitionSql(r)),n.push(this.dropViewSql(r)),i.push(await this.insertViewDefinitionSql(r)),i.push(this.createViewSql(r)),await this.executeQueries(n,i)}async renameTable(e,t){let r=[],n=[],i=x.isTable(e)?e:await this.getCachedTable(e),s=i.clone(),{schema:a,tableName:c}=this.driver.parseTableName(i);if(s.name=a?`${a}.${t}`:t,r.push(new b(`ALTER TABLE ${this.escapePath(i)} RENAME TO "${t}"`)),n.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME TO "${c}"`)),s.primaryColumns.length>0&&!s.primaryColumns[0].primaryKeyConstraintName){let l=s.primaryColumns.map(d=>d.name),h=this.connection.namingStrategy.primaryKeyName(i,l),p=this.connection.namingStrategy.primaryKeyName(s,l);r.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${h}" TO "${p}"`)),n.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${p}" TO "${h}"`))}s.columns.map(l=>{if(l.isGenerated&&l.generationStrategy==="increment"){let h=this.buildSequencePath(i,l.name),p=this.buildSequenceName(i,l.name),d=this.buildSequencePath(s,l.name),m=this.buildSequenceName(s,l.name),f=`ALTER SEQUENCE ${this.escapePath(h)} RENAME TO "${m}"`,A=`ALTER SEQUENCE ${this.escapePath(d)} RENAME TO "${p}"`;r.push(new b(f)),n.push(new b(A))}}),s.uniques.forEach(l=>{let h=this.connection.namingStrategy.uniqueConstraintName(i,l.columnNames);if(l.name!==h)return;let p=this.connection.namingStrategy.uniqueConstraintName(s,l.columnNames);r.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${l.name}" TO "${p}"`)),n.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${p}" TO "${l.name}"`)),l.name=p}),s.indices.forEach(l=>{let h=this.connection.namingStrategy.indexName(i,l.columnNames,l.where);if(l.name!==h)return;let{schema:p}=this.driver.parseTableName(s),d=this.connection.namingStrategy.indexName(s,l.columnNames,l.where),m=p?`ALTER INDEX "${p}"."${l.name}" RENAME TO "${d}"`:`ALTER INDEX "${l.name}" RENAME TO "${d}"`,f=p?`ALTER INDEX "${p}"."${d}" RENAME TO "${l.name}"`:`ALTER INDEX "${d}" RENAME TO "${l.name}"`;r.push(new b(m)),n.push(new b(f)),l.name=d}),s.foreignKeys.forEach(l=>{let h=this.connection.namingStrategy.foreignKeyName(i,l.columnNames,this.getTablePath(l),l.referencedColumnNames);if(l.name!==h)return;let p=this.connection.namingStrategy.foreignKeyName(s,l.columnNames,this.getTablePath(l),l.referencedColumnNames);r.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${l.name}" TO "${p}"`)),n.push(new b(`ALTER TABLE ${this.escapePath(s)} RENAME CONSTRAINT "${p}" TO "${l.name}"`)),l.name=p});let u=s.columns.filter(l=>l.type==="enum"||l.type==="simple-enum");for(let l of u){if(l.enumName)continue;let h=await this.getUserDefinedTypeName(i,l);r.push(new b(`ALTER TYPE "${h.schema}"."${h.name}" RENAME TO ${this.buildEnumName(s,l,!1)}`)),n.push(new b(`ALTER TYPE ${this.buildEnumName(s,l)} RENAME TO "${h.name}"`))}await this.executeQueries(r,n)}async addColumn(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone(),i=[],s=[];if((t.type==="enum"||t.type==="simple-enum")&&(await this.hasEnumType(r,t)||(i.push(this.createEnumTypeSql(r,t)),s.push(this.dropEnumTypeSql(r,t)))),i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(r,t)}`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN "${t.name}"`)),t.isPrimary){let c=n.primaryColumns;if(c.length>0){let h=c[0].primaryKeyConstraintName?c[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(n,c.map(d=>d.name)),p=c.map(d=>`"${d.name}"`).join(", ");i.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${h}"`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${h}" PRIMARY KEY (${p})`))}c.push(t);let u=c[0].primaryKeyConstraintName?c[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(n,c.map(h=>h.name)),l=c.map(h=>`"${h.name}"`).join(", ");i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${u}" PRIMARY KEY (${l})`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${u}"`))}let a=n.indices.find(c=>c.columnNames.length===1&&c.columnNames[0]===t.name);if(a&&(i.push(this.createIndexSql(r,a)),s.push(this.dropIndexSql(r,a))),t.isUnique){let c=new Ve({name:this.connection.namingStrategy.uniqueConstraintName(r,[t.name]),columnNames:[t.name]});n.uniques.push(c),i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${c.name}" UNIQUE ("${t.name}")`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${c.name}"`))}if(t.generatedType==="STORED"&&t.asExpression){let c=(await this.getTableNameWithSchema(r.name)).split("."),u=c[1],l=c[0],h=this.insertTypeormMetadataSql({database:this.driver.database,schema:l,table:u,type:ce.GENERATED_COLUMN,name:t.name,value:t.asExpression}),p=this.deleteTypeormMetadataSql({database:this.driver.database,schema:l,table:u,type:ce.GENERATED_COLUMN,name:t.name});i.push(h),s.push(p)}t.comment&&(i.push(new b(`COMMENT ON COLUMN ${this.escapePath(r)}."${t.name}" IS ${this.escapeComment(t.comment)}`)),s.push(new b(`COMMENT ON COLUMN ${this.escapePath(r)}."${t.name}" IS ${this.escapeComment(t.comment)}`))),await this.executeQueries(i,s),n.addColumn(t),this.replaceCachedTable(r,n)}async addColumns(e,t){for(let r of t)await this.addColumn(e,r)}async renameColumn(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=x.isTableColumn(t)?t:n.columns.find(a=>a.name===t);if(!i)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);let s;return x.isTableColumn(r)?s=r:(s=i.clone(),s.name=r),this.changeColumn(n,i,s)}async changeColumn(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),s=[],a=[],c=!1,u=x.isTableColumn(t)?t:n.columns.find(l=>l.name===t);if(!u)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);if(u.type!==r.type||u.length!==r.length||r.isArray!==u.isArray||!u.generatedType&&r.generatedType==="STORED"||u.asExpression!==r.asExpression&&r.generatedType==="STORED")await this.dropColumn(n,u),await this.addColumn(n,r),i=n.clone();else{if(u.name!==r.name){if(s.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME COLUMN "${u.name}" TO "${r.name}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME COLUMN "${r.name}" TO "${u.name}"`)),u.type==="enum"||u.type==="simple-enum"){let h=await this.getUserDefinedTypeName(n,u);s.push(new b(`ALTER TYPE "${h.schema}"."${h.name}" RENAME TO ${this.buildEnumName(n,r,!1)}`)),a.push(new b(`ALTER TYPE ${this.buildEnumName(n,r)} RENAME TO "${h.name}"`))}if(u.isPrimary===!0&&!u.primaryKeyConstraintName){let p=i.primaryColumns.map(f=>f.name),d=this.connection.namingStrategy.primaryKeyName(i,p);p.splice(p.indexOf(u.name),1),p.push(r.name);let m=this.connection.namingStrategy.primaryKeyName(i,p);s.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME CONSTRAINT "${d}" TO "${m}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME CONSTRAINT "${m}" TO "${d}"`))}if(u.isGenerated===!0&&r.generationStrategy==="increment"){let h=this.buildSequencePath(n,u.name),p=this.buildSequenceName(n,u.name),d=this.buildSequencePath(n,r.name),m=this.buildSequenceName(n,r.name),f=`ALTER SEQUENCE ${this.escapePath(h)} RENAME TO "${m}"`,A=`ALTER SEQUENCE ${this.escapePath(d)} RENAME TO "${p}"`;s.push(new b(f)),a.push(new b(A))}i.findColumnUniques(u).forEach(h=>{let p=this.connection.namingStrategy.uniqueConstraintName(i,h.columnNames);if(h.name!==p)return;h.columnNames.splice(h.columnNames.indexOf(u.name),1),h.columnNames.push(r.name);let d=this.connection.namingStrategy.uniqueConstraintName(i,h.columnNames);s.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME CONSTRAINT "${h.name}" TO "${d}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME CONSTRAINT "${d}" TO "${h.name}"`)),h.name=d}),i.findColumnIndices(u).forEach(h=>{let p=this.connection.namingStrategy.indexName(i,h.columnNames,h.where);if(h.name!==p)return;h.columnNames.splice(h.columnNames.indexOf(u.name),1),h.columnNames.push(r.name);let{schema:d}=this.driver.parseTableName(n),m=this.connection.namingStrategy.indexName(i,h.columnNames,h.where),f=d?`ALTER INDEX "${d}"."${h.name}" RENAME TO "${m}"`:`ALTER INDEX "${h.name}" RENAME TO "${m}"`,A=d?`ALTER INDEX "${d}"."${m}" RENAME TO "${h.name}"`:`ALTER INDEX "${m}" RENAME TO "${h.name}"`;s.push(new b(f)),a.push(new b(A)),h.name=m}),i.findColumnForeignKeys(u).forEach(h=>{let p=this.connection.namingStrategy.foreignKeyName(i,h.columnNames,this.getTablePath(h),h.referencedColumnNames);if(h.name!==p)return;h.columnNames.splice(h.columnNames.indexOf(u.name),1),h.columnNames.push(r.name);let d=this.connection.namingStrategy.foreignKeyName(i,h.columnNames,this.getTablePath(h),h.referencedColumnNames);s.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME CONSTRAINT "${h.name}" TO "${d}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME CONSTRAINT "${d}" TO "${h.name}"`)),h.name=d});let l=i.columns.find(h=>h.name===u.name);i.columns[i.columns.indexOf(l)].name=r.name,u.name=r.name}if((r.precision!==u.precision||r.scale!==u.scale)&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${this.driver.createFullType(r)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${this.driver.createFullType(u)}`))),(r.type==="enum"||r.type==="simple-enum")&&(u.type==="enum"||u.type==="simple-enum")&&(!K.isArraysEqual(r.enum,u.enum)||r.enumName!==u.enumName)){let l=r.isArray?"[]":"",h=this.buildEnumName(n,r),p=this.buildEnumName(n,u),d=this.buildEnumName(n,u,!1),m=this.buildEnumName(n,u,!0,!1,!0),f=this.buildEnumName(n,u,!1,!1,!0);s.push(new b(`ALTER TYPE ${p} RENAME TO ${f}`)),a.push(new b(`ALTER TYPE ${m} RENAME TO ${d}`)),s.push(this.createEnumTypeSql(n,r,h)),a.push(this.dropEnumTypeSql(n,r,h)),u.default!==null&&u.default!==void 0&&(c=!0,s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" DROP DEFAULT`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" SET DEFAULT ${u.default}`)));let A=`${h}${l} USING "${r.name}"::"text"::${h}${l}`,R=`${m}${l} USING "${r.name}"::"text"::${m}${l}`;s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${A}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${R}`)),r.default!==null&&r.default!==void 0&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT ${r.default}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`))),s.push(this.dropEnumTypeSql(n,u,m)),a.push(this.createEnumTypeSql(n,u,m))}if(u.isNullable!==r.isNullable&&(r.isNullable?(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" DROP NOT NULL`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" SET NOT NULL`))):(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" SET NOT NULL`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" DROP NOT NULL`)))),u.comment!==r.comment&&(s.push(new b(`COMMENT ON COLUMN ${this.escapePath(n)}."${u.name}" IS ${this.escapeComment(r.comment)}`)),a.push(new b(`COMMENT ON COLUMN ${this.escapePath(n)}."${r.name}" IS ${this.escapeComment(u.comment)}`))),r.isPrimary!==u.isPrimary){let l=i.primaryColumns;if(l.length>0){let h=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,l.map(d=>d.name)),p=l.map(d=>`"${d.name}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${h}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${h}" PRIMARY KEY (${p})`))}if(r.isPrimary===!0){l.push(r);let h=i.columns.find(m=>m.name===r.name);h.isPrimary=!0;let p=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,l.map(m=>m.name)),d=l.map(m=>`"${m.name}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${p}" PRIMARY KEY (${d})`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${p}"`))}else{let h=l.find(d=>d.name===r.name);l.splice(l.indexOf(h),1);let p=i.columns.find(d=>d.name===r.name);if(p.isPrimary=!1,l.length>0){let d=l[0].primaryKeyConstraintName?l[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,l.map(f=>f.name)),m=l.map(f=>`"${f.name}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${d}" PRIMARY KEY (${m})`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${d}"`))}}}if(r.isUnique!==u.isUnique)if(r.isUnique===!0){let l=new Ve({name:this.connection.namingStrategy.uniqueConstraintName(n,[r.name]),columnNames:[r.name]});i.uniques.push(l),s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l.name}" UNIQUE ("${r.name}")`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l.name}"`))}else{let l=i.uniques.find(h=>h.columnNames.length===1&&!!h.columnNames.find(p=>p===r.name));i.uniques.splice(i.uniques.indexOf(l),1),s.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP CONSTRAINT "${l.name}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD CONSTRAINT "${l.name}" UNIQUE ("${r.name}")`))}if(u.isGenerated!==r.isGenerated&&(u.isGenerated&&(u.generationStrategy==="uuid"?(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" DROP DEFAULT`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${u.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):u.generationStrategy==="increment"&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(n,r))}')`)),s.push(new b(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(n,r))}`)),a.push(new b(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(n,r))} OWNED BY ${this.escapePath(n)}."${r.name}"`)))),r.generationStrategy==="uuid"?r.isGenerated===!0?(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT ${this.driver.uuidGenerator}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`))):(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT ${this.driver.uuidGenerator}`))):r.generationStrategy==="increment"&&(r.isGenerated===!0?(s.push(new b(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(n,r))} OWNED BY ${this.escapePath(n)}."${r.name}"`)),a.push(new b(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(n,r))}`)),s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(n,r))}')`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`))):(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT nextval('${this.escapePath(this.buildSequencePath(n,r))}')`)),s.push(new b(`DROP SEQUENCE ${this.escapePath(this.buildSequencePath(n,r))}`)),a.push(new b(`CREATE SEQUENCE IF NOT EXISTS ${this.escapePath(this.buildSequencePath(n,r))} OWNED BY ${this.escapePath(n)}."${r.name}"`))))),r.default!==u.default&&!c&&(r.default!==null&&r.default!==void 0?(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT ${r.default}`)),u.default!==null&&u.default!==void 0?a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT ${u.default}`)):a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`))):u.default!==null&&u.default!==void 0&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" DROP DEFAULT`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" SET DEFAULT ${u.default}`)))),((r.spatialFeatureType||"").toLowerCase()!==(u.spatialFeatureType||"").toLowerCase()||r.srid!==u.srid)&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${this.driver.createFullType(r)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${this.driver.createFullType(u)}`))),r.collation!==u.collation){s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${r.type} COLLATE "${r.collation}"`));let l=u.collation?`"${u.collation}"`:'pg_catalog."default"';a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${r.type} COLLATE ${l}`))}if(r.generatedType!==u.generatedType&&(!r.generatedType||r.generatedType==="VIRTUAL")){let l=(await this.getTableNameWithSchema(n.name)).split("."),h=l[1],p=l[0];s.push(new b(`ALTER TABLE ${this.escapePath(n)} RENAME COLUMN "${u.name}" TO "TEMP_OLD_${u.name}"`)),s.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,r)}`)),s.push(new b(`UPDATE ${this.escapePath(n)} SET "${r.name}" = "TEMP_OLD_${u.name}"`)),s.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "TEMP_OLD_${u.name}"`)),s.push(this.deleteTypeormMetadataSql({database:this.driver.database,schema:p,table:h,type:ce.GENERATED_COLUMN,name:u.name})),a.push(this.insertTypeormMetadataSql({database:this.driver.database,schema:p,table:h,type:ce.GENERATED_COLUMN,name:u.name,value:u.asExpression})),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ADD ${this.buildCreateColumnSql(n,u)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} DROP COLUMN "${r.name}"`))}}await this.executeQueries(s,a),this.replaceCachedTable(n,i)}async changeColumns(e,t){for(let{oldColumn:r,newColumn:n}of t)await this.changeColumn(e,r,n)}async dropColumn(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableColumn(t)?t:r.findColumnByName(t);if(!n)throw new y(`Column "${t}" was not found in table "${r.name}"`);let i=r.clone(),s=[],a=[];if(n.isPrimary){let h=n.primaryKeyConstraintName?n.primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,i.primaryColumns.map(m=>m.name)),p=i.primaryColumns.map(m=>`"${m.name}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${h}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${h}" PRIMARY KEY (${p})`));let d=i.findColumnByName(n.name);if(d.isPrimary=!1,i.primaryColumns.length>0){let m=i.primaryColumns[0].primaryKeyConstraintName?i.primaryColumns[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(i,i.primaryColumns.map(A=>A.name)),f=i.primaryColumns.map(A=>`"${A.name}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(i)} ADD CONSTRAINT "${m}" PRIMARY KEY (${f})`)),a.push(new b(`ALTER TABLE ${this.escapePath(i)} DROP CONSTRAINT "${m}"`))}}let c=i.indices.find(h=>h.columnNames.length===1&&h.columnNames[0]===n.name);c&&(i.indices.splice(i.indices.indexOf(c),1),s.push(this.dropIndexSql(r,c)),a.push(this.createIndexSql(r,c)));let u=i.checks.find(h=>!!h.columnNames&&h.columnNames.length===1&&h.columnNames[0]===n.name);u&&(i.checks.splice(i.checks.indexOf(u),1),s.push(this.dropCheckConstraintSql(r,u)),a.push(this.createCheckConstraintSql(r,u)));let l=i.uniques.find(h=>h.columnNames.length===1&&h.columnNames[0]===n.name);if(l&&(i.uniques.splice(i.uniques.indexOf(l),1),s.push(this.dropUniqueConstraintSql(r,l)),a.push(this.createUniqueConstraintSql(r,l))),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN "${n.name}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(r,n)}`)),(n.type==="enum"||n.type==="simple-enum")&&await this.hasEnumType(r,n)){let p=await this.getUserDefinedTypeName(r,n),d=`"${p.schema}"."${p.name}"`;s.push(this.dropEnumTypeSql(r,n,d)),a.push(this.createEnumTypeSql(r,n,d))}if(n.generatedType==="STORED"){let h=(await this.getTableNameWithSchema(r.name)).split("."),p=h[1],d=h[0],m=this.deleteTypeormMetadataSql({database:this.driver.database,schema:d,table:p,type:ce.GENERATED_COLUMN,name:n.name}),f=this.insertTypeormMetadataSql({database:this.driver.database,schema:d,table:p,type:ce.GENERATED_COLUMN,name:n.name,value:n.asExpression});s.push(m),a.push(f)}await this.executeQueries(s,a),i.removeColumn(n),this.replaceCachedTable(r,i)}async dropColumns(e,t){for(let r of[...t])await this.dropColumn(e,r)}async createPrimaryKey(e,t,r){let n=x.isTable(e)?e:await this.getCachedTable(e),i=n.clone(),s=this.createPrimaryKeySql(n,t,r);i.columns.forEach(c=>{t.find(u=>u===c.name)&&(c.isPrimary=!0)});let a=this.dropPrimaryKeySql(i);await this.executeQueries(s,a),this.replaceCachedTable(n,i)}async updatePrimaryKeys(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=r.clone(),i=t.map(h=>h.name),s=[],a=[],c=n.primaryColumns;if(c.length>0){let h=c[0].primaryKeyConstraintName?c[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(n,c.map(d=>d.name)),p=c.map(d=>`"${d.name}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${h}"`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${h}" PRIMARY KEY (${p})`))}n.columns.filter(h=>i.indexOf(h.name)!==-1).forEach(h=>h.isPrimary=!0);let u=c[0]?.primaryKeyConstraintName?c[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(n,i),l=i.map(h=>`"${h}"`).join(", ");s.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD CONSTRAINT "${u}" PRIMARY KEY (${l})`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP CONSTRAINT "${u}"`)),await this.executeQueries(s,a),this.replaceCachedTable(r,n)}async dropPrimaryKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=this.dropPrimaryKeySql(r),i=this.createPrimaryKeySql(r,r.primaryColumns.map(s=>s.name),t);await this.executeQueries(n,i),r.primaryColumns.forEach(s=>{s.isPrimary=!1})}async createUniqueConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.uniqueConstraintName(r,t.columnNames));let n=this.createUniqueConstraintSql(r,t),i=this.dropUniqueConstraintSql(r,t);await this.executeQueries(n,i),r.addUniqueConstraint(t)}async createUniqueConstraints(e,t){for(let r of t)await this.createUniqueConstraint(e,r)}async dropUniqueConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableUnique(t)?t:r.uniques.find(a=>a.name===t);if(!n)throw new y(`Supplied unique constraint was not found in table ${r.name}`);let i=this.dropUniqueConstraintSql(r,n),s=this.createUniqueConstraintSql(r,n);await this.executeQueries(i,s),r.removeUniqueConstraint(n)}async dropUniqueConstraints(e,t){for(let r of[...t])await this.dropUniqueConstraint(e,r)}async createCheckConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(r,t.expression));let n=this.createCheckConstraintSql(r,t),i=this.dropCheckConstraintSql(r,t);await this.executeQueries(n,i),r.addCheckConstraint(t)}async createCheckConstraints(e,t){let r=t.map(n=>this.createCheckConstraint(e,n));await Promise.all(r)}async dropCheckConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableCheck(t)?t:r.checks.find(a=>a.name===t);if(!n)throw new y(`Supplied check constraint was not found in table ${r.name}`);let i=this.dropCheckConstraintSql(r,n),s=this.createCheckConstraintSql(r,n);await this.executeQueries(i,s),r.removeCheckConstraint(n)}async dropCheckConstraints(e,t){let r=t.map(n=>this.dropCheckConstraint(e,n));await Promise.all(r)}async createExclusionConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.exclusionConstraintName(r,t.expression));let n=this.createExclusionConstraintSql(r,t),i=this.dropExclusionConstraintSql(r,t);await this.executeQueries(n,i),r.addExclusionConstraint(t)}async createExclusionConstraints(e,t){let r=t.map(n=>this.createExclusionConstraint(e,n));await Promise.all(r)}async dropExclusionConstraint(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableExclusion(t)?t:r.exclusions.find(a=>a.name===t);if(!n)throw new y(`Supplied exclusion constraint was not found in table ${r.name}`);let i=this.dropExclusionConstraintSql(r,n),s=this.createExclusionConstraintSql(r,n);await this.executeQueries(i,s),r.removeExclusionConstraint(n)}async dropExclusionConstraints(e,t){let r=t.map(n=>this.dropExclusionConstraint(e,n));await Promise.all(r)}async createForeignKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(r,t.columnNames,this.getTablePath(t),t.referencedColumnNames));let n=this.createForeignKeySql(r,t),i=this.dropForeignKeySql(r,t);await this.executeQueries(n,i),r.addForeignKey(t)}async createForeignKeys(e,t){for(let r of t)await this.createForeignKey(e,r)}async dropForeignKey(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableForeignKey(t)?t:r.foreignKeys.find(a=>a.name===t);if(!n)throw new y(`Supplied foreign key was not found in table ${r.name}`);n.name||(n.name=this.connection.namingStrategy.foreignKeyName(r,n.columnNames,this.getTablePath(n),n.referencedColumnNames));let i=this.dropForeignKeySql(r,n),s=this.createForeignKeySql(r,n);await this.executeQueries(i,s),r.removeForeignKey(n)}async dropForeignKeys(e,t){for(let r of[...t])await this.dropForeignKey(e,r)}async createIndex(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(r,t));let n=this.createIndexSql(r,t),i=this.dropIndexSql(r,t);await this.executeQueries(n,i),r.addIndex(t)}async createViewIndex(e,t){let r=x.isView(e)?e:await this.getCachedView(e);t.name||(t.name=this.generateIndexName(r,t));let n=this.createViewIndexSql(r,t),i=this.dropIndexSql(r,t);await this.executeQueries(n,i),r.addIndex(t)}async createIndices(e,t){for(let r of t)await this.createIndex(e,r)}async createViewIndices(e,t){for(let r of t)await this.createViewIndex(e,r)}async dropIndex(e,t){let r=x.isTable(e)?e:await this.getCachedTable(e),n=x.isTableIndex(t)?t:r.indices.find(a=>a.name===t);if(!n)throw new y(`Supplied index ${t} was not found in table ${r.name}`);n.name||(n.name=this.generateIndexName(r,n));let i=this.dropIndexSql(r,n),s=this.createIndexSql(r,n);await this.executeQueries(i,s),r.removeIndex(n)}async dropViewIndex(e,t){let r=x.isView(e)?e:await this.getCachedView(e),n=x.isTableIndex(t)?t:r.indices.find(a=>a.name===t);if(!n)throw new y(`Supplied index ${t} was not found in view ${r.name}`);n.name||(n.name=this.generateIndexName(r,n));let i=this.dropIndexSql(r,n),s=this.createViewIndexSql(r,n);await this.executeQueries(i,s),r.removeIndex(n)}async dropIndices(e,t){for(let r of[...t])await this.dropIndex(e,r)}async clearTable(e){await this.query(`TRUNCATE TABLE ${this.escapePath(e)}`)}async clearDatabase(){let e=[];this.connection.entityMetadatas.filter(n=>n.schema).forEach(n=>{!!e.find(s=>s===n.schema)||e.push(n.schema)}),e.push(this.driver.options.schema||"current_schema()");let t=e.map(n=>n==="current_schema()"?n:"'"+n+"'").join(", "),r=this.isTransactionActive;r||await this.startTransaction();try{let n=`SELECT 'DROP VIEW IF EXISTS "' || schemaname || '"."' || viewname || '" CASCADE;' as "query" FROM "pg_views" WHERE "schemaname" IN (${t}) AND "viewname" NOT IN ('geography_columns', 'geometry_columns', 'raster_columns', 'raster_overviews')`,i=await this.query(n);if(await Promise.all(i.map(c=>this.query(c.query))),H.isReleaseVersionOrGreater(this.driver,"9.3")){let c=`SELECT 'DROP MATERIALIZED VIEW IF EXISTS "' || schemaname || '"."' || matviewname || '" CASCADE;' as "query" FROM "pg_matviews" WHERE "schemaname" IN (${t})`,u=await this.query(c);await Promise.all(u.map(l=>this.query(l.query)))}let s=`SELECT 'DROP TABLE IF EXISTS "' || schemaname || '"."' || tablename || '" CASCADE;' as "query" FROM "pg_tables" WHERE "schemaname" IN (${t}) AND "tablename" NOT IN ('spatial_ref_sys')`,a=await this.query(s);await Promise.all(a.map(c=>this.query(c.query))),await this.dropEnumTypes(t),r||await this.commitTransaction()}catch(n){try{r||await this.rollbackTransaction()}catch{}throw n}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);let r=await this.getCurrentDatabase(),n=await this.getCurrentSchema(),i=e.length===0?"1=1":e.map(h=>this.driver.parseTableName(h)).map(({schema:h,tableName:p})=>(h||(h=this.driver.options.schema||n),`("t"."schema" = '${h}' AND "t"."name" = '${p}')`)).join(" OR "),a=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('m') AND "cnst"."contype" IS NULL AND (${e.length===0?"1=1":e.map(h=>this.driver.parseTableName(h)).map(({schema:h,tableName:p})=>(h||(h=this.driver.options.schema||n),`("ns"."nspname" = '${h}' AND "t"."relname" = '${p}')`)).join(" OR ")})`,c=`SELECT "t".* FROM ${this.escapePath(this.getTypeormMetadataTableName())} "t" INNER JOIN "pg_catalog"."pg_class" "c" ON "c"."relname" = "t"."name" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "c"."relnamespace" AND "n"."nspname" = "t"."schema" WHERE "t"."type" IN ('${ce.VIEW}', '${ce.MATERIALIZED_VIEW}') ${i?`AND (${i})`:""}`,u=await this.query(c),l=await this.query(a);return u.map(h=>{let p=K.uniq(l.filter(f=>f.table_name===h.name&&f.table_schema===h.schema),f=>f.constraint_name),d=new Tt,m=h.schema===n&&!this.driver.options.schema?void 0:h.schema;return d.database=r,d.schema=h.schema,d.name=this.driver.buildTableName(h.name,m),d.expression=h.value,d.materialized=h.type===ce.MATERIALIZED_VIEW,d.indices=p.map(f=>{let A=l.filter(R=>R.table_schema===f.table_schema&&R.table_name===f.table_name&&R.constraint_name===f.constraint_name);return new Oe({view:d,name:f.constraint_name,columnNames:A.map(R=>R.column_name),isUnique:f.is_unique==="TRUE",where:f.condition,isFulltext:!1})}),d})}async loadTables(e){if(e&&e.length===0)return[];let t=await this.getCurrentSchema(),r=await this.getCurrentDatabase(),n=[];if(!e)n.push(...await this.query(`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables"`));else{let C=`SELECT "table_schema", "table_name", obj_description(('"' || "table_schema" || '"."' || "table_name" || '"')::regclass, 'pg_class') AS table_comment FROM "information_schema"."tables" WHERE `+e.map(U=>this.driver.parseTableName(U)).map(({schema:U,tableName:J})=>`("table_schema" = '${U||t}' AND "table_name" = '${J}')`).join(" OR ");n.push(...await this.query(C))}if(n.length===0)return[];let s=`SELECT columns.*, pg_catalog.col_description(('"' || table_catalog || '"."' || table_schema || '"."' || table_name || '"')::regclass::oid, ordinal_position) AS description, ('"' || "udt_schema" || '"."' || "udt_name" || '"')::"regtype"::text AS "regtype", pg_catalog.format_type("col_attr"."atttypid", "col_attr"."atttypmod") AS "format_type" FROM "information_schema"."columns" LEFT JOIN "pg_catalog"."pg_attribute" AS "col_attr" ON "col_attr"."attname" = "columns"."column_name" AND "col_attr"."attrelid" = ( SELECT "cls"."oid" FROM "pg_catalog"."pg_class" AS "cls" LEFT JOIN "pg_catalog"."pg_namespace" AS "ns" ON "ns"."oid" = "cls"."relnamespace" WHERE "cls"."relname" = "columns"."table_name" AND "ns"."nspname" = "columns"."table_schema" ) WHERE `+n.map(({table_schema:I,table_name:C})=>`("table_schema" = '${I}' AND "table_name" = '${C}')`).join(" OR "),a=n.map(({table_schema:I,table_name:C})=>`("ns"."nspname" = '${I}' AND "t"."relname" = '${C}')`).join(" OR "),c=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "cnst"."conname" AS "constraint_name", pg_get_constraintdef("cnst"."oid") AS "expression", CASE "cnst"."contype" WHEN 'p' THEN 'PRIMARY' WHEN 'u' THEN 'UNIQUE' WHEN 'c' THEN 'CHECK' WHEN 'x' THEN 'EXCLUDE' END AS "constraint_type", "a"."attname" AS "column_name" FROM "pg_constraint" "cnst" INNER JOIN "pg_class" "t" ON "t"."oid" = "cnst"."conrelid" INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "cnst"."connamespace" LEFT JOIN "pg_attribute" "a" ON "a"."attrelid" = "cnst"."conrelid" AND "a"."attnum" = ANY ("cnst"."conkey") WHERE "t"."relkind" IN ('r', 'p') AND (${a})`,u=`SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN 't' THEN 'TRUE' ELSE'FALSE' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name", "am"."amname" AS "index_type" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" INNER JOIN "pg_am" "am" ON "i"."relam" = "am"."oid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN ('r', 'p') AND "cnst"."contype" IS NULL AND (${a})`,l=n.map(({table_schema:I,table_name:C})=>`("ns"."nspname" = '${I}' AND "cl"."relname" = '${C}')`).join(" OR "),p=await this.hasSupportForPartitionedTables()?` AND "cl"."relispartition" = 'f'`:"",d=`SELECT "con"."conname" AS "constraint_name", "con"."nspname" AS "table_schema", "con"."relname" AS "table_name", "att2"."attname" AS "column_name", "ns"."nspname" AS "referenced_table_schema", "cl"."relname" AS "referenced_table_name", "att"."attname" AS "referenced_column_name", "con"."confdeltype" AS "on_delete", "con"."confupdtype" AS "on_update", "con"."condeferrable" AS "deferrable", "con"."condeferred" AS "deferred" FROM ( SELECT UNNEST ("con1"."conkey") AS "parent", UNNEST ("con1"."confkey") AS "child", "con1"."confrelid", "con1"."conrelid", "con1"."conname", "con1"."contype", "ns"."nspname", "cl"."relname", "con1"."condeferrable", CASE WHEN "con1"."condeferred" THEN 'INITIALLY DEFERRED' ELSE 'INITIALLY IMMEDIATE' END as condeferred, CASE "con1"."confdeltype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confdeltype", CASE "con1"."confupdtype" WHEN 'a' THEN 'NO ACTION' WHEN 'r' THEN 'RESTRICT' WHEN 'c' THEN 'CASCADE' WHEN 'n' THEN 'SET NULL' WHEN 'd' THEN 'SET DEFAULT' END as "confupdtype" FROM "pg_class" "cl" INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_constraint" "con1" ON "con1"."conrelid" = "cl"."oid" WHERE "con1"."contype" = 'f' AND (${l}) ) "con" INNER JOIN "pg_attribute" "att" ON "att"."attrelid" = "con"."confrelid" AND "att"."attnum" = "con"."child" INNER JOIN "pg_class" "cl" ON "cl"."oid" = "con"."confrelid" ${p}INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_attribute" "att2" ON "att2"."attrelid" = "con"."conrelid" AND "att2"."attnum" = "con"."parent"`,[m,f,A,R]=await Promise.all([this.query(s),this.query(c),this.query(u),this.query(d)]);return Promise.all(n.map(async I=>{let C=new Me,U=(S,$)=>S[$]===t&&(!this.driver.options.schema||this.driver.options.schema===t)?void 0:S[$],J=U(I,"table_schema");C.database=r,C.schema=I.table_schema,C.comment=I.table_comment,C.name=this.driver.buildTableName(I.table_name,J),C.columns=await Promise.all(m.filter(S=>S.table_name===I.table_name&&S.table_schema===I.table_schema).map(async S=>{let $=f.filter(D=>D.table_name===S.table_name&&D.table_schema===S.table_schema&&D.column_name===S.column_name),T=new We;if(T.name=S.column_name,T.type=S.regtype.toLowerCase(),T.type==="vector"||T.type==="halfvec"){let D=S.format_type.match(/^(?:vector|halfvec)\((\d+)\)$/);D&&D[1]&&(T.length=D[1])}if(T.type==="numeric"||T.type==="numeric[]"||T.type==="decimal"||T.type==="float"){let D=S.numeric_precision,j=S.numeric_scale;if(S.data_type==="ARRAY"){let Z=S.format_type.match(/^numeric\(([0-9]+),([0-9]+)\)\[\]$/);Z&&(D=+Z[1],j=+Z[2])}D!==null&&!this.isDefaultColumnPrecision(C,T,D)?T.precision=D:j!==null&&!this.isDefaultColumnScale(C,T,j)&&(T.precision=void 0),j!==null&&!this.isDefaultColumnScale(C,T,j)?T.scale=j:D!==null&&!this.isDefaultColumnPrecision(C,T,D)&&(T.scale=void 0)}if((T.type==="interval"||T.type==="time without time zone"||T.type==="time with time zone"||T.type==="timestamp without time zone"||T.type==="timestamp with time zone")&&(T.precision=this.isDefaultColumnPrecision(C,T,S.datetime_precision)?void 0:S.datetime_precision),S.data_type==="USER-DEFINED"||S.data_type==="ARRAY"){let{name:D}=await this.getUserDefinedTypeName(C,T),Z=this.buildEnumName(C,T,!1,!0)!==D?D:void 0,se=`SELECT "e"."enumlabel" AS "value" FROM "pg_enum" "e" INNER JOIN "pg_type" "t" ON "t"."oid" = "e"."enumtypid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${I.table_schema}' AND "t"."typname" = '${Z||D}'`,me=await this.query(se);if(me.length&&(T.type="enum",T.enum=me.map(B=>B.value),T.enumName=Z),S.data_type==="ARRAY"){T.isArray=!0;let B=T.type.replace("[]","");T.type=this.connection.driver.normalizeType({type:B})}}if(T.type==="geometry"||T.type==="geography"){let D=`SELECT * FROM (SELECT "f_table_schema" "table_schema", "f_table_name" "table_name", "f_${T.type}_column" "column_name", "srid", "type" FROM "${T.type}_columns") AS _ WHERE "column_name" = '${S.column_name}' AND "table_schema" = '${S.table_schema}' AND "table_name" = '${S.table_name}'`,j=await this.query(D);j.length>0&&(T.spatialFeatureType=j[0].type,T.srid=j[0].srid)}if(this.driver.withLengthColumnTypes.indexOf(T.type)!==-1){let D;if(T.isArray){let j=/\((\d+)\)/.exec(S.format_type);D=j?j[1]:void 0}else S.character_maximum_length&&(D=S.character_maximum_length.toString());D&&(T.length=this.isDefaultColumnLength(C,T,D)?"":D)}T.isNullable=S.is_nullable==="YES";let w=$.find(D=>D.constraint_type==="PRIMARY");if(w){T.isPrimary=!0;let j=f.filter(se=>se.table_name===S.table_name&&se.table_schema===S.table_schema&&se.column_name!==S.column_name&&se.constraint_type==="PRIMARY").map(se=>se.column_name);j.push(S.column_name);let Z=this.connection.namingStrategy.primaryKeyName(C,j);w.constraint_name!==Z&&(T.primaryKeyConstraintName=w.constraint_name)}let P=$.filter(D=>D.constraint_type==="UNIQUE"),v=P.every(D=>f.some(j=>j.constraint_type==="UNIQUE"&&j.constraint_name===D.constraint_name&&j.column_name!==S.column_name));if(T.isUnique=P.length>0&&!v,S.is_identity==="YES")T.isGenerated=!0,T.generationStrategy="identity",T.generatedIdentity=S.identity_generation;else if(S.column_default!==null&&S.column_default!==void 0){let D=`nextval('${this.buildSequenceName(C,S.column_name)}'::regclass)`,j=`nextval('${this.buildSequencePath(C,S.column_name)}'::regclass)`,Z=S.column_default.replace(/"/g,"");Z===D||Z===j?(T.isGenerated=!0,T.generationStrategy="increment"):S.column_default==="gen_random_uuid()"||/^uuid_generate_v\d\(\)/.test(S.column_default)?T.type==="uuid"?(T.isGenerated=!0,T.generationStrategy="uuid"):T.default=S.column_default:S.column_default==="now()"||S.column_default.indexOf("'now'::text")!==-1?T.default=S.column_default:(T.default=S.column_default.replace(/::[\w\s.[\]\-"]+/g,""),T.default=T.default.replace(/^(-?\d+)$/,"'$1'"))}if(S.is_generated==="ALWAYS"&&S.generation_expression){T.generatedType="STORED";let D=this.selectTypeormMetadataSql({database:r,schema:I.table_schema,table:I.table_name,type:ce.GENERATED_COLUMN,name:T.name}),j=await this.query(D.query,D.parameters);j[0]&&j[0].value?T.asExpression=j[0].value:T.asExpression=""}return T.comment=S.description?S.description:void 0,S.character_set_name&&(T.charset=S.character_set_name),S.collation_name&&(T.collation=S.collation_name),T}));let ne=K.uniq(f.filter(S=>S.table_name===I.table_name&&S.table_schema===I.table_schema&&S.constraint_type==="UNIQUE"),S=>S.constraint_name);C.uniques=ne.map(S=>{let $=f.filter(T=>T.constraint_name===S.constraint_name);return new Ve({name:S.constraint_name,columnNames:$.map(T=>T.column_name),deferrable:S.deferrable?S.deferred:void 0})});let oe=K.uniq(f.filter(S=>S.table_name===I.table_name&&S.table_schema===I.table_schema&&S.constraint_type==="CHECK"),S=>S.constraint_name);C.checks=oe.map(S=>{let $=f.filter(T=>T.constraint_name===S.constraint_name);return new pt({name:S.constraint_name,columnNames:$.map(T=>T.column_name),expression:S.expression.replace(/^\s*CHECK\s*\((.*)\)\s*$/i,"$1")})});let z=K.uniq(f.filter(S=>S.table_name===I.table_name&&S.table_schema===I.table_schema&&S.constraint_type==="EXCLUDE"),S=>S.constraint_name);C.exclusions=z.map(S=>new tr({name:S.constraint_name,expression:S.expression.substring(8)}));let O=K.uniq(R.filter(S=>S.table_name===I.table_name&&S.table_schema===I.table_schema),S=>S.constraint_name);C.foreignKeys=O.map(S=>{let $=R.filter(P=>P.constraint_name===S.constraint_name),T=U(S,"referenced_table_schema"),w=this.driver.buildTableName(S.referenced_table_name,T);return new Ye({name:S.constraint_name,columnNames:$.map(P=>P.column_name),referencedSchema:S.referenced_table_schema,referencedTableName:w,referencedColumnNames:$.map(P=>P.referenced_column_name),onDelete:S.on_delete,onUpdate:S.on_update,deferrable:S.deferrable?S.deferred:void 0})});let he=K.uniq(A.filter(S=>S.table_name===I.table_name&&S.table_schema===I.table_schema),S=>S.constraint_name);return C.indices=he.map(S=>{let $=A.filter(T=>T.table_schema===S.table_schema&&T.table_name===S.table_name&&T.constraint_name===S.constraint_name);return new Oe({table:C,name:S.constraint_name,columnNames:$.map(T=>T.column_name),isUnique:S.is_unique==="TRUE",where:S.condition,isSpatial:S.index_type==="gist",isFulltext:!1})}),C}))}createTableSql(e,t){let r=e.columns.map(s=>this.buildCreateColumnSql(e,s)).join(", "),n=`CREATE TABLE ${this.escapePath(e)} (${r}`;if(e.columns.filter(s=>s.isUnique).forEach(s=>{e.uniques.some(c=>c.columnNames.length===1&&c.columnNames[0]===s.name)||e.uniques.push(new Ve({name:this.connection.namingStrategy.uniqueConstraintName(e,[s.name]),columnNames:[s.name]}))}),e.uniques.length>0){let s=e.uniques.map(a=>{let c=a.name?a.name:this.connection.namingStrategy.uniqueConstraintName(e,a.columnNames),u=a.columnNames.map(h=>`"${h}"`).join(", "),l=`CONSTRAINT "${c}" UNIQUE (${u})`;return a.deferrable&&(l+=` DEFERRABLE ${a.deferrable}`),l}).join(", ");n+=`, ${s}`}if(e.checks.length>0){let s=e.checks.map(a=>`CONSTRAINT "${a.name?a.name:this.connection.namingStrategy.checkConstraintName(e,a.expression)}" CHECK (${a.expression})`).join(", ");n+=`, ${s}`}if(e.exclusions.length>0){let s=e.exclusions.map(a=>`CONSTRAINT "${a.name?a.name:this.connection.namingStrategy.exclusionConstraintName(e,a.expression)}" EXCLUDE ${a.expression}`).join(", ");n+=`, ${s}`}if(e.foreignKeys.length>0&&t){let s=e.foreignKeys.map(a=>{let c=a.columnNames.map(h=>`"${h}"`).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames,this.getTablePath(a),a.referencedColumnNames));let u=a.referencedColumnNames.map(h=>`"${h}"`).join(", "),l=`CONSTRAINT "${a.name}" FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${u})`;return a.onDelete&&(l+=` ON DELETE ${a.onDelete}`),a.onUpdate&&(l+=` ON UPDATE ${a.onUpdate}`),a.deferrable&&(l+=` DEFERRABLE ${a.deferrable}`),l}).join(", ");n+=`, ${s}`}let i=e.columns.filter(s=>s.isPrimary);if(i.length>0){let s=i[0].primaryKeyConstraintName?i[0].primaryKeyConstraintName:this.connection.namingStrategy.primaryKeyName(e,i.map(c=>c.name)),a=i.map(c=>`"${c.name}"`).join(", ");n+=`, CONSTRAINT "${s}" PRIMARY KEY (${a})`}return n+=")",e.columns.filter(s=>s.comment).forEach(s=>n+=`; COMMENT ON COLUMN ${this.escapePath(e)}."${s.name}" IS ${this.escapeComment(s.comment)}`),new b(n)}async getVersion(){return(await this.query("SELECT version()"))[0].version.replace(/^PostgreSQL ([\d.]+).*$/,"$1")}dropTableSql(e){return new b(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){let t=e.materialized?"MATERIALIZED ":"",r=this.escapePath(e);return typeof e.expression=="string"?new b(`CREATE ${t}VIEW ${r} AS ${e.expression}`):new b(`CREATE ${t}VIEW ${r} AS ${e.expression(this.connection).getQuery()}`)}async insertViewDefinitionSql(e){let t=await this.getCurrentSchema(),{schema:r,tableName:n}=this.driver.parseTableName(e);r||(r=t);let i=e.materialized?ce.MATERIALIZED_VIEW:ce.VIEW,s=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:i,schema:r,name:n,value:s})}dropViewSql(e){let t=e.materialized?"MATERIALIZED ":"";return new b(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){let t=await this.getCurrentSchema(),{schema:r,tableName:n}=this.driver.parseTableName(e);r||(r=t);let i=e.materialized?ce.MATERIALIZED_VIEW:ce.VIEW;return this.deleteTypeormMetadataSql({type:i,schema:r,name:n})}async dropEnumTypes(e){let t=`SELECT 'DROP TYPE IF EXISTS "' || n.nspname || '"."' || t.typname || '" CASCADE;' as "query" FROM "pg_type" "t" INNER JOIN "pg_enum" "e" ON "e"."enumtypid" = "t"."oid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" IN (${e}) GROUP BY "n"."nspname", "t"."typname"`,r=await this.query(t);await Promise.all(r.map(n=>this.query(n.query)))}async hasEnumType(e,t){let{schema:r}=this.driver.parseTableName(e);r||(r=await this.getCurrentSchema());let n=this.buildEnumName(e,t,!1,!0),i=`SELECT "n"."nspname", "t"."typname" FROM "pg_type" "t" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '${r}' AND "t"."typname" = '${n}'`;return!!(await this.query(i)).length}createEnumTypeSql(e,t,r){r||(r=this.buildEnumName(e,t));let n=t.enum.map(i=>`'${i.replaceAll("'","''")}'`).join(", ");return new b(`CREATE TYPE ${r} AS ENUM(${n})`)}dropEnumTypeSql(e,t,r){return r||(r=this.buildEnumName(e,t)),new b(`DROP TYPE ${r}`)}createIndexSql(e,t){let r=t.columnNames.map(n=>`"${n}"`).join(", ");return new b(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX${t.isConcurrent?" CONCURRENTLY":""} "${t.name}" ON ${this.escapePath(e)} ${t.isSpatial?"USING GiST ":""}(${r}) ${t.where?"WHERE "+t.where:""}`)}createViewIndexSql(e,t){let r=t.columnNames.map(n=>`"${n}"`).join(", ");return new b(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX "${t.name}" ON ${this.escapePath(e)} (${r}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e,t){let r=x.isTableIndex(t)?t.name:t,n=x.isTableIndex(t)?t.isConcurrent:!1,{schema:i}=this.driver.parseTableName(e);return i?new b(`DROP INDEX ${n?"CONCURRENTLY ":""}"${i}"."${r}"`):new b(`DROP INDEX ${n?"CONCURRENTLY ":""}"${r}"`)}createPrimaryKeySql(e,t,r){let n=r||this.connection.namingStrategy.primaryKeyName(e,t),i=t.map(s=>`"${s}"`).join(", ");return new b(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${n}" PRIMARY KEY (${i})`)}dropPrimaryKeySql(e){if(!e.primaryColumns.length)throw new y(`Table ${e} has no primary keys.`);let t=e.primaryColumns.map(i=>i.name),r=e.primaryColumns[0].primaryKeyConstraintName,n=r||this.connection.namingStrategy.primaryKeyName(e,t);return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${n}"`)}createUniqueConstraintSql(e,t){let r=t.columnNames.map(i=>'"'+i+'"').join(", "),n=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" UNIQUE (${r})`;return t.deferrable&&(n+=` DEFERRABLE ${t.deferrable}`),new b(n)}dropUniqueConstraintSql(e,t){let r=x.isTableUnique(t)?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${r}"`)}createCheckConstraintSql(e,t){return new b(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){let r=x.isTableCheck(t)?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${r}"`)}createExclusionConstraintSql(e,t){return new b(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" EXCLUDE ${t.expression}`)}dropExclusionConstraintSql(e,t){let r=x.isTableExclusion(t)?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${r}"`)}createForeignKeySql(e,t){let r=t.columnNames.map(s=>'"'+s+'"').join(", "),n=t.referencedColumnNames.map(s=>'"'+s+'"').join(","),i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT "${t.name}" FOREIGN KEY (${r}) REFERENCES ${this.escapePath(this.getTablePath(t))}(${n})`;return t.onDelete&&(i+=` ON DELETE ${t.onDelete}`),t.onUpdate&&(i+=` ON UPDATE ${t.onUpdate}`),t.deferrable&&(i+=` DEFERRABLE ${t.deferrable}`),new b(i)}dropForeignKeySql(e,t){let r=x.isTableForeignKey(t)?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT "${r}"`)}buildSequenceName(e,t){let{tableName:r}=this.driver.parseTableName(e),n=x.isTableColumn(t)?t.name:t,i=`${r}_${n}_seq`;return i.length>this.connection.driver.maxAliasLength&&(i=`${r.substring(0,29)}_${n.substring(0,Math.max(29,63-e.name.length-5))}_seq`),i}buildSequencePath(e,t){let{schema:r}=this.driver.parseTableName(e);return r?`${r}.${this.buildSequenceName(e,t)}`:this.buildSequenceName(e,t)}buildEnumName(e,t,r=!0,n,i){let{schema:s,tableName:a}=this.driver.parseTableName(e),c=t.enumName?t.enumName:`${a}_${t.name.toLowerCase()}_enum`;return s&&r&&(c=`${s}.${c}`),i&&(c=c+"_old"),c.split(".").map(u=>n?u:`"${u}"`).join(".")}async getUserDefinedTypeName(e,t){let{schema:r,tableName:n}=this.driver.parseTableName(e);r||(r=await this.getCurrentSchema());let i=await this.query(`SELECT "udt_schema", "udt_name" FROM "information_schema"."columns" WHERE "table_schema" = '${r}' AND "table_name" = '${n}' AND "column_name"='${t.name}'`),s=i[0].udt_name;return s.indexOf("_")===0&&(s=s.substr(1,s.length)),{schema:i[0].udt_schema,name:s}}escapeComment(e){return!e||e.length===0?"NULL":(e=e.replace(/'/g,"''").replace(/\u0000/g,""),`'${e}'`)}escapePath(e){let{schema:t,tableName:r}=this.driver.parseTableName(e);return t&&t!==this.driver.searchSchema?`"${t}"."${r}"`:`"${r}"`}async getTableNameWithSchema(e){let t=x.isTable(e)?e.name:e;return t.indexOf(".")===-1?`${(await this.query("SELECT current_schema()"))[0].current_schema}.${t}`:`${t.split(".")[0]}.${t.split(".")[1]}`}buildCreateColumnSql(e,t){let r='"'+t.name+'"';if(t.isGenerated===!0&&t.generationStrategy!=="uuid")if(t.generationStrategy==="identity"){let n=t.generatedIdentity||"BY DEFAULT";r+=` ${t.type} GENERATED ${n} AS IDENTITY`}else(t.type==="integer"||t.type==="int"||t.type==="int4")&&(r+=" SERIAL"),(t.type==="smallint"||t.type==="int2")&&(r+=" SMALLSERIAL"),(t.type==="bigint"||t.type==="int8")&&(r+=" BIGSERIAL");return t.type==="enum"||t.type==="simple-enum"?(r+=" "+this.buildEnumName(e,t),t.isArray&&(r+=" array")):(!t.isGenerated||t.type==="uuid")&&(r+=" "+this.connection.driver.createFullType(t)),t.generatedType==="STORED"&&t.asExpression&&(r+=` GENERATED ALWAYS AS (${t.asExpression}) STORED`),t.charset&&(r+=' CHARACTER SET "'+t.charset+'"'),t.collation&&(r+=' COLLATE "'+t.collation+'"'),t.isNullable!==!0&&(r+=" NOT NULL"),t.default!==void 0&&t.default!==null&&(r+=" DEFAULT "+t.default),t.isGenerated&&t.generationStrategy==="uuid"&&!t.default&&(r+=` DEFAULT ${this.driver.uuidGenerator}`),r}async hasSupportForPartitionedTables(){return!!(await this.query("SELECT TRUE FROM information_schema.columns WHERE table_name = 'pg_class' and column_name = 'relispartition'")).length}async changeTableComment(e,t){let r=[],n=[],i=x.isTable(e)?e:await this.getCachedTable(e);t=this.escapeComment(t);let s=this.escapeComment(i.comment);if(t===s)return;let a=i.clone();r.push(new b(`COMMENT ON TABLE ${this.escapePath(a)} IS ${t}`)),n.push(new b(`COMMENT ON TABLE ${this.escapePath(i)} IS ${s}`)),await this.executeQueries(r,n),i.comment=a.comment,this.replaceCachedTable(i,a)}};var Tl=class extends vo{constructor(e,t){super(e,t)}},Po=class extends Tl{constructor(e,t,r){super(e,r),this.client=t}connect(){return this.databaseConnection?Promise.resolve(this.databaseConnection):this.databaseConnectionPromise?this.databaseConnectionPromise:(this.mode==="slave"&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(([e,t])=>(this.driver.connectedQueryRunners.push(this),this.databaseConnection=e,this.releaseCallback=t,this.databaseConnection)),this.databaseConnectionPromise)}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?await this.client.startTransaction():await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.commitTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.client.rollbackTransaction(),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.client.query(e,t),i=new Le;return i.raw=n,n?.hasOwnProperty("records")&&Array.isArray(n.records)&&(i.records=n.records),n?.hasOwnProperty("numberOfRecordsUpdated")&&(i.affected=n.numberOfRecordsUpdated),r?i:i.raw}changeTableComment(e,t){throw new y("aurora-postgres driver does not support change comment.")}};var bl=class extends Rn{},Oo=class extends bl{constructor(e){super(),this.transactionSupport="nested",this.connection=e,this.options=e.options,this.isReplicated=!1,this.loadDependencies(),this.client=new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,r)=>this.connection.logger.logQuery(t,r),this.options.serviceConfigOptions,this.options.formatOptions),this.database=H.buildDriverOptions(this.options).database}async connect(){}async disconnect(){}createQueryRunner(e){return new Po(this,new this.DataApiDriver(this.options.region,this.options.secretArn,this.options.resourceArn,this.options.database,(t,r)=>this.connection.logger.logQuery(t,r),this.options.serviceConfigOptions,this.options.formatOptions),e)}preparePersistentValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.preparePersistentValue(e,t):(t.transformer&&(e=ve.transformTo(t.transformer,e)),this.client.preparePersistentValue(e,t))}prepareHydratedValue(e,t){return this.options.formatOptions&&this.options.formatOptions.castParameters===!1?super.prepareHydratedValue(e,t):(t.transformer&&(e=ve.transformFrom(t.transformer,e)),this.client.prepareHydratedValue(e,t))}loadDependencies(){let e=this.options.driver||ge.load("typeorm-aurora-data-api-driver"),{pg:t}=e;this.DataApiDriver=t}executeQuery(e,t){return this.connection.query(t)}async afterConnect(){let e=await this.checkMetadataForExtensions();return e.hasExtensions&&await this.enableExtensions(e,this.connection),Promise.resolve()}};var Io=class extends st{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new Be(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async executeSet(e){if(this.isReleased)throw new Pe;return(await this.connect()).executeSet(e,!1)}async query(e,t,r=!1){if(this.isReleased)throw new Pe;let n=await this.connect();this.driver.connection.logger.logQuery(e,t,this);let i=e.substring(0,e.indexOf(" ")!==-1?e.indexOf(" "):void 0);try{let s;["BEGIN","ROLLBACK","COMMIT","CREATE","ALTER","DROP"].indexOf(i)!==-1?s=await n.execute(e,!1):["INSERT","UPDATE","DELETE"].indexOf(i)!==-1?s=await n.run(e,t,!1):s=await n.query(e,t||[]);let a=new Le;return s?.hasOwnProperty("values")&&(a.raw=s.values,a.records=s.values),s?.hasOwnProperty("changes")&&(a.affected=s.changes.changes,a.raw=s.changes.lastId||s.changes.changes),r?a:a.raw}catch(s){throw this.driver.connection.logger.logQueryError(s,e,t,this),new Qe(e,t,s)}}parametrize(e){return Object.keys(e).map(t=>`"${t}"=?`)}};var $o=class extends Nt{constructor(e){super(e),this.database=this.options.database,this.driver=this.options.driver,this.sqlite=this.options.driver}async connect(){this.databaseConnection=this.createDatabaseConnection(),await this.databaseConnection}async disconnect(){return this.queryRunner=void 0,(await this.databaseConnection).close().then(()=>{this.databaseConnection=void 0})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Io(this)),this.queryRunner}async createDatabaseConnection(){let e=this.options.mode||"no-encryption",t=e!=="no-encryption",r=typeof this.options.version>"u"?1:this.options.version,n=await this.sqlite.createConnection(this.options.database,t,e,r);return await n.open(),await n.execute("PRAGMA foreign_keys = ON"),this.options.journalMode&&["DELETE","TRUNCATE","PERSIST","MEMORY","WAL","OFF"].indexOf(this.options.journalMode)!==-1&&await n.execute(`PRAGMA journal_mode = ${this.options.journalMode}`),n}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new wt("Capacitor","@capacitor-community/sqlite")}};var qo=class extends Ht{constructor(e,t){super(),this.driver=e,this.connection=e.connection,this.mode=t,this.broadcaster=new Be(this)}async connect(){if(this.session)return Promise.resolve(this.session);let[e]=await this.driver.instanceDatabase.createSession({});return this.session=e,this.sessionTransaction=await e.transaction(),this.session}async release(){return this.isReleased=!0,this.session&&await this.session.delete(),this.session=void 0,Promise.resolve()}async startTransaction(e){this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}await this.connect(),await this.sessionTransaction.begin(),this.connection.logger.logQuery("START TRANSACTION"),await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new He;await this.broadcaster.broadcast("BeforeTransactionCommit"),await this.sessionTransaction.commit(),this.connection.logger.logQuery("COMMIT"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive||!this.sessionTransaction)throw new He;await this.broadcaster.broadcast("BeforeTransactionRollback"),await this.sessionTransaction.rollback(),this.connection.logger.logQuery("ROLLBACK"),this.isTransactionActive=!1,await this.broadcaster.broadcast("AfterTransactionRollback")}async query(e,t,r=!1){if(this.isReleased)throw new Pe;await this.connect(),this.driver.connection.logger.logQuery(e,t,this),await this.broadcaster.broadcast("BeforeQuery",e,t);let n=new _e;try{let i=Date.now(),s,a=e.startsWith("SELECT"),c=a&&!this.isTransactionActive?this.driver.instanceDatabase:this.sessionTransaction;!this.isTransactionActive&&!a&&await this.sessionTransaction.begin();try{s=await c.run({sql:e,params:t?t.reduce((d,m,f)=>(d["param"+f]=m,d),{}):void 0,json:!0}),!this.isTransactionActive&&!a&&await this.sessionTransaction.commit()}catch(d){try{!this.isTransactionActive&&!a&&await this.sessionTransaction.rollback()}catch{}throw d}let u=this.driver.options.maxQueryExecutionTime,h=Date.now()-i;this.broadcaster.broadcastAfterQueryEvent(n,e,t,!0,h,s,void 0),u&&h>u&&this.driver.connection.logger.logQuerySlow(h,e,t,this);let p=new Le;return p.raw=s,p.records=s?s[0]:[],s&&s[1]&&s[1].rowCountExact&&(p.affected=parseInt(s[1].rowCountExact)),r?p:p.records}catch(i){throw this.driver.connection.logger.logQueryError(i,e,t,this),this.broadcaster.broadcastAfterQueryEvent(n,e,t,!1,void 0,void 0,i),new Qe(e,t,i)}finally{await n.wait()}}async updateDDL(e,t){if(this.isReleased)throw new Pe;this.driver.connection.logger.logQuery(e,t,this);try{let r=Date.now(),[n]=await this.driver.instanceDatabase.updateSchema(e);await n.promise();let i=this.driver.options.maxQueryExecutionTime,a=Date.now()-r;i&&a>i&&this.driver.connection.logger.logQuerySlow(a,e,t,this)}catch(r){throw this.driver.connection.logger.logQueryError(r,e,t,this),new Qe(e,t,r)}}async stream(e,t,r,n){if(this.isReleased)throw new Pe;try{this.driver.connection.logger.logQuery(e,t,this);let i={sql:e,params:t?t.reduce((a,c,u)=>(a["param"+u]=c,a),{}):void 0,json:!0},s=this.driver.instanceDatabase.runStream(i);return r&&s.on("end",r),n&&s.on("error",n),s}catch(i){throw this.driver.connection.logger.logQueryError(i,e,t,this),new Qe(e,t,i)}}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){throw new y("Check database queries are not supported by Spanner driver.")}async getCurrentDatabase(){throw new y("Check database queries are not supported by Spanner driver.")}async hasSchema(e){return!!(await this.query(`SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = '${e}'`)).length}async getCurrentSchema(){throw new y("Check schema queries are not supported by Spanner driver.")}async hasTable(e){let r=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` = '${e instanceof Me?e.name:e}'`;return!!(await this.query(r)).length}async hasColumn(e,t){let n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` = '${e instanceof Me?e.name:e}' AND \`COLUMN_NAME\` = '${t}'`;return!!(await this.query(n)).length}async createDatabase(e,t){if(t&&await this.hasDatabase(e))return Promise.resolve();let r=`CREATE DATABASE "${e}"`,n=`DROP DATABASE "${e}"`;await this.executeQueries(new b(r),new b(n))}async dropDatabase(e,t){let r=t?`DROP DATABASE IF EXISTS "${e}"`:`DROP DATABASE "${e}"`,n=`CREATE DATABASE "${e}"`;await this.executeQueries(new b(r),new b(n))}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t,r){return Promise.resolve()}async createTable(e,t=!1,r=!0,n=!0){if(t&&await this.hasTable(e))return Promise.resolve();let i=[],s=[];i.push(this.createTableSql(e,r)),s.push(this.dropTableSql(e)),r&&e.foreignKeys.forEach(c=>s.push(this.dropForeignKeySql(e,c))),n&&e.indices.forEach(c=>{c.name||(c.name=this.connection.namingStrategy.indexName(e,c.columnNames,c.where)),i.push(this.createIndexSql(e,c)),s.push(this.dropIndexSql(e,c))});let a=e.columns.filter(c=>c.generatedType&&c.asExpression);for(let c of a){let u=this.insertTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:c.name,value:c.asExpression}),l=this.deleteTypeormMetadataSql({table:e.name,type:ce.GENERATED_COLUMN,name:c.name});i.push(u),s.push(l)}await this.executeQueries(i,s)}async dropTable(e,t,r=!0,n=!0){if(t&&!await this.hasTable(e))return Promise.resolve();let i=r,s=this.getTablePath(e),a=await this.getCachedTable(s),c=[],u=[];n&&a.indices.forEach(h=>{c.push(this.dropIndexSql(a,h)),u.push(this.createIndexSql(a,h))}),r&&a.foreignKeys.forEach(h=>c.push(this.dropForeignKeySql(a,h))),c.push(this.dropTableSql(a)),u.push(this.createTableSql(a,i));let l=a.columns.filter(h=>h.generatedType&&h.asExpression);for(let h of l){let p=this.deleteTypeormMetadataSql({table:a.name,type:ce.GENERATED_COLUMN,name:h.name}),d=this.insertTypeormMetadataSql({table:a.name,type:ce.GENERATED_COLUMN,name:h.name,value:h.asExpression});c.push(p),u.push(d)}await this.executeQueries(c,u)}async createView(e){let t=[],r=[];t.push(this.createViewSql(e)),t.push(await this.insertViewDefinitionSql(e)),r.push(this.dropViewSql(e)),r.push(await this.deleteViewDefinitionSql(e)),await this.executeQueries(t,r)}async dropView(e){let t=e instanceof Tt?e.name:e,r=await this.getCachedView(t),n=[],i=[];n.push(await this.deleteViewDefinitionSql(r)),n.push(this.dropViewSql(r)),i.push(await this.insertViewDefinitionSql(r)),i.push(this.createViewSql(r)),await this.executeQueries(n,i)}async renameTable(e,t){throw new y("Rename table queries are not supported by Spanner driver.")}async addColumn(e,t){let r=e instanceof Me?e:await this.getCachedTable(e),n=r.clone(),i=[],s=[];i.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(t)}`)),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN ${this.driver.escape(t.name)}`));let a=n.indices.find(c=>c.columnNames.length===1&&c.columnNames[0]===t.name);if(a)i.push(this.createIndexSql(r,a)),s.push(this.dropIndexSql(r,a));else if(t.isUnique){let c=new Oe({name:this.connection.namingStrategy.indexName(r,[t.name]),columnNames:[t.name],isUnique:!0});n.indices.push(c),n.uniques.push(new Ve({name:c.name,columnNames:c.columnNames})),i.push(this.createIndexSql(r,c)),s.push(this.dropIndexSql(r,c))}if(t.generatedType&&t.asExpression){let c=this.insertTypeormMetadataSql({table:r.name,type:ce.GENERATED_COLUMN,name:t.name,value:t.asExpression}),u=this.deleteTypeormMetadataSql({table:r.name,type:ce.GENERATED_COLUMN,name:t.name});i.push(c),s.push(u)}await this.executeQueries(i,s),n.addColumn(t),this.replaceCachedTable(r,n)}async addColumns(e,t){for(let r of t)await this.addColumn(e,r)}async renameColumn(e,t,r){let n=e instanceof Me?e:await this.getCachedTable(e),i=t instanceof We?t:n.columns.find(a=>a.name===t);if(!i)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);let s;return r instanceof We?s=r:(s=i.clone(),s.name=r),this.changeColumn(n,i,s)}async changeColumn(e,t,r){let n=e instanceof Me?e:await this.getCachedTable(e),i=n.clone(),s=[],a=[],c=t instanceof We?t:n.columns.find(u=>u.name===t);if(!c)throw new y(`Column "${t}" was not found in the "${n.name}" table.`);if(c.name!==r.name||c.type!==r.type||c.length!==r.length||c.isArray!==r.isArray||c.generatedType!==r.generatedType||c.asExpression!==r.asExpression)await this.dropColumn(n,c),await this.addColumn(n,r),i=n.clone();else if((r.precision!==c.precision||r.scale!==c.scale)&&(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${this.driver.createFullType(r)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${r.name}" TYPE ${this.driver.createFullType(c)}`))),c.isNullable!==r.isNullable&&(r.isNullable?(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${c.name}" DROP NOT NULL`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${c.name}" SET NOT NULL`))):(s.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${c.name}" SET NOT NULL`)),a.push(new b(`ALTER TABLE ${this.escapePath(n)} ALTER COLUMN "${c.name}" DROP NOT NULL`)))),r.isUnique!==c.isUnique)if(r.isUnique===!0){let u=new Oe({name:this.connection.namingStrategy.indexName(n,[r.name]),columnNames:[r.name],isUnique:!0});i.indices.push(u),i.uniques.push(new Ve({name:u.name,columnNames:u.columnNames})),s.push(this.createIndexSql(n,u)),a.push(this.dropIndexSql(n,u))}else{let u=i.indices.find(h=>h.columnNames.length===1&&h.isUnique===!0&&!!h.columnNames.find(p=>p===r.name));i.indices.splice(i.indices.indexOf(u),1);let l=i.uniques.find(h=>h.name===u.name);i.uniques.splice(i.uniques.indexOf(l),1),s.push(this.dropIndexSql(n,u)),a.push(this.createIndexSql(n,u))}await this.executeQueries(s,a),this.replaceCachedTable(n,i)}async changeColumns(e,t){for(let{oldColumn:r,newColumn:n}of t)await this.changeColumn(e,r,n)}async dropColumn(e,t){let r=e instanceof Me?e:await this.getCachedTable(e),n=t instanceof We?t:r.findColumnByName(t);if(!n)throw new y(`Column "${t}" was not found in table "${r.name}"`);let i=r.clone(),s=[],a=[],c=i.indices.find(l=>l.columnNames.length===1&&l.columnNames[0]===n.name);c&&(i.indices.splice(i.indices.indexOf(c),1),s.push(this.dropIndexSql(r,c)),a.push(this.createIndexSql(r,c)));let u=i.checks.find(l=>!!l.columnNames&&l.columnNames.length===1&&l.columnNames[0]===n.name);if(u&&(i.checks.splice(i.checks.indexOf(u),1),s.push(this.dropCheckConstraintSql(r,u)),a.push(this.createCheckConstraintSql(r,u))),s.push(new b(`ALTER TABLE ${this.escapePath(r)} DROP COLUMN ${this.driver.escape(n.name)}`)),a.push(new b(`ALTER TABLE ${this.escapePath(r)} ADD ${this.buildCreateColumnSql(n)}`)),n.generatedType&&n.asExpression){let l=this.deleteTypeormMetadataSql({table:r.name,type:ce.GENERATED_COLUMN,name:n.name}),h=this.insertTypeormMetadataSql({table:r.name,type:ce.GENERATED_COLUMN,name:n.name,value:n.asExpression});s.push(l),a.push(h)}await this.executeQueries(s,a),i.removeColumn(n),this.replaceCachedTable(r,i)}async dropColumns(e,t){for(let r of[...t])await this.dropColumn(e,r)}async createPrimaryKey(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async updatePrimaryKeys(e,t){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async dropPrimaryKey(e){throw new Error("The keys of a table can't change; you can't add a key column to an existing table or remove a key column from an existing table.")}async createUniqueConstraint(e,t){throw new y("Spanner does not support unique constraints. Use unique index instead.")}async createUniqueConstraints(e,t){throw new y("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraint(e,t){throw new y("Spanner does not support unique constraints. Use unique index instead.")}async dropUniqueConstraints(e,t){throw new y("Spanner does not support unique constraints. Use unique index instead.")}async createCheckConstraint(e,t){let r=e instanceof Me?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.checkConstraintName(r,t.expression));let n=this.createCheckConstraintSql(r,t),i=this.dropCheckConstraintSql(r,t);await this.executeQueries(n,i),r.addCheckConstraint(t)}async createCheckConstraints(e,t){let r=t.map(n=>this.createCheckConstraint(e,n));await Promise.all(r)}async dropCheckConstraint(e,t){let r=e instanceof Me?e:await this.getCachedTable(e),n=t instanceof pt?t:r.checks.find(a=>a.name===t);if(!n)throw new y(`Supplied check constraint was not found in table ${r.name}`);let i=this.dropCheckConstraintSql(r,n),s=this.createCheckConstraintSql(r,n);await this.executeQueries(i,s),r.removeCheckConstraint(n)}async dropCheckConstraints(e,t){let r=t.map(n=>this.dropCheckConstraint(e,n));await Promise.all(r)}async createExclusionConstraint(e,t){throw new y("Spanner does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new y("Spanner does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new y("Spanner does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new y("Spanner does not support exclusion constraints.")}async createForeignKey(e,t){let r=e instanceof Me?e:await this.getCachedTable(e);t.name||(t.name=this.connection.namingStrategy.foreignKeyName(r,t.columnNames,this.getTablePath(t),t.referencedColumnNames));let n=this.createForeignKeySql(r,t),i=this.dropForeignKeySql(r,t);await this.executeQueries(n,i),r.addForeignKey(t)}async createForeignKeys(e,t){for(let r of t)await this.createForeignKey(e,r)}async dropForeignKey(e,t){let r=e instanceof Me?e:await this.getCachedTable(e),n=t instanceof Ye?t:r.foreignKeys.find(a=>a.name===t);if(!n)throw new y(`Supplied foreign key was not found in table ${r.name}`);let i=this.dropForeignKeySql(r,n),s=this.createForeignKeySql(r,n);await this.executeQueries(i,s),r.removeForeignKey(n)}async dropForeignKeys(e,t){for(let r of[...t])await this.dropForeignKey(e,r)}async createIndex(e,t){let r=e instanceof Me?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(r,t));let n=this.createIndexSql(r,t),i=this.dropIndexSql(r,t);await this.executeQueries(n,i),r.addIndex(t)}async createIndices(e,t){for(let r of t)await this.createIndex(e,r)}async dropIndex(e,t){let r=e instanceof Me?e:await this.getCachedTable(e),n=t instanceof Oe?t:r.indices.find(a=>a.name===t);if(!n)throw new y(`Supplied index ${t} was not found in table ${r.name}`);n.name||(n.name=this.generateIndexName(r,n));let i=this.dropIndexSql(r,n),s=this.createIndexSql(r,n);await this.executeQueries(i,s),r.removeIndex(n)}async dropIndices(e,t){for(let r of[...t])await this.dropIndex(e,r)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)} WHERE true`)}async clearDatabase(){let t=await this.query("SELECT concat('DROP INDEX `', INDEX_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`INDEXES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `INDEX_TYPE` = 'INDEX' AND `SPANNER_IS_MANAGED` = false"),n=await this.query("SELECT concat('ALTER TABLE `', TABLE_NAME, '`', ' DROP CONSTRAINT `', CONSTRAINT_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLE_CONSTRAINTS` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `CONSTRAINT_TYPE` = 'FOREIGN KEY'"),s=await this.query("SELECT concat('DROP TABLE `', TABLE_NAME, '`') AS `query` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'");if(!t.length&&!n.length&&!s.length)return;let a=this.isTransactionActive;a||await this.startTransaction();try{for(let c of t)await this.updateDDL(c.query);for(let c of n)await this.updateDDL(c.query);for(let c of s)await this.updateDDL(c.query);await this.commitTransaction()}catch(c){try{a||await this.rollbackTransaction()}catch{}throw c}}async executeMemoryUpSql(){for(let{query:e,parameters:t}of this.sqlInMemory.upQueries)this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async executeMemoryDownSql(){for(let{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())this.isDMLQuery(e)?await this.query(e,t):await this.updateDDL(e,t)}async loadViews(e){return Promise.resolve([])}async loadTables(e){if(e&&e.length===0)return[];let t=[];if(!e||!e.length)t.push(...await this.query("SELECT `TABLE_NAME` FROM `INFORMATION_SCHEMA`.`TABLES` WHERE `TABLE_CATALOG` = '' AND `TABLE_SCHEMA` = '' AND `TABLE_TYPE` = 'BASE TABLE'"));else{let m=`SELECT \`TABLE_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLES\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_TYPE\` = 'BASE TABLE' AND \`TABLE_NAME\` IN (${e.map(f=>`'${f}'`).join(", ")})`;t.push(...await this.query(m))}if(!t.length)return[];let r=t.map(m=>`'${m.TABLE_NAME}'`).join(", "),n=`SELECT * FROM \`INFORMATION_SCHEMA\`.\`COLUMNS\` WHERE \`TABLE_CATALOG\` = '' AND \`TABLE_SCHEMA\` = '' AND \`TABLE_NAME\` IN (${r})`,i=`SELECT \`KCU\`.\`TABLE_NAME\`, \`KCU\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'PRIMARY KEY' AND \`TC\`.\`TABLE_NAME\` IN (${r})`,s=`SELECT \`I\`.\`TABLE_NAME\`, \`I\`.\`INDEX_NAME\`, \`I\`.\`IS_UNIQUE\`, \`I\`.\`IS_NULL_FILTERED\`, \`IC\`.\`COLUMN_NAME\` FROM \`INFORMATION_SCHEMA\`.\`INDEXES\` \`I\` INNER JOIN \`INFORMATION_SCHEMA\`.\`INDEX_COLUMNS\` \`IC\` ON \`IC\`.\`INDEX_NAME\` = \`I\`.\`INDEX_NAME\` AND \`IC\`.\`TABLE_NAME\` = \`I\`.\`TABLE_NAME\` WHERE \`I\`.\`TABLE_CATALOG\` = '' AND \`I\`.\`TABLE_SCHEMA\` = '' AND \`I\`.\`TABLE_NAME\` IN (${r}) AND \`I\`.\`INDEX_TYPE\` = 'INDEX' AND \`I\`.\`SPANNER_IS_MANAGED\` = false`,a=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`CC\`.\`CHECK_CLAUSE\`, \`CCU\`.\`COLUMN_NAME\`FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CHECK_CONSTRAINTS\` \`CC\` ON \`CC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'CHECK' AND \`TC\`.\`TABLE_NAME\` IN (${r}) AND \`TC\`.\`CONSTRAINT_NAME\` NOT LIKE 'CK_IS_NOT_NULL%'`,c=`SELECT \`TC\`.\`TABLE_NAME\`, \`TC\`.\`CONSTRAINT_NAME\`, \`KCU\`.\`COLUMN_NAME\`, \`CTU\`.\`TABLE_NAME\` AS \`REFERENCED_TABLE_NAME\`, \`CCU\`.\`COLUMN_NAME\` AS \`REFERENCED_COLUMN_NAME\`, \`RC\`.\`UPDATE_RULE\`, \`RC\`.\`DELETE_RULE\` FROM \`INFORMATION_SCHEMA\`.\`TABLE_CONSTRAINTS\` \`TC\` INNER JOIN \`INFORMATION_SCHEMA\`.\`KEY_COLUMN_USAGE\` \`KCU\` ON \`KCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_TABLE_USAGE\` \`CTU\` ON \`CTU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`REFERENTIAL_CONSTRAINTS\` \`RC\` ON \`RC\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` INNER JOIN \`INFORMATION_SCHEMA\`.\`CONSTRAINT_COLUMN_USAGE\` \`CCU\` ON \`CCU\`.\`CONSTRAINT_NAME\` = \`TC\`.\`CONSTRAINT_NAME\` WHERE \`TC\`.\`TABLE_CATALOG\` = '' AND \`TC\`.\`TABLE_SCHEMA\` = '' AND \`TC\`.\`CONSTRAINT_TYPE\` = 'FOREIGN KEY' AND \`TC\`.\`TABLE_NAME\` IN (${r})`,[u,l,h,p,d]=await Promise.all([this.query(n),this.query(i),this.query(s),this.query(a),this.query(c)]);return Promise.all(t.map(async m=>{let f=new Me;f.name=this.driver.buildTableName(m.TABLE_NAME),f.columns=await Promise.all(u.filter(C=>C.TABLE_NAME===m.TABLE_NAME).map(async C=>{let U=h.filter(he=>he.TABLE_NAME===m.TABLE_NAME&&he.COLUMN_NAME===C.COLUMN_NAME&&he.IS_UNIQUE===!0),J=this.connection.entityMetadatas.find(he=>this.getTablePath(f)===this.getTablePath(he)),ne=U.length>0&&J&&J.indices.some(he=>U.some(S=>he.name===S.INDEX_NAME&&he.synchronize===!1)),oe=U.every(he=>h.some(S=>S.INDEX_NAME===he.INDEX_NAME&&S.COLUMN_NAME!==C.COLUMN_NAME)),z=new We;z.name=C.COLUMN_NAME;let O=C.SPANNER_TYPE.toLowerCase();if(O.indexOf("array")!==-1&&(z.isArray=!0,O=O.substring(O.indexOf("<")+1,O.indexOf(">"))),O.indexOf("(")!==-1?z.type=O.substring(0,O.indexOf("(")):z.type=O,this.driver.withLengthColumnTypes.indexOf(z.type)!==-1&&(z.length=O.substring(O.indexOf("(")+1,O.indexOf(")"))),C.IS_GENERATED==="ALWAYS"){z.asExpression=C.GENERATION_EXPRESSION,z.generatedType="STORED";let he=this.selectTypeormMetadataSql({table:m.TABLE_NAME,type:ce.GENERATED_COLUMN,name:z.name}),S=await this.query(he.query,he.parameters);S[0]&&S[0].value?z.asExpression=S[0].value:z.asExpression=""}return z.isUnique=U.length>0&&!ne&&!oe,z.isNullable=C.IS_NULLABLE==="YES",z.isPrimary=l.some(he=>he.TABLE_NAME===C.TABLE_NAME&&he.COLUMN_NAME===C.COLUMN_NAME),z}));let A=d.filter(C=>C.TABLE_NAME===m.TABLE_NAME);f.foreignKeys=K.uniq(A,C=>C.CONSTRAINT_NAME).map(C=>{let U=A.filter(J=>J.CONSTRAINT_NAME===C.CONSTRAINT_NAME);return new Ye({name:C.CONSTRAINT_NAME,columnNames:K.uniq(U.map(J=>J.COLUMN_NAME)),referencedDatabase:C.REFERENCED_TABLE_SCHEMA,referencedTableName:C.REFERENCED_TABLE_NAME,referencedColumnNames:K.uniq(U.map(J=>J.REFERENCED_COLUMN_NAME)),onDelete:C.DELETE_RULE,onUpdate:C.UPDATE_RULE})});let R=h.filter(C=>C.TABLE_NAME===m.TABLE_NAME);f.indices=K.uniq(R,C=>C.INDEX_NAME).map(C=>{let U=R.filter(J=>J.INDEX_NAME===C.INDEX_NAME);return new Oe({table:f,name:C.INDEX_NAME,columnNames:U.map(J=>J.COLUMN_NAME),isUnique:C.IS_UNIQUE,isNullFiltered:C.IS_NULL_FILTERED})});let I=p.filter(C=>C.TABLE_NAME===m.TABLE_NAME);return f.checks=K.uniq(I,C=>C.CONSTRAINT_NAME).map(C=>{let U=I.filter(J=>J.CONSTRAINT_NAME===C.CONSTRAINT_NAME);return new pt({name:C.CONSTRAINT_NAME,columnNames:U.map(J=>J.COLUMN_NAME),expression:C.CHECK_CLAUSE})}),f}))}createTableSql(e,t){let r=e.columns.map(s=>this.buildCreateColumnSql(s)).join(", "),n=`CREATE TABLE ${this.escapePath(e)} (${r}`;if(e.columns.filter(s=>s.isUnique).forEach(s=>{let a=e.indices.some(u=>u.columnNames.length===1&&!!u.isUnique&&u.columnNames.indexOf(s.name)!==-1),c=e.uniques.some(u=>u.columnNames.length===1&&u.columnNames.indexOf(s.name)!==-1);!a&&!c&&e.indices.push(new Oe({name:this.connection.namingStrategy.uniqueConstraintName(e,[s.name]),columnNames:[s.name],isUnique:!0}))}),e.uniques.length>0&&e.uniques.forEach(s=>{e.indices.some(c=>c.name===s.name)||e.indices.push(new Oe({name:s.name,columnNames:s.columnNames,isUnique:!0}))}),e.checks.length>0){let s=e.checks.map(a=>`CONSTRAINT \`${a.name?a.name:this.connection.namingStrategy.checkConstraintName(e,a.expression)}\` CHECK (${a.expression})`).join(", ");n+=`, ${s}`}if(e.foreignKeys.length>0&&t){let s=e.foreignKeys.map(a=>{let c=a.columnNames.map(l=>`\`${l}\``).join(", ");a.name||(a.name=this.connection.namingStrategy.foreignKeyName(e,a.columnNames,this.getTablePath(a),a.referencedColumnNames));let u=a.referencedColumnNames.map(l=>`\`${l}\``).join(", ");return`CONSTRAINT \`${a.name}\` FOREIGN KEY (${c}) REFERENCES ${this.escapePath(this.getTablePath(a))} (${u})`}).join(", ");n+=`, ${s}`}n+=")";let i=e.columns.filter(s=>s.isPrimary);if(i.length>0){let s=i.map(a=>this.driver.escape(a.name)).join(", ");n+=` PRIMARY KEY (${s})`}return new b(n)}dropTableSql(e){return new b(`DROP TABLE ${this.escapePath(e)}`)}createViewSql(e){let t=e.materialized?"MATERIALIZED ":"",r=this.escapePath(e),n=typeof e.expression=="string"?e.expression:e.expression(this.connection).getQuery();return new b(`CREATE ${t}VIEW ${r} SQL SECURITY INVOKER AS ${n}`)}async insertViewDefinitionSql(e){let{schema:t,tableName:r}=this.driver.parseTableName(e),n=e.materialized?ce.MATERIALIZED_VIEW:ce.VIEW,i=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:n,schema:t,name:r,value:i})}dropViewSql(e){let t=e.materialized?"MATERIALIZED ":"";return new b(`DROP ${t}VIEW ${this.escapePath(e)}`)}async deleteViewDefinitionSql(e){let{schema:t,tableName:r}=this.driver.parseTableName(e),n=e.materialized?ce.MATERIALIZED_VIEW:ce.VIEW;return this.deleteTypeormMetadataSql({type:n,schema:t,name:r})}createIndexSql(e,t){let r=t.columnNames.map(i=>this.driver.escape(i)).join(", "),n="";return t.isUnique&&(n+="UNIQUE "),t.isNullFiltered&&(n+="NULL_FILTERED "),new b(`CREATE ${n}INDEX \`${t.name}\` ON ${this.escapePath(e)} (${r})`)}dropIndexSql(e,t){let r=t instanceof Oe?t.name:t;return new b(`DROP INDEX \`${r}\``)}createCheckConstraintSql(e,t){return new b(`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` CHECK (${t.expression})`)}dropCheckConstraintSql(e,t){let r=t instanceof pt?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${r}\``)}createForeignKeySql(e,t){let r=t.columnNames.map(s=>this.driver.escape(s)).join(", "),n=t.referencedColumnNames.map(s=>this.driver.escape(s)).join(","),i=`ALTER TABLE ${this.escapePath(e)} ADD CONSTRAINT \`${t.name}\` FOREIGN KEY (${r}) REFERENCES ${this.escapePath(this.getTablePath(t))} (${n})`;return new b(i)}dropForeignKeySql(e,t){let r=t instanceof Ye?t.name:t;return new b(`ALTER TABLE ${this.escapePath(e)} DROP CONSTRAINT \`${r}\``)}escapePath(e){let{tableName:t}=this.driver.parseTableName(e);return`\`${t}\``}buildCreateColumnSql(e){let t=`${this.driver.escape(e.name)} ${this.connection.driver.createFullType(e)}`;return e.generatedType==="STORED"&&e.asExpression?t+=` AS (${e.asExpression}) STORED`:e.isNullable||(t+=" NOT NULL"),t}async executeQueries(e,t){if(e instanceof b&&(e=[e]),t instanceof b&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(let{query:r,parameters:n}of e)this.isDMLQuery(r)?await this.query(r,n):await this.updateDDL(r,n)}isDMLQuery(e){return e.startsWith("INSERT")||e.startsWith("UPDATE")||e.startsWith("DELETE")}changeTableComment(e,t){throw new y("spanner driver does not support change table comment.")}};var at=class o{constructor(e){this["@instanceof"]=Symbol.for("EntityMetadata"),this.childEntityMetadatas=[],this.inheritanceTree=[],this.tableType="regular",this.withoutRowid=!1,this.synchronize=!0,this.hasNonNullableRelations=!1,this.isJunction=!1,this.isAlwaysUsingConstructor=!0,this.isClosureJunction=!1,this.hasMultiplePrimaryKeys=!1,this.hasUUIDGeneratedColumns=!1,this.ownColumns=[],this.columns=[],this.ancestorColumns=[],this.descendantColumns=[],this.nonVirtualColumns=[],this.ownerColumns=[],this.inverseColumns=[],this.generatedColumns=[],this.primaryColumns=[],this.ownRelations=[],this.relations=[],this.eagerRelations=[],this.lazyRelations=[],this.oneToOneRelations=[],this.ownerOneToOneRelations=[],this.oneToManyRelations=[],this.manyToOneRelations=[],this.manyToManyRelations=[],this.ownerManyToManyRelations=[],this.relationsWithJoinColumns=[],this.relationIds=[],this.relationCounts=[],this.foreignKeys=[],this.embeddeds=[],this.allEmbeddeds=[],this.ownIndices=[],this.indices=[],this.uniques=[],this.ownUniques=[],this.checks=[],this.exclusions=[],this.ownListeners=[],this.listeners=[],this.afterLoadListeners=[],this.beforeInsertListeners=[],this.afterInsertListeners=[],this.beforeUpdateListeners=[],this.afterUpdateListeners=[],this.beforeRemoveListeners=[],this.beforeSoftRemoveListeners=[],this.beforeRecoverListeners=[],this.afterRemoveListeners=[],this.afterSoftRemoveListeners=[],this.afterRecoverListeners=[],this.connection=e.connection,this.inheritanceTree=e.inheritanceTree||[],this.inheritancePattern=e.inheritancePattern,this.treeType=e.tableTree?e.tableTree.type:void 0,this.treeOptions=e.tableTree?e.tableTree.options:void 0,this.parentClosureEntityMetadata=e.parentClosureEntityMetadata,this.tableMetadataArgs=e.args,this.target=this.tableMetadataArgs.target,this.tableType=this.tableMetadataArgs.type,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid,this.dependsOn=this.tableMetadataArgs.dependsOn}create(e,t){let r=!!(t&&t.pojo===!0),n;return typeof this.target=="function"&&!r?!t?.fromDeserializer||this.isAlwaysUsingConstructor?n=new this.target:n=Object.create(this.target.prototype):n={},this.connection.options.typename&&(n[this.connection.options.typename]=this.targetName),this.lazyRelations.forEach(i=>this.connection.relationLoader.enableLazyLoad(i,n,e)),n}hasId(e){return e?this.primaryColumns.every(t=>{let r=t.getEntityValue(e);return r!=null&&r!==""}):!1}hasAllPrimaryKeys(e){return this.primaryColumns.every(t=>{let r=t.getEntityValue(e);return r!=null})}ensureEntityIdMap(e){if(X.isObject(e))return e;if(this.hasMultiplePrimaryKeys)throw new Wa(this,e);return this.primaryColumns[0].createValueMap(e)}getEntityIdMap(e){if(e)return o.getValueMap(e,this.primaryColumns,{skipNulls:!0})}getEntityIdMixedMap(e){if(!e)return e;let t=this.getEntityIdMap(e);return this.hasMultiplePrimaryKeys?t:t&&this.primaryColumns[0].getEntityValue(t)}compareEntities(e,t){let r=this.getEntityIdMap(e);if(!r)return!1;let n=this.getEntityIdMap(t);return n?K.compareIds(r,n):!1}findColumnWithPropertyName(e){return this.columns.find(t=>t.propertyName===e)}findColumnWithDatabaseName(e){return this.columns.find(t=>t.databaseName===e)}hasColumnWithPropertyPath(e){return this.columns.some(r=>r.propertyPath===e)||this.hasRelationWithPropertyPath(e)}findColumnWithPropertyPath(e){let t=this.columns.find(n=>n.propertyPath===e);if(t)return t;let r=this.relations.find(n=>n.propertyPath===e);if(r&&r.joinColumns.length===1)return r.joinColumns[0]}findColumnWithPropertyPathStrict(e){return this.columns.find(t=>t.propertyPath===e)}findColumnsWithPropertyPath(e){let t=this.columns.find(n=>n.propertyPath===e);if(t)return[t];let r=this.findRelationWithPropertyPath(e);return r&&r.joinColumns?r.joinColumns:[]}hasRelationWithPropertyPath(e){return this.relations.some(t=>t.propertyPath===e)}findRelationWithPropertyPath(e){return this.relations.find(t=>t.propertyPath===e)}hasEmbeddedWithPropertyPath(e){return this.allEmbeddeds.some(t=>t.propertyPath===e)}findEmbeddedWithPropertyPath(e){return this.allEmbeddeds.find(t=>t.propertyPath===e)}mapPropertyPathsToColumns(e){return e.map(t=>{let r=this.findColumnWithPropertyPath(t);if(r==null)throw new it(t,this);return r})}extractRelationValuesFromEntity(e,t){let r=[];return t.forEach(n=>{let i=n.getEntityValue(e);Array.isArray(i)?i.forEach(s=>r.push([n,s,o.getInverseEntityMetadata(s,n)])):i&&r.push([n,i,o.getInverseEntityMetadata(i,n)])}),r}findInheritanceMetadata(e){if(this.inheritancePattern==="STI"&&this.childEntityMetadatas.length>0){let t;return this.discriminatorColumn&&(t=e[this.discriminatorColumn.propertyName]),this.childEntityMetadatas.find(r=>t===r.discriminatorValue||e.constructor===r.target)||this}return this}static getInverseEntityMetadata(e,t){return t.inverseEntityMetadata.findInheritanceMetadata(e)}static createPropertyPath(e,t,r=""){let n=[];return Object.keys(t).forEach(i=>{let s=r?r+"."+i:i;if(e.hasEmbeddedWithPropertyPath(s)){let a=this.createPropertyPath(e,t[i],s);n.push(...a)}else{let a=r?r+"."+i:i;n.push(a)}}),n}static difference(e,t){return e.filter(r=>!t.find(n=>K.compareIds(r,n)))}static getValueMap(e,t,r){return t.reduce((n,i)=>{let s=i.getEntityValueMap(e,r);if(!(n===void 0||s===null||s===void 0))return K.mergeDeep(n,s)},{})}build(){let e=this.connection.namingStrategy,t=this.connection.options.entityPrefix,r=this.connection.options.entitySkipConstructor;this.engine=this.tableMetadataArgs.engine,this.database=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.database:this.tableMetadataArgs.database,this.tableMetadataArgs.schema?this.schema=this.tableMetadataArgs.schema:this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.schema=this.parentEntityMetadata.schema:this.connection.options?.hasOwnProperty("schema")&&(this.schema=this.connection.options.schema),this.givenTableName=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.givenTableName:this.tableMetadataArgs.name,this.synchronize=this.tableMetadataArgs.synchronize!==!1,this.targetName=typeof this.tableMetadataArgs.target=="function"?this.tableMetadataArgs.target.name:this.tableMetadataArgs.target,this.tableMetadataArgs.type==="closure-junction"?this.tableNameWithoutPrefix=e.closureJunctionTableName(this.givenTableName):this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.tableNameWithoutPrefix=e.tableName(this.parentEntityMetadata.targetName,this.parentEntityMetadata.givenTableName):(this.tableNameWithoutPrefix=e.tableName(this.targetName,this.givenTableName),this.tableMetadataArgs.type==="junction"&&this.connection.driver.maxAliasLength&&this.connection.driver.maxAliasLength>0&&this.tableNameWithoutPrefix.length>this.connection.driver.maxAliasLength&&(this.tableNameWithoutPrefix=Qa(this.tableNameWithoutPrefix,{separator:"_",segmentLength:3}))),this.tableName=t?e.prefixTableName(t,this.tableNameWithoutPrefix):this.tableNameWithoutPrefix,this.target=this.target?this.target:this.tableName,this.name=this.targetName?this.targetName:this.tableName,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid===!0,this.tablePath=this.connection.driver.buildTableName(this.tableName,this.schema,this.database),this.orderBy=typeof this.tableMetadataArgs.orderBy=="function"?this.tableMetadataArgs.orderBy(this.propertiesMap):this.tableMetadataArgs.orderBy,r!==void 0&&(this.isAlwaysUsingConstructor=!r),this.isJunction=this.tableMetadataArgs.type==="closure-junction"||this.tableMetadataArgs.type==="junction",this.isClosureJunction=this.tableMetadataArgs.type==="closure-junction",this.comment=this.tableMetadataArgs.comment}registerColumn(e){this.ownColumns.indexOf(e)===-1&&(this.ownColumns.push(e),this.columns=this.embeddeds.reduce((t,r)=>t.concat(r.columnsFromTree),this.ownColumns),this.primaryColumns=this.columns.filter(t=>t.isPrimary),this.hasMultiplePrimaryKeys=this.primaryColumns.length>1,this.hasUUIDGeneratedColumns=this.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,this.propertiesMap=this.createPropertiesMap(),this.childEntityMetadatas&&this.childEntityMetadatas.forEach(t=>t.registerColumn(e)))}createPropertiesMap(){let e={};return this.columns.forEach(t=>K.mergeDeep(e,t.createValueMap(t.propertyPath))),this.relations.forEach(t=>K.mergeDeep(e,t.createValueMap(t.propertyPath))),e}getInsertionReturningColumns(){return this.columns.filter(e=>e.default!==void 0||e.asExpression!==void 0||e.isGenerated||e.isCreateDate||e.isUpdateDate||e.isDeleteDate||e.isVersion)}};var Do=class{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="none",this.supportedDataTypes=["bool","int64","float64","numeric","string","json","bytes","date","timestamp","array"],this.supportedUpsertTypes=[],this.spatialTypes=[],this.withLengthColumnTypes=["string","bytes"],this.withPrecisionColumnTypes=[],this.withScaleColumnTypes=[],this.mappedDataTypes={createDate:"timestamp",createDateDefault:"",updateDate:"timestamp",updateDateDefault:"",deleteDate:"timestamp",deleteDateNullable:!0,version:"int64",treeLevel:"int64",migrationId:"int64",migrationName:"string",migrationTimestamp:"int64",cacheId:"string",cacheIdentifier:"string",cacheTime:"int64",cacheDuration:"int64",cacheQuery:"string",cacheResult:"string",metadataType:"string",metadataDatabase:"string",metadataSchema:"string",metadataTable:"string",metadataName:"string",metadataValue:"string"},this.parametersPrefix="@param",this.dataTypeDefaults={},this.maxAliasLength=63,this.cteCapabilities={enabled:!0},this.connection=e,this.options=e.options,this.isReplicated=!!this.options.replication,this.loadDependencies()}async connect(){this.instance=this.spanner.instance(this.options.instanceId),this.instanceDatabase=this.instance.database(this.options.databaseId)}afterConnect(){return Promise.resolve()}async disconnect(){this.instanceDatabase.close()}createSchemaBuilder(){return new Vt(this.connection)}createQueryRunner(e){return new qo(this,e)}escapeQueryWithParameters(e,t,r){let n=Object.keys(r).map(s=>r[s]);if(!t||!Object.keys(t).length)return[e,n];let i=new Map;return e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(s,a,c)=>{if(!t.hasOwnProperty(c))return s;if(i.has(c))return this.parametersPrefix+i.get(c);let u=t[c];return u===null?s:a?u.map(l=>(n.push(l),this.createParameter(c,n.length-1))).join(", "):u instanceof Function?u():(n.push(u),i.set(c,n.length-1),this.createParameter(c,n.length-1))}),e=e.replace(/([ ]+)?=([ ]+)?:(\.\.\.)?([A-Za-z0-9_.]+)/g,(s,a,c,u,l)=>t.hasOwnProperty(l)&&t[l]===null?" IS NULL":s),[e,n]}escape(e){return`\`${e}\``}buildTableName(e,t,r){let n=[e];return r&&n.unshift(r),n.join(".")}parseTableName(e){let t=this.database,r=void 0;if(e instanceof Me||e instanceof Tt){let i=this.parseTableName(e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||r,tableName:i.tableName}}if(e instanceof Ye){let i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||r,tableName:i.tableName}}if(e instanceof at)return{database:e.database||t,schema:e.schema||r,tableName:e.tableName};let n=e.split(".");return{database:(n.length>1?n[0]:void 0)||t,schema:r,tableName:n.length>1?n[1]:n[0]}}preparePersistentValue(e,t){return t.transformer&&(e=ve.transformTo(t.transformer,e)),e==null?e:t.type==="numeric"?(this.options.driver||ge.load("spanner")).Spanner.numeric(e.toString()):t.type==="date"?re.mixedDateToDateString(e):t.type==="json"?e:t.type==="timestamp"||t.type===Date?re.mixedDateToDate(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?ve.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="bool"?e=!!e:t.type==="timestamp"||t.type===Date?e=new Date(e):t.type==="numeric"?e=e.value:t.type==="date"?e=re.mixedDateToDateString(e):t.type==="json"?e=typeof e=="string"?JSON.parse(e):e:t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=ve.transformFrom(t.transformer,e)),e)}normalizeType(e){return e.type===Number?"int64":e.type===String||e.type==="uuid"?"string":e.type===Date?"timestamp":e.type===Buffer?"bytes":e.type===Boolean?"bool":e.type||""}normalizeDefault(e){return e.default===""?`"${e.default}"`:`${e.default}`}normalizeIsUnique(e){return e.entityMetadata.indices.some(t=>t.isUnique&&t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){if(e.length)return e.length.toString();if(e.generationStrategy==="uuid")return"36";switch(e.type){case String:case"string":case"bytes":return"max";default:return""}}createFullType(e){let t=e.type;return this.getColumnLength(e)?t+=`(${this.getColumnLength(e)})`:e.width?t+=`(${e.width})`:e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+=`(${e.precision},${e.scale})`:e.precision!==null&&e.precision!==void 0&&(t+=`(${e.precision})`),e.isArray&&(t=`array<${t}>`),t}obtainMasterConnection(){return this.instanceDatabase}obtainSlaveConnection(){return this.instanceDatabase}createGeneratedMap(e,t,r){if(!t)return;if(t.insertId===void 0)return Object.keys(t).reduce((i,s)=>{let a=e.findColumnWithDatabaseName(s);return a&&K.mergeDeep(i,a.createValueMap(t[s])),i},{});let n=e.generatedColumns.reduce((i,s)=>{let a;return s.generationStrategy==="increment"&&t.insertId&&(a=t.insertId+r),K.mergeDeep(i,s.createValueMap(a))},{});return Object.keys(n).length>0?n:void 0}findChangedColumns(e,t){return t.filter(r=>{let n=e.find(s=>s.name===r.databaseName);return n?n.name!==r.databaseName||n.type!==this.normalizeType(r)||n.length!==this.getColumnLength(r)||n.asExpression!==r.asExpression||n.generatedType!==r.generatedType||n.isPrimary!==r.isPrimary||!this.compareNullableValues(r,n)||n.isUnique!==this.normalizeIsUnique(r):!1})}isReturningSqlSupported(){return!0}isUUIDGenerationSupported(){return!0}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return this.parametersPrefix+t}loadDependencies(){try{let e=this.options.driver||ge.load("spanner");if(this.options.credentials){this.spanner=new e.Spanner({projectId:this.options.projectId,credentials:this.options.credentials});return}this.spanner=new e.Spanner({projectId:this.options.projectId})}catch(e){throw console.error(e),new wt("Spanner","@google-cloud/spanner")}}compareNullableValues(e,t){return e.generatedType?!0:e.isNullable===t.isNullable}compareDefaultValues(e,t){return typeof e=="string"&&typeof t=="string"&&(e=e.replace(/^'+|'+$/g,""),t=t.replace(/^'+|'+$/g,"")),e===t}normalizeDatetimeFunction(e){if(!e)return e;if(e.toUpperCase().indexOf("CURRENT_TIMESTAMP")!==-1||e.toUpperCase().indexOf("NOW")!==-1){let r=e.match(/\(\d+\)/);return r?`CURRENT_TIMESTAMP${r[0]}`:"CURRENT_TIMESTAMP"}else return e}escapeComment(e){return e&&(e=e.replace(/\u0000/g,""),e)}};var Vn=class{create(e){let{type:t}=e.options;switch(t){case"mysql":return new Qi(e);case"postgres":return new Rn(e);case"cockroachdb":return new da(e);case"sap":return new fa(e);case"mariadb":return new Qi(e);case"sqlite":return new ga(e);case"better-sqlite3":return new Ea(e);case"cordova":return new fo(e);case"nativescript":return new To(e);case"react-native":return new go(e);case"sqljs":return new wo(e);case"oracle":return new ya(e);case"mssql":return new ma(e);case"mongodb":return new ha(e);case"expo":return new Ro(e).create();case"aurora-mysql":return new Mo(e);case"aurora-postgres":return new Oo(e);case"capacitor":return new $o(e);case"spanner":return new Do(e);default:throw new la(t,["aurora-mysql","aurora-postgres","better-sqlite3","capacitor","cockroachdb","cordova","expo","mariadb","mongodb","mssql","mysql","nativescript","oracle","postgres","react-native","sap","sqlite","sqljs","spanner"])}}};var pce=It(eg());var Er=class{static getInheritanceTree(e){let t=[e],r=n=>{let i=Object.getPrototypeOf(n);i&&i.name&&(t.push(i),r(i))};return r(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(r=>r.target&&t.indexOf(r.target)!==-1):e}};var Wn=class{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(r=>(Array.isArray(e)?e.indexOf(r.target)!==-1:r.target===e)&&r.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterForeignKeys(e){return this.foreignKeys.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(r=>r.target===e&&r.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(r=>r.target===e&&r.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(r=>(Array.isArray(e)?e.indexOf(r.target)!==-1:r.target===e)&&r.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(r=>(Array.isArray(e)?e.indexOf(r.target)!==-1:r.target===e)&&r.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&Er.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(r=>Array.isArray(t)?t.indexOf(r.target)!==-1:r.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){let r=[];return e.forEach(n=>{(Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)&&(r.find(s=>s.propertyName===n.propertyName)||r.push(n))}),r}filterByTargetAndWithoutDuplicateRelationProperties(e,t){let r=[];return e.forEach(n=>{if(Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t){let s=r.findIndex(a=>a.propertyName===n.propertyName);if(Array.isArray(t)&&s!==-1&&t.indexOf(n.target)<t.indexOf(r[s].target)){let a=Object.create(r[s]);a.type=n.type,r[s]=a}else s===-1&&r.push(n)}}),r}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){let r=[];return e.forEach(n=>{(Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)&&(r.find(a=>a.prefix===n.prefix&&a.propertyName===n.propertyName)||r.push(n))}),r}};var ts=class{constructor(e){X.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new y(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}};var dt=class{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;let[t,r]=e.split(".");return!(!t||!r||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}};var Hn=class{constructor(e,t,r){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,r&&X.assign(this,r)}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(let t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(r=>t.selection===this.alias.name+"."+r.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(dt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(dt.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!dt.isAliasProperty(this.entityOrProperty))return;let t=this.queryExpressionMap.findAliasByName(this.parentAlias),r=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(r||t.metadata.parentEntityMetadata&&(r=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),r))return r;throw new y(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty);if(this.mapAsEntity&&this.connection.hasMetadata(this.mapAsEntity))return this.connection.getMetadata(this.mapAsEntity)}get junctionAlias(){if(!this.relation)throw new y("Cannot get junction table for join without relation.");if(typeof this.entityOrProperty!="string")throw new y("Junction property is not defined.");let e=this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."));return this.relation.isOwning?H.buildAlias(this.connection.driver,void 0,e,this.alias.name):H.buildAlias(this.connection.driver,void 0,this.alias.name,e)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}};var Tr=class{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,X.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value must be a string representation of alias property");let t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new y(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){let[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}};var br=class{constructor(e,t){this.expressionMap=e,X.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){let[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value is a string representation of alias property");let[e,t]=this.relationName.split("."),n=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!n)throw new y(`Relation with property path ${t} in entity was not found.`);return n}get metadata(){if(!dt.isAliasProperty(this.relationName))throw new y("Given value is a string representation of alias property");let e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}};var Lo=class o{constructor(e){this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy),this.timeTravel=e.options?.timeTravelQueries||!1}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){let e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,r)=>(t[this.mainAlias.name+"."+r]=e[r],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);let r=new ts;return r.type=e.type,t&&(r.name=t),e.metadata&&(r.metadata=e.metadata),e.target&&!r.hasMetadata&&(r.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(r.tablePath=e.tablePath),e.subQuery&&(r.subQuery=e.subQuery),this.aliases.push(r),r}findAliasByName(e){let t=this.aliases.find(r=>r.name===e);if(!t)throw new y(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){let[t,r]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(r)}get relationMetadata(){if(!this.mainAlias)throw new y("Entity to work with is not specified!");let e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new y(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){let e=new o(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new ts(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Hn(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new Tr(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new br(this,t)),e.wheres=this.wheres.map(t=>({...t})),e.havings=this.havings.map(t=>({...t})),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.useIndex=this.useIndex,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.timeTravel=this.timeTravel,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}};var Gt=class{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}};var $e=class o{constructor(e,t,r=!0,n=!1,i,s){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=r,this._multipleParameters=n,this._getSql=i,this._objectLiteralParameters=s}get useParameter(){return x.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return x.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return x.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return x.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if(x.isFindOperator(this._value))return this._value}get getSql(){return x.isFindOperator(this._value)?this._value.getSql:this._getSql}transformValue(e){this._value instanceof o?this._value.transformValue(e):this._value=Array.isArray(this._value)&&this._multipleParameters?this._value.map(t=>e&&ve.transformTo(e,t)):ve.transformTo(e,this._value)}};function tg(o){return new $e("in",o,!0,!0)}var yx=/[.*+\-?^${}()|[\]\\]/g,rg=o=>o.replace(yx,"\\$&");var je=class o{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,x.isDataSource(e)?(this.connection=e,this.queryRunner=t,this.expressionMap=new Lo(this.connection)):(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone())}static registerQueryBuilderClass(e,t){o.queryBuilderRegistry[e]=t}get alias(){if(!this.expressionMap.mainAlias)throw new y("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){return this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(r=>({selection:r})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]),x.isSelectQueryBuilder(this)?this:o.queryBuilderRegistry.SelectQueryBuilder(this)}insert(){return this.expressionMap.queryType="insert",x.isInsertQueryBuilder(this)?this:o.queryBuilderRegistry.InsertQueryBuilder(this)}update(e,t){let r=t||e;if(e=x.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){let n=this.createFromAlias(e);this.expressionMap.setMainAlias(n)}return this.expressionMap.queryType="update",this.expressionMap.valuesSet=r,x.isUpdateQueryBuilder(this)?this:o.queryBuilderRegistry.UpdateQueryBuilder(this)}delete(){return this.expressionMap.queryType="delete",x.isDeleteQueryBuilder(this)?this:o.queryBuilderRegistry.DeleteQueryBuilder(this)}softDelete(){return this.expressionMap.queryType="soft-delete",x.isSoftDeleteQueryBuilder(this)?this:o.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}restore(){return this.expressionMap.queryType="restore",x.isSoftDeleteQueryBuilder(this)?this:o.queryBuilderRegistry.SoftDeleteQueryBuilder(this)}relation(e,t){let r=arguments.length===2?e:void 0,n=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=n,r){let i=this.createFromAlias(r);this.expressionMap.setMainAlias(i)}return x.isRelationQueryBuilder(this)?this:o.queryBuilderRegistry.RelationQueryBuilder(this)}hasRelation(e,t){let r=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!r.findRelationWithPropertyPath(i))}hasParameter(e){return this.parentQueryBuilder?.hasParameter(e)||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new y(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new y("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(let[t,r]of Object.entries(e))this.setParameter(t,r);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){let e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){let t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){let r=t.childEntityMetadatas.filter(n=>n.discriminatorColumn).map(n=>n.discriminatorValue);r.push(t.discriminatorValue),e.discriminatorColumnValues=r}}return e}printSql(){let[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){let e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){let[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner();try{return await r.query(e,t)}finally{r!==this.queryRunner&&await r.release()}}createQueryBuilder(e){return new this.constructor(this.connection,e??this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,r){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:r||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new y('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){let r=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:r.tablePath})}else{if(typeof e=="string"){let i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}let r=e(this.subQuery());this.setParameters(r.getParameters());let n=r.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:n})}}replacePropertyNames(e){return e}replacePropertyNamesForTheWholeQuery(e){let t={};for(let i of this.expressionMap.aliases){if(!i.hasMetadata)continue;let s=this.expressionMap.aliasNamePrefixingEnabled&&i.name?`${i.name}.`:"";t[s]||(t[s]={});for(let a of i.metadata.relations)a.joinColumns.length>0&&(t[s][a.propertyPath]=a.joinColumns[0].databaseName);for(let a of i.metadata.relations){let c=[...a.joinColumns,...a.inverseJoinColumns];for(let u of c){let l=`${a.propertyPath}.${u.referencedColumn.propertyPath}`;t[s][l]=u.databaseName}}for(let a of i.metadata.columns)t[s][a.databaseName]=a.databaseName;for(let a of i.metadata.columns)t[s][a.propertyName]=a.databaseName;for(let a of i.metadata.columns)t[s][a.propertyPath]=a.databaseName}let r=Object.keys(t),n=r.map(i=>rg(i)).join("|");return r.length>0&&(e=e.replace(new RegExp(`([ =(]|^.{0})${n?"("+n+")":""}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(...i)=>{let s,a,c;if(n){if(s=i[0],a=i[1],c=i[3],t[i[2]][c])return`${a}${this.escape(i[2].substring(0,i[2].length-1))}.${this.escape(t[i[2]][c])}`}else if(s=i[0],a=i[1],c=i[2],t[""][c])return`${a}${this.escape(t[""][c])}`;return s})),e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace(/\*\//g,"")} */ `:""}createTimeTravelQuery(){return this.expressionMap.queryType==="select"&&this.expressionMap.timeTravel?` AS OF SYSTEM TIME ${this.expressionMap.timeTravel}`:""}createWhereExpression(){let e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){let n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&n.deleteDateColumn){let i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.deleteDateColumn.propertyName:n.deleteDateColumn.propertyName,s=`${this.replacePropertyNames(i)} IS NULL`;e.push(s)}if(n.discriminatorColumn&&n.parentEntityMetadata){let i=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.discriminatorColumn.databaseName:n.discriminatorColumn.databaseName,s=`${this.replacePropertyNames(i)} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){let n=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(n)}let r="";return r+=this.createTimeTravelQuery(),e.length?e.length===1?r+=` WHERE ${e[0]}`:r+=` WHERE ( ${e.join(" ) AND ( ")} )`:r+="",r}createReturningExpression(e){let t=this.getReturningColumns(),r=this.connection.driver;if(typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&r.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(n=>t.indexOf(n)===-1)),t.length){let n=t.map(i=>{let s=this.escape(i.databaseName);return r.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+s:this.escape(this.getMainTableName())+"."+s:s}).join(", ");return r.options.type==="oracle"&&(n+=" INTO "+t.map(i=>this.createParameter({type:r.columnTypeToNativeParameter(i.type),dir:r.oracle.BIND_OUT})).join(", ")),r.options.type==="mssql"&&(this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update")&&(n+=" INTO @OutputTable"),n}else if(typeof this.expressionMap.returning=="string")return this.expressionMap.returning;return""}getReturningColumns(){let e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,r)=>{let n=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(r>0?"AND ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${n}${this.connection.options.isolateWhereStatements?")":""}`;case"or":return(r>0?"OR ":"")+`${this.connection.options.isolateWhereStatements?"(":""}${n}${this.connection.options.isolateWhereStatements?")":""}`}return n}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";let{driver:r}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"jsonContains":return`${e.parameters[0]} ::jsonb @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return r.options.type==="postgres"||r.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return r.options.type==="cockroachdb"?`${e.parameters[0]}::STRING = ANY(${e.parameters[1]}::STRING[])`:`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`;case"and":return"("+e.parameters.join(" AND ")+")";case"or":return"("+e.parameters.join(" OR ")+")"}throw new TypeError(`Unsupported FindOperator ${$e.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";let e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(r=>{let n=typeof r.queryBuilder=="string"?r.queryBuilder:"";if(typeof r.queryBuilder!="string"){if(r.queryBuilder.hasCommonTableExpressions())throw new y(`Nested CTEs aren't supported (CTE: ${r.alias})`);if(n=r.queryBuilder.getQuery(),!this.connection.driver.cteCapabilities.writable&&!x.isSelectQueryBuilder(r.queryBuilder))throw new y(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${r.alias})`);this.setParameters(r.queryBuilder.getParameters())}let i=this.escape(r.alias);if(r.options.columnNames){let c=r.options.columnNames.map(u=>this.escape(u));if(x.isSelectQueryBuilder(r.queryBuilder)&&r.queryBuilder.expressionMap.selects.length&&r.options.columnNames.length!==r.queryBuilder.expressionMap.selects.length)throw new y(`cte.options.columnNames length (${r.options.columnNames.length}) doesn't match subquery select list length ${r.queryBuilder.expressionMap.selects.length} (CTE: ${r.alias})`);i+=`(${c.join(", ")})`}let s=r.options.recursive&&e?"RECURSIVE":"",a="";return this.connection.driver.cteCapabilities.materializedHint&&r.options.materialized!==void 0&&(a=r.options.materialized?"MATERIALIZED":"NOT MATERIALIZED"),[s,i,"AS",a,`(${n})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){let t=this.expressionMap.mainAlias.metadata,r=(Array.isArray(e)?e:[e]).map(n=>t.ensureEntityIdMap(n));if(!t.hasMultiplePrimaryKeys){let n=t.primaryColumns[0];if(!n.transformer&&!n.relationMetadata&&!n.embeddedMetadata)return{[n.propertyName]:tg(r.map(i=>n.getEntityValue(i,!1)))}}return new Gt(n=>{for(let i of r)n.orWhere(new Gt(s=>s.where(i)))})}getExistsCondition(e){let t=e.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select("1").setOption("disable-global-order");return[`EXISTS (${t.getQuery()})`,t.getParameters()]}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias,r=[],n=e.split(".");for(;n.length>1;){let a=n[0];if(!t?.hasMetadata)break;if(t.metadata.hasEmbeddedWithPropertyPath(a)){n.unshift(`${n.shift()}.${n.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(a)){let c=this.expressionMap.joinAttributes.find(u=>u.relationPropertyPath===a);if(!c?.alias){let u=r.length>0?`${r.join(".")}.${a}`:a;throw new Error(`Cannot find alias for relation at ${u}`)}t=c.alias,r.push(...a.split(".")),n.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);let i=n.join("."),s=t.metadata.findColumnsWithPropertyPath(i);if(!s.length)throw new it(e,t.metadata);return[t,r,s]}createPropertyPath(e,t,r=""){let n=[];for(let i of Object.keys(t)){let s=r?`${r}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||x.isFindOperator(t[i])){n.push(s);continue}if(e.hasEmbeddedWithPropertyPath(s)){let a=this.createPropertyPath(e,t[i],s);n.push(...a);continue}if(e.hasRelationWithPropertyPath(s)){let a=e.findRelationWithPropertyPath(s);if(a.relationType==="one-to-one"||a.relationType==="many-to-one"){let h=a.joinColumns.map(d=>d.referencedColumn).filter(d=>!!d);if(h.length>0&&h.every(d=>d.getEntityValue(t[i],!1))){n.push(s);continue}}if(a.relationType==="one-to-many"||a.relationType==="many-to-many")throw new Error(`Cannot query across ${a.relationType} for property ${s}`);let c=a.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(h=>h.getEntityValue(t[i],!1))){let h=c.map(p=>`${s}.${p.propertyPath}`);n.push(...h);continue}let l=this.createPropertyPath(a.inverseEntityMetadata,t[i]).map(h=>`${s}.${h}`);n.push(...l);continue}n.push(s)}return n}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){let t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(let r of t){let[n,i,s]=this.findColumnsForPropertyPath(r);for(let a of s){let c=e;for(let h of i){if(!c||!(h in c)){c={};break}c=c[h]}let u=this.expressionMap.aliasNamePrefixingEnabled?`${n.name}.${a.propertyPath}`:a.propertyPath,l=a.getEntityValue(c,!0);yield[u,l]}}}else for(let t of Object.keys(e)){let r=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,r]}}getWherePredicateCondition(e,t){if(x.isFindOperator(t)){let r=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(let n of t.value)r.push(this.createParameter(n));else r.push(this.createParameter(t.value));if(t.type==="raw")return t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]};if(t.type==="not")return t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...r]};if(t.type==="and"){let n=t.value;return{operator:t.type,parameters:n.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else if(t.type==="or"){let n=t.value;return{operator:t.type,parameters:n.map(i=>this.createWhereConditionExpression(this.getWherePredicateCondition(e,i)))}}else return{operator:t.type,parameters:[e,...r]}}else if(t===null){let r=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(r==="sql-null")return{operator:"isNull",parameters:[e]};if(r==="throw")throw new y(`Null value encountered in property '${e}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}else if(t===void 0&&(this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new y(`Undefined value encountered in property '${e}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if(x.isBrackets(e)){let n=this.createQueryBuilder();return n.parentQueryBuilder=this,n.expressionMap.mainAlias=this.expressionMap.mainAlias,n.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,n.expressionMap.parameters=this.expressionMap.parameters,n.expressionMap.nativeParameters=this.expressionMap.nativeParameters,n.expressionMap.wheres=[],e.whereFactory(n),{operator:x.isNotBrackets(e)?"not":"brackets",condition:n.expressionMap.wheres}}if(typeof e=="function")return e(this);let t=Array.isArray(e)?e:[e],r=[];for(let n of t){let i=[];for(let[s,a]of this.getPredicates(n))i.push({type:"and",condition:this.getWherePredicateCondition(s,a)});r.push({type:"or",condition:i})}return r.length===1?r[0].condition:r}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}};je.queryBuilderRegistry={};var rs=class{static from(e){let t=new this;return t.raw=e.records,t.affected=e.affected,t}};var ns=class extends je{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createDeleteExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner(),n=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);let i=await r.query(e,t,!0),s=rs.from(i);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await r.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),n&&await r.commitTransaction(),s}catch(i){if(n)try{await r.rollbackTransaction()}catch{}throw i}finally{r!==this.queryRunner&&await r.release()}}from(e,t){e=x.isEntitySchema(e)?e.options.name:e;let r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new Wt;return this.expressionMap.returning=e,this}createDeleteExpression(){let e=this.getTableName(this.getMainTableName()),t=this.createWhereExpression(),r=this.createReturningExpression("delete");return r===""?`DELETE FROM ${e}${t}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${e} OUTPUT ${r}${t}`:this.connection.driver.options.type==="spanner"?`DELETE FROM ${e}${t} THEN RETURN ${r}`:`DELETE FROM ${e}${t} RETURNING ${r}`}};var nt=[];for(let o=0;o<256;++o)nt.push((o+256).toString(16).slice(1));function ng(o,e=0){return(nt[o[e+0]]+nt[o[e+1]]+nt[o[e+2]]+nt[o[e+3]]+"-"+nt[o[e+4]]+nt[o[e+5]]+"-"+nt[o[e+6]]+nt[o[e+7]]+"-"+nt[o[e+8]]+nt[o[e+9]]+"-"+nt[o[e+10]]+nt[o[e+11]]+nt[o[e+12]]+nt[o[e+13]]+nt[o[e+14]]+nt[o[e+15]]).toLowerCase()}var wl,gx=new Uint8Array(16);function Nl(){if(!wl){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");wl=crypto.getRandomValues.bind(crypto)}return wl(gx)}var Ex=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Al={randomUUID:Ex};function Tx(o,e,t){if(Al.randomUUID&&!e&&!o)return Al.randomUUID();o=o||{};let r=o.random??o.rng?.()??Nl();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let n=0;n<16;++n)e[t+n]=r[n];return e}return ng(r)}var is=Tx;var Gn=class{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){let t=new this;return t.raw=e.raw,t}};var wr=class{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){let r=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(n,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,u,l)=>(c[this.expressionMap.extraReturningColumns[l].databaseName]=u[0],c),{}));let s=Array.isArray(e.raw)?e.raw[i]:e.raw,a=this.queryRunner.connection.driver.createGeneratedMap(r,s);a&&(this.queryRunner.manager.merge(r.target,n,a),e.generatedMaps.push(a))}else{let s=this.expressionMap.extraReturningColumns;if(s.length>0){let a=this.expressionMap.mainAlias.metadata.getEntityIdMap(n);if(!a)throw new y("Cannot update entity because entity id is not set in the entity.");let c=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(u=>r.targetName+"."+u.propertyPath)).addSelect(s.map(u=>r.targetName+"."+u.propertyPath)).from(r.target,r.targetName).where(a).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(r.target,n,c),e.generatedMaps.push(c))}}}))}async insert(e,t){let r=this.expressionMap.mainAlias.metadata,n=r.getInsertionReturningColumns(),i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");n=n.filter(a=>a.isGenerated?i===!0:!0);let s=t.map((a,c)=>{Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(this.queryRunner.connection.driver.options.type==="oracle"?e.raw=e.raw.reduce((h,p,d)=>(h[this.expressionMap.extraReturningColumns[d].databaseName]=p[0],h),{}):this.queryRunner.connection.driver.options.type==="spanner"&&(e.raw=e.raw[0]));let u=Array.isArray(e.raw)?e.raw[c]:e.raw,l=this.queryRunner.connection.driver.createGeneratedMap(r,u,c,t.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(r.target,l,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(r.target,a,l),l});if(n.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){let a=t.map(u=>{let l=r.getEntityIdMap(u);if(!l)throw new y("Cannot update entity because entity id is not set in the entity.");return l}),c=await this.queryRunner.manager.createQueryBuilder().select(r.primaryColumns.map(u=>r.targetName+"."+u.propertyPath)).addSelect(n.map(u=>r.targetName+"."+u.propertyPath)).from(r.target,r.targetName).where(a).setOption("create-pojo").getMany();t.forEach((u,l)=>{this.queryRunner.manager.merge(r.target,s[l],c[l]),this.queryRunner.manager.merge(r.target,u,c[l])})}t.forEach((a,c)=>{let u=r.getEntityIdMap(a);e.identifiers.push(u),e.generatedMaps.push(s[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.asExpression!==void 0||e.isUpdateDate||e.isVersion||e.isDeleteDate)}};var ss=class extends je{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createInsertExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let e=this.getValueSets();if(e.length===0)return new Gn;let t=this.obtainQueryRunner(),r=!1;try{if(this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),r=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){let m=new _e;e.forEach(f=>{t.broadcaster.broadcastBeforeInsertEvent(m,this.expressionMap.mainAlias.metadata,f)}),await m.wait()}let n=null,i=null,s=new wr(t,this.expressionMap),a=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(let m of this.expressionMap.returning)a.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(m));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(e.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),a.push(...this.expressionMap.extraReturningColumns.filter(m=>!a.includes(m)))),a.length>0&&this.connection.driver.options.type==="mssql"&&(n=this.connection.driver.buildTableVariableDeclaration("@OutputTable",a),i="SELECT * FROM @OutputTable");let[c,u]=this.getQueryAndParameters(),h=[n,c,i].filter(m=>m!=null).join(`;

`),p=await t.query(h,u,!0),d=Gn.from(p);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.insert(d,e),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){let m=new _e;e.forEach(f=>{t.broadcaster.broadcastAfterInsertEvent(m,this.expressionMap.mainAlias.metadata,f)}),await m.wait()}return r&&await t.commitTransaction(),d}catch(n){if(r)try{await t.rollbackTransaction()}catch{}throw n}finally{t!==this.queryRunner&&await t.release()}}into(e,t){e=x.isEntitySchema(e)?e.options.name:e;let r=this.createFromAlias(e);return this.expressionMap.setMainAlias(r),this.expressionMap.insertColumns=t||[],this}values(e){return this.expressionMap.valuesSet=e,this}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new Wt;return this.expressionMap.returning=e,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}onConflict(e){return this.expressionMap.onConflict=e,this}orIgnore(e=!0){return this.expressionMap.onIgnore=!!e,this}orUpdate(e,t,r){let{where:n,parameters:i}=r?.overwriteCondition??{},s;if(n){let a=this.getWhereCondition(n);(Array.isArray(a)?a.length!==0:a)&&(s=[{type:"simple",condition:a}])}return i&&this.setParameters(i),Array.isArray(e)?(this.expressionMap.onUpdate={overwrite:e,conflict:t,skipUpdateIfNoValuesChanged:r?.skipUpdateIfNoValuesChanged,indexPredicate:r?.indexPredicate,upsertType:r?.upsertType,overwriteCondition:s},this):(this.expressionMap.onUpdate={conflict:e?.conflict_target,columns:e?.columns,overwrite:e?.overwrite,skipUpdateIfNoValuesChanged:r?.skipUpdateIfNoValuesChanged,upsertType:r?.upsertType,overwriteCondition:s},this)}createInsertExpression(){if((this.expressionMap.onUpdate||this.expressionMap.onIgnore)&&(this.expressionMap.onUpdate?.upsertType??"merge-into")==="merge-into"&&this.connection.driver.supportedUpsertTypes.includes("merge-into"))return this.createMergeExpression();let e=this.getTableName(this.getMainTableName()),t=this.alias!==this.getMainTableName()?this.escape(this.alias):e,r=this.createValuesExpression(),n=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression(),s="INSERT ";if(this.expressionMap.onUpdate?.upsertType==="primary-key"&&(s="UPSERT "),(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),s+=`INTO ${e}`,this.alias!==this.getMainTableName()&&H.isPostgresFamily(this.connection.driver)&&(s+=` AS "${this.alias}"`),i?s+=`(${i})`:!r&&(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s+="()"),n&&this.connection.driver.options.type==="mssql"&&(s+=` OUTPUT ${n}`),r?(this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="sap")&&this.getValueSets().length>1?s+=` ${r}`:s+=` VALUES ${r}`:H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?s+=" VALUES ()":s+=" DEFAULT VALUES",this.expressionMap.onUpdate?.upsertType!=="primary-key"){if(this.connection.driver.supportedUpsertTypes.includes("on-conflict-do-update")){if(this.expressionMap.onIgnore)s+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)s+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){let{overwrite:a,columns:c,conflict:u,skipUpdateIfNoValuesChanged:l,indexPredicate:h}=this.expressionMap.onUpdate,p="ON CONFLICT";if(Array.isArray(u)){if(p+=` ( ${u.map(m=>this.escape(m)).join(", ")} )`,h&&!H.isPostgresFamily(this.connection.driver))throw new y("indexPredicate option is not supported by the current database driver");h&&H.isPostgresFamily(this.connection.driver)&&(p+=` WHERE ( ${h} )`)}else u&&(p+=` ON CONSTRAINT ${this.escape(u)}`);let d=[];if(Array.isArray(a)?d.push(...a.map(m=>`${this.escape(m)} = EXCLUDED.${this.escape(m)}`)):c&&d.push(...c.map(m=>`${this.escape(m)} = :${m}`)),d.length>0&&(s+=` ${p} DO UPDATE SET `,d.push(...this.expressionMap.mainAlias.metadata.columns.filter(m=>m.isUpdateDate&&!a?.includes(m.databaseName)&&!(this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1||H.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")).map(m=>`${this.escape(m.databaseName)} = DEFAULT`)),s+=d.join(", ")),Array.isArray(a)&&l){this.expressionMap.onUpdate.overwriteCondition??=[];let m=a.map(f=>({type:"or",condition:`${t}.${this.escape(f)} IS DISTINCT FROM EXCLUDED.${this.escape(f)}`}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:m})}H.isPostgresFamily(this.connection.driver)&&this.expressionMap.onUpdate.overwriteCondition&&this.expressionMap.onUpdate.overwriteCondition.length>0&&(s+=` WHERE ${this.createUpsertConditionExpression()}`)}}else if(this.connection.driver.supportedUpsertTypes.includes("on-duplicate-key-update")){if(this.expressionMap.onUpdate){let{overwrite:a,columns:c}=this.expressionMap.onUpdate;Array.isArray(a)?(s+=" ON DUPLICATE KEY UPDATE ",s+=a.map(u=>`${this.escape(u)} = VALUES(${this.escape(u)})`).join(", "),s+=" "):Array.isArray(c)&&(s+=" ON DUPLICATE KEY UPDATE ",s+=c.map(u=>`${this.escape(u)} = :${u}`).join(", "),s+=" ")}}else if(this.expressionMap.onUpdate)throw new y("onUpdate is not supported by the current database driver")}return n&&(H.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||H.isMySQLFamily(this.connection.driver))&&(s+=` RETURNING ${n}`),n&&this.connection.driver.options.type==="spanner"&&(s+=` THEN RETURN ${n}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(a=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(a.propertyPath)!==-1:a.isInsert).some(a=>this.isOverridingAutoIncrementBehavior(a))&&(s=`SET IDENTITY_INSERT ${e} ON; ${s}; SET IDENTITY_INSERT ${e} OFF`),s}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(e=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(e.propertyPath)!==-1:!(!e.isInsert||e.isGenerated&&e.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!H.isSQLiteFamily(this.connection.driver)&&!H.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(e)))):[]}createColumnNamesExpression(){let e=this.getInsertedColumns();if(e.length>0)return e.map(t=>this.escape(t.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){let t=this.getValueSets();if(t.length===1)return Object.keys(t[0]).map(r=>this.escape(r)).join(", ")}return this.expressionMap.insertColumns.map(t=>this.escape(t)).join(", ")}createValuesExpression(){let e=this.getValueSets(),t=this.getInsertedColumns();if(t.length>0){let r="";return e.forEach((n,i)=>{t.forEach((s,a)=>{a===0&&(this.connection.driver.options.type==="oracle"&&e.length>1||this.connection.driver.options.type==="sap"&&e.length>1?r+=" SELECT ":r+="("),r+=this.createColumnValueExpression(e,i,s),a===t.length-1?i===e.length-1?["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?r+=" FROM "+this.connection.driver.dummyTableName:r+=")":["oracle","sap"].includes(this.connection.driver.options.type)&&e.length>1?r+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":r+="), ":r+=", "})}),r==="()"?"":r}else{let r="";return e.forEach((n,i)=>{Object.keys(n).forEach((a,c)=>{c===0&&(r+="(");let u=n[a];typeof u=="function"?r+=u():u===void 0?this.connection.driver.options.type==="oracle"&&e.length>1||H.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r+="NULL":r+="DEFAULT":u===null&&this.connection.driver.options.type==="spanner"||(r+=this.createParameter(u)),c===Object.keys(n).length-1?i===e.length-1?r+=")":r+="), ":r+=", "})}),r==="()"?"":r}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(X.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new ro}isOverridingAutoIncrementBehavior(e){return e.isPrimary&&e.isGenerated&&e.generationStrategy==="increment"&&this.getValueSets().some(t=>e.getEntityValue(t)!==void 0&&e.getEntityValue(t)!==null)}createMergeExpression(){if(!this.connection.driver.supportedUpsertTypes.includes("merge-into"))throw new y('Upsert type "merge-into" is not supported by current database driver');if(this.expressionMap.onUpdate?.upsertType&&this.expressionMap.onUpdate.upsertType!=="merge-into")throw new y(`Upsert type "${this.expressionMap.onUpdate.upsertType}" is not supported by current database driver`);let e=this.getTableName(this.getMainTableName()),t=this.escape(this.alias),r=this.getInsertedColumns(),n=this.createColumnNamesExpression(),i=`MERGE INTO ${e} ${this.escape(this.alias)}`,s=this.escape("mergeIntoSource"),a=this.createMergeIntoSourceExpression(s);if(i+=` ${a}`,this.expressionMap.onIgnore){let l=r.find(h=>h.isPrimary);l?i+=` ON (${t}.${this.escape(l.databaseName)} = ${s}.${this.escape(l.databaseName)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(h=>`(${h.columns.map(p=>`${t}.${this.escape(p.databaseName)} = ${s}.${this.escape(p.databaseName)}`).join(" AND ")})`).join(" OR ")})`}else if(this.expressionMap.onUpdate){let{conflict:l,indexPredicate:h}=this.expressionMap.onUpdate;if(h)throw new y('indexPredicate option is not supported by upsert type "merge-into"');Array.isArray(l)?i+=` ON (${l.map(p=>`${t}.${this.escape(p)} = ${s}.${this.escape(p)}`).join(" AND ")})`:l?i+=` ON (${t}.${this.escape(l)} = ${s}.${this.escape(l)})`:i+=`ON (${this.expressionMap.mainAlias.metadata.uniques.map(p=>`(${p.columns.map(d=>`${t}.${this.escape(d.databaseName)} = ${s}.${this.escape(d.databaseName)}`).join(" AND ")})`).join(" OR ")})`}if(this.expressionMap.onUpdate){let{overwrite:l,columns:h,conflict:p,skipUpdateIfNoValuesChanged:d}=this.expressionMap.onUpdate,m="";if(Array.isArray(l)&&(m+=(l||h)?.filter(A=>!p?.includes(A)).map(A=>`${t}.${this.escape(A)} = ${s}.${this.escape(A)}`).join(", ")),Array.isArray(l)&&d){this.expressionMap.onUpdate.overwriteCondition??=[];let A=l.map(R=>({type:"or",condition:{operator:"notEqual",parameters:[`${t}.${this.escape(R)}`,`${s}.${this.escape(R)}`]}}));this.expressionMap.onUpdate.overwriteCondition.push({type:"and",condition:A})}let f=this.createUpsertConditionExpression();m.trim()&&((this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap")&&f!=""?i+=` WHEN MATCHED AND ${f} THEN UPDATE SET ${m}`:(i+=` WHEN MATCHED THEN UPDATE SET ${m}`,f!=""&&(i+=` WHERE ${f}`)))}let c=this.createMergeIntoInsertValuesExpression(s),u=this.connection.driver.options.type==="mssql"?this.createReturningExpression("insert"):null;return i+=" WHEN NOT MATCHED THEN INSERT",n&&(i+=`(${n})`),c&&(i+=` VALUES ${c}`),u&&this.connection.driver.options.type==="mssql"&&(i+=` OUTPUT ${u}`),this.connection.driver.options.type==="mssql"&&(i+=";"),i}createMergeIntoSourceExpression(e){let t=this.getValueSets(),r=this.getInsertedColumns(),n="USING (";if(r.length>0)this.connection.driver.options.type==="mssql"&&(n+="VALUES "),t.forEach((i,s)=>{r.forEach((a,c)=>{c===0&&(this.connection.driver.options.type==="mssql"?n+="(":n+="SELECT ");let u=a.getEntityValue(i);u===void 0&&!(a.isGenerated&&a.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported())?a.default!==void 0&&a.default!==null?n+=this.connection.driver.normalizeDefault(a):n+="NULL":u===null?n+="NULL":n+=this.createColumnValueExpression(t,s,a),this.connection.driver.options.type!=="mssql"&&(n+=` AS ${this.escape(a.databaseName)}`),c===r.length-1?s===t.length-1?["oracle","sap"].includes(this.connection.driver.options.type)?n+=" FROM "+this.connection.driver.dummyTableName:this.connection.driver.options.type==="mssql"&&(n+=")"):["oracle","sap"].includes(this.connection.driver.options.type)&&t.length>1?n+=" FROM "+this.connection.driver.dummyTableName+" UNION ALL ":this.connection.driver.options.type==="mssql"?n+="), ":n+=" UNION ALL ":n+=", "})});else throw new y('Upsert type "merge-into" is not supported without metadata tables');return n+=`) ${e}`,this.connection.driver.options.type==="mssql"&&(n+=` (${r.map(i=>this.escape(i.databaseName)).join(", ")})`),n}createMergeIntoInsertValuesExpression(e){let t=this.getInsertedColumns(),r="";if(t.length>0)t.forEach((n,i)=>{i===0&&(r+="("),n.isGenerated&&n.generationStrategy==="uuid"&&this.connection.driver.isUUIDGenerationSupported()||n.isGenerated&&n.generationStrategy!=="uuid"?r+="DEFAULT":r+=`${e}.${this.escape(n.databaseName)}`,i===t.length-1?r+=")":r+=", "});else throw new y('Upsert type "merge-into" is not supported without metadata tables');return r==="()"?"":r}createUpsertConditionExpression(){if(!this.expressionMap.onUpdate.overwriteCondition)return"";let e=[],t=this.createWhereClausesExpression(this.expressionMap.onUpdate.overwriteCondition);if(t.length>0&&t!=="1=1"&&e.push(t),this.expressionMap.mainAlias.hasMetadata){let n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&n.deleteDateColumn){let s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.deleteDateColumn.propertyName:n.deleteDateColumn.propertyName} IS NULL`;e.push(s)}if(n.discriminatorColumn&&n.parentEntityMetadata){let s=`${this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.discriminatorColumn.databaseName:n.discriminatorColumn.databaseName} IN (:...discriminatorColumnValues)`;e.push(s)}}if(this.expressionMap.extraAppendedAndWhereCondition){let n=this.expressionMap.extraAppendedAndWhereCondition;e.push(n)}let r="";return e.length?e.length===1?r+=`${e[0]}`:r+=`( ${e.join(" ) AND ( ")} )`:r+="",r}createColumnValueExpression(e,t,r){let n=e[t],i="",s=r.getEntityValue(n);if(typeof s!="function"&&(s=this.connection.driver.preparePersistentValue(s,r)),r.isVersion&&s===void 0)i+="1";else if(r.isDiscriminator)i+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(r.isGenerated&&r.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&s===void 0)s=is(),i+=this.createParameter(s),t in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[t]={}),r.setEntityValue(this.expressionMap.locallyGenerated[t],s);else if(s===void 0)this.connection.driver.options.type==="oracle"&&e.length>1||H.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?r.default!==void 0&&r.default!==null?i+=this.connection.driver.normalizeDefault(r):this.connection.driver.options.type==="spanner"&&r.isGenerated&&r.generationStrategy==="uuid"?i+="GENERATE_UUID()":i+="NULL":i+="DEFAULT";else if(s===null&&(this.connection.driver.options.type==="spanner"||this.connection.driver.options.type==="oracle"))i+="NULL";else if(typeof s=="function")i+=s();else{this.connection.driver.options.type==="mssql"&&(s=this.connection.driver.parametrizeValue(r,s));let a=this.createParameter(s);if((H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.includes(r.type)){let u=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";r.srid!=null?i+=`${u}(${a}, ${r.srid})`:i+=`${u}(${a})`}else H.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.includes(r.type)?r.srid!=null?i+=`ST_SetSRID(ST_GeomFromGeoJSON(${a}), ${r.srid})::${r.type}`:i+=`ST_GeomFromGeoJSON(${a})::${r.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.includes(r.type)?i+=r.type+"::STGeomFromText("+a+", "+(r.srid||"0")+")":i+=a}return i}};var as=class{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){let t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){let r=t.joinColumns.reduce((n,i)=>{let s=X.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(n,s),n},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(r).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){let r={};t.inverseRelation.joinColumns.forEach(c=>{r[c.propertyName]=null});let n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},s=[];n.forEach((c,u)=>{t.inverseRelation.joinColumns.map((l,h)=>{let p="joinColumn_"+u+"_"+h;i[p]=X.isObject(c)?l.referencedColumn.getEntityValue(c):c,s.push(`${l.propertyPath} = :${p}`)})});let a=s.map(c=>"("+c+")").join(" OR ");if(!a)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(r).where(a).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new y("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");let r=this.expressionMap.of,n=t.inverseRelation.joinColumns.reduce((i,s)=>{let a=X.isObject(r)?s.referencedColumn.getEntityValue(r):r;return s.setEntityValue(i,a),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).whereInIds(e).execute()}else{let r=t.junctionEntityMetadata,n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?n:i,a=t.isManyToManyOwner?i:n,c=[];if(s.forEach(u=>{a.forEach(l=>{let h={};r.ownerColumns.forEach(p=>{h[p.databaseName]=X.isObject(u)?p.referencedColumn.getEntityValue(u):u}),r.inverseColumns.forEach(p=>{h[p.databaseName]=X.isObject(l)?p.referencedColumn.getEntityValue(l):l}),c.push(h)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(u=>this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(u).execute())):await this.queryBuilder.createQueryBuilder().insert().into(r.tableName).values(c).execute()}}};var _o=class{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){let t=this.expressionMap.relationMetadata;if(t.isOneToMany){let r=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],n=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(u=>{i[u.propertyName]=null});let s={},a=[];r.forEach((u,l)=>{a.push(...n.map((h,p)=>[...t.inverseRelation.joinColumns.map((d,m)=>{let f="joinColumn_"+l+"_"+p+"_"+m;return s[f]=X.isObject(u)?d.referencedColumn.getEntityValue(u):u,`${d.propertyPath} = :${f}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((d,m)=>{let f="primaryColumn_"+p+"_"+p+"_"+m;return s[f]=X.isObject(h)?d.getEntityValue(h):h,`${d.propertyPath} = :${f}`})].join(" AND ")))});let c=a.map(u=>"("+u+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(c).setParameters(s).execute()}else{let r=t.junctionEntityMetadata,n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],s=t.isManyToManyOwner?n:i,a=t.isManyToManyOwner?i:n,c={},u=[];s.forEach((h,p)=>{u.push(...a.map((d,m)=>[...r.ownerColumns.map((f,A)=>{let R="firstValue_"+p+"_"+m+"_"+A;return c[R]=X.isObject(h)?f.referencedColumn.getEntityValue(h):h,`${f.databaseName} = :${R}`}),...r.inverseColumns.map((f,A)=>{let R="secondValue_"+p+"_"+m+"_"+A;return c[R]=X.isObject(d)?f.referencedColumn.getEntityValue(d):d,`${f.databaseName} = :${R}`})].join(" AND ")))});let l=u.map(h=>"("+h+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(r.tableName).where(l).setParameters(c).execute()}}};var os=class extends je{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(e){return this.expressionMap.of=e,this}async set(e){let t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new y("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToMany||t.isOneToMany)throw new y(`Set operation is only supported for many-to-one and one-to-one relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .add() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!X.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new y('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new as(this,this.expressionMap).update(e)}async add(e){if(Array.isArray(e)&&e.length===0)return;let t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new y("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new y(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set() method instead.`);if(t.joinColumns&&t.joinColumns.length>1&&(!X.isObject(e)||Object.keys(e).length<t.joinColumns.length))throw new y('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new as(this,this.expressionMap).update(e)}async remove(e){if(Array.isArray(e)&&e.length===0)return;let t=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new y("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(t.isManyToOne||t.isOneToOne)throw new y(`Add operation is only supported for many-to-many and one-to-many relations. However given "${t.propertyPath}" has ${t.relationType} relation. Use .set(null) method instead.`);return new _o(this,this.expressionMap).remove(e)}async addAndRemove(e,t){await this.remove(t),await this.add(e)}async loadOne(){return this.loadMany().then(e=>e[0])}async loadMany(){let e=this.expressionMap.of;if(!X.isObject(e)){let t=this.expressionMap.mainAlias.metadata;if(t.hasMultiplePrimaryKeys)throw new y("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");e=t.primaryColumns[0].createValueMap(e)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,e,this.queryRunner)}};var Bo=class{constructor(e,t,r,n,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=r,this.rawRelationCountResults=n,this.queryRunner=i,this.pojo=this.expressionMap.options.includes("create-pojo"),this.selections=new Set(this.expressionMap.selects.map(s=>s.selection)),this.aliasCache=new Map,this.columnsCache=new Map}transform(e,t){let r=this.group(e,t),n=[];for(let i of r.values()){let s=this.transformRawResultsGroup(i,t);s!==void 0&&n.push(s)}return n}buildAlias(e,t){let r=this.aliasCache.get(e);r||(r=new Map,this.aliasCache.set(e,r));let n=r.get(t);return n||(n=H.buildAlias(this.driver,void 0,e,t),r.set(t,n)),n}group(e,t){let r=new Map,n=[];t.metadata.tableType==="view"?n.push(...t.metadata.columns.map(i=>this.buildAlias(t.name,i.databaseName))):n.push(...t.metadata.primaryColumns.map(i=>this.buildAlias(t.name,i.databaseName)));for(let i of e){let s=n.map(c=>{let u=i[c];return Buffer.isBuffer(u)?u.toString("hex"):X.isObject(u)?JSON.stringify(u):u}).join("_"),a=r.get(s);a?a.push(i):r.set(s,[i])}return r}transformRawResultsGroup(e,t){let r=t.metadata;if(r.discriminatorColumn){let l=e.map(p=>p[this.buildAlias(t.name,t.metadata.discriminatorColumn.databaseName)]),h=r.childEntityMetadatas.find(p=>typeof l.find(d=>d===p.discriminatorValue)<"u");h&&(r=h)}let n=r.create(this.queryRunner,{fromDeserializer:!0,pojo:this.pojo}),i=this.transformColumns(e,t,n,r),s=this.transformJoins(e,n,t,r),a=this.transformRelationIds(e,t,n,r),c=this.transformRelationCounts(e,t,n);if(i||r.primaryColumns.every(l=>l.isVirtual===!0)&&(s||a||c))return n}transformColumns(e,t,r,n){let i=!1,s=e[0];for(let[a,c]of this.getColumnsToProcess(t.name,n)){let u=s[a];u!==void 0&&(u!==null&&!c.isVirtualProperty&&(i=!0),c.setEntityValue(r,this.driver.prepareHydratedValue(u,c)))}return i}transformJoins(e,t,r,n){let i=!1;for(let s of this.expressionMap.joinAttributes){if(!s.metadata||!s.isSelected||s.relation&&!n.relations.find(c=>c===s.relation))continue;if(s.mapToProperty){if(s.mapToPropertyParentAlias!==r.name)continue}else if(!s.relation||s.parentAlias!==r.name||s.relationPropertyPath!==s.relation.propertyPath)continue;let a=this.transform(e,s.alias);a=s.isMany?a:a[0],a=!s.isMany&&a===void 0?null:a,a!==void 0&&(s.mapToPropertyPropertyName?t[s.mapToPropertyPropertyName]=a:s.relation.setEntityValue(t,a),i=!0)}return i}transformRelationIds(e,t,r,n){let i=!1;for(let[s,a]of this.rawRelationIdResults.entries()){if(a.relationIdAttribute.parentAlias!==t.name)continue;let c=a.relationIdAttribute.relation,u=this.createValueMapFromJoinColumns(c,a.relationIdAttribute.parentAlias,e);if(u==null)continue;this.prepareDataForTransformRelationIds();let l=this.hashEntityIds(c,u),h=this.relationIdMaps[s][l]||[],p=a.relationIdAttribute.mapToPropertyPropertyPath.split("."),d=(m,f,A)=>{let R=m.shift();if(R&&m.length===0)return f[R]=A,f;if(R&&m.length>0)d(m,f[R],A);else return f};c.isOneToOne||c.isManyToOne?h[0]!==void 0&&(d(p,r,h[0]),i=!0):(d(p,r,h),i=i||h.length>0)}return i}transformRelationCounts(e,t,r){let n=!1;for(let i of this.rawRelationCountResults){if(i.relationCountAttribute.parentAlias!==t.name)continue;let s=i.relationCountAttribute.relation,a;s.isOneToMany?a=s.inverseRelation.joinColumns[0].referencedColumn.databaseName:a=s.isOwning?s.joinColumns[0].referencedColumn.databaseName:s.inverseRelation.joinColumns[0].referencedColumn.databaseName;let c=e[0][this.buildAlias(t.name,a)];if(c!=null){r[i.relationCountAttribute.mapToPropertyPropertyName]=0;for(let u of i.results)u.parentId===c&&(r[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(u.cnt),n=!0)}}return n}getColumnsToProcess(e,t){let r=this.columnsCache.get(e);r||(r=new Map,this.columnsCache.set(e,r));let n=r.get(t);return n||(n=t.columns.filter(i=>!i.isVirtual&&(this.selections.has(e)||this.selections.has(`${e}.${i.propertyPath}`))&&!t.childEntityMetadatas.some(s=>s.target===i.target)).map(i=>[this.buildAlias(e,i.databaseName),i]),r.set(t,n)),n}createValueMapFromJoinColumns(e,t,r){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?n=e.joinColumns.map(i=>i):n=e.inverseRelation.inverseJoinColumns.map(i=>i),n.reduce((i,s)=>{for(let a of r)e.isManyToOne||e.isOneToOneOwner?i[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.databaseName)],s):i[s.databaseName]=this.driver.prepareHydratedValue(a[this.buildAlias(t,s.referencedColumn.databaseName)],s.referencedColumn);return i},{})}extractEntityPrimaryIds(e,t){let r;return e.isManyToOne||e.isOneToOneOwner?r=e.entityMetadata.primaryColumns.map(n=>n):e.isOneToMany||e.isOneToOneNotOwner?r=e.inverseRelation.joinColumns.map(n=>n):e.isOwning?r=e.joinColumns.map(n=>n):r=e.inverseRelation.inverseJoinColumns.map(n=>n),r.reduce((n,i)=>(n[i.databaseName]=t[i.databaseName],n),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{let t=e.relationIdAttribute.relation,r;return t.isManyToOne||t.isOneToOneOwner?r=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?r=t.inverseEntityMetadata.primaryColumns:t.isOwning?r=t.inverseJoinColumns:r=t.inverseRelation.joinColumns,e.results.reduce((n,i)=>{let s=r.reduce((a,c)=>{let u=i[c.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(u=c.referencedColumn.createValueMap(u)),K.mergeDeep(a,c.createValueMap(u))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(u=c.referencedColumn.referencedColumn.createValueMap(u)),K.mergeDeep(a,c.referencedColumn.createValueMap(u)))},{});if(r.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?s=r[0].getEntityValue(s):s=r[0].referencedColumn.getEntityValue(s)),s!==void 0){let a=this.hashEntityIds(t,i);n[a]?n[a].push(s):n[a]=[s]}return n},{})}))}hashEntityIds(e,t){let r=this.extractEntityPrimaryIds(e,t);return JSON.stringify(r)}};var Uo=class{constructor(e,t,r){this.connection=e,this.queryRunner=t,this.relationIdAttributes=r}async load(e){let t=this.relationIdAttributes.map(async r=>{if(r.relation.isManyToOne||r.relation.isOneToOneOwner){if(r.queryBuilderFactory)throw new y("Additional condition can not be used with ManyToOne or OneToOne owner relations.");let n={},i=e.map(s=>{let a={},c=[];r.relation.joinColumns.forEach(l=>{a[l.databaseName]=this.connection.driver.prepareHydratedValue(s[H.buildAlias(this.connection.driver,void 0,r.parentAlias,l.databaseName)],l.referencedColumn);let h=`${l.databaseName}:${a[l.databaseName]}`;c.indexOf(h)===-1&&c.push(h)}),r.relation.entityMetadata.primaryColumns.forEach(l=>{a[l.databaseName]=this.connection.driver.prepareHydratedValue(s[H.buildAlias(this.connection.driver,void 0,r.parentAlias,l.databaseName)],l);let h=`${l.databaseName}:${a[l.databaseName]}`;c.indexOf(h)===-1&&c.push(h)}),c.sort();let u=c.join("::");return n[u]?null:(n[u]=!0,a)}).filter(s=>s);return{relationIdAttribute:r,results:i}}else if(r.relation.isOneToMany||r.relation.isOneToOneNotOwner){let n=r.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.joinColumns,s=n.inverseEntityMetadata.target,a=n.inverseEntityMetadata.tableName,c=r.alias||a,u={},l={},h=e.map((f,A)=>{let R=[],I={},C=i.map(J=>{let ne=J.databaseName+A,oe=f[H.buildAlias(this.connection.driver,void 0,r.parentAlias,J.referencedColumn.databaseName)],z=`${c}:${J.propertyPath}:${oe}`;return R.indexOf(z)!==-1?"":(R.push(z),I[ne]=oe,c+"."+J.propertyPath+" = :"+ne)}).filter(J=>J).join(" AND ");R.sort();let U=R.join("::");return u[U]?"":(u[U]=!0,Object.assign(l,I),C)}).filter(f=>f).map(f=>"("+f+")").join(" OR ");if(!h)return{relationIdAttribute:r,results:[]};let p=this.connection.createQueryBuilder(this.queryRunner);K.uniq([...i,...n.inverseRelation.entityMetadata.primaryColumns],f=>f.propertyPath).forEach(f=>{p.addSelect(c+"."+f.propertyPath,f.databaseName)}),p.from(s,c).where("("+h+")").setParameters(l),r.queryBuilderFactory&&r.queryBuilderFactory(p);let m=await p.getRawMany();return m.forEach(f=>{i.forEach(A=>{f[A.databaseName]=this.connection.driver.prepareHydratedValue(f[A.databaseName],A.referencedColumn)}),n.inverseRelation.entityMetadata.primaryColumns.forEach(A=>{f[A.databaseName]=this.connection.driver.prepareHydratedValue(f[A.databaseName],A)})}),{relationIdAttribute:r,results:m}}else{let n=r.relation,i=n.isOwning?n.joinColumns:n.inverseRelation.inverseJoinColumns,s=n.isOwning?n.inverseJoinColumns:n.inverseRelation.joinColumns,a=r.junctionAlias,c=r.joinInverseSideMetadata.tableName,u=r.alias||c,l=n.isOwning?n.junctionEntityMetadata.tableName:n.inverseRelation.junctionEntityMetadata.tableName,h=e.map(C=>i.reduce((U,J)=>(U[J.propertyPath]=C[H.buildAlias(this.connection.driver,void 0,r.parentAlias,J.referencedColumn.databaseName)],U),{}));if(h.length===0)return{relationIdAttribute:r,results:[]};let p={},d={},m=h.map((C,U)=>{let J=[],ne={},oe=Object.keys(C).map(O=>{let he=O+U,S=C[O],$=`${a}:${O}:${S}`;return J.indexOf($)!==-1?"":(J.push($),ne[he]=S,a+"."+O+" = :"+he)}).filter(O=>O).join(" AND ");J.sort();let z=J.join("::");return d[z]?"":(d[z]=!0,Object.assign(p,ne),oe)}).filter(C=>C),f=s.map(C=>a+"."+C.propertyPath+" = "+u+"."+C.referencedColumn.propertyPath).join(" AND "),A=m.map(C=>"("+C+" AND "+f+")").join(" OR "),R=this.connection.createQueryBuilder(this.queryRunner);s.forEach(C=>{R.addSelect(a+"."+C.propertyPath,C.databaseName).addOrderBy(a+"."+C.propertyPath)}),i.forEach(C=>{R.addSelect(a+"."+C.propertyPath,C.databaseName).addOrderBy(a+"."+C.propertyPath)}),R.from(c,u).innerJoin(l,a,A).setParameters(p),r.queryBuilderFactory&&r.queryBuilderFactory(R);let I=await R.getRawMany();return I.forEach(C=>{[...i,...s].forEach(U=>{C[U.databaseName]=this.connection.driver.prepareHydratedValue(C[U.databaseName],U.referencedColumn)})}),{relationIdAttribute:r,results:I}}});return Promise.all(t)}};var Kn=class{constructor(e,t){this.connection=e,this.queryRunner=t}load(e,t,r){let n=Array.isArray(t)?t:[t],i=Array.isArray(r)?r:r?[r]:void 0;return e.isManyToMany?this.loadForManyToMany(e,n,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,n,i):this.loadForOneToManyAndOneToOneNotOwner(e,n,i)}async loadManyToManyRelationIdsAndGroup(e,t,r,n){let i=e.isManyToMany||e.isOneToMany,s=Array.isArray(t)?t:[t];if(!r&&(r=await this.connection.relationLoader.load(e,t,this.queryRunner,n),!r.length))return s.map(h=>({entity:h,related:i?[]:void 0}));let a=await this.load(e,t,r),c=Array.isArray(r)?r:[r],u=[],l=[];return e.isManyToManyOwner?(u=e.junctionEntityMetadata.inverseColumns.map(h=>h.referencedColumn),l=e.junctionEntityMetadata.ownerColumns.map(h=>h.referencedColumn)):e.isManyToManyNotOwner?(u=e.junctionEntityMetadata.ownerColumns.map(h=>h.referencedColumn),l=e.junctionEntityMetadata.inverseColumns.map(h=>h.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(u=e.joinColumns.map(h=>h.referencedColumn),l=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(u=e.inverseRelation.entityMetadata.primaryColumns,l=e.inverseRelation.joinColumns.map(h=>h.referencedColumn)),s.map(h=>{let p={entity:h,related:i?[]:void 0},d=a.filter(m=>l.every(f=>f.compareEntityValue(h,m[f.entityMetadata.name+"_"+f.propertyAliasName])));return d.length&&c.forEach(m=>{d.forEach(f=>{u.every(R=>R.compareEntityValue(m,f[H.buildAlias(this.connection.driver,void 0,R.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+R.propertyPath.replace(".","_"))]))&&(i?p.related.push(m):p.related=m)})}),p})}loadForManyToMany(e,t,r){let n=e.junctionEntityMetadata,i=n.name,s=e.isOwning?n.ownerColumns:n.inverseColumns,a=e.isOwning?n.inverseColumns:n.ownerColumns,c=this.connection.createQueryBuilder(this.queryRunner);s.forEach(p=>{let d=H.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+p.propertyPath,d)}),a.forEach(p=>{let d=H.buildAlias(this.connection.driver,void 0,p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+p.propertyPath,d)});let u="";if(s.length===1){let p=t.map(m=>s[0].referencedColumn.getEntityValue(m));p.every(m=>typeof m=="number")?u=`${i}.${s[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values1",p),u=i+"."+s[0].propertyPath+" IN (:...values1)")}else u="("+t.map((p,d)=>s.map(m=>{let f="entity1_"+d+"_"+m.propertyName;return c.setParameter(f,m.referencedColumn.getEntityValue(p)),i+"."+m.propertyPath+" = :"+f}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";let l="";if(r)if(a.length===1){let p=r.map(m=>a[0].referencedColumn.getEntityValue(m));p.every(m=>typeof m=="number")?l=`${i}.${a[0].propertyPath} IN (${p.join(", ")})`:(c.setParameter("values2",p),l=i+"."+a[0].propertyPath+" IN (:...values2)")}else l="("+r.map((p,d)=>a.map(m=>{let f="entity2_"+d+"_"+m.propertyName;return c.setParameter(f,m.referencedColumn.getEntityValue(p)),i+"."+m.propertyPath+" = :"+f}).join(" AND ")).map(p=>"("+p+")").join(" OR ")+")";let h=[u,l].filter(p=>p.length>0).join(" AND ");return c.from(n.target,i).where(h).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,r){let n=e.entityMetadata.targetName,i=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(u=>u===c));if(r&&i){let c=[];if(t.forEach(u=>{let l={};e.entityMetadata.primaryColumns.forEach(h=>{let p=h.entityMetadata.name+"_"+h.propertyPath.replace(".","_");l[p]=h.getEntityValue(u)}),r.forEach(h=>{e.joinColumns.forEach(p=>{let d=p.getEntityValue(u),m=p.referencedColumn.getEntityValue(h);if(!(d===void 0||m===void 0)&&d===m){let f=p.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+p.referencedColumn.propertyPath.replace(".","_");l[f]=m}})}),Object.keys(l).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(l)}),c.length===t.length)return Promise.resolve(c)}let s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{let u=H.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));s.addSelect(n+"."+c.propertyPath,u)}),e.joinColumns.forEach(c=>{let u=H.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));s.addSelect(n+"."+c.propertyPath,u)});let a="";if(e.entityMetadata.primaryColumns.length===1){let c=t.map(l=>e.entityMetadata.primaryColumns[0].getEntityValue(l));c.every(l=>typeof l=="number")?a=`${n}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(s.setParameter("values",c),a=n+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else a=t.map((c,u)=>e.entityMetadata.primaryColumns.map((l,h)=>{let p="entity"+u+"_"+h;return s.setParameter(p,l.getEntityValue(c)),n+"."+l.propertyPath+" = :"+p}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return s.from(e.entityMetadata.target,n).where(a).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,r){let n=e;if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(u=>e.joinColumns.indexOf(u)!==-1))return Promise.resolve(t.map(u=>{let l={};return e.joinColumns.forEach(function(h){let p=h.referencedColumn.getEntityValue(u),d=h.referencedColumn.entityMetadata.name+"_"+h.referencedColumn.propertyPath.replace(".","_"),m=h.entityMetadata.name+"_"+n.propertyPath.replace(".","_")+"_"+h.propertyPath.replace(".","_");l[d]=p,l[m]=p}),l}));let i=e.entityMetadata.targetName,s=this.connection.createQueryBuilder(this.queryRunner);e.entityMetadata.primaryColumns.forEach(c=>{let u=H.buildAlias(this.connection.driver,void 0,c.entityMetadata.name+"_"+n.propertyPath.replace(".","_")+"_"+c.propertyPath.replace(".","_"));s.addSelect(i+"."+c.propertyPath,u)}),e.joinColumns.forEach(c=>{let u=H.buildAlias(this.connection.driver,void 0,c.referencedColumn.entityMetadata.name+"_"+c.referencedColumn.propertyPath.replace(".","_"));s.addSelect(i+"."+c.propertyPath,u)});let a="";if(e.joinColumns.length===1){let c=t.map(l=>e.joinColumns[0].referencedColumn.getEntityValue(l));c.every(l=>typeof l=="number")?a=`${i}.${e.joinColumns[0].propertyPath} IN (${c.join(", ")})`:(s.setParameter("values",c),a=i+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else a=t.map((c,u)=>e.joinColumns.map((l,h)=>{let p="entity"+u+"_"+h;return s.setParameter(p,l.referencedColumn.getEntityValue(c)),i+"."+l.propertyPath+" = :"+p}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return s.from(e.entityMetadata.target,i).where(a).getRawMany()}};var Fo=class{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{let t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{let r=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(r)})})}metadataToAttribute(e,t){return new Tr(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}};var jo=class{constructor(e,t,r){this.connection=e,this.queryRunner=t,this.relationCountAttributes=r}async load(e){let t=(n,i,s)=>s.indexOf(n)===i,r=this.relationCountAttributes.map(async n=>{if(n.relation.isOneToMany){let i=n.relation,s=i.inverseRelation,a=s.joinColumns[0].referencedColumn.propertyName,c=i.inverseEntityMetadata.target,u=i.inverseEntityMetadata.tableName,l=n.alias||u,h=s.propertyName,p=e.map(m=>m[n.parentAlias+"_"+a]).filter(m=>!!m);if(p=p.filter(t),p.length===0)return{relationCountAttribute:n,results:[]};let d=this.connection.createQueryBuilder(this.queryRunner);return d.select(l+"."+h,"parentId").addSelect("COUNT(*)","cnt").from(c,l).where(l+"."+h+" IN (:...ids)").addGroupBy(l+"."+h).setParameter("ids",p),n.queryBuilderFactory&&n.queryBuilderFactory(d),{relationCountAttribute:n,results:await d.getRawMany()}}else{let i,s,a,c;n.relation.isOwning?(i=n.relation.joinColumns[0].referencedColumn.databaseName,s=n.relation.inverseJoinColumns[0].referencedColumn.databaseName,a=n.relation.junctionEntityMetadata.columns[0],c=n.relation.junctionEntityMetadata.columns[1]):(i=n.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,s=n.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,a=n.relation.junctionEntityMetadata.columns[1],c=n.relation.junctionEntityMetadata.columns[0]);let u=e.map(A=>A[n.parentAlias+"_"+i]).filter(A=>!!A);if(u=u.filter(t),u.length===0)return{relationCountAttribute:n,results:[]};let l=n.junctionAlias,h=n.joinInverseSideMetadata.tableName,p=n.alias||h,d=n.relation.junctionEntityMetadata.tableName,m=l+"."+a.propertyName+" IN ("+u.map(A=>isNaN(A)?"'"+A+"'":A)+") AND "+l+"."+c.propertyName+" = "+p+"."+s,f=this.connection.createQueryBuilder(this.queryRunner);return f.select(l+"."+a.propertyName,"parentId").addSelect("COUNT("+f.escape(p)+"."+f.escape(s)+")","cnt").from(h,p).innerJoin(d,l,m).addGroupBy(l+"."+a.propertyName),n.queryBuilderFactory&&n.queryBuilderFactory(f),{relationCountAttribute:n,results:await f.getRawMany()}}});return Promise.all(r)}};var Qo=class{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{let t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{let r=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(r)})})}metadataToAttribute(e,t){return new br(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}};var Ge=class o{static isFindOneOptions(e){let t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){let t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t?.relations){let r=[...t.relations];if(o.applyRelationsRecursively(e,r,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),r.length>0)throw new io(r)}return e}static applyRelationsRecursively(e,t,r,n,i){let s=[];if(i){let a=new RegExp("^"+i.replace(".","\\.")+"\\.");s=t.filter(c=>c.match(a)).map(c=>n.findRelationWithPropertyPath(c.replace(a,""))).filter(c=>c)}else s=t.map(a=>n.findRelationWithPropertyPath(a)).filter(a=>a);s.forEach(a=>{let c=H.buildAlias(e.connection.driver,{joiner:"__"},r,a.propertyPath),u=r+"."+a.propertyPath;e.expressionMap.relationLoadStrategy==="query"?e.concatRelationMetadata(a):e.leftJoinAndSelect(u,c),t.splice(t.indexOf(i?i+"."+a.propertyPath:a.propertyPath),1);let l,h;if(e.expressionMap.relationLoadStrategy==="query")l=a.inverseEntityMetadata,h=c;else{let p=e.expressionMap.joinAttributes.find(d=>d.entityOrProperty===u);l=p.metadata,h=p.alias.name}if(!h||!l)throw new it(a.propertyPath,n);if(this.applyRelationsRecursively(e,t,h,l,i?i+"."+a.propertyPath:a.propertyPath),e.expressionMap.relationLoadStrategy==="join"){let p=n.relations.find(d=>d.propertyName===a.propertyPath);p&&this.joinEagerRelations(e,c,p.inverseEntityMetadata)}})}static joinEagerRelations(e,t,r){r.eagerRelations.forEach(n=>{let i=H.buildAlias(e.connection.driver,{joiner:"__"},t,n.propertyName),s=!0;for(let u of e.expressionMap.joinAttributes)if(!(u.condition!==void 0||u.mapToProperty!==void 0||u.isMappingMany!==void 0||u.direction!=="LEFT"||u.entityOrProperty!==`${t}.${n.propertyPath}`)){s=!1,i=u.alias.name;break}let a=!!e.expressionMap.joinAttributes.find(u=>u.alias.name===i);s&&!a&&e.leftJoin(t+"."+n.propertyPath,i);let c=!0;for(let u of e.expressionMap.selects)if(!(u.aliasName!==void 0||u.virtual!==void 0||u.selection!==i)){c=!1;break}c&&e.addSelect(i),this.joinEagerRelations(e,i,n.inverseEntityMetadata)})}};var Nr=class o extends je{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),this.replacePropertyNamesForTheWholeQuery(e)}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){let e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(r=>({selection:r}));else if(typeof e=="function"){let r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(r=>({selection:r})));else if(typeof e=="function"){let r=e(this.subQuery());this.setParameters(r.getParameters()),this.expressionMap.selects.push({selection:r.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}fromDummy(){return this.from(this.connection.driver.dummyTableName??"(SELECT 1 AS dummy_column)","dummy_table")}from(e,t){let r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}addFrom(e,t){let r=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(r),this}innerJoin(e,t,r,n){return this.join("INNER",e,t,r,n),this}leftJoin(e,t,r,n){return this.join("LEFT",e,t,r,n),this}innerJoinAndSelect(e,t,r,n){return this.addSelect(t),this.innerJoin(e,t,r,n),this}leftJoinAndSelect(e,t,r,n){return this.addSelect(t),this.leftJoin(e,t,r,n),this}innerJoinAndMapMany(e,t,r,n,i){return this.addSelect(r),this.join("INNER",t,r,n,i,e,!0),this}innerJoinAndMapOne(e,t,r,n,i,s){return this.addSelect(r),this.join("INNER",t,r,n,i,e,!1,s),this}leftJoinAndMapMany(e,t,r,n,i){return this.addSelect(r),this.join("LEFT",t,r,n,i,e,!0),this}leftJoinAndMapOne(e,t,r,n,i,s){return this.addSelect(r),this.join("LEFT",t,r,n,i,e,!1,s),this}loadRelationIdAndMap(e,t,r,n){let i=new Tr(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof r=="string"&&(i.alias=r),typeof r=="object"&&r.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=n,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,r,n){let i=new br(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=r,i.queryBuilderFactory=n,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereExists(e){return this.where(...this.getExistsCondition(e))}andWhereExists(e){return this.andWhere(...this.getExistsCondition(e))}orWhereExists(e){return this.orWhere(...this.getExistsCondition(e))}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}timeTravelQuery(e){return this.connection.driver.options.type==="cockroachdb"&&(e===void 0?this.expressionMap.timeTravel="follower_read_timestamp()":this.expressionMap.timeTravel=e),this}orderBy(e,t="ASC",r){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new y('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new y('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new y('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(r!==void 0&&r!=="NULLS FIRST"&&r!=="NULLS LAST")throw new y('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new y('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new y('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new y('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new y('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,r){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=r,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new fr;this.expressionMap.queryEntity=!1;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);let r=await this.loadRawResults(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;let r=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getOne(){let t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){let r=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){let n=r.updateDateColumn.getEntityValue(t);if(n.getTime()!==this.expressionMap.lockVersion.getTime())throw new Zi(r.name,this.expressionMap.lockVersion,n)}else{let n=r.versionColumn.getEntityValue(t);if(n!==this.expressionMap.lockVersion)throw new Zi(r.name,this.expressionMap.lockVersion,n)}}return t===void 0?null:t}async getOneOrFail(){let e=await this.getOne();if(!e)throw new Gr(this.expressionMap.mainAlias.target,this.expressionMap.parameters);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new fr;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new fr;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;let r=await this.executeCountQuery(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getExists(){if(this.expressionMap.lockMode==="optimistic")throw new fr;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;let r=await this.executeExistsQuery(e);return t&&await e.commitTransaction(),r}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new fr;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;let r=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let n=this.lazyCount(r);if(n===void 0){let s=this.expressionMap.cacheId;s&&(this.expressionMap.cacheId=`${s}-count`),n=await this.executeCountQuery(e)}let i=[r.entities,n];return t&&await e.commitTransaction(),i}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}lazyCount(e){let t=this.expressionMap.limit!==void 0&&this.expressionMap.limit!==null;if(this.expressionMap.joinAttributes.length>0&&t)return;let r=this.expressionMap.take!==void 0&&this.expressionMap.take!==null,n=t?this.expressionMap.limit:r?this.expressionMap.take:void 0;if(n!==void 0&&e.entities.length===n)return;let i=this.expressionMap.skip!==void 0&&this.expressionMap.skip!==null&&this.expressionMap.skip>0,s=this.expressionMap.offset!==void 0&&this.expressionMap.offset!==null&&this.expressionMap.offset>0;if(e.entities.length===0&&(i||s))return;let a=s?this.expressionMap.offset:i?this.expressionMap.skip:0;return e.entities.length+a}async stream(){this.expressionMap.queryEntity=!1;let[e,t]=this.getQueryAndParameters(),r=this.obtainQueryRunner(),n=!1;try{this.expressionMap.useTransaction===!0&&r.isTransactionActive===!1&&(await r.startTransaction(),n=!0);let i=()=>{if(r!==this.queryRunner)return r.release()},s=r.stream(e,t,i,i);return n&&await r.commitTransaction(),s}catch(i){if(n)try{await r.rollbackTransaction()}catch{}throw i}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,r,n,i,s,a,c){i&&this.setParameters(i);let u=new Hn(this.connection,this.expressionMap);u.direction=e,u.mapAsEntity=c,u.mapToProperty=s,u.isMappingMany=a,u.entityOrProperty=t,u.condition=n,this.expressionMap.joinAttributes.push(u);let l=u.metadata;if(l){if(l.deleteDateColumn&&!this.expressionMap.withDeleted){let h=`${r}.${l.deleteDateColumn.propertyName} IS NULL`;u.condition=u.condition?` ${u.condition} AND ${h}`:`${h}`}u.alias=this.expressionMap.createAlias({type:"join",name:r,metadata:l}),u.relation&&u.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:u.junctionAlias,metadata:u.relation.junctionEntityMetadata})}else{let h="";if(typeof t=="function"){let d=t(this.subQuery());this.setParameters(d.getParameters()),h=d.getQuery()}else h=t;let p=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";u.alias=this.expressionMap.createAlias({type:"join",name:r,tablePath:p===!1?t:void 0,subQuery:p===!0?h:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new y("Cannot build query because main alias is not set (call qb#from method)");let e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){let a=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,a)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,a))}this.expressionMap.joinAttributes.forEach(a=>{if(a.metadata)e.push(...this.buildEscapedEntityColumnSelects(a.alias.name,a.metadata)),t.push(...this.findEntityColumnSelects(a.alias.name,a.metadata));else if(this.expressionMap.selects.some(u=>u.selection===a.alias.name)){e.push({selection:this.escape(a.alias.name)+".*"});let u=this.expressionMap.selects.find(l=>l.selection===a.alias.name);t.push(u)}}),this.expressionMap.selects.filter(a=>t.indexOf(a)===-1).forEach(a=>e.push({selection:this.replacePropertyNames(a.selection),aliasName:a.aliasName})),e.length===0&&e.push({selection:"*"});let r="";this.expressionMap.useIndex&&H.isMySQLFamily(this.connection.driver)&&(r=` USE INDEX (${this.expressionMap.useIndex})`);let n=this.expressionMap.aliases.filter(a=>a.type==="from"&&(a.tablePath||a.subQuery)).map(a=>a.subQuery?a.subQuery+" "+this.escape(a.name):this.getTableName(a.tablePath)+" "+this.escape(a.name)),i=this.createSelectDistinctExpression(),s=e.map(a=>a.selection+(a.aliasName?" AS "+this.escape(a.aliasName):"")).join(", ");return i+s+" FROM "+n.join(", ")+this.createTableLockExpression()+r}createSelectDistinctExpression(){let{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:r}=this.expressionMap,{driver:n}=this.connection,i="SELECT ";return r>0&&H.isMySQLFamily(n)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),H.isPostgresFamily(n)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(a=>this.replacePropertyNames(a)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{let r=t.relation,n=t.tablePath,i=t.alias.name,s=t.condition?" AND ("+t.condition+")":"",a=t.parentAlias;if(!a||!r){let c=t.alias.subQuery?t.alias.subQuery:this.getTableName(n);return" "+t.direction+" JOIN "+c+" "+this.escape(i)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(r.isManyToOne||r.isOneToOneOwner){let c=r.joinColumns.map(u=>i+"."+u.referencedColumn.propertyPath+"="+a+"."+r.propertyPath+"."+u.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c+s)}else if(r.isOneToMany||r.isOneToOneNotOwner){let c=r.inverseRelation.joinColumns.map(u=>(r.inverseEntityMetadata.tableType==="entity-child"&&r.inverseEntityMetadata.discriminatorColumn&&(s+=" AND "+i+"."+r.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+r.inverseEntityMetadata.discriminatorValue+"'"),i+"."+r.inverseRelation.propertyPath+"."+u.referencedColumn.propertyPath+"="+a+"."+u.referencedColumn.propertyPath)).join(" AND ");if(!c)throw new y(`Relation ${r.entityMetadata.name}.${r.propertyName} does not have join columns.`);return" "+t.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c+s)}else{let c=r.junctionEntityMetadata.tablePath,u=t.junctionAlias,l="",h="";return r.isOwning?(l=r.joinColumns.map(p=>u+"."+p.propertyPath+"="+a+"."+p.referencedColumn.propertyPath).join(" AND "),h=r.inverseJoinColumns.map(p=>i+"."+p.referencedColumn.propertyPath+"="+u+"."+p.propertyPath).join(" AND ")):(l=r.inverseRelation.inverseJoinColumns.map(p=>u+"."+p.propertyPath+"="+a+"."+p.referencedColumn.propertyPath).join(" AND "),h=r.inverseRelation.joinColumns.map(p=>i+"."+p.referencedColumn.propertyPath+"="+u+"."+p.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(c)+" "+this.escape(u)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(l)+" "+t.direction+" JOIN "+this.getTableName(n)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(h+s)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){let e=this.expressionMap.allOrderBys;return Object.keys(e).length===0?"":" ORDER BY "+Object.keys(e).map(t=>{let r=typeof e[t]=="string"?e[t]:e[t].order+" "+e[t].nulls,n=this.expressionMap.selects.find(i=>i.selection===t);if(n&&!n.aliasName&&t.indexOf(".")!==-1){let i=t.split("."),s=i[0],a=i.slice(1).join("."),c=this.expressionMap.aliases.find(u=>u.name===s);if(c){let u=c.metadata.findColumnWithPropertyPath(a);if(u){let l=H.buildAlias(this.connection.driver,void 0,s,u.databaseName);return this.escape(l)+" "+r}}}return this.replacePropertyNames(t)+" "+r}).join(", ")}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;e===void 0&&t===void 0&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take);let r=t!=null,n=e!=null;if(this.connection.driver.options.type==="mssql"){let i="";if((r||n)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(i=" ORDER BY (SELECT NULL)"),r&&n)return i+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(r)return i+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(n)return i+" OFFSET "+e+" ROWS"}else if(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(r&&n)return" LIMIT "+t+" OFFSET "+e;if(r)return" LIMIT "+t;if(n)throw new lo}else if(H.isSQLiteFamily(this.connection.driver)){if(r&&n)return" LIMIT "+t+" OFFSET "+e;if(r)return" LIMIT "+t;if(n)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(r&&n)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(r)return" FETCH NEXT "+t+" ROWS ONLY";if(n)return" OFFSET "+e+" ROWS"}else{if(r&&n)return" LIMIT "+t+" OFFSET "+e;if(r)return" LIMIT "+t;if(n)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){let e=this.connection.driver,t="";if(this.expressionMap.lockTables){if(!(H.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new y("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new y("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let r="";switch(this.expressionMap.onLocked==="nowait"?r=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(r=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return H.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+r:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(H.isPostgresFamily(e))return" FOR SHARE"+t+r;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new sr;case"pessimistic_write":if(H.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+r;if(H.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+r;if(e.options.type==="mssql")return"";throw new sr;case"pessimistic_partial_write":if(H.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(H.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new sr;case"pessimistic_write_or_fail":if(H.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(H.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new sr;case"for_no_key_update":if(H.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+r;throw new sr;case"for_key_share":if(H.isPostgresFamily(e))return" FOR KEY SHARE"+t+r;throw new sr;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";let e=this.expressionMap.havings.map((t,r)=>{switch(t.type){case"and":return(r>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(r>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){let r=this.expressionMap.selects.some(u=>u.selection===e),n=[];if(r&&n.push(...t.columns.filter(u=>u.isSelect===!0)),n.push(...t.columns.filter(u=>this.expressionMap.selects.some(l=>l.selection===e+"."+u.propertyPath))),n.length===0)return[];let i=this.expressionMap.queryEntity?t.primaryColumns.filter(u=>n.indexOf(u)===-1):[],s=[...n,...i],a=[],c=this.escape(e);return s.forEach(u=>{let l=c+"."+this.escape(u.databaseName);u.isVirtualProperty&&u.query&&(l=`(${u.query(c)})`),this.connection.driver.spatialTypes.indexOf(u.type)!==-1&&((H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(l=`${this.connection.driver.options.legacySpatialSupport?"AsText":"ST_AsText"}(${l})`),H.isPostgresFamily(this.connection.driver)&&(u.precision?l=`ST_AsGeoJSON(${l}, ${u.precision})::json`:l=`ST_AsGeoJSON(${l})::json`),this.connection.driver.options.type==="mssql"&&(l=`${l}.ToString()`));let h=this.expressionMap.selects.filter(p=>p.selection===e+"."+u.propertyPath);h.length?h.forEach(p=>{a.push({selection:l,aliasName:p.aliasName?p.aliasName:H.buildAlias(this.connection.driver,void 0,e,u.databaseName),virtual:p.virtual})}):a.push({selection:l,aliasName:H.buildAlias(this.connection.driver,void 0,e,u.databaseName),virtual:r})}),a}findEntityColumnSelects(e,t){return this.expressionMap.selects.filter(r=>r.selection===e||t.columns.some(n=>r.selection===e+"."+n.propertyPath))}computeCountExpression(){let e=this.expressionMap.mainAlias.name,r=this.expressionMap.mainAlias.metadata.primaryColumns,n=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||H.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+r.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+"))";if(H.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+r.map(i=>`${n}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){let i=r.map(s=>`${n}.${this.escape(s.databaseName)}`).join(", '|;|', ");return r.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?r.length===1?`COUNT(DISTINCT(${n}.${this.escape(r[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${r.map(s=>`CAST(${n}.${this.escape(s.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+r.map(i=>`${n}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){let t=this.computeCountExpression(),r=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!r||!r[0]||!r[0].cnt?0:parseInt(r[0].cnt)}async executeExistsQuery(e){return(await this.connection.createQueryBuilder().fromDummy().select("1","row_exists").whereExists(this).limit(1).loadRawResults(e)).length>0}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){let e=Array.isArray(this.findOptions.select)?K.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){let e=Array.isArray(this.findOptions.relations)?K.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){let e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{let r=this.expressionMap.aliases.find(n=>n.metadata.tableNameWithoutPrefix===t);if(!r)throw new y(`"${t}" is not part of this query`);return this.escape(r.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Ge.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}concatRelationMetadata(e){this.relationMetadatas.push(e)}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new y('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new so;if(this.expressionMap.lockMode==="optimistic"){let c=this.expressionMap.mainAlias.metadata;if(!c.versionColumn&&!c.updateDateColumn)throw new to(c.name)}let t=new Uo(this.connection,e,this.expressionMap.relationIdAttributes),r=new jo(this.connection,e,this.expressionMap.relationCountAttributes);new Fo(this.expressionMap).transform(),new Qo(this.expressionMap).transform();let s=[],a=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){let[c,u]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),l=this.expressionMap.mainAlias.metadata,h=this.expressionMap.mainAlias.name,p=l.primaryColumns.map(f=>{let A=this.escape("distinctAlias"),R=this.escape(H.buildAlias(this.connection.driver,void 0,h,f.databaseName));u[R]||(u[R]="ASC");let I=H.buildAlias(this.connection.driver,void 0,"ids_"+h,f.databaseName);return`${A}.${R} AS ${this.escape(I)}`}),d=this.clone(),m=d.expressionMap.timeTravel;if(s=await new o(this.connection,e).select(`DISTINCT ${p.join(", ")}`).addSelect(c).from(`(${d.orderBy().timeTravelQuery(!1).getQuery()})`,"distinctAlias").timeTravelQuery(m).offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(u).cache(this.expressionMap.cache&&this.expressionMap.cacheId?`${this.expressionMap.cacheId}-pagination`:this.expressionMap.cache,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),s.length>0){let f="",A={};if(l.hasMultiplePrimaryKeys)f=s.map((R,I)=>l.primaryColumns.map(C=>{let U=`orm_distinct_ids_${I}_${C.databaseName}`,J=H.buildAlias(this.connection.driver,void 0,"ids_"+h,C.databaseName);return A[U]=R[J],`${h}.${C.propertyPath}=:${U}`}).join(" AND ")).join(" OR ");else{let R=H.buildAlias(this.connection.driver,void 0,"ids_"+h,l.primaryColumns[0].databaseName),I=s.map(U=>U[R]);I.every(U=>typeof U=="number")?f=`${h}.${l.primaryColumns[0].propertyPath} IN (${I.join(", ")})`:(A.orm_distinct_ids=I,f=h+"."+l.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}s=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:f}).setParameters(A).loadRawResults(e)}}else s=await this.loadRawResults(e);if(s.length>0){let c=await t.load(s),u=await r.load(s);a=new Bo(this.expressionMap,this.connection.driver,c,u,this.queryRunner).transform(s,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,a)}if(this.expressionMap.relationLoadStrategy==="query"){let c=new Kn(this.connection,e);await Promise.all(this.relationMetadatas.map(async u=>{let l=u.inverseEntityMetadata.target,h=u.inverseEntityMetadata.targetName,p=Array.isArray(this.findOptions.select)?K.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,d=Array.isArray(this.findOptions.relations)?K.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,m=this.createQueryBuilder(e).select(h).from(l,h).setFindOptions({select:p?K.deepValue(p,u.propertyPath):void 0,order:this.findOptions.order?K.deepValue(this.findOptions.order,u.propertyPath):void 0,relations:d?K.deepValue(d,u.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(a.length>0){let f=await c.loadManyToManyRelationIdsAndGroup(u,a,void 0,m);a.forEach(A=>{let R=f.find(I=>I.entity===A);if(R){let I=R.related===void 0?null:R.related;u.setEntityValue(A,I)}})}}))}return{raw:s,entities:a}}createOrderByCombinedWithSelectExpression(e){let t=this.expressionMap.allOrderBys,r=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){let s=i.split("."),a=s[0],c=s.slice(1).join("."),l=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(H.buildAlias(this.connection.driver,void 0,a,l.databaseName))}else return this.expressionMap.selects.find(s=>s.selection===i||s.aliasName===i)?this.escape(e)+"."+this.escape(i):""}).join(", "),n={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){let s=i.split("."),a=s[0],c=s.slice(1).join("."),l=this.expressionMap.findAliasByName(a).metadata.findColumnWithPropertyPath(c);n[this.escape(e)+"."+this.escape(H.buildAlias(this.connection.driver,void 0,a,l.databaseName))]=t[i]}else this.expressionMap.selects.find(s=>s.selection===i||s.aliasName===i)?n[this.escape(e)+"."+this.escape(i)]=t[i]:n[i]=t[i]}),[r,n]}async loadRawResults(e){let[t,r]=this.getQueryAndParameters(),n=t+" -- PARAMETERS: "+JSON.stringify(r,(l,h)=>typeof h=="bigint"?h.toString():h),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{},s,a=i.alwaysEnabled&&this.expressionMap.cache!==!1||this.expressionMap.cache===!0,c=!1;if(this.connection.queryResultCache&&a)try{if(s=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:n,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),s&&!this.connection.queryResultCache.isExpired(s))return JSON.parse(s.result)}catch(l){if(!i.ignoreErrors)throw l;c=!0}let u=await e.query(t,r,!0);if(!c&&this.connection.queryResultCache&&a)try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:n,time:Date.now(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(u.records)},s,e)}catch(l){if(!i.ignoreErrors)throw l}return u.records}mergeExpressionMap(e){return X.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner(this.connection.defaultReplicationModeForReads())}buildSelect(e,t,r,n){for(let i in e){if(e[i]===void 0||e[i]===!1)continue;let s=n?n+"."+i:i,a=t.findColumnWithPropertyPathStrict(s),c=t.findEmbeddedWithPropertyPath(s),u=t.findRelationWithPropertyPath(s);if(!c&&!a&&!u)throw new it(s,t);a?this.selects.push(r+"."+s):c&&this.buildSelect(e[i],t,r,s)}}buildRelations(e,t,r,n,i){e&&Object.keys(e).forEach(s=>{let a=e[s],c=i?i+"."+s:s,u=r.findEmbeddedWithPropertyPath(c),l=r.findRelationWithPropertyPath(c);if(!u&&!l)throw new it(c,r);if(u)this.buildRelations(a,typeof t=="object"?K.deepValue(t,u.propertyPath):void 0,r,n,c);else if(l){let h=n+"_"+c.replace(".","_");h=H.buildAlias(this.connection.driver,{joiner:"__"},n,h),(a===!0||typeof a=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.concatRelationMetadata(l):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[s]=="object"?t[s]:void 0,alias:h,parentAlias:n,relationMetadata:l}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],l.inverseEntityMetadata,h))),typeof a=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(a,typeof t=="object"?K.deepValue(t,l.propertyPath):void 0,l.inverseEntityMetadata,h,void 0)}})}buildEagerRelations(e,t,r,n,i){e&&Object.keys(e).forEach(s=>{let a=e[s],c=i?i+"."+s:s,u=r.findEmbeddedWithPropertyPath(c),l=r.findRelationWithPropertyPath(c);if(!u&&!l)throw new it(c,r);if(u)this.buildEagerRelations(a,typeof t=="object"?K.deepValue(t,u.propertyPath):void 0,r,n,c);else if(l){let h=n+"_"+c.replace(".","_");h=H.buildAlias(this.connection.driver,{joiner:"__"},n,h),(a===!0||typeof a=="object")&&l.inverseEntityMetadata.eagerRelations.forEach(p=>{let d=h+"_"+p.propertyPath.replace(".","_");d=H.buildAlias(this.connection.driver,{joiner:"__"},h,d),this.joins.find(f=>f.alias===d)||this.joins.push({type:"left",select:!0,alias:d,parentAlias:h,selection:void 0,relationMetadata:p}),t&&typeof t[s]=="object"&&this.buildSelect(t[s],l.inverseEntityMetadata,h)}),typeof a=="object"&&this.buildEagerRelations(a,typeof t=="object"?K.deepValue(t,l.propertyPath):void 0,l.inverseEntityMetadata,h,void 0)}})}buildOrder(e,t,r,n){for(let i in e){if(e[i]===void 0)continue;let s=n?n+"."+i:i,a=t.findColumnWithPropertyPathStrict(s),c=t.findEmbeddedWithPropertyPath(s),u=t.findRelationWithPropertyPath(s);if(!c&&!a&&!u)throw new it(s,t);if(a){let l=typeof e[i]=="object"?e[i].direction:e[i];l=l==="DESC"||l==="desc"||l===-1?"DESC":"ASC";let h=typeof e[i]=="object"?e[i].nulls:void 0;h=h?.toLowerCase()==="first"?"NULLS FIRST":h?.toLowerCase()==="last"?"NULLS LAST":void 0;let p=`${r}.${s}`;this.addOrderBy(p,l,h)}else if(c)this.buildOrder(e[i],t,r,s);else if(u){let l=r+"_"+s.replace(".","_");l=H.buildAlias(this.connection.driver,{joiner:"__"},r,l),this.joins.find(p=>p.alias===l)||this.joins.push({type:"left",select:!1,alias:l,parentAlias:r,selection:void 0,relationMetadata:u}),this.buildOrder(e[i],u.inverseEntityMetadata,l)}}}buildWhere(e,t,r,n){let i="";if(Array.isArray(e))e.length&&(i=e.map(s=>this.buildWhere(s,t,r,n)).filter(s=>!!s).map(s=>"("+s+")").join(" OR "));else{let s=[];for(let a in e){let c=e[a],u=n?n+"."+a:a,l=t.findColumnWithPropertyPathStrict(u),h=t.findEmbeddedWithPropertyPath(u),p=t.findRelationWithPropertyPath(u);if(!h&&!l&&!p)throw new it(u,t);if(c===void 0){if((this.connection.options.invalidWhereValuesBehavior?.undefined||"ignore")==="throw")throw new y(`Undefined value encountered in property '${r}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.undefined' to 'ignore' in connection options to skip properties with undefined values.`);continue}if(c===null){let d=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(d==="ignore")continue;if(d==="throw")throw new y(`Null value encountered in property '${r}.${a}' of a where condition. To match with SQL NULL, the IsNull() operator must be used. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`)}if(l){let d=`${r}.${u}`;if(l.isVirtualProperty&&l.query&&(d=`(${l.query(this.escape(r))})`),c===null){s.push(`${d} IS NULL`);continue}x.isEqualOperator(e[a])&&(c=e[a].value),l.transformer&&(c instanceof $e?c.transformValue(l.transformer):c=ve.transformTo(l.transformer,c)),this.connection.driver.options.type==="mssql"&&(c=this.connection.driver.parametrizeValues(l,c)),s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(d,c)))}else if(h){let d=this.buildWhere(e[a],t,r,u);d&&s.push(d)}else if(p){if(e[a]===null){let d=this.connection.options.invalidWhereValuesBehavior?.null||"ignore";if(d==="sql-null")s.push(`${r}.${u} IS NULL`);else if(d==="throw")throw new y(`Null value encountered in property '${r}.${a}' of a where condition. Set 'invalidWhereValuesBehavior.null' to 'ignore' or 'sql-null' in connection options to skip or handle null values.`);continue}if(typeof e[a]=="object"&&Object.keys(e[a]).every(m=>e[a][m]===void 0))continue;if(x.isFindOperator(e[a]))if(e[a].type==="moreThan"||e[a].type==="lessThan"||e[a].type==="moreThanOrEqual"||e[a].type==="lessThanOrEqual"){let d="";e[a].type==="moreThan"?d=">":e[a].type==="lessThan"?d="<":e[a].type==="moreThanOrEqual"?d=">=":e[a].type==="lessThanOrEqual"&&(d="<=");let m=this.subQuery();if(p.isManyToManyOwner)m.select("COUNT(*)").from(p.joinTableName,p.joinTableName).where(p.joinColumns.map(f=>`${p.joinTableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else if(p.isManyToManyNotOwner)m.select("COUNT(*)").from(p.inverseRelation.joinTableName,p.inverseRelation.joinTableName).where(p.inverseRelation.inverseJoinColumns.map(f=>`${p.inverseRelation.joinTableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else if(p.isOneToMany)m.select("COUNT(*)").from(p.inverseEntityMetadata.target,p.inverseEntityMetadata.tableName).where(p.inverseRelation.joinColumns.map(f=>`${p.inverseEntityMetadata.tableName}.${f.propertyName} = ${r}.${f.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(m.getSql()+" "+d+" "+parseInt(e[a].value))}else if(p.isManyToOne||p.isOneToOne&&p.isOneToOneOwner){let d=`${r}.${u}`;s.push(this.createWhereConditionExpression(this.getWherePredicateCondition(d,e[a])))}else throw new Error("This relation isn't supported by given find operator");else{let d=r+"_"+p.propertyPath.replace(".","_");d=H.buildAlias(this.connection.driver,{joiner:"__"},r,d),this.joins.find(A=>A.alias===d)||this.joins.push({type:"left",select:!1,selection:void 0,alias:d,parentAlias:r,relationMetadata:p});let f=this.buildWhere(e[a],p.inverseEntityMetadata,d);f&&s.push(f)}}}i=s.length?"("+s.join(") AND (")+")":s.join(" AND ")}return i.length?"("+i+")":i}};var zr=class{constructor(){this.generatedMaps=[]}static from(e){let t=new this;return t.raw=e.records,t.affected=e.affected,t}};var ko=class extends je{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createUpdateExpression();return e+=this.createCteExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));let r=new wr(e,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getSoftDeletionReturningColumns());let[n,i]=this.getQueryAndParameters(),s=await e.query(n,i,!0),a=zr.from(s);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(a,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await e.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await e.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),t&&await e.commitTransaction(),a}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}from(e,t){e=x.isEntitySchema(e)?e.options.name:e;let r=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(r),this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Wt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new y(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];let t=Array.isArray(e)?e:[e];return t.forEach(r=>{let n=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!n)throw new y("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(n)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){let e=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!e)throw new y(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!e.deleteDateColumn)throw new Xa(e);let t=[];switch(this.expressionMap.queryType){case"soft-delete":t.push(this.escape(e.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":t.push(this.escape(e.deleteDateColumn.databaseName)+" = NULL");break;default:throw new y('The queryType must be "soft-delete" or "restore"')}if(e.versionColumn&&t.push(this.escape(e.versionColumn.databaseName)+" = "+this.escape(e.versionColumn.databaseName)+" + 1"),e.updateDateColumn&&t.push(this.escape(e.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),t.length<=0)throw new Hr;let r=this.createWhereExpression(),n=this.createReturningExpression("update");return n===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${r}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")} OUTPUT ${n}${r}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${t.join(", ")}${r} RETURNING ${n}`}createOrderByExpression(){let e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(H.isMySQLFamily(this.connection.driver))return" LIMIT "+e;throw new jn}return""}};var cs=class extends je{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createUpdateExpression(),e+=this.createOrderByExpression(),e+=this.createLimitExpression(),this.replacePropertyNamesForTheWholeQuery(e.trim())}async execute(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let r=null,n=null,i=new wr(e,this.expressionMap),s=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(let p of this.expressionMap.returning)s.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(p));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=i.getUpdationReturningColumns(),s.push(...this.expressionMap.extraReturningColumns.filter(p=>!s.includes(p)))),s.length>0&&this.connection.driver.options.type==="mssql"&&(r=this.connection.driver.buildTableVariableDeclaration("@OutputTable",s),n="SELECT * FROM @OutputTable");let[a,c]=this.getQueryAndParameters(),u=[r,a,n],l=await e.query(u.filter(p=>p!=null).join(`;

`),c,!0),h=zr.from(l);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await i.update(h,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),t&&await e.commitTransaction(),h}catch(r){if(t)try{await e.rollbackTransaction()}catch{}throw r}finally{e!==this.queryRunner&&await e.release()}}set(e){return this.expressionMap.valuesSet=e,this}where(e,t){this.expressionMap.wheres=[];let r=this.getWhereCondition(e);return r&&(this.expressionMap.wheres=[{type:"simple",condition:r}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}output(e){return this.returning(e)}returning(e){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Wt;return this.expressionMap.returning=e,this}orderBy(e,t="ASC",r){return e?typeof e=="object"?this.expressionMap.orderBys=e:r?this.expressionMap.orderBys={[e]:{order:t,nulls:r}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",r){return r?this.expressionMap.orderBys[e]={order:t,nulls:r}:this.expressionMap.orderBys[e]=t,this}limit(e){return this.expressionMap.limit=e,this}whereEntity(e){if(!this.expressionMap.mainAlias.hasMetadata)throw new y(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];let t=Array.isArray(e)?e:[e];return t.forEach(r=>{let n=this.expressionMap.mainAlias.metadata.getEntityIdMap(r);if(!n)throw new y("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(n)}),this.expressionMap.whereEntities=t,this}updateEntity(e){return this.expressionMap.updateEntity=e,this}createUpdateExpression(){let e=this.getValueSet(),t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,r={};for(let c in e)e[c]!==void 0&&(r[c]=e[c]);let n=[],i=[];if(t?(this.createPropertyPath(t,r).forEach(c=>{let u=t.findColumnsWithPropertyPath(c);if(u.length<=0)throw new it(c,t);u.forEach(l=>{if(!l.isUpdate||i.includes(l))return;i.push(l);let h=l.getEntityValue(r);if(l.referencedColumn&&typeof h=="object"&&!(h instanceof Date)&&h!==null&&!Buffer.isBuffer(h)?h=l.referencedColumn.getEntityValue(h):typeof h!="function"&&(h=this.connection.driver.preparePersistentValue(h,l)),typeof h=="function")n.push(this.escape(l.databaseName)+" = "+h());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&h===null)n.push(this.escape(l.databaseName)+" = NULL");else{this.connection.driver.options.type==="mssql"&&(h=this.connection.driver.parametrizeValue(l,h));let p=this.createParameter(h),d=null;if((H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.spatialTypes.indexOf(l.type)!==-1){let f=this.connection.driver.options.legacySpatialSupport?"GeomFromText":"ST_GeomFromText";l.srid!=null?d=`${f}(${p}, ${l.srid})`:d=`${f}(${p})`}else H.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(l.type)!==-1?l.srid!=null?d=`ST_SetSRID(ST_GeomFromGeoJSON(${p}), ${l.srid})::${l.type}`:d=`ST_GeomFromGeoJSON(${p})::${l.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(l.type)!==-1?d=l.type+"::STGeomFromText("+p+", "+(l.srid||"0")+")":d=p;n.push(this.escape(l.databaseName)+" = "+d)}})}),(n.length>0||Object.keys(r).length===0)&&(t.versionColumn&&i.indexOf(t.versionColumn)===-1&&n.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&i.indexOf(t.updateDateColumn)===-1&&n.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(r).map(c=>{let u=r[c];if(typeof u=="function")n.push(this.escape(c)+" = "+u());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&u===null)n.push(this.escape(c)+" = NULL");else{let l=this.createParameter(u);n.push(this.escape(c)+" = "+l)}}),n.length<=0)throw new Hr;let s=this.createWhereExpression(),a=this.createReturningExpression("update");return a===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")} OUTPUT ${a}${s}`:this.connection.driver.options.type==="spanner"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s} THEN RETURN ${a}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s} RETURNING ${a}`}createOrderByExpression(){let e=this.expressionMap.orderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitExpression(){let e=this.expressionMap.limit;if(e){if(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+e;throw new jn}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new Hr}};function xl(){je.registerQueryBuilderClass("DeleteQueryBuilder",o=>new ns(o)),je.registerQueryBuilderClass("InsertQueryBuilder",o=>new ss(o)),je.registerQueryBuilderClass("RelationQueryBuilder",o=>new os(o)),je.registerQueryBuilderClass("SelectQueryBuilder",o=>new Nr(o)),je.registerQueryBuilderClass("SoftDeleteQueryBuilder",o=>new ko(o)),je.registerQueryBuilderClass("UpdateQueryBuilder",o=>new cs(o))}var vt=class{static sha1(e){let t=function(J,ne){return J<<ne|J>>>32-ne},r=function(J){let ne="",oe,z;for(oe=7;oe>=0;oe--)z=J>>>oe*4&15,ne+=z.toString(16);return ne},n,i,s,a=new Array(80),c=1732584193,u=4023233417,l=2562383102,h=271733878,p=3285377520,d,m,f,A,R,I;e=encodeURIComponent(e);let C=e.length,U=[];for(i=0;i<C-3;i+=4)s=e.charCodeAt(i)<<24|e.charCodeAt(i+1)<<16|e.charCodeAt(i+2)<<8|e.charCodeAt(i+3),U.push(s);switch(C%4){case 0:i=2147483648;break;case 1:i=e.charCodeAt(C-1)<<24|8388608;break;case 2:i=e.charCodeAt(C-2)<<24|e.charCodeAt(C-1)<<16|32768;break;case 3:i=e.charCodeAt(C-3)<<24|e.charCodeAt(C-2)<<16|e.charCodeAt(C-1)<<8|128;break}for(U.push(i);U.length%16!==14;)U.push(0);for(U.push(C>>>29),U.push(C<<3&4294967295),n=0;n<U.length;n+=16){for(i=0;i<16;i++)a[i]=U[n+i];for(i=16;i<=79;i++)a[i]=t(a[i-3]^a[i-8]^a[i-14]^a[i-16],1);for(d=c,m=u,f=l,A=h,R=p,i=0;i<=19;i++)I=t(d,5)+(m&f|~m&A)+R+a[i]+1518500249&4294967295,R=A,A=f,f=t(m,30),m=d,d=I;for(i=20;i<=39;i++)I=t(d,5)+(m^f^A)+R+a[i]+1859775393&4294967295,R=A,A=f,f=t(m,30),m=d,d=I;for(i=40;i<=59;i++)I=t(d,5)+(m&f|m&A|f&A)+R+a[i]+2400959708&4294967295,R=A,A=f,f=t(m,30),m=d,d=I;for(i=60;i<=79;i++)I=t(d,5)+(m^f^A)+R+a[i]+3395469782&4294967295,R=A,A=f,f=t(m,30),m=d,d=I;c=c+d&4294967295,u=u+m&4294967295,l=l+f&4294967295,h=h+A&4294967295,p=p+R&4294967295}return I=r(c)+r(u)+r(l)+r(h)+r(p),I.toLowerCase()}};var zn=class{constructor(){this.nestedSetColumnNames={left:"nsleft",right:"nsright"},this.materializedPathColumnName="mpath"}getTableName(e){return typeof e!="string"&&(e=e.name),e.split(".").pop()}tableName(e,t){return t||gl(e)}closureJunctionTableName(e){return e+"_closure"}columnName(e,t,r){let n=t||e;return r.length?ja(r.join("_"))+Hy(n):n}relationName(e){return e}primaryKeyName(e,t){let r=[...t];r.sort();let s=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return"PK_"+vt.sha1(s).substr(0,27)}uniqueConstraintName(e,t){let r=[...t];r.sort();let s=`${this.getTableName(e).replace(".","_")}_${r.join("_")}`;return"UQ_"+vt.sha1(s).substr(0,27)}relationConstraintName(e,t,r){let n=[...t];n.sort();let a=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return r&&(a+=`_${r}`),"REL_"+vt.sha1(a).substr(0,26)}defaultConstraintName(e,t){let i=`${this.getTableName(e).replace(".","_")}_${t}`;return"DF_"+vt.sha1(i).substr(0,27)}foreignKeyName(e,t,r,n){let i=[...t];i.sort();let c=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return"FK_"+vt.sha1(c).substr(0,27)}indexName(e,t,r){let n=[...t];n.sort();let a=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return r&&(a+=`_${r}`),"IDX_"+vt.sha1(a).substr(0,26)}checkConstraintName(e,t,r){let s=`${this.getTableName(e).replace(".","_")}_${t}`,a="CHK_"+vt.sha1(s).substr(0,26);return r?`${a}_ENUM`:a}exclusionConstraintName(e,t){let i=`${this.getTableName(e).replace(".","_")}_${t}`;return"XCL_"+vt.sha1(i).substr(0,26)}joinColumnName(e,t){return ja(e+"_"+t)}joinTableName(e,t,r,n){return gl(e+"_"+r.replace(/\./gi,"_")+"_"+t)}joinTableColumnDuplicationPrefix(e,t){return e+"_"+t}joinTableColumnName(e,t,r){return ja(e+"_"+(r||t))}joinTableInverseColumnName(e,t,r){return this.joinTableColumnName(e,t,r)}prefixTableName(e,t){return e+t}};var Jn=class{constructor(e,t,r,n,i){this.id=e,this.timestamp=t,this.name=r,this.instance=n,this.transaction=i}};var mt=class{constructor(e,t,...r){this.value=e,this.type=t,this["@instanceof"]=Symbol.for("MssqlParameter"),this.params=[],this.params=r||[]}};var Jr=class{constructor(e,t){this.connection=e,this.queryRunner=t,this.transaction="all";let{schema:r}=this.connection.driver.options,n=this.connection.driver.database;this.migrationsDatabase=n,this.migrationsSchema=r,this.migrationsTableName=e.options.migrationsTableName||"migrations",this.migrationsTable=this.connection.driver.buildTableName(this.migrationsTableName,r,n)}async executeMigration(e){return this.withQueryRunner(async t=>{await this.createMigrationsTableIfNotExist(t);let r=this.connection.driver.createSchemaBuilder();return x.isRdbmsSchemaBuilder(r)&&await r.createMetadataTableIfNecessary(t),await t.beforeMigration(),await e.instance.up(t),await t.afterMigration(),await this.insertExecutedMigration(t,e),e})}async getAllMigrations(){return Promise.resolve(this.getMigrations())}async getExecutedMigrations(){return this.withQueryRunner(async e=>(await this.createMigrationsTableIfNotExist(e),await this.loadExecutedMigrations(e)))}async getPendingMigrations(){let e=await this.getAllMigrations(),t=await this.getExecutedMigrations();return e.filter(r=>!t.find(n=>n.name===r.name))}insertMigration(e){return this.withQueryRunner(t=>this.insertExecutedMigration(t,e))}deleteMigration(e){return this.withQueryRunner(t=>this.deleteExecutedMigration(t,e))}async showMigrations(){let e=!1,t=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(t);let r=await this.loadExecutedMigrations(t),n=this.getMigrations();for(let i of n){let s=r.find(a=>a.name===i.name);s?this.connection.logger.logSchemaBuild(`[X] ${s.id} ${i.name}`):(e=!0,this.connection.logger.logSchemaBuild(`[ ] ${i.name}`))}return this.queryRunner||await t.release(),e}async executePendingMigrations(){let e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);let t=this.connection.driver.createSchemaBuilder();x.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);let r=await this.loadExecutedMigrations(e),n=this.getLatestTimestampMigration(r),i=this.getMigrations(),s=[],a=i.filter(l=>!r.find(p=>p.name===l.name));if(!a.length)return this.connection.logger.logSchemaBuild("No migrations are pending"),this.queryRunner||await e.release(),[];if(this.connection.logger.logSchemaBuild(`${r.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${i.length} migrations were found in the source code.`),n&&this.connection.logger.logSchemaBuild(`${n.name} is the last executed migration. It was executed on ${new Date(n.timestamp).toString()}.`),this.connection.logger.logSchemaBuild(`${a.length} migrations are new migrations must be executed.`),this.transaction==="all"){let l=a.filter(h=>h.instance?.transaction!==void 0);if(l.length>0){let h=new po(l);throw this.connection.logger.logMigration(`Migrations failed, error: ${h.message}`),h}}let c={each:!0,none:!1,all:!1}[this.transaction];for(let l of a)if(l.instance){let h=l.instance.transaction;h===void 0?l.transaction=c:l.transaction=h}let u=!1;this.transaction==="all"&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),u=!0);try{for(let l of a){if(this.fake){await this.insertExecutedMigration(e,l);continue}l.transaction&&!e.isTransactionActive&&(await e.beforeMigration(),await e.startTransaction(),u=!0),await l.instance.up(e).catch(h=>{throw this.connection.logger.logMigration(`Migration "${l.name}" failed, error: ${h?.message}`),h}).then(async()=>{await this.insertExecutedMigration(e,l),l.transaction&&u&&(await e.commitTransaction(),await e.afterMigration())}).then(()=>{s.push(l),this.connection.logger.logSchemaBuild(`Migration ${l.name} has been ${this.fake?"(fake) ":""}executed successfully.`)})}this.transaction==="all"&&u&&(await e.commitTransaction(),await e.afterMigration())}catch(l){if(u)try{await e.rollbackTransaction()}catch{}throw l}finally{this.queryRunner||await e.release()}return s}async undoLastMigration(){let e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);let t=this.connection.driver.createSchemaBuilder();x.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);let r=await this.loadExecutedMigrations(e),n=this.getLatestExecutedMigration(r);if(!n){this.connection.logger.logSchemaBuild("No migrations were found in the database. Nothing to revert!");return}let s=this.getMigrations().find(c=>c.name===n.name);if(!s)throw new y(`No migration ${n.name} was found in the source code. Make sure you have this migration in your codebase and its included in the connection options.`);this.connection.logger.logSchemaBuild(`${r.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${n.name} is the last executed migration. It was executed on ${new Date(n.timestamp).toString()}.`),this.connection.logger.logSchemaBuild("Now reverting it...");let a=!1;this.transaction!=="none"&&!e.isTransactionActive&&(await e.startTransaction(),a=!0);try{this.fake||(await e.beforeMigration(),await s.instance.down(e),await e.afterMigration()),await this.deleteExecutedMigration(e,s),this.connection.logger.logSchemaBuild(`Migration ${s.name} has been ${this.fake?"(fake) ":""}reverted successfully.`),a&&await e.commitTransaction()}catch(c){if(a)try{await e.rollbackTransaction()}catch{}throw c}finally{this.queryRunner||await e.release()}}async createMigrationsTableIfNotExist(e){if(this.connection.driver.options.type==="mongodb")return;await e.hasTable(this.migrationsTable)||await e.createTable(new Me({database:this.migrationsDatabase,schema:this.migrationsSchema,name:this.migrationsTable,columns:[{name:"id",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationId}),isGenerated:!0,generationStrategy:"increment",isPrimary:!0,isNullable:!1},{name:"timestamp",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp}),isPrimary:!1,isNullable:!1},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}),isNullable:!1}]}))}async loadExecutedMigrations(e){return this.connection.driver.options.type==="mongodb"?e.cursor(this.migrationsTableName,{}).sort({_id:-1}).toArray():(await this.connection.manager.createQueryBuilder(e).select().orderBy(this.connection.driver.escape("id"),"DESC").from(this.migrationsTable,this.migrationsTableName).getRawMany()).map(r=>new Jn(parseInt(r.id),parseInt(r.timestamp),r.name))}getMigrations(){let e=this.connection.migrations.map(t=>{let r=t.name||t.constructor.name,n=parseInt(r.substr(-13),10);if(!n||isNaN(n))throw new y(`${r} migration name is wrong. Migration class name should have a JavaScript timestamp appended.`);return new Jn(void 0,n,r,t)});return this.checkForDuplicateMigrations(e),e.sort((t,r)=>t.timestamp-r.timestamp)}checkForDuplicateMigrations(e){let t=e.map(n=>n.name),r=Array.from(new Set(t.filter((n,i)=>t.indexOf(n)<i)));if(r.length>0)throw Error(`Duplicate migrations: ${r.join(", ")}`)}getLatestTimestampMigration(e){let t=e.map(r=>r).sort((r,n)=>(r.timestamp-n.timestamp)*-1);return t.length>0?t[0]:void 0}getLatestExecutedMigration(e){return e.length>0?e[0]:void 0}async insertExecutedMigration(e,t){let r={};this.connection.driver.options.type==="mssql"?(r.timestamp=new mt(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),r.name=new mt(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(r.timestamp=t.timestamp,r.name=t.name),this.connection.driver.options.type==="mongodb"?await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).insertOne(r):await e.manager.createQueryBuilder().insert().into(this.migrationsTable).values(r).execute()}async deleteExecutedMigration(e,t){let r={};if(this.connection.driver.options.type==="mssql"?(r.timestamp=new mt(t.timestamp,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp})),r.name=new mt(t.name,this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}))):(r.timestamp=t.timestamp,r.name=t.name),this.connection.driver.options.type==="mongodb")await e.databaseConnection.db(this.connection.driver.database).collection(this.migrationsTableName).deleteOne(r);else{let n=e.manager.createQueryBuilder();await n.delete().from(this.migrationsTable).where(`${n.escape("timestamp")} = :timestamp`).andWhere(`${n.escape("name")} = :name`).setParameters(r).execute()}}async withQueryRunner(e){let t=this.queryRunner||this.connection.createQueryRunner();try{return await e(t)}finally{this.queryRunner||await t.release()}}};function Vo(o,e,t){let r=[],n={};return function i(s){n[s]=!0,r.push(s),o[s].forEach(function(a){if(!n[a])i(a);else if(r.indexOf(a)>=0)throw r.push(a),new y(`Dependency Cycle Found: ${r.join(" -> ")}`)}),r.pop(),(!e||o[s].length===0)&&t.indexOf(s)===-1&&t.push(s)}}var Wo=class{constructor(){this.nodes={},this.outgoingEdges={},this.incomingEdges={}}addNode(e,t){this.hasNode(e)||(arguments.length===2?this.nodes[e]=t:this.nodes[e]=e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])}removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(function(t){Object.keys(t).forEach(function(r){let n=t[r].indexOf(e);n>=0&&t[r].splice(n,1)})}))}hasNode(e){return this.nodes.hasOwnProperty(e)}getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new y(`Node does not exist: ${e}`)}setNodeData(e,t){if(this.hasNode(e))this.nodes[e]=t;else throw new y(`Node does not exist: ${e}`)}addDependency(e,t){if(!this.hasNode(e))throw new y(`Node does not exist: ${e}`);if(!this.hasNode(t))throw new y(`Node does not exist: ${t}`);return this.outgoingEdges[e].indexOf(t)===-1&&this.outgoingEdges[e].push(t),this.incomingEdges[t].indexOf(e)===-1&&this.incomingEdges[t].push(e),!0}removeDependency(e,t){let r;this.hasNode(e)&&(r=this.outgoingEdges[e].indexOf(t),r>=0&&this.outgoingEdges[e].splice(r,1)),this.hasNode(t)&&(r=this.incomingEdges[t].indexOf(e),r>=0&&this.incomingEdges[t].splice(r,1))}dependenciesOf(e,t){if(this.hasNode(e)){let r=[];Vo(this.outgoingEdges,t,r)(e);let i=r.indexOf(e);return i>=0&&r.splice(i,1),r}else throw new y(`Node does not exist: ${e}`)}dependantsOf(e,t){if(this.hasNode(e)){let r=[];Vo(this.incomingEdges,t,r)(e);let i=r.indexOf(e);return i>=0&&r.splice(i,1),r}else throw new y(`Node does not exist: ${e}`)}overallOrder(e){let t=this,r=[],n=Object.keys(this.nodes);if(n.length===0)return r;{let i=Vo(this.outgoingEdges,!1,[]);n.forEach(function(a){i(a)});let s=Vo(this.outgoingEdges,e,r);return n.filter(function(a){return t.incomingEdges[a].length===0}).forEach(function(a){s(a)}),r}}};var Ho=class{validateMany(e,t){e.forEach(r=>this.validate(r,e,t)),this.validateDependencies(e),this.validateEagerRelations(e)}validate(e,t,r){if(!e.primaryColumns.length&&!e.isJunction)throw new eo(e);if(e.primaryColumns.length>1&&!e.primaryColumns.every((s,a,c)=>s.primaryKeyConstraintName===c[0].primaryKeyConstraintName))throw new y(`Entity ${e.name} has multiple primary columns with different constraint names. Constraint names should be the equal.`);if(e.inheritancePattern==="STI"||e.tableType==="entity-child"){if(!e.discriminatorColumn)throw new y(`Entity ${e.name} using single-table inheritance, it should also have a discriminator column. Did you forget to put discriminator column options?`);if(typeof e.discriminatorValue>"u")throw new y(`Entity ${e.name} has an undefined discriminator value. Discriminator value should be defined.`);let i=t.find(s=>s!==e&&(s.inheritancePattern==="STI"||s.tableType==="entity-child")&&s.tableName===e.tableName&&s.discriminatorValue===e.discriminatorValue&&s.inheritanceTree.some(a=>e.inheritanceTree.indexOf(a)!==-1));if(i)throw new y(`Entities ${e.name} and ${i.name} have the same discriminator values. Make sure they are different while using the @ChildEntity decorator.`)}if(e.relationCounts.forEach(i=>{if(i.relation.isManyToOne||i.relation.isOneToOne)throw new y("Relation count can not be implemented on ManyToOne or OneToOne relations.")}),r.options.type!=="mongodb"&&e.columns.filter(i=>!i.isVirtualProperty).forEach(i=>{let s=r.normalizeType(i);if(!r.supportedDataTypes.includes(s))throw new ao(i,s,r.options.type);if(i.length&&!r.withLengthColumnTypes.includes(s))throw new y(`Column ${i.propertyName} of Entity ${e.name} does not support length property.`);if(i.type==="enum"&&!i.enum&&!i.enumName)throw new y(`Column "${i.propertyName}" of Entity "${e.name}" is defined as enum, but missing "enum" or "enumName" properties.`)}),(H.isMySQLFamily(r)||r.options.type==="aurora-mysql")&&e.columns.filter(s=>s.isGenerated&&s.generationStrategy!=="uuid").length>1)throw new y(`Error in ${e.name} entity. There can be only one auto-increment column in MySql table.`);if(H.isMySQLFamily(r)&&t.filter(s=>s.database).length===0&&!r.database)throw new ho("database");if(r.options.type==="mssql"&&e.columns.filter(s=>s.charset).length>1)throw new y("Character set specifying is not supported in Sql Server");if(r.options.type==="postgres"){let i=e.columns.find(s=>s.asExpression&&(!s.generatedType||s.generatedType==="VIRTUAL"));if(i)throw new y(`Column "${i.propertyName}" of Entity "${e.name}" is defined as VIRTUAL, but Postgres supports only STORED generated columns.`)}let n=e.create(void 0,{fromDeserializer:!0});e.relations.forEach(i=>{if(i.isManyToMany||i.isOneToMany){if(i.persistenceEnabled===!1)return;let s=i.getEntityValue(n);if(Array.isArray(s))throw new oo(i)}}),e.relations.forEach(i=>{if(r.supportedOnDeleteTypes&&i.onDelete&&!r.supportedOnDeleteTypes.includes(i.onDelete))throw new y(`OnDeleteType "${i.onDelete}" is not supported for ${r.options.type}!`);if(r.supportedOnUpdateTypes&&i.onUpdate&&!r.supportedOnUpdateTypes.includes(i.onUpdate))throw new y(`OnUpdateType "${i.onUpdate}" is not valid for ${r.options.type}!`)}),e.relations.forEach(i=>{if(i.isCascadeRemove&&i.inverseRelation&&i.inverseRelation.isCascadeRemove)throw new y(`Relation ${e.name}#${i.propertyName} and ${i.inverseRelation.entityMetadata.name}#${i.inverseRelation.propertyName} both has cascade remove set. This may lead to unexpected circular removals. Please set cascade remove only from one side of relationship.`)})}validateDependencies(e){let t=new Wo;e.forEach(r=>{t.addNode(r.name)}),e.forEach(r=>{r.relationsWithJoinColumns.filter(n=>!n.isNullable).forEach(n=>{t.addDependency(r.name,n.inverseEntityMetadata.name)})});try{t.overallOrder()}catch(r){throw new Za(r.toString().replace("Error: Dependency Cycle Found: ",""))}}validateEagerRelations(e){e.forEach(t=>{t.eagerRelations.forEach(r=>{if(r.inverseRelation&&r.inverseRelation.isEager)throw new y(`Circular eager relations are disallowed. ${t.targetName}#${r.propertyPath} contains "eager: true", and its inverse side ${r.inverseEntityMetadata.targetName}#${r.inverseRelation.propertyPath} contains "eager: true" as well. Remove "eager: true" from one side of the relation.`)})})}};var Ar=class o{static createRelationMaps(e,t,r,n){return n.map(i=>{let s=t.treeParentRelation.joinColumns[0],a=s.referencedColumn??t.primaryColumns[0],c=s.givenDatabaseName||s.databaseName,u=a.givenDatabaseName||a.databaseName,l=i[r+"_"+u],h=i[r+"_"+c];return{id:e.connection.driver.prepareHydratedValue(l,a),parentId:e.connection.driver.prepareHydratedValue(h,s)}})}static buildChildrenEntityTree(e,t,r,n,i){let s=e.treeChildrenRelation.propertyName;if(i.depth===0){t[s]=[];return}let c=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],u=c.getEntityValue(t),l=n.filter(p=>p.parentId===u),h=new Set(l.map(p=>p.id));t[s]=r.filter(p=>h.has(c.getEntityValue(p))),t[s].forEach(p=>{o.buildChildrenEntityTree(e,p,r,n,{...i,depth:i.depth-1})})}static buildParentEntityTree(e,t,r,n){let i=e.treeParentRelation.propertyName,a=e.treeParentRelation.joinColumns[0].referencedColumn??e.primaryColumns[0],c=a.getEntityValue(t),u=n.find(h=>h.id===c),l=r.find(h=>u?a.getEntityValue(h)===u.parentId:!1);l&&(t[i]=l,o.buildParentEntityTree(e,t[i],r,n))}};var Yn=class{get metadata(){return this.manager.connection.getMetadata(this.target)}constructor(e,t,r){this.target=e,this.manager=t,this.queryRunner=r}createQueryBuilder(e,t){return this.manager.createQueryBuilder(this.metadata.target,e||this.metadata.targetName,t||this.queryRunner)}hasId(e){return this.manager.hasId(this.metadata.target,e)}getId(e){return this.manager.getId(this.metadata.target,e)}create(e){return this.manager.create(this.metadata.target,e)}merge(e,...t){return this.manager.merge(this.metadata.target,e,...t)}preload(e){return this.manager.preload(this.metadata.target,e)}save(e,t){return this.manager.save(this.metadata.target,e,t)}remove(e,t){return this.manager.remove(this.metadata.target,e,t)}softRemove(e,t){return this.manager.softRemove(this.metadata.target,e,t)}recover(e,t){return this.manager.recover(this.metadata.target,e,t)}insert(e){return this.manager.insert(this.metadata.target,e)}update(e,t){return this.manager.update(this.metadata.target,e,t)}updateAll(e){return this.manager.updateAll(this.metadata.target,e)}upsert(e,t){return this.manager.upsert(this.metadata.target,e,t)}delete(e){return this.manager.delete(this.metadata.target,e)}deleteAll(){return this.manager.deleteAll(this.metadata.target)}softDelete(e){return this.manager.softDelete(this.metadata.target,e)}restore(e){return this.manager.restore(this.metadata.target,e)}exist(e){return this.manager.exists(this.metadata.target,e)}exists(e){return this.manager.exists(this.metadata.target,e)}existsBy(e){return this.manager.existsBy(this.metadata.target,e)}count(e){return this.manager.count(this.metadata.target,e)}countBy(e){return this.manager.countBy(this.metadata.target,e)}sum(e,t){return this.manager.sum(this.metadata.target,e,t)}average(e,t){return this.manager.average(this.metadata.target,e,t)}minimum(e,t){return this.manager.minimum(this.metadata.target,e,t)}maximum(e,t){return this.manager.maximum(this.metadata.target,e,t)}async find(e){return this.manager.find(this.metadata.target,e)}async findBy(e){return this.manager.findBy(this.metadata.target,e)}findAndCount(e){return this.manager.findAndCount(this.metadata.target,e)}findAndCountBy(e){return this.manager.findAndCountBy(this.metadata.target,e)}async findByIds(e){return this.manager.findByIds(this.metadata.target,e)}async findOne(e){return this.manager.findOne(this.metadata.target,e)}async findOneBy(e){return this.manager.findOneBy(this.metadata.target,e)}async findOneById(e){return this.manager.findOneById(this.metadata.target,e)}async findOneOrFail(e){return this.manager.findOneOrFail(this.metadata.target,e)}async findOneByOrFail(e){return this.manager.findOneByOrFail(this.metadata.target,e)}query(e,t){return this.manager.query(e,t)}async sql(e,...t){let{query:r,parameters:n}=gr({driver:this.manager.connection.driver,strings:e,expressions:t});return await this.query(r,n)}clear(){return this.manager.clear(this.metadata.target)}increment(e,t,r){return this.manager.increment(this.metadata.target,e,t,r)}decrement(e,t,r){return this.manager.decrement(this.metadata.target,e,t,r)}extend(e){let t=this.constructor,{target:r,manager:n,queryRunner:i}=this,s=class extends t{constructor(a,c,u){super(a,c,u)}};for(let a in e)s.prototype[a]=e[a];return new s(r,n,i)}};var Go=class extends Yn{async findTrees(e){let t=await this.findRoots(e);return await Promise.all(t.map(r=>this.findDescendantsTree(r,e))),t}findRoots(e){let t=a=>this.manager.connection.driver.escape(a),r=a=>this.manager.connection.driver.escape(a),n=this.metadata.treeParentRelation.joinColumns[0],i=n.givenDatabaseName||n.databaseName,s=this.createQueryBuilder("treeEntity");return Ge.applyOptionsToTreeQueryBuilder(s,e),s.where(`${t("treeEntity")}.${r(i)} IS NULL`).getMany()}findDescendants(e,t){let r=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);return Ge.applyOptionsToTreeQueryBuilder(r,t),r.getMany()}async findDescendantsTree(e,t){let r=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);Ge.applyOptionsToTreeQueryBuilder(r,t);let n=await r.getRawAndEntities(),i=Ar.createRelationMaps(this.manager,this.metadata,"treeEntity",n.raw);return Ar.buildChildrenEntityTree(this.metadata,e,n.entities,i,{depth:-1,...t}),e}countDescendants(e){return this.createDescendantsQueryBuilder("treeEntity","treeClosure",e).getCount()}createDescendantsQueryBuilder(e,t,r){let n=i=>this.manager.connection.driver.escape(i);if(this.metadata.treeType==="closure-table"){let i=this.metadata.closureJunctionTable.descendantColumns.map(c=>n(t)+"."+n(c.propertyPath)+" = "+n(e)+"."+n(c.referencedColumn.propertyPath)).join(" AND "),s={},a=this.metadata.closureJunctionTable.ancestorColumns.map(c=>(s[c.referencedColumn.propertyName]=c.referencedColumn.getEntityValue(r),n(t)+"."+n(c.propertyPath)+" = :"+c.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,i).where(a).setParameters(s)}else if(this.metadata.treeType==="nested-set"){let i=e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN joined."+this.metadata.nestedSetLeftColumn.propertyPath+" AND joined."+this.metadata.nestedSetRightColumn.propertyPath,s={},a=this.metadata.treeParentRelation.joinColumns.map(c=>{let u=c.referencedColumn.propertyPath.replace(".","_");return s[u]=c.referencedColumn.getEntityValue(r),"joined."+c.referencedColumn.propertyPath+" = :"+u}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",i).where(a,s)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(i=>{let s=i.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(r));return H.isSQLiteFamily(this.manager.connection.driver)?`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE ${s.getQuery()} || '%'`:`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE NULLIF(CONCAT(${s.getQuery()}, '%'), '%')`});throw new y("Supported only in tree entities")}findAncestors(e,t){let r=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);return Ge.applyOptionsToTreeQueryBuilder(r,t),r.getMany()}async findAncestorsTree(e,t){let r=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);Ge.applyOptionsToTreeQueryBuilder(r,t);let n=await r.getRawAndEntities(),i=Ar.createRelationMaps(this.manager,this.metadata,"treeEntity",n.raw);return Ar.buildParentEntityTree(this.metadata,e,n.entities,i),e}countAncestors(e){return this.createAncestorsQueryBuilder("treeEntity","treeClosure",e).getCount()}createAncestorsQueryBuilder(e,t,r){if(this.metadata.treeType==="closure-table"){let n=this.metadata.closureJunctionTable.ancestorColumns.map(a=>t+"."+a.propertyPath+" = "+e+"."+a.referencedColumn.propertyPath).join(" AND "),i={},s=this.metadata.closureJunctionTable.descendantColumns.map(a=>(i[a.referencedColumn.propertyName]=a.referencedColumn.getEntityValue(r),t+"."+a.propertyPath+" = :"+a.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,n).where(s).setParameters(i)}else if(this.metadata.treeType==="nested-set"){let n="joined."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN "+e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" AND "+e+"."+this.metadata.nestedSetRightColumn.propertyPath,i={},s=this.metadata.treeParentRelation.joinColumns.map(a=>{let c=a.referencedColumn.propertyPath.replace(".","_");return i[c]=a.referencedColumn.getEntityValue(r),"joined."+a.referencedColumn.propertyPath+" = :"+c}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",n).where(s,i)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(n=>{let i=n.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(r));return H.isSQLiteFamily(this.manager.connection.driver)?`${i.getQuery()} LIKE ${e}.${this.metadata.materializedPathColumn.propertyPath} || '%'`:`${i.getQuery()} LIKE CONCAT(${e}.${this.metadata.materializedPathColumn.propertyPath}, '%')`});throw new y("Supported only in tree entities")}};var Ko=class{transform(e,t,r,n=!1){return this.groupAndTransform(e,t,r,n),e}groupAndTransform(e,t,r,n=!1){r.nonVirtualColumns.forEach(i=>{let s=i.getEntityValue(t);s!==void 0&&i.setEntityValue(e,s)}),r.relations.length&&r.relations.forEach(i=>{let s=i.getEntityValue(e),a=i.getEntityValue(t,n);if(a!==void 0)if(i.isOneToMany||i.isManyToMany){if(!Array.isArray(a))return;s||(s=[],i.setEntityValue(e,s)),a.forEach(c=>{let u=s.find(h=>i.inverseEntityMetadata.compareEntities(c,h)),l=i.inverseEntityMetadata.findInheritanceMetadata(c);u||(u=l.create(void 0,{fromDeserializer:!0}),s.push(u)),this.groupAndTransform(u,c,l,n)})}else{if(!X.isObject(a)){X.isObject(s)||i.setEntityValue(e,a);return}let c=i.inverseEntityMetadata.findInheritanceMetadata(a);s||(s=c.create(void 0,{fromDeserializer:!0}),i.setEntityValue(e,s)),this.groupAndTransform(s,a,c,n)}})}};var Cl=class{constructor(e,t,r,n){this.plainEntity=e,this.metadata=t,this.parentLoadMapItem=r,this.relation=n}get target(){return this.metadata.target}get id(){return this.metadata.getEntityIdMixedMap(this.plainEntity)}},Rl=class{constructor(){this.loadMapItems=[]}get mainLoadMapItem(){return this.loadMapItems.find(e=>!e.relation&&!e.parentLoadMapItem)}addLoadMap(e){this.loadMapItems.find(r=>r.target===e.target&&r.id===e.id)||this.loadMapItems.push(e)}fillEntities(e,t){t.forEach(r=>{let n=this.loadMapItems.find(i=>i.target===e&&i.metadata.compareEntities(r,i.plainEntity));n&&(n.entity=r)})}groupByTargetIds(){let e=[];return this.loadMapItems.forEach(t=>{let r=e.find(n=>n.target===t.target);r||(r={target:t.target,ids:[]},e.push(r)),r.ids.push(t.id)}),e}},zo=class{constructor(e){this.manager=e}async transform(e,t){if(!t.hasAllPrimaryKeys(e))return Promise.reject("Given object does not have a primary column, cannot transform it to database entity.");let r=new Rl,n=(i,s,a,c)=>{let u=new Cl(i,s,a,c);r.addLoadMap(u),s.extractRelationValuesFromEntity(i,t.relations).filter(l=>l!=null).forEach(([l,h,p])=>n(h,p,u,l))};return n(e,t),await Promise.all(r.groupByTargetIds().map(i=>this.manager.findByIds(i.target,i.ids).then(s=>r.fillEntities(i.target,s)))),r.loadMapItems.forEach(i=>{!i.relation||!i.entity||!i.parentLoadMapItem||!i.parentLoadMapItem.entity||(i.relation.isManyToMany||i.relation.isOneToMany?(i.parentLoadMapItem.entity[i.relation.propertyName]||(i.parentLoadMapItem.entity[i.relation.propertyName]=[]),i.parentLoadMapItem.entity[i.relation.propertyName].push(i.entity)):i.parentLoadMapItem.entity[i.relation.propertyName]=i.entity)}),r.mainLoadMapItem?r.mainLoadMapItem.entity:void 0}};var Jo=class{get repository(){let e=this.getCustomRepositoryTarget(this);if(!e)throw new kn(this.constructor);return this.manager.getRepository(e)}get treeRepository(){let e=this.getCustomRepositoryTarget(this);if(!e)throw new kn(this.constructor);return this.manager.getTreeRepository(e)}createQueryBuilder(e){let t=this.getCustomRepositoryTarget(this.constructor);if(!t)throw new kn(this.constructor);return this.manager.getRepository(t).createQueryBuilder(e)}createQueryBuilderFor(e,t){return this.getRepositoryFor(e).createQueryBuilder(t)}getRepositoryFor(e){return this.manager.getRepository(e)}getTreeRepositoryFor(e){return this.manager.getTreeRepository(e)}getCustomRepositoryTarget(e){let t=pe().entityRepositories.find(r=>r.target===(typeof e=="function"?e:e.constructor));if(!t)throw new Fn(e);return t.entity}};var us=class{constructor(e){this.subjects=[...e],this.metadatas=this.getUniqueMetadatas(this.subjects)}sort(e){if(!this.metadatas.length)return this.subjects;let t=[];if(e==="delete"){let a=this.subjects.filter(c=>!c.entity&&!c.databaseEntity);t.push(...a),this.removeAlreadySorted(a)}let r=this.getNonNullableDependencies(),n=this.toposort(r);e==="insert"&&(n=n.reverse()),n.forEach(a=>{let c=this.subjects.filter(u=>u.metadata.targetName===a||u.metadata.inheritanceTree.some(l=>l.name===a));t.push(...c),this.removeAlreadySorted(c)});let i=this.getDependencies(),s=this.toposort(i);return e==="insert"&&(s=s.reverse()),s.forEach(a=>{let c=this.subjects.filter(u=>u.metadata.targetName===a);t.push(...c),this.removeAlreadySorted(c)}),t.push(...this.subjects),t}removeAlreadySorted(e){e.forEach(t=>{this.subjects.splice(this.subjects.indexOf(t),1)})}getUniqueMetadatas(e){let t=[];return e.forEach(r=>{t.indexOf(r.metadata)===-1&&t.push(r.metadata)}),t}getNonNullableDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(r=>{r.isNullable||e.push([t.targetName,r.inverseEntityMetadata.targetName])}),e),[])}getDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(r=>{r.inverseEntityMetadata!==t&&e.push([t.targetName,r.inverseEntityMetadata.targetName])}),e),[])}toposort(e){function t(u){let l=[];for(let h=0,p=u.length;h<p;h++){let d=u[h];l.indexOf(d[0])<0&&l.push(d[0]),l.indexOf(d[1])<0&&l.push(d[1])}return l}let r=t(e),n=r.length,i=n,s=new Array(n),a=new Set;for(;i--;)a.has(i)||c(r[i],i,[]);function c(u,l,h){if(h.indexOf(u)>=0)throw new y("Cyclic dependency: "+JSON.stringify(u));if(!~r.indexOf(u))throw new y("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(u));if(a.has(l))return;a.add(l);let p=e.filter(function(d){return d[0]===u});if(l=p.length){let d=h.concat(u);do{let m=p[--l][1];c(m,r.indexOf(m),d)}while(l)}s[--n]=u}return s}};var Yo=class{compute(e){e.forEach(t=>{this.computeDiffColumns(t),this.computeDiffRelationalColumns(e,t)})}computeDiffColumns(e){e.entity&&e.metadata.columns.forEach(t=>{if(t.isVirtual||t.isDiscriminator)return;let r=e.changeMaps.find(i=>i.column===t);r&&e.changeMaps.splice(e.changeMaps.indexOf(r),1);let n=t.getEntityValue(e.entity);if(n!==void 0){if(e.databaseEntity){let i=t.type!=="json"&&t.type!=="jsonb",s=t.getEntityValue(e.databaseEntity,i);if(t.relationMetadata){let c=t.relationMetadata.getEntityValue(e.entity);if(c!=null)return}let a=n;if(n!==null&&s!==null){switch(t.type){case"date":a=t.isArray?n.map(c=>re.mixedDateToDateString(c)):re.mixedDateToDateString(n),s=t.isArray?s.map(c=>re.mixedDateToDateString(c)):re.mixedDateToDateString(s);break;case"time":case"time with time zone":case"time without time zone":case"timetz":a=t.isArray?n.map(c=>re.mixedDateToTimeString(c)):re.mixedDateToTimeString(n),s=t.isArray?s.map(c=>re.mixedDateToTimeString(c)):re.mixedDateToTimeString(s);break;case"datetime":case"datetime2":case Date:case"timestamp":case"timestamp without time zone":case"timestamp with time zone":case"timestamp with local time zone":case"timestamptz":a=t.isArray?n.map(c=>re.mixedDateToUtcDatetimeString(c)):re.mixedDateToUtcDatetimeString(n),s=t.isArray?s.map(c=>re.mixedDateToUtcDatetimeString(c)):re.mixedDateToUtcDatetimeString(s);break;case"json":case"jsonb":if(K.deepCompare(n,s))return;break;case"simple-array":a=re.simpleArrayToString(n),s=re.simpleArrayToString(s);break;case"simple-enum":a=re.simpleEnumToString(n),s=re.simpleEnumToString(s);break;case"simple-json":a=re.simpleJsonToString(n),s=re.simpleJsonToString(s);break}t.transformer&&(a=ve.transformTo(t.transformer,n))}if(t.isArray){if(K.deepCompare(a,s))return}else if(Buffer.isBuffer(a)&&Buffer.isBuffer(s)){if(a.equals(s))return}else if(a===s)return}e.diffColumns.includes(t)||e.diffColumns.push(t),e.changeMaps.push({column:t,value:n})}})}computeDiffRelationalColumns(e,t){t.entity&&t.metadata.relationsWithJoinColumns.forEach(r=>{let n=r.getEntityValue(t.entity);if(n===void 0)return;if(t.databaseEntity){let a=n;a!==null&&X.isObject(a)&&(a=r.getRelationIdMap(a));let c=r.getEntityValue(t.databaseEntity);if(K.compareIds(a,c))return;t.diffRelations.push(r)}let i=e.find(a=>a.mustBeInserted&&a.entity===n);i&&(n=i);let s=t.changeMaps.find(a=>a.relation===r);s?s.value=n:t.changeMaps.push({relation:r,value:n})})}};var ls=class extends y{constructor(){super("Nested sets do not support multiple root entities.")}};var Xn=class{constructor(e){this.queryRunner=e}async insert(e){let t=u=>this.queryRunner.connection.driver.escape(u),r=this.getTableName(e.metadata.tablePath),n=t(e.metadata.nestedSetLeftColumn.databaseName),i=t(e.metadata.nestedSetRightColumn.databaseName),s=e.metadata.treeParentRelation.getEntityValue(e.entity);!s&&e.parentSubject&&e.parentSubject.entity&&(s=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);let a=e.metadata.getEntityIdMap(s),c;if(a&&(c=await this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.nestedSetRightColumn.propertyPath,"right").from(e.metadata.target,e.metadata.targetName).whereInIds(a).getRawOne().then(u=>{let l=u?u.right:void 0;return typeof l=="string"?parseInt(l):l})),c!==void 0)await this.queryRunner.query(`UPDATE ${r} SET ${n} = CASE WHEN ${n} > ${c} THEN ${n} + 2 ELSE ${n} END,${i} = ${i} + 2 WHERE ${i} >= ${c}`),K.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(c),e.metadata.nestedSetRightColumn.createValueMap(c+1));else{if(!await this.isUniqueRootEntity(e,s))throw new ls;K.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(1),e.metadata.nestedSetRightColumn.createValueMap(2))}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let r=e.databaseEntity;if(!r&&t&&(r=e.metadata.treeChildrenRelation.getEntityValue(t).find(a=>Object.entries(e.identifier).every(([c,u])=>a[c]===u))),r===void 0||t===void 0)return;let n=e.metadata.treeParentRelation.getEntityValue(r),i=e.metadata.getEntityIdMap(n),s=e.metadata.getEntityIdMap(t);if(!K.compareIds(i,s)){if(t){let a=m=>this.queryRunner.connection.driver.escape(m),c=this.getTableName(e.metadata.tablePath),u=a(e.metadata.nestedSetLeftColumn.databaseName),l=a(e.metadata.nestedSetRightColumn.databaseName),h=e.metadata.getEntityIdMap(r),p;h&&(p=(await this.getNestedSetIds(e.metadata,h))[0]);let d;if(s&&(d=(await this.getNestedSetIds(e.metadata,s))[0]),p!==void 0&&d!==void 0){let m=d.left>p.left,f=p.right-p.left+1,A;m?A=d.left-p.right:A=d.right-p.left;let R=`WHEN ${u} >= ${p.left} AND ${u} < ${p.right} THEN ${u} + ${A} `,I=`WHEN ${l} > ${p.left} AND ${l} <= ${p.right} THEN ${l} + ${A} `;m?await this.queryRunner.query(`UPDATE ${c} SET ${u} = CASE WHEN ${u} > ${p.right} AND ${u} <= ${d.left} THEN ${u} - ${f} `+R+`ELSE ${u} END, ${l} = CASE WHEN ${l} > ${p.right} AND ${l} < ${d.left} THEN ${l} - ${f} `+I+`ELSE ${l} END`):await this.queryRunner.query(`UPDATE ${c} SET ${u} = CASE WHEN ${u} < ${p.left} AND ${u} > ${d.right} THEN ${u} + ${f} `+R+`ELSE ${u} END, ${l} = CASE WHEN ${l} < ${p.left} AND ${l} >= ${d.right} THEN ${l} + ${f} `+I+`ELSE ${l} END`)}}else if(!await this.isUniqueRootEntity(e,t))throw new ls}}async remove(e){Array.isArray(e)||(e=[e]);let t=e[0].metadata,r=u=>this.queryRunner.connection.driver.escape(u),n=this.getTableName(t.tablePath),i=r(t.nestedSetLeftColumn.databaseName),s=r(t.nestedSetRightColumn.databaseName),a=[];for(let u of e){let l=t.getEntityIdMap(u.entity);l&&a.push(l)}let c=await this.getNestedSetIds(t,a);for(let u of c){let l=u.right-u.left+1;await this.queryRunner.query(`UPDATE ${n} SET ${i} = CASE WHEN ${i} > ${u.left} THEN ${i} - ${l} ELSE ${i} END, ${s} = CASE WHEN ${s} > ${u.right} THEN ${s} - ${l} ELSE ${s} END`)}}getNestedSetIds(e,t){let r={left:`${e.targetName}.${e.nestedSetLeftColumn.propertyPath}`,right:`${e.targetName}.${e.nestedSetRightColumn.propertyPath}`},n=this.queryRunner.manager.createQueryBuilder();return Object.entries(r).forEach(([i,s])=>{n.addSelect(s,i)}),n.from(e.target,e.targetName).whereInIds(t).orderBy(r.right,"DESC").getRawMany().then(i=>{let s=[];for(let a of i){let c={};for(let u of Object.keys(r)){let l=a?a[u]:void 0;c[u]=typeof l=="string"?parseInt(l):l}s.push(c)}return s})}async isUniqueRootEntity(e,t){let r=u=>this.queryRunner.connection.driver.escape(u),n=this.getTableName(e.metadata.tablePath),i=[],s=e.metadata.treeParentRelation.joinColumns.map(u=>{let l=r(u.databaseName),h=u.getEntityValue(t);if(h==null)return`${l} IS NULL`;i.push(h);let p=this.queryRunner.connection.driver.createParameter("entity_"+u.databaseName,i.length-1);return`${l} = ${p}`}).join(" AND "),a="count",c=await this.queryRunner.query(`SELECT COUNT(1) AS ${r(a)} FROM ${n} WHERE ${s}`,i,!0);return parseInt(c.records[0][a])===0}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}};var Zn=class{constructor(e){this.queryRunner=e}async insert(e){let t={};e.metadata.closureJunctionTable.ancestorColumns.forEach(n=>{t[n.databaseName]=e.identifier}),e.metadata.closureJunctionTable.descendantColumns.forEach(n=>{t[n.databaseName]=e.identifier}),await this.queryRunner.manager.createQueryBuilder().insert().into(e.metadata.closureJunctionTable.tablePath).values(t).updateEntity(!1).callListeners(!1).execute();let r=e.metadata.treeParentRelation.getEntityValue(e.entity);if(!r&&e.parentSubject&&e.parentSubject.entity&&(r=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity),r){let n=h=>this.queryRunner.connection.driver.escape(h),i=this.getTableName(e.metadata.closureJunctionTable.tablePath),s=[],a=e.metadata.closureJunctionTable.ancestorColumns.map(h=>n(h.databaseName)),c=e.metadata.closureJunctionTable.descendantColumns.map(h=>n(h.databaseName)),u=e.metadata.primaryColumns.map(h=>(s.push(h.getEntityValue(e.insertedValueSet?e.insertedValueSet:e.entity)),this.queryRunner.connection.driver.createParameter("child_entity_"+h.databaseName,s.length-1))),l=e.metadata.closureJunctionTable.descendantColumns.map(h=>{let p=n(h.databaseName),d=h.referencedColumn.getEntityValue(r);if(!d)throw new es(e.metadata.name);s.push(d);let m=this.queryRunner.connection.driver.createParameter("parent_entity_"+h.referencedColumn.databaseName,s.length-1);return`${p} = ${m}`});await this.queryRunner.query(`INSERT INTO ${i} (${[...a,...c].join(", ")}) SELECT ${a.join(", ")}, ${u.join(", ")} FROM ${i} WHERE ${l.join(" AND ")}`,s)}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let r=e.databaseEntity;if(!r&&t&&(r=e.metadata.treeChildrenRelation.getEntityValue(t).find(d=>Object.entries(e.identifier).every(([m,f])=>d[m]===f))),r===void 0||t===void 0)return;let n=e.metadata.treeParentRelation.getEntityValue(r),i=e.metadata.getEntityIdMap(n),s=e.metadata.getEntityIdMap(t);if(K.compareIds(i,s))return;let a=d=>this.queryRunner.connection.driver.escape(d),c=e.metadata.closureJunctionTable,u=c.ancestorColumns.map(d=>a(d.databaseName)),l=c.descendantColumns.map(d=>a(d.databaseName)),h=(d,m)=>{let f=`sub${m}`,A=d.createQueryBuilder().select(l.join(", ")).from(c.tablePath,f);for(let R of c.ancestorColumns)A.andWhere(`${a(f)}.${a(R.databaseName)} = :value_${R.referencedColumn.databaseName}`);return d.createQueryBuilder().select(l.join(", ")).from(`(${A.getQuery()})`,m).setParameters(A.getParameters()).getQuery()},p={};for(let d of e.metadata.primaryColumns)p[`value_${d.databaseName}`]=r[d.databaseName];if(await this.queryRunner.manager.createQueryBuilder().delete().from(c.tablePath).where(d=>`(${l.join(", ")}) IN (${h(d,"descendant")})`).andWhere(d=>`(${u.join(", ")}) NOT IN (${h(d,"ancestor")})`).setParameters(p).execute(),t){let d=[],m=this.getTableName(c.tablePath),f=a("supertree"),A=a("subtree"),R=[...u.map(U=>`${f}.${U}`),...l.map(U=>`${A}.${U}`)],I=e.metadata.closureJunctionTable.ancestorColumns.map(U=>{let J=a(U.databaseName),ne=U.referencedColumn.getEntityValue(r);d.push(ne);let oe=this.queryRunner.connection.driver.createParameter("entity_"+U.referencedColumn.databaseName,d.length-1);return`${A}.${J} = ${oe}`}),C=e.metadata.closureJunctionTable.descendantColumns.map(U=>{let J=a(U.databaseName),ne=U.referencedColumn.getEntityValue(t);if(!ne)throw new es(e.metadata.name);d.push(ne);let oe=this.queryRunner.connection.driver.createParameter("parent_entity_"+U.referencedColumn.databaseName,d.length-1);return`${f}.${J} = ${oe}`});await this.queryRunner.query(`INSERT INTO ${m} (${[...u,...l].join(", ")}) SELECT ${R.join(", ")} FROM ${m} AS ${f}, ${m} AS ${A} WHERE ${[...I,...C].join(" AND ")}`,d)}}async remove(e){if(this.queryRunner.connection.driver.options.type!=="mssql")return;Array.isArray(e)||(e=[e]);let t=c=>this.queryRunner.connection.driver.escape(c),r=e.map(c=>c.identifier),n=e[0].metadata.closureJunctionTable,i=c=>c.map(u=>{let l=r.map(h=>h[u.referencedColumn.databaseName]);return`${t(u.databaseName)} IN (${l.join(", ")})`}).join(" AND "),s=i(n.ancestorColumns),a=i(n.descendantColumns);await this.queryRunner.manager.createQueryBuilder().delete().from(n.tablePath).where(s).orWhere(a).execute()}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}};var hs=class{constructor(e){this.queryRunner=e}async insert(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);let r=e.metadata.getEntityIdMap(t),n="";r&&(n=await this.getEntityPath(e,r));let i=e.metadata.treeParentRelation.joinColumns.map(s=>s.referencedColumn.getEntityValue(e.insertedValueSet)).join("_");await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[e.metadata.materializedPathColumn.propertyPath]:n+i+"."}).where(e.identifier).execute()}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let r=e.databaseEntity;!r&&t&&(r=e.metadata.treeChildrenRelation.getEntityValue(t).find(h=>Object.entries(e.identifier).every(([p,d])=>h[p]===d)));let n=e.metadata.treeParentRelation.getEntityValue(r),i=this.getEntityParentReferencedColumnMap(e,n),s=this.getEntityParentReferencedColumnMap(e,t);if(K.compareIds(i,s))return;let a="";s&&(a=await this.getEntityPath(e,s));let c="";i&&(c=await this.getEntityPath(e,i)||"");let u=e.metadata.treeParentRelation.joinColumns.map(h=>h.referencedColumn.getEntityValue(r)).join("_"),l=e.metadata.materializedPathColumn.propertyPath;await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[l]:()=>`REPLACE(${this.queryRunner.connection.driver.escape(l)}, '${c}${u}.', '${a}${u}.')`}).where(`${l} LIKE :path`,{path:`${c}${u}.%`}).execute()}getEntityParentReferencedColumnMap(e,t){if(t)return at.getValueMap(t,e.metadata.treeParentRelation.joinColumns.map(r=>r.referencedColumn).filter(r=>r!=null),{skipNulls:!0})}getEntityPath(e,t){let r=e.metadata,n=(Array.isArray(t)?t:[t]).map(i=>r.ensureEntityIdMap(i));return this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.materializedPathColumn.propertyPath,"path").from(e.metadata.target,e.metadata.targetName).where(new Gt(i=>{for(let s of n)i.orWhere(new Gt(a=>a.where(s)))})).getRawOne().then(i=>i?i.path:"")}};var Xo=class{constructor(e,t,r){this.hasExecutableOperations=!1,this.insertSubjects=[],this.updateSubjects=[],this.removeSubjects=[],this.softRemoveSubjects=[],this.recoverSubjects=[],this.queryRunner=e,this.allSubjects=t,this.options=r,this.validate(),this.recompute()}async execute(){let e;(!this.options||this.options.listeners!==!1)&&(e=this.broadcastBeforeEventsForAll(),e.promises.length>0&&await Promise.all(e.promises)),e&&e.count>0&&(this.insertSubjects.forEach(t=>t.recompute()),this.updateSubjects.forEach(t=>t.recompute()),this.removeSubjects.forEach(t=>t.recompute()),this.softRemoveSubjects.forEach(t=>t.recompute()),this.recoverSubjects.forEach(t=>t.recompute()),this.recompute()),this.insertSubjects=new us(this.insertSubjects).sort("insert"),await this.executeInsertOperations(),this.updateSubjects=this.allSubjects.filter(t=>t.mustBeUpdated),await this.executeUpdateOperations(),this.removeSubjects=new us(this.removeSubjects).sort("delete"),await this.executeRemoveOperations(),this.softRemoveSubjects=this.allSubjects.filter(t=>t.mustBeSoftRemoved),await this.executeSoftRemoveOperations(),this.recoverSubjects=this.allSubjects.filter(t=>t.mustBeRecovered),await this.executeRecoverOperations(),this.updateSpecialColumnsInPersistedEntities(),(!this.options||this.options.listeners!==!1)&&(e=this.broadcastAfterEventsForAll(),e.promises.length>0&&await Promise.all(e.promises))}validate(){this.allSubjects.forEach(e=>{if(e.mustBeUpdated&&e.mustBeRemoved)throw new uo(e)})}recompute(){new Yo().compute(this.allSubjects),this.insertSubjects=this.allSubjects.filter(e=>e.mustBeInserted),this.updateSubjects=this.allSubjects.filter(e=>e.mustBeUpdated),this.removeSubjects=this.allSubjects.filter(e=>e.mustBeRemoved),this.softRemoveSubjects=this.allSubjects.filter(e=>e.mustBeSoftRemoved),this.recoverSubjects=this.allSubjects.filter(e=>e.mustBeRecovered),this.hasExecutableOperations=this.insertSubjects.length>0||this.updateSubjects.length>0||this.removeSubjects.length>0||this.softRemoveSubjects.length>0||this.recoverSubjects.length>0}broadcastBeforeEventsForAll(){let e=new _e;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}broadcastAfterEventsForAll(){let e=new _e;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterInsertEvent(e,t.metadata,t.entity,t.identifier)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRecoverEvent(e,t.metadata,t.entity,t.databaseEntity,t.identifier)),e}async executeInsertOperations(){let[e,t]=this.groupBulkSubjects(this.insertSubjects,"insert");for(let r of t){let n=e[r],i=[],s=[],a=[];if(this.queryRunner.connection.driver.options.type==="mongodb"?n.forEach(c=>{c.metadata.createDateColumn&&c.entity&&(c.entity[c.metadata.createDateColumn.databaseName]=new Date),c.metadata.updateDateColumn&&c.entity&&(c.entity[c.metadata.updateDateColumn.databaseName]=new Date),c.createValueSetAndPopChangeMap(),s.push(c),i.push(c.entity)}):this.queryRunner.connection.driver.options.type==="oracle"?n.forEach(c=>{a.push(c)}):n.forEach(c=>{c.changeMaps.length===0||c.metadata.treeType||this.queryRunner.connection.driver.options.type==="oracle"||this.queryRunner.connection.driver.options.type==="sap"?a.push(c):(s.push(c),i.push(c.createValueSetAndPopChangeMap()))}),x.isMongoEntityManager(this.queryRunner.manager)){let c=await this.queryRunner.manager.insert(n[0].metadata.target,i);n.forEach((u,l)=>{u.identifier=c.identifiers[l],u.generatedMap=c.generatedMaps[l],u.insertedValueSet=i[l]})}else{if(i.length>0){let c=await this.queryRunner.manager.createQueryBuilder().insert().into(n[0].metadata.target).values(i).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute();s.forEach((u,l)=>{u.identifier=c.identifiers[l],u.generatedMap=c.generatedMaps[l],u.insertedValueSet=i[l]})}if(a.length>0)for(let c of a)c.insertedValueSet=c.createValueSetAndPopChangeMap(),c.metadata.treeType==="nested-set"&&await new Xn(this.queryRunner).insert(c),await this.queryRunner.manager.createQueryBuilder().insert().into(c.metadata.target).values(c.insertedValueSet).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute().then(u=>{c.identifier=u.identifiers[0],c.generatedMap=u.generatedMaps[0]}),c.metadata.treeType==="closure-table"?await new Zn(this.queryRunner).insert(c):c.metadata.treeType==="materialized-path"&&await new hs(this.queryRunner).insert(c)}n.forEach(c=>{c.generatedMap&&c.metadata.columns.forEach(u=>{let l=u.getEntityValue(c.generatedMap);if(l!=null){let h=this.queryRunner.connection.driver.prepareHydratedValue(l,u);u.setEntityValue(c.generatedMap,h)}})})}}async executeUpdateOperations(){let e=async i=>{if(!i.identifier)throw new Wr(i);if(x.isMongoEntityManager(this.queryRunner.manager)){let s=this.cloneMongoSubjectEntity(i);i.metadata.objectIdColumn&&i.metadata.objectIdColumn.propertyName&&delete s[i.metadata.objectIdColumn.propertyName],i.metadata.createDateColumn&&i.metadata.createDateColumn.propertyName&&delete s[i.metadata.createDateColumn.propertyName],i.metadata.updateDateColumn&&i.metadata.updateDateColumn.propertyName&&(s[i.metadata.updateDateColumn.propertyName]=new Date),await this.queryRunner.manager.update(i.metadata.target,i.identifier,s)}else{let s=i.createValueSetAndPopChangeMap();switch(i.metadata.treeType){case"nested-set":await new Xn(this.queryRunner).update(i);break;case"closure-table":await new Zn(this.queryRunner).update(i);break;case"materialized-path":await new hs(this.queryRunner).update(i);break}let a=this.queryRunner.manager.createQueryBuilder().update(i.metadata.target).set(s).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);i.entity?a.whereEntity(i.identifier):a.where(i.identifier);let u=(await a.execute()).generatedMaps[0];u&&(i.metadata.columns.forEach(l=>{let h=l.getEntityValue(u);if(h!=null){let p=this.queryRunner.connection.driver.prepareHydratedValue(h,l);l.setEntityValue(u,p)}}),i.generatedMap||(i.generatedMap={}),Object.assign(i.generatedMap,u))}},t=[],r=[];for(let i of this.updateSubjects)i.metadata.treeType==="nested-set"?t.push(i):r.push(i);let n=async()=>{for(let i of t)await e(i)};await Promise.all([...r.map(e),n()])}async executeRemoveOperations(){let[e,t]=this.groupBulkSubjects(this.removeSubjects,"delete");for(let r of t){let n=e[r],i=n.map(s=>{if(!s.identifier)throw new Wr(s);return s.identifier});if(x.isMongoEntityManager(this.queryRunner.manager))await this.queryRunner.manager.delete(n[0].metadata.target,i);else{switch(n[0].metadata.treeType){case"nested-set":await new Xn(this.queryRunner).remove(n);break;case"closure-table":await new Zn(this.queryRunner).remove(n);break}await this.queryRunner.manager.createQueryBuilder().delete().from(n[0].metadata.target).where(i).callListeners(!1).execute()}}}cloneMongoSubjectEntity(e){let t={};if(e.entity)for(let r of e.metadata.columns)K.mergeDeep(t,r.getEntityValueMap(e.entity));return t}async executeSoftRemoveOperations(){await Promise.all(this.softRemoveSubjects.map(async e=>{if(!e.identifier)throw new Wr(e);let t;if(x.isMongoEntityManager(this.queryRunner.manager)){let r=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete r[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete r[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(r[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(r[e.metadata.deleteDateColumn.propertyName]=new Date),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,r)}else{let r=this.queryRunner.manager.createQueryBuilder().softDelete().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?r.whereEntity(e.identifier):r.where(e.identifier),t=await r.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(r=>{let n=r.getEntityValue(e.generatedMap);if(n!=null){let i=this.queryRunner.connection.driver.prepareHydratedValue(n,r);r.setEntityValue(e.generatedMap,i)}})}))}async executeRecoverOperations(){await Promise.all(this.recoverSubjects.map(async e=>{if(!e.identifier)throw new Wr(e);let t;if(x.isMongoEntityManager(this.queryRunner.manager)){let r=this.cloneMongoSubjectEntity(e);e.metadata.objectIdColumn&&e.metadata.objectIdColumn.propertyName&&delete r[e.metadata.objectIdColumn.propertyName],e.metadata.createDateColumn&&e.metadata.createDateColumn.propertyName&&delete r[e.metadata.createDateColumn.propertyName],e.metadata.updateDateColumn&&e.metadata.updateDateColumn.propertyName&&(r[e.metadata.updateDateColumn.propertyName]=new Date),e.metadata.deleteDateColumn&&e.metadata.deleteDateColumn.propertyName&&(r[e.metadata.deleteDateColumn.propertyName]=null),t=await this.queryRunner.manager.update(e.metadata.target,e.identifier,r)}else{let r=this.queryRunner.manager.createQueryBuilder().restore().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?r.whereEntity(e.identifier):r.where(e.identifier),t=await r.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(r=>{let n=r.getEntityValue(e.generatedMap);if(n!=null){let i=this.queryRunner.connection.driver.prepareHydratedValue(n,r);r.setEntityValue(e.generatedMap,i)}})}))}updateSpecialColumnsInPersistedEntities(){this.insertSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.insertSubjects),this.updateSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.updateSubjects),this.softRemoveSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.softRemoveSubjects),this.recoverSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.recoverSubjects),this.removeSubjects.length&&this.removeSubjects.forEach(e=>{e.entity&&e.metadata.primaryColumns.forEach(t=>{t.setEntityValue(e.entity,void 0)})}),this.allSubjects.forEach(e=>{e.entity&&(e.metadata.relationIds.forEach(t=>{t.setValue(e.entity)}),x.isMongoEntityManager(this.queryRunner.manager)&&e.metadata.objectIdColumn&&e.metadata.objectIdColumn.databaseName&&e.metadata.objectIdColumn.databaseName!==e.metadata.objectIdColumn.propertyName&&delete e.entity[e.metadata.objectIdColumn.databaseName])})}updateSpecialColumnsInInsertedAndUpdatedEntities(e){e.forEach(t=>{t.entity&&(t.metadata.columns.forEach(r=>{t.metadata.childEntityMetadatas.length>0&&t.metadata.childEntityMetadatas.map(n=>n.target).indexOf(r.target)!==-1||r.isVirtual||r.isDeleteDate||(r.isNullable&&r.getEntityValue(t.entity)===void 0&&r.setEntityValue(t.entity,null),t.updatedRelationMaps.length>0&&t.updatedRelationMaps.forEach(n=>{n.relation.joinColumns.forEach(i=>{i.isVirtual!==!0&&i.setEntityValue(t.entity,X.isObject(n.value)?i.referencedColumn.getEntityValue(n.value):n.value)})}))}),t.generatedMap&&this.queryRunner.manager.merge(t.metadata.target,t.entity,t.generatedMap))})}groupBulkSubjects(e,t){let r={},n=[],i=e.some(a=>a.metadata.getInsertionReturningColumns().length>0),s=t==="delete"||this.queryRunner.connection.driver.isReturningSqlSupported("insert")||i===!1;return e.forEach((a,c)=>{let u=s||a.metadata.isJunction?a.metadata.name:a.metadata.name+"_"+c;r[u]?r[u].push(a):(r[u]=[a],n.push(u))}),[r,n]}};var ot=class{constructor(e){this["@instanceof"]=Symbol.for("Subject"),this.identifier=void 0,this.entityWithFulfilledIds=void 0,this.databaseEntityLoaded=!1,this.changeMaps=[],this.canBeInserted=!1,this.canBeUpdated=!1,this.mustBeRemoved=!1,this.canBeSoftRemoved=!1,this.canBeRecovered=!1,this.updatedRelationMaps=[],this.diffColumns=[],this.diffRelations=[],this.metadata=e.metadata,this.entity=e.entity,this.parentSubject=e.parentSubject,e.canBeInserted!==void 0&&(this.canBeInserted=e.canBeInserted),e.canBeUpdated!==void 0&&(this.canBeUpdated=e.canBeUpdated),e.mustBeRemoved!==void 0&&(this.mustBeRemoved=e.mustBeRemoved),e.canBeSoftRemoved!==void 0&&(this.canBeSoftRemoved=e.canBeSoftRemoved),e.canBeRecovered!==void 0&&(this.canBeRecovered=e.canBeRecovered),e.identifier!==void 0&&(this.identifier=e.identifier),e.changeMaps!==void 0&&this.changeMaps.push(...e.changeMaps),this.recompute()}get mustBeInserted(){return this.canBeInserted&&!this.databaseEntity}get mustBeUpdated(){return this.canBeUpdated&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)&&this.changeMaps.some(e=>!e.column||e.column.isUpdate)}get mustBeSoftRemoved(){return this.canBeSoftRemoved&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}get mustBeRecovered(){return this.canBeRecovered&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}createValueSetAndPopChangeMap(){let e=[],t=this.changeMaps.reduce((r,n)=>{let i=n.value;x.isSubject(i)&&(i=i.insertedValueSet?i.insertedValueSet:i.entity);let s;if(this.metadata.isJunction&&n.column)s=n.column.createValueMap(n.column.referencedColumn.getEntityValue(i));else if(n.column)s=n.column.createValueMap(i);else if(n.relation)if(X.isObject(i)&&!Buffer.isBuffer(i)){let a=n.relation.getRelationIdMap(i);if(a===void 0)return e.push(n),this.canBeUpdated=!0,r;s=n.relation.createValueMap(a),this.updatedRelationMaps.push({relation:n.relation,value:a})}else s=n.relation.createValueMap(i),this.updatedRelationMaps.push({relation:n.relation,value:i});return K.mergeDeep(r,s),r},{});return this.changeMaps=e,t}recompute(){this.entity?(this.entityWithFulfilledIds=Object.assign({},this.entity),this.parentSubject&&this.metadata.primaryColumns.forEach(e=>{if(e.relationMetadata&&e.relationMetadata.inverseEntityMetadata===this.parentSubject.metadata){let t=e.referencedColumn.getEntityValue(this.parentSubject.entity);e.setEntityValue(this.entityWithFulfilledIds,t)}}),this.identifier=this.metadata.getEntityIdMap(this.entityWithFulfilledIds)):this.databaseEntity&&(this.identifier=this.metadata.getEntityIdMap(this.databaseEntity))}};var Zo=class{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let r=[];if(e.databaseEntity){let s=t.getEntityValue(e.databaseEntity);s&&(r=s.map(a=>t.inverseEntityMetadata.getEntityIdMap(a)))}let n=t.getEntityValue(e.entity);if(n===null&&(n=[]),n===void 0)return;let i=[];n.forEach(s=>{let a=t.inverseEntityMetadata.getEntityIdMap(s),c=this.subjects.find(l=>l.entity===s);if(c&&(a=c.identifier),!a){if(!c)return;c.changeMaps.push({relation:t.inverseRelation,value:e});return}r.find(l=>K.compareIds(a,l))||(c||(c=new ot({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:a}),this.subjects.push(c)),c.changeMaps.push({relation:t.inverseRelation,value:e})),i.push(a)}),t.inverseRelation?.orphanedRowAction!=="disable"&&at.difference(r,i).forEach(s=>{let a=new ot({metadata:t.inverseEntityMetadata,parentSubject:e,identifier:s});!t.inverseRelation||t.inverseRelation.orphanedRowAction==="nullify"?(a.canBeUpdated=!0,a.changeMaps=[{relation:t.inverseRelation,value:null}]):t.inverseRelation.orphanedRowAction==="delete"?a.mustBeRemoved=!0:t.inverseRelation.orphanedRowAction==="soft-delete"&&(a.canBeSoftRemoved=!0),this.subjects.push(a)})}};var ec=class{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToOneRelations.forEach(t=>{t.isOwning||t.persistenceEnabled===!1||this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let r;e.databaseEntity&&(r=t.getEntityValue(e.databaseEntity));let n=t.getEntityValue(e.entity);if(n===void 0)return;if(n===null){if(r){let c=new ot({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:r,changeMaps:[{relation:t.inverseRelation,value:null}]});this.subjects.push(c)}return}let i=t.inverseEntityMetadata.getEntityIdMap(n),s=this.subjects.find(c=>!!c.entity&&c.entity===n);if(s&&(i=s.identifier),!i){if(!s)return;s.changeMaps.push({relation:t.inverseRelation,value:e})}r&&K.compareIds(i,r)||(s||(s=new ot({metadata:t.inverseEntityMetadata,canBeUpdated:!0,identifier:i}),this.subjects.push(s)),s.changeMaps.push({relation:t.inverseRelation,value:e}))}};var ps=class{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.entity&&e.metadata.manyToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForAllRemoval(e){e.databaseEntity&&e.metadata.manyToManyRelations.forEach(t=>{if(t.persistenceEnabled===!1)return;t.getEntityValue(e.databaseEntity).forEach(n=>{let i=new ot({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,n)});this.subjects.push(i)})})}buildForSubjectRelation(e,t){let r=[];if(e.databaseEntity){let a=t.getEntityValue(e.databaseEntity);a&&(r=a.map(c=>t.inverseEntityMetadata.getEntityIdMap(c)))}let n=t.getEntityValue(e.entity);if(n===null&&(n=[]),!Array.isArray(n))return;n.forEach(a=>{let c=t.inverseEntityMetadata.getEntityIdMap(a),u=this.subjects.find(m=>m.entity===a);if(u&&(c=u.identifier),!c&&!u||r.find(m=>K.compareIds(m,c)))return;let h=t.isOwning?e:u||a,p=t.isOwning?u||a:e,d=new ot({metadata:t.junctionEntityMetadata,parentSubject:e,canBeInserted:!0});this.subjects.push(d),t.junctionEntityMetadata.ownerColumns.forEach(m=>{d.changeMaps.push({column:m,value:h})}),t.junctionEntityMetadata.inverseColumns.forEach(m=>{d.changeMaps.push({column:m,value:p})})});let i=[];n.forEach(a=>{let c=t.inverseEntityMetadata.getEntityIdMap(a),u=this.subjects.find(l=>l.entity===a);u&&(c=u.identifier),c!=null&&i.push(c)}),r.filter(a=>!i.find(c=>K.compareIds(c,a))).forEach(a=>{let c=new ot({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,a)});this.subjects.push(c)})}buildJunctionIdentifier(e,t,r){let n=t.isOwning?e.entity:r,i=t.isOwning?r:e.entity,s={};return t.junctionEntityMetadata.ownerColumns.forEach(a=>{K.mergeDeep(s,a.createValueMap(a.referencedColumn.getEntityValue(n)))}),t.junctionEntityMetadata.inverseColumns.forEach(a=>{K.mergeDeep(s,a.createValueMap(a.referencedColumn.getEntityValue(i)))}),s}};var tc=class{constructor(e,t){this.queryRunner=e,this.subjects=t}async load(e){let t=this.groupByEntityTargets().map(async r=>{let n=[],i=[];if(r.subjects.forEach(u=>{u.databaseEntity||!u.identifier||(n.push(u.identifier),i.push(u))}),!n.length)return;let s=[];e==="save"||e==="soft-remove"||e==="recover"?r.subjects.forEach(u=>{u.metadata.relations.forEach(l=>{l.getEntityValue(u.entityWithFulfilledIds)!==void 0&&s.indexOf(l.propertyPath)===-1&&s.push(l.propertyPath)})}):s.push(...r.subjects[0].metadata.manyToManyRelations.map(u=>u.propertyPath));let a={loadEagerRelations:!1,loadRelationIds:{relations:s,disableMixedMap:!0},withDeleted:!0},c=[];this.queryRunner.connection.driver.options.type==="mongodb"?c=await this.queryRunner.manager.getRepository(r.target).findByIds(n,a):c=await this.queryRunner.manager.getRepository(r.target).createQueryBuilder().setFindOptions(a).whereInIds(n).getMany(),c.forEach(u=>{let l=i[0].metadata.getEntityIdMap(u);i.forEach(h=>{h.databaseEntity||K.compareIds(h.identifier,l)&&(h.databaseEntity=u)})});for(let u of i)u.databaseEntityLoaded=!0});await Promise.all(t)}groupByEntityTargets(){return this.subjects.reduce((e,t)=>{let r=e.find(n=>n.target===t.metadata.target);return r||(r={target:t.metadata.target,subjects:[]},e.push(r)),r.subjects.push(t),e},[])}};var rc=class{constructor(e){this.allSubjects=e}build(e,t){e.metadata.extractRelationValuesFromEntity(e.entity,e.metadata.relations).forEach(([r,n,i])=>{if(n==null||!r.isCascadeInsert&&!r.isCascadeUpdate&&!r.isCascadeSoftRemove&&!r.isCascadeRecover||!X.isObject(n))return;let s=this.findByPersistEntityLike(i.target,n);if(s){s.canBeInserted===!1&&(s.canBeInserted=r.isCascadeInsert===!0&&t==="save"),s.canBeUpdated===!1&&(s.canBeUpdated=r.isCascadeUpdate===!0&&t==="save"),s.canBeSoftRemoved===!1&&(s.canBeSoftRemoved=r.isCascadeSoftRemove===!0&&t==="soft-remove"),s.canBeRecovered===!1&&(s.canBeRecovered=r.isCascadeRecover===!0&&t==="recover");return}let a=new ot({metadata:i,parentSubject:e,entity:n,canBeInserted:r.isCascadeInsert===!0&&t==="save",canBeUpdated:r.isCascadeUpdate===!0&&t==="save",canBeSoftRemoved:r.isCascadeSoftRemove===!0&&t==="soft-remove",canBeRecovered:r.isCascadeRecover===!0&&t==="recover"});this.allSubjects.push(a),this.build(a,t)})}findByPersistEntityLike(e,t){return this.allSubjects.find(r=>r.entity?r.entity===t?!0:r.metadata.target===e&&r.metadata.compareEntities(r.entityWithFulfilledIds,t):!1)}};var Yr=class{constructor(e,t,r,n,i,s){this.connection=e,this.queryRunner=t,this.mode=r,this.target=n,this.entity=i,this.options=s}async execute(){if(!this.entity||typeof this.entity!="object")return Promise.reject(new Ja(this.mode,this.entity));await Promise.resolve();let e=this.queryRunner||this.connection.createQueryRunner(),t=e.data;this.options&&this.options.data&&(e.data=this.options.data);try{let r=Array.isArray(this.entity)?this.entity:[this.entity],n=this.options&&this.options.chunk&&this.options.chunk>0?K.chunk(r,this.options.chunk):[r],s=(await Promise.all(n.map(async c=>{let u=[];c.forEach(h=>{let p=this.target?this.target:h.constructor;if(p===Object)throw new Ha(this.mode);let d=this.connection.getMetadata(p).findInheritanceMetadata(h);u.push(new ot({metadata:d,entity:h,canBeInserted:this.mode==="save",canBeUpdated:this.mode==="save",mustBeRemoved:this.mode==="remove",canBeSoftRemoved:this.mode==="soft-remove",canBeRecovered:this.mode==="recover"}))});let l=new rc(u);return u.forEach(h=>{l.build(h,this.mode)}),await new tc(e,u).load(this.mode),this.mode==="save"||this.mode==="soft-remove"||this.mode==="recover"?(new Zo(u).build(),new ec(u).build(),new ps(u).build()):u.forEach(h=>{h.mustBeRemoved&&new ps(u).buildForAllRemoval(h)}),new Xo(e,u,this.options)}))).filter(c=>c.hasExecutableOperations);if(s.length===0)return;let a=!1;try{e.isTransactionActive||this.connection.driver.transactionSupport!=="none"&&(!this.options||this.options.transaction!==!1)&&(a=!0,await e.startTransaction());for(let c of s)await c.execute();a===!0&&await e.commitTransaction()}catch(c){if(a)try{await e.rollbackTransaction()}catch{}throw c}}finally{e.data=t,this.queryRunner||await e.release()}}};var ei=class{constructor(e,t){this["@instanceof"]=Symbol.for("EntityManager"),this.repositories=new Map,this.treeRepositories=[],this.plainObjectToEntityTransformer=new Ko,this.connection=e,t&&(this.queryRunner=t,X.assign(this.queryRunner,{manager:this}))}async transaction(e,t){let r=typeof e=="string"?e:void 0,n=typeof e=="function"?e:t;if(!n)throw new y("Transaction method requires callback in second parameter if isolation level is supplied.");if(this.queryRunner&&this.queryRunner.isReleased)throw new Qn;let i=this.queryRunner||this.connection.createQueryRunner();try{await i.startTransaction(r);let s=await n(i.manager);return await i.commitTransaction(),s}catch(s){try{await i.rollbackTransaction()}catch{}throw s}finally{this.queryRunner||await i.release()}}async query(e,t){return this.connection.query(e,t,this.queryRunner)}async sql(e,...t){let{query:r,parameters:n}=gr({driver:this.connection.driver,strings:e,expressions:t});return await this.query(r,n)}createQueryBuilder(e,t,r){return t?this.connection.createQueryBuilder(e,t,r||this.queryRunner):this.connection.createQueryBuilder(e||r||this.queryRunner)}hasId(e,t){let r=arguments.length===2?e:e.constructor,n=arguments.length===2?t:e;return this.connection.getMetadata(r).hasId(n)}getId(e,t){let r=arguments.length===2?e:e.constructor,n=arguments.length===2?t:e;return this.connection.getMetadata(r).getEntityIdMixedMap(n)}create(e,t){let r=this.connection.getMetadata(e);if(!t)return r.create(this.queryRunner);if(Array.isArray(t))return t.map(i=>this.create(e,i));let n=r.create(this.queryRunner);return this.plainObjectToEntityTransformer.transform(n,t,r,!0),n}merge(e,t,...r){let n=this.connection.getMetadata(e);return r.forEach(i=>this.plainObjectToEntityTransformer.transform(t,i,n)),t}async preload(e,t){let r=this.connection.getMetadata(e),i=await new zo(this.connection.manager).transform(t,r);if(i)return this.merge(e,i,t)}save(e,t,r){let n=arguments.length>1&&(typeof e=="function"||x.isEntitySchema(e)||typeof e=="string")?e:void 0,i=n?t:e,s=n?r:t;return x.isEntitySchema(n)&&(n=n.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new Yr(this.connection,this.queryRunner,"save",n,i,s).execute().then(()=>i)}remove(e,t,r){let n=arguments.length>1&&(typeof e=="function"||x.isEntitySchema(e)||typeof e=="string")?e:void 0,i=n?t:e,s=n?r:t;return Array.isArray(i)&&i.length===0?Promise.resolve(i):new Yr(this.connection,this.queryRunner,"remove",n,i,s).execute().then(()=>i)}softRemove(e,t,r){let n=arguments.length>1&&(typeof e=="function"||x.isEntitySchema(e)||typeof e=="string")?e:void 0,i=n?t:e,s=n?r:t;return x.isEntitySchema(n)&&(n=n.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new Yr(this.connection,this.queryRunner,"soft-remove",n,i,s).execute().then(()=>i)}recover(e,t,r){let n=arguments.length>1&&(typeof e=="function"||x.isEntitySchema(e)||typeof e=="string")?e:void 0,i=n?t:e,s=n?r:t;return x.isEntitySchema(n)&&(n=n.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new Yr(this.connection,this.queryRunner,"recover",n,i,s).execute().then(()=>i)}async insert(e,t){return this.createQueryBuilder().insert().into(e).values(t).execute()}async upsert(e,t,r){let n=this.connection.getMetadata(e),i;Array.isArray(r)?i={conflictPaths:r}:i=r;let s;Array.isArray(t)?s=t:s=[t];let a=n.mapPropertyPathsToColumns(Array.isArray(i.conflictPaths)?i.conflictPaths:Object.keys(i.conflictPaths)),c=n.columns.filter(u=>!a.includes(u)&&s.some(l=>typeof u.getEntityValue(l)<"u"));return this.createQueryBuilder().insert().into(e).values(s).orUpdate([...a,...c].map(u=>u.databaseName),a.map(u=>u.databaseName),{skipUpdateIfNoValuesChanged:i.skipUpdateIfNoValuesChanged,indexPredicate:i.indexPredicate,upsertType:i.upsertType||this.connection.driver.supportedUpsertTypes[0]}).execute()}update(e,t,r){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new y("Empty criteria(s) are not allowed for the update method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().update(e).set(r).whereInIds(t).execute():this.createQueryBuilder().update(e).set(r).where(t).execute()}updateAll(e,t){return this.createQueryBuilder().update(e).set(t).execute()}delete(e,t){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new y("Empty criteria(s) are not allowed for the delete method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().delete().from(e).whereInIds(t).execute():this.createQueryBuilder().delete().from(e).where(t).execute()}deleteAll(e){return this.createQueryBuilder().delete().from(e).execute()}softDelete(e,t){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new y("Empty criteria(s) are not allowed for the softDelete method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().softDelete().from(e).whereInIds(t).execute():this.createQueryBuilder().softDelete().from(e).where(t).execute()}restore(e,t){return K.isCriteriaNullOrEmpty(t)?Promise.reject(new y("Empty criteria(s) are not allowed for the restore method.")):K.isPrimitiveCriteria(t)?this.createQueryBuilder().restore().from(e).whereInIds(t).execute():this.createQueryBuilder().restore().from(e).where(t).execute()}exists(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ge.extractFindManyOptionsAlias(t)||r.name).setFindOptions(t||{}).getExists()}async existsBy(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).setFindOptions({where:t}).getExists()}count(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ge.extractFindManyOptionsAlias(t)||r.name).setFindOptions(t||{}).getCount()}countBy(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).setFindOptions({where:t}).getCount()}sum(e,t,r){return this.callAggregateFun(e,"SUM",t,r)}average(e,t,r){return this.callAggregateFun(e,"AVG",t,r)}minimum(e,t,r){return this.callAggregateFun(e,"MIN",t,r)}maximum(e,t,r){return this.callAggregateFun(e,"MAX",t,r)}async callAggregateFun(e,t,r,n={}){let i=this.connection.getMetadata(e),s=i.columns.find(c=>c.propertyPath===r);if(!s)throw new y(`Column "${r}" was not found in table "${i.name}"`);let a=await this.createQueryBuilder(e,i.name).setFindOptions({where:n}).select(`${t}(${this.connection.driver.escape(s.databaseName)})`,t).getRawOne();return a[t]===null?null:parseFloat(a[t])}async find(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ge.extractFindManyOptionsAlias(t)||r.name).setFindOptions(t||{}).getMany()}async findBy(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).setFindOptions({where:t}).getMany()}findAndCount(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,Ge.extractFindManyOptionsAlias(t)||r.name).setFindOptions(t||{}).getManyAndCount()}findAndCountBy(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).setFindOptions({where:t}).getManyAndCount()}async findByIds(e,t){if(!t.length)return Promise.resolve([]);let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).andWhereInIds(t).getMany()}async findOne(e,t){let n=this.connection.getMetadata(e).name;if(t&&t.join&&(n=t.join.alias),!t.where)throw new Error("You must provide selection conditions in order to find a single row.");return this.createQueryBuilder(e,n).setFindOptions({...t,take:1}).getOne()}async findOneBy(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).setFindOptions({where:t,take:1}).getOne()}async findOneById(e,t){let r=this.connection.getMetadata(e);return this.createQueryBuilder(e,r.name).setFindOptions({take:1}).whereInIds(r.ensureEntityIdMap(t)).getOne()}async findOneOrFail(e,t){return this.findOne(e,t).then(r=>r===null?Promise.reject(new Gr(e,t)):Promise.resolve(r))}async findOneByOrFail(e,t){return this.findOneBy(e,t).then(r=>r===null?Promise.reject(new Gr(e,t)):Promise.resolve(r))}async clear(e){let t=this.connection.getMetadata(e),r=this.queryRunner||this.connection.createQueryRunner();try{return await r.clearTable(t.tablePath)}finally{this.queryRunner||await r.release()}}async increment(e,t,r,n){let i=this.connection.getMetadata(e),s=i.findColumnWithPropertyPath(r);if(!s)throw new y(`Column ${r} was not found in ${i.targetName} entity.`);if(isNaN(Number(n)))throw new y(`Value "${n}" is not a number.`);let a=r.split(".").reduceRight((c,u)=>({[u]:c}),()=>this.connection.driver.escape(s.databaseName)+" + "+n);return this.createQueryBuilder(e,"entity").update(e).set(a).where(t).execute()}async decrement(e,t,r,n){let i=this.connection.getMetadata(e),s=i.findColumnWithPropertyPath(r);if(!s)throw new y(`Column ${r} was not found in ${i.targetName} entity.`);if(isNaN(Number(n)))throw new y(`Value "${n}" is not a number.`);let a=r.split(".").reduceRight((c,u)=>({[u]:c}),()=>this.connection.driver.escape(s.databaseName)+" - "+n);return this.createQueryBuilder(e,"entity").update(e).set(a).where(t).execute()}getRepository(e){let t=this.repositories.get(e);if(t)return t;if(this.connection.driver.options.type==="mongodb"){let r=new pa(e,this,this.queryRunner);return this.repositories.set(e,r),r}else{let r=new Yn(e,this,this.queryRunner);return this.repositories.set(e,r),r}}getTreeRepository(e){if(this.connection.driver.treeSupport===!1)throw new Ga(this.connection.driver);let t=this.treeRepositories.find(n=>n.target===e);if(t)return t;let r=new Go(e,this,this.queryRunner);return this.treeRepositories.push(r),r}getMongoRepository(e){return this.connection.getMongoRepository(e)}withRepository(e){let t=e.constructor,{target:r,manager:n,queryRunner:i,...s}=e;return Object.assign(new t(e.target,this),{...s})}getCustomRepository(e){let t=pe().entityRepositories.find(i=>i.target===(typeof e=="function"?e:e.constructor));if(!t)throw new Fn(e);let r=t.entity?this.connection.getMetadata(t.entity):void 0,n=new t.target(this,r);if(n instanceof Jo)n.manager||(n.manager=this);else{if(!r)throw new Ya(e);n.manager=this,n.metadata=r}return n}async release(){if(!this.queryRunner)throw new co;return this.queryRunner.release()}};var nc=class extends ei{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SqljsEntityManager"),this.driver=e.driver}async loadDatabase(e){await this.driver.load(e)}async saveDatabase(e){await this.driver.save(e)}exportDatabase(){return this.driver.export()}};var ic=class{create(e,t){return e.driver.options.type==="mongodb"?new ji(e):e.driver.options.type==="sqljs"?new nc(e,t):new ei(e,t)}};function sc(o,e,t=[".js",".cjs",".ts"]){return[]}var bx=new class{constructor(){this.instances=[]}get(o){let e=this.instances.find(t=>t.type===o);return e||(e={type:o,object:new o},this.instances.push(e)),e.object}},ig,ac;function oc(o){if(ig)try{let e=ig.get(o);if(e||!ac||!ac.fallback)return e}catch(e){if(!ac||!ac.fallbackOnErrors)throw e}return bx.get(o)}var tt=class{constructor(e){this["@instanceof"]=Symbol.for("ColumnMetadata"),this.length="",this.isPrimary=!1,this.isGenerated=!1,this.isNullable=!1,this.isSelect=!0,this.isInsert=!0,this.isUpdate=!0,this.zerofill=!1,this.unsigned=!1,this.isArray=!1,this.isVirtual=!1,this.isVirtualProperty=!1,this.isDiscriminator=!1,this.isTreeLevel=!1,this.isCreateDate=!1,this.isUpdateDate=!1,this.isDeleteDate=!1,this.isVersion=!1,this.isObjectId=!1,this.isNestedSetLeft=!1,this.isNestedSetRight=!1,this.isMaterializedPath=!1,this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.referencedColumn=e.referencedColumn,e.args.target&&(this.target=e.args.target),e.args.propertyName&&(this.propertyName=e.args.propertyName),e.args.options.name&&(this.givenDatabaseName=e.args.options.name),e.args.options.type&&(this.type=e.args.options.type),e.args.options.length&&(this.length=e.args.options.length?e.args.options.length.toString():""),e.args.options.width&&(this.width=e.args.options.width),e.args.options.charset&&(this.charset=e.args.options.charset),e.args.options.collation&&(this.collation=e.args.options.collation),e.args.options.primary&&(this.isPrimary=e.args.options.primary),e.args.options.default===null&&(this.isNullable=!0),e.args.options.nullable!==void 0&&(this.isNullable=e.args.options.nullable),e.args.options.select!==void 0&&(this.isSelect=e.args.options.select),e.args.options.insert!==void 0&&(this.isInsert=e.args.options.insert),e.args.options.update!==void 0&&(this.isUpdate=e.args.options.update),e.args.options.readonly!==void 0&&(this.isUpdate=!e.args.options.readonly),e.args.options.comment&&(this.comment=e.args.options.comment),e.args.options.default!==void 0&&(this.default=e.args.options.default),e.args.options.onUpdate&&(this.onUpdate=e.args.options.onUpdate),e.args.options.generatedIdentity&&(this.generatedIdentity=e.args.options.generatedIdentity),e.args.options.scale!==null&&e.args.options.scale!==void 0&&(this.scale=e.args.options.scale),e.args.options.zerofill&&(this.zerofill=e.args.options.zerofill,this.unsigned=!0),e.args.options.unsigned&&(this.unsigned=e.args.options.unsigned),e.args.options.precision!==null&&(this.precision=e.args.options.precision),e.args.options.enum&&(X.isObject(e.args.options.enum)&&!Array.isArray(e.args.options.enum)?this.enum=Object.keys(e.args.options.enum).filter(t=>isNaN(+t)&&typeof e.args.options.enum[t]!="function").map(t=>e.args.options.enum[t]):this.enum=e.args.options.enum),e.args.options.enumName&&(this.enumName=e.args.options.enumName),e.args.options.primaryKeyConstraintName&&(this.primaryKeyConstraintName=e.args.options.primaryKeyConstraintName),e.args.options.foreignKeyConstraintName&&(this.foreignKeyConstraintName=e.args.options.foreignKeyConstraintName),e.args.options.asExpression&&(this.asExpression=e.args.options.asExpression,this.generatedType=e.args.options.generatedType?e.args.options.generatedType:"VIRTUAL"),e.args.options.hstoreType&&(this.hstoreType=e.args.options.hstoreType),e.args.options.array&&(this.isArray=e.args.options.array),e.args.mode&&(this.isVirtualProperty=e.args.mode==="virtual-property",this.isVirtual=e.args.mode==="virtual",this.isTreeLevel=e.args.mode==="treeLevel",this.isCreateDate=e.args.mode==="createDate",this.isUpdateDate=e.args.mode==="updateDate",this.isDeleteDate=e.args.mode==="deleteDate",this.isVersion=e.args.mode==="version",this.isObjectId=e.args.mode==="objectId"),this.isVirtualProperty&&(this.isInsert=!1,this.isUpdate=!1),e.args.options.transformer&&(this.transformer=e.args.options.transformer),e.args.options.spatialFeatureType&&(this.spatialFeatureType=e.args.options.spatialFeatureType),e.args.options.srid!==void 0&&(this.srid=e.args.options.srid),e.args.options.query&&(this.query=e.args.options.query),this.isTreeLevel&&(this.type=e.connection.driver.mappedDataTypes.treeLevel),this.isCreateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.createDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.createDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.createDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.createDatePrecision)),this.isUpdateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.updateDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.updateDateDefault),this.onUpdate||(this.onUpdate=e.connection.driver.mappedDataTypes.updateDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.updateDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.updateDatePrecision)),this.isDeleteDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.deleteDate),this.isNullable||(this.isNullable=e.connection.driver.mappedDataTypes.deleteDateNullable),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.deleteDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.deleteDatePrecision)),this.isVersion&&(this.type=e.connection.driver.mappedDataTypes.version),e.closureType&&(this.closureType=e.closureType),e.nestedSetLeft&&(this.isNestedSetLeft=e.nestedSetLeft),e.nestedSetRight&&(this.isNestedSetRight=e.nestedSetRight),e.materializedPath&&(this.isMaterializedPath=e.materializedPath)}createValueMap(e,t=!1){if(this.embeddedMetadata){let r=[...this.embeddedMetadata.parentPropertyNames],n=(i,s)=>{let a=i.shift();return a?(s[a]={},n(i,s[a]),s):((this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),s[t?this.databaseName:this.propertyName]=e,s)};return n(r,{})}else return(this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),{[t?this.databaseName:this.propertyName]:e}}getEntityValueMap(e,t){if(this.embeddedMetadata){let n=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,s=(c,u)=>{if(u===void 0)return{};let l=c.shift();if(l){let h=s(c,u[l]);return Object.keys(h).length>0?{[l]:h}:{}}return i&&Array.isArray(u)?u.map(h=>({[this.propertyName]:h[this.propertyName]})):u[this.propertyName]!==void 0?{[this.propertyName]:u[this.propertyName]}:{}},a=s(n,e);return Object.keys(a).length>0?a:void 0}else if(this.relationMetadata&&!Object.getOwnPropertyDescriptor(e,this.relationMetadata.propertyName)?.get&&e[this.relationMetadata.propertyName]&&X.isObject(e[this.relationMetadata.propertyName])){if(this.relationMetadata.joinColumns.length>1){let n=this.relationMetadata.joinColumns.reduce((i,s)=>{let a=s.referencedColumn.getEntityValueMap(e[this.relationMetadata.propertyName]);return a===void 0?i:K.mergeDeep(i,a)},{});if(Object.keys(n).length>0)return{[this.propertyName]:n}}else{let n=this.relationMetadata.joinColumns[0].referencedColumn.getEntityValue(e[this.relationMetadata.propertyName]);if(n)return{[this.propertyName]:n}}return}else return e[this.propertyName]!==void 0?{[this.propertyName]:e[this.propertyName]}:void 0}getEntityValue(e,t=!1){if(e==null)return;let r;if(this.embeddedMetadata){let n=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,s=(c,u)=>{let l=c.shift();return l&&u?s(c,u[l]):u},a=s(n,e);if(a)if(this.relationMetadata&&this.referencedColumn){let c=this.relationMetadata.getEntityValue(a);c&&X.isObject(c)&&!x.isFindOperator(c)&&!Buffer.isBuffer(c)?r=this.referencedColumn.getEntityValue(c):a[this.propertyName]&&X.isObject(a[this.propertyName])&&!x.isFindOperator(a[this.propertyName])&&!Buffer.isBuffer(a[this.propertyName])&&!(a[this.propertyName]instanceof Date)?r=this.referencedColumn.getEntityValue(a[this.propertyName]):r=a[this.propertyName]}else this.referencedColumn?r=this.referencedColumn.getEntityValue(a[this.propertyName]):i&&Array.isArray(a)?r=a.map(c=>c[this.propertyName]):r=a[this.propertyName]}else if(this.relationMetadata&&this.referencedColumn){let n=this.relationMetadata.getEntityValue(e);n&&X.isObject(n)&&!x.isFindOperator(n)&&typeof n!="function"&&!Buffer.isBuffer(n)?r=this.referencedColumn.getEntityValue(n):e[this.propertyName]&&X.isObject(e[this.propertyName])&&!x.isFindOperator(e[this.propertyName])&&typeof e[this.propertyName]!="function"&&!Buffer.isBuffer(e[this.propertyName])&&!(e[this.propertyName]instanceof Date)?r=this.referencedColumn.getEntityValue(e[this.propertyName]):r=e[this.propertyName]}else this.referencedColumn?r=this.referencedColumn.getEntityValue(e[this.propertyName]):r=e[this.propertyName];return t&&this.transformer&&(r=ve.transformTo(this.transformer,r)),r}setEntityValue(e,t){if(this.embeddedMetadata){let r=(n,i)=>{let s=n.shift();return s?(i[s.propertyName]||(i[s.propertyName]=s.create()),r(n,i[s.propertyName]),i):(i[this.propertyName]=t,i)};return r([...this.embeddedMetadata.embeddedMetadataTree],e)}else!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName?(this.propertyName in e||(e[this.propertyName]={}),e[this.propertyName][this.referencedColumn.propertyName]=t):e[this.propertyName]=t}compareEntityValue(e,t){let r=this.getEntityValue(e);return typeof r?.equals=="function"?r.equals(t):r===t}build(e){return this.propertyPath=this.buildPropertyPath(),this.propertyAliasName=this.propertyPath.replace(".","_"),this.databaseName=this.buildDatabaseName(e),this.databasePath=this.buildDatabasePath(),this.databaseNameWithoutPrefixes=e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,[]),this}buildPropertyPath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.propertyName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName&&(e+="."+this.referencedColumn.propertyName),e}buildDatabasePath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.databaseName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.databaseName!==this.databaseName&&(e+="."+this.referencedColumn.databaseName),e}buildDatabaseName(e){let t=this.embeddedMetadata?this.embeddedMetadata.parentPrefixes:[];return e.driver.options.type==="mongodb"&&(t=[]),e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,t)}};var ct=class{constructor(e){this.isUnique=!1,this.isSpatial=!1,this.isFulltext=!1,this.isNullFiltered=!1,this.synchronize=!0,this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,e.args.synchronize!==null&&e.args.synchronize!==void 0&&(this.synchronize=e.args.synchronize),this.isUnique=!!e.args.unique,this.isSpatial=!!e.args.spatial,this.isFulltext=!!e.args.fulltext,this.isNullFiltered=!!e.args.nullFiltered,this.parser=e.args.parser,this.where=e.args.where,this.isSparse=e.args.sparse,this.isBackground=e.args.background,this.isConcurrent=e.args.concurrent,this.expireAfterSeconds=e.args.expireAfterSeconds,this.givenName=e.args.name,this.givenColumnNames=e.args.columns)}build(e){if(this.synchronize===!1)return this.name=this.givenName,this;let t={};if(this.givenColumnNames){let r=[];if(Array.isArray(this.givenColumnNames))r=this.givenColumnNames.map(n=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+n:n.trim()),r.forEach(n=>t[n]=1);else{let n=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(n)?(r=n.map(i=>String(i)),r.forEach(i=>t[i]=1)):(r=Object.keys(n).map(i=>String(i)),Object.keys(n).forEach(i=>t[i]=n[i]))}this.columns=r.map(n=>{let i=this.entityMetadata.columns.find(u=>u.propertyPath===n);if(i)return[i];let s=this.entityMetadata.relations.find(u=>u.isWithJoinColumn&&u.propertyName===n);if(s)return s.joinColumns;let a=this.givenName?'"'+this.givenName+'" ':"",c=this.entityMetadata.targetName;throw new y(`Index ${a}contains column that is missing in the entity (${c}): `+n)}).reduce((n,i)=>n.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((r,n)=>{let i=this.entityMetadata.columns.find(s=>s.propertyPath===n);return i&&(r[i.databasePath]=t[n]),r},{}),this.name=this.givenName?this.givenName:e.indexName(this.entityMetadata.tableName,this.columns.map(r=>r.databaseName),this.where),this}};var ds=class{constructor(e){this.isTreeParent=!1,this.isTreeChildren=!1,this.isPrimary=!1,this.isLazy=!1,this.isEager=!1,this.persistenceEnabled=!0,this.isCascadeInsert=!1,this.isCascadeUpdate=!1,this.isCascadeRemove=!1,this.isCascadeSoftRemove=!1,this.isCascadeRecover=!1,this.isNullable=!0,this.createForeignKeyConstraints=!0,this.isOwning=!1,this.isOneToOne=!1,this.isOneToOneOwner=!1,this.isWithJoinColumn=!1,this.isOneToOneNotOwner=!1,this.isOneToMany=!1,this.isManyToOne=!1,this.isManyToMany=!1,this.isManyToManyOwner=!1,this.isManyToManyNotOwner=!1,this.foreignKeys=[],this.joinColumns=[],this.inverseJoinColumns=[],this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata;let t=e.args;this.target=t.target,this.propertyName=t.propertyName,this.relationType=t.relationType,t.inverseSideProperty&&(this.givenInverseSidePropertyFactory=t.inverseSideProperty),this.isLazy=t.isLazy||!1,this.isCascadeInsert=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("insert")!==-1,this.isCascadeUpdate=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("update")!==-1,this.isCascadeRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("remove")!==-1,this.isCascadeSoftRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("soft-remove")!==-1,this.isCascadeRecover=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("recover")!==-1,this.isNullable=!(t.options.nullable===!1||this.isPrimary),this.onDelete=t.options.onDelete,this.onUpdate=t.options.onUpdate,this.deferrable=t.options.deferrable,this.createForeignKeyConstraints=t.options.createForeignKeyConstraints!==!1,this.isEager=t.options.eager||!1,this.persistenceEnabled=t.options.persistence!==!1,this.orphanedRowAction=t.options.orphanedRowAction||"nullify",this.isTreeParent=t.isTreeParent||!1,this.isTreeChildren=t.isTreeChildren||!1,typeof t.type=="function"?this.type=typeof t.type=="function"?t.type():t.type:x.isEntitySchema(t.type)?this.type=t.type.options.name:X.isObject(t.type)&&typeof t.type.name=="string"?this.type=t.type.name:this.type=t.type,this.isOneToOne=this.relationType==="one-to-one",this.isOneToMany=this.relationType==="one-to-many",this.isManyToOne=this.relationType==="many-to-one",this.isManyToMany=this.relationType==="many-to-many",this.isOneToOneNotOwner=!!this.isOneToOne,this.isManyToManyNotOwner=!!this.isManyToMany}getRelationIdMap(e){let r=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(n=>n.referencedColumn);return at.getValueMap(e,r)}ensureRelationIdMap(e){if(X.isObject(e))return e;let r=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(n=>n.referencedColumn);if(r.length>1)throw new y("Cannot create relation id map for a single value because relation contains multiple referenced columns.");return r[0].createValueMap(e)}getEntityValue(e,t=!1){if(e!=null)if(this.embeddedMetadata){let r=[...this.embeddedMetadata.parentPropertyNames],n=(s,a)=>{let c=s.shift();return c?a[c]?n(s,a[c]):void 0:a},i=n(r,e);return this.isLazy?i["__"+this.propertyName+"__"]!==void 0?i["__"+this.propertyName+"__"]:t===!0?i[this.propertyName]:void 0:i?i[this.isLazy?"__"+this.propertyName+"__":this.propertyName]:void 0}else return this.isLazy?e["__"+this.propertyName+"__"]!==void 0?e["__"+this.propertyName+"__"]:t===!0?e[this.propertyName]:void 0:e[this.propertyName]}setEntityValue(e,t){let r=this.isLazy?"__"+this.propertyName+"__":this.propertyName;if(this.embeddedMetadata){let n=(i,s)=>{let a=i.shift();return a?(s[a.propertyName]||(s[a.propertyName]=a.create()),n(i,s[a.propertyName]),s):(s[r]=t,s)};return n([...this.embeddedMetadata.embeddedMetadataTree],e)}else e[r]=t}createValueMap(e){if(this.embeddedMetadata){let t=[...this.embeddedMetadata.parentPropertyNames],r=(n,i)=>{let s=n.shift();return s?(i[s]={},r(n,i[s]),i):(i[this.propertyName]=e,i)};return r(t,{})}else return{[this.propertyName]:e}}build(){this.propertyPath=this.buildPropertyPath()}registerForeignKeys(...e){this.foreignKeys.push(...e)}registerJoinColumns(e=[],t=[]){this.joinColumns=e,this.inverseJoinColumns=t,this.isOwning=this.isManyToOne||(this.isManyToMany||this.isOneToOne)&&this.joinColumns.length>0,this.isOneToOneOwner=this.isOneToOne&&this.isOwning,this.isOneToOneNotOwner=this.isOneToOne&&!this.isOwning,this.isManyToManyOwner=this.isManyToMany&&this.isOwning,this.isManyToManyNotOwner=this.isManyToMany&&!this.isOwning,this.isWithJoinColumn=this.isManyToOne||this.isOneToOneOwner}registerJunctionEntityMetadata(e){this.junctionEntityMetadata=e,this.joinTableName=e.tableName,this.inverseRelation&&(this.inverseRelation.junctionEntityMetadata=e,this.joinTableName=e.tableName)}buildInverseSidePropertyPath(){if(this.givenInverseSidePropertyFactory){let e=this.inverseEntityMetadata.propertiesMap;if(typeof this.givenInverseSidePropertyFactory=="function")return this.givenInverseSidePropertyFactory(e);if(typeof this.givenInverseSidePropertyFactory=="string")return this.givenInverseSidePropertyFactory}else{if(this.isTreeParent&&this.entityMetadata.treeChildrenRelation)return this.entityMetadata.treeChildrenRelation.propertyName;if(this.isTreeChildren&&this.entityMetadata.treeParentRelation)return this.entityMetadata.treeParentRelation.propertyName}return""}buildPropertyPath(){return!this.embeddedMetadata||!this.embeddedMetadata.parentPropertyNames.length?this.propertyName:this.embeddedMetadata.parentPropertyNames.join(".")+"."+this.propertyName}};var cc=class{constructor(e){this.columns=[],this.relations=[],this.listeners=[],this.indices=[],this.uniques=[],this.relationIds=[],this.relationCounts=[],this.embeddeds=[],this.isAlwaysUsingConstructor=!0,this.isArray=!1,this.parentPropertyNames=[],this.parentPrefixes=[],this.embeddedMetadataTree=[],this.columnsFromTree=[],this.relationsFromTree=[],this.listenersFromTree=[],this.indicesFromTree=[],this.uniquesFromTree=[],this.relationIdsFromTree=[],this.relationCountsFromTree=[],this.entityMetadata=e.entityMetadata,this.type=e.args.type(),this.propertyName=e.args.propertyName,this.customPrefix=e.args.prefix,this.isArray=e.args.isArray}create(e){return typeof this.type!="function"?{}:e?.fromDeserializer||!this.isAlwaysUsingConstructor?Object.create(this.type.prototype):new this.type}build(e){return this.embeddeds.forEach(t=>t.build(e)),this.prefix=this.buildPrefix(e),this.parentPropertyNames=this.buildParentPropertyNames(),this.parentPrefixes=this.buildParentPrefixes(),this.propertyPath=this.parentPropertyNames.join("."),this.embeddedMetadataTree=this.buildEmbeddedMetadataTree(),this.columnsFromTree=this.buildColumnsFromTree(),this.relationsFromTree=this.buildRelationsFromTree(),this.listenersFromTree=this.buildListenersFromTree(),this.indicesFromTree=this.buildIndicesFromTree(),this.uniquesFromTree=this.buildUniquesFromTree(),this.relationIdsFromTree=this.buildRelationIdsFromTree(),this.relationCountsFromTree=this.buildRelationCountsFromTree(),e.options.entitySkipConstructor&&(this.isAlwaysUsingConstructor=!e.options.entitySkipConstructor),this}buildPartialPrefix(){if(this.customPrefix===void 0||this.customPrefix===!0)return[this.propertyName];if(this.customPrefix===""||this.customPrefix===!1)return[];if(typeof this.customPrefix=="string")return[this.customPrefix];throw new y(`Invalid prefix option given for ${this.entityMetadata.targetName}#${this.propertyName}`)}buildPrefix(e){if(e.driver.options.type==="mongodb")return this.propertyName;let t=[];return this.parentEmbeddedMetadata&&t.push(this.parentEmbeddedMetadata.buildPrefix(e)),t.push(...this.buildPartialPrefix()),t.join("_")}buildParentPropertyNames(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPropertyNames().concat(this.propertyName):[this.propertyName]}buildParentPrefixes(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPrefixes().concat(this.buildPartialPrefix()):this.buildPartialPrefix()}buildEmbeddedMetadataTree(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildEmbeddedMetadataTree().concat(this):[this]}buildColumnsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildColumnsFromTree()),this.columns)}buildRelationsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationsFromTree()),this.relations)}buildListenersFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildListenersFromTree()),this.listeners)}buildIndicesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildIndicesFromTree()),this.indices)}buildUniquesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildUniquesFromTree()),this.uniques)}buildRelationIdsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationIdsFromTree()),this.relationIds)}buildRelationCountsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationCountsFromTree()),this.relationCounts)}};var ms=class{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}setValue(e){let t=this.relation.getEntityValue(e);if(Array.isArray(t))e[this.propertyName]=t.map(r=>this.relation.inverseEntityMetadata.getEntityIdMixedMap(r)).filter(r=>r!=null);else{let r=this.relation.inverseEntityMetadata.getEntityIdMixedMap(t);r!==void 0&&(e[this.propertyName]=r)}}build(){let e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new y(`Cannot find relation ${e}. Wrong relation specified for @RelationId decorator.`);this.relation=t}};var fs=class{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}build(){let e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new y(`Cannot find relation ${e}. Wrong relation specified for @RelationCount decorator.`);this.relation=t}};var Re=class{};Re.AFTER_LOAD="after-load";Re.BEFORE_INSERT="before-insert";Re.AFTER_INSERT="after-insert";Re.BEFORE_UPDATE="before-update";Re.AFTER_UPDATE="after-update";Re.BEFORE_REMOVE="before-remove";Re.AFTER_REMOVE="after-remove";Re.BEFORE_SOFT_REMOVE="before-soft-remove";Re.AFTER_SOFT_REMOVE="after-soft-remove";Re.BEFORE_RECOVER="before-recover";Re.AFTER_RECOVER="after-recover";var Pt=class{constructor(e){this.columns=[],this.referencedColumns=[],this.columnNames=[],this.referencedColumnNames=[],this.entityMetadata=e.entityMetadata,this.referencedEntityMetadata=e.referencedEntityMetadata,this.columns=e.columns,this.referencedColumns=e.referencedColumns,this.onDelete=e.onDelete||"NO ACTION",this.onUpdate=e.onUpdate||"NO ACTION",this.deferrable=e.deferrable,this.givenName=e.name,e.namingStrategy&&this.build(e.namingStrategy)}build(e){this.columnNames=this.columns.map(t=>t.databaseName),this.referencedColumnNames=this.referencedColumns.map(t=>t.databaseName),this.referencedTablePath=this.referencedEntityMetadata.tablePath,this.name=this.givenName?this.givenName:e.foreignKeyName(this.entityMetadata.tableName,this.columnNames,this.referencedEntityMetadata.tableName,this.referencedColumnNames)}};var uc=class{constructor(e){this.connection=e}build(e,t){let r=this.collectReferencedColumns(e,t),n=this.collectInverseReferencedColumns(e,t),i=t.name||this.connection.namingStrategy.joinTableName(e.entityMetadata.tableNameWithoutPrefix,e.inverseEntityMetadata.tableNameWithoutPrefix,e.propertyPath,e.inverseRelation?e.inverseRelation.propertyName:""),s=new at({connection:this.connection,args:{target:"",name:i,type:"junction",database:t.database||e.entityMetadata.database,schema:t.schema||e.entityMetadata.schema,synchronize:t.synchronize}});s.build();let a=r.map(u=>{let l=t.joinColumns?t.joinColumns.find(p=>(!p.referencedColumnName||p.referencedColumnName===u.propertyName)&&!!p.name):void 0,h=l&&l.name?l.name:this.connection.namingStrategy.joinTableColumnName(e.entityMetadata.tableNameWithoutPrefix,u.propertyName,u.databaseName);return new tt({connection:this.connection,entityMetadata:s,referencedColumn:u,args:{target:"",mode:"virtual",propertyName:h,options:{name:h,length:!u.length&&(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(u)!=="uuid"&&(u.generationStrategy==="uuid"||u.type==="uuid")?"36":u.length,width:u.width,type:u.type,precision:u.precision,scale:u.scale,charset:u.charset,collation:u.collation,zerofill:u.zerofill,unsigned:u.zerofill?!0:u.unsigned,enum:u.enum,enumName:u.enumName,foreignKeyConstraintName:l?.foreignKeyConstraintName,nullable:!1,primary:!0}}})}),c=n.map(u=>{let l=t.inverseJoinColumns?t.inverseJoinColumns.find(p=>(!p.referencedColumnName||p.referencedColumnName===u.propertyName)&&!!p.name):void 0,h=l&&l.name?l.name:this.connection.namingStrategy.joinTableInverseColumnName(e.inverseEntityMetadata.tableNameWithoutPrefix,u.propertyName,u.databaseName);return new tt({connection:this.connection,entityMetadata:s,referencedColumn:u,args:{target:"",mode:"virtual",propertyName:h,options:{length:!u.length&&(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(u)!=="uuid"&&(u.generationStrategy==="uuid"||u.type==="uuid")?"36":u.length,width:u.width,type:u.type,precision:u.precision,scale:u.scale,charset:u.charset,collation:u.collation,zerofill:u.zerofill,unsigned:u.zerofill?!0:u.unsigned,enum:u.enum,enumName:u.enumName,foreignKeyConstraintName:l?.foreignKeyConstraintName,name:h,nullable:!1,primary:!0}}})});return this.changeDuplicatedColumnNames(a,c),s.ownerColumns=a,s.inverseColumns=c,s.ownColumns=[...a,...c],s.ownColumns.forEach(u=>u.relationMetadata=e),s.foreignKeys=e.createForeignKeyConstraints?[new Pt({entityMetadata:s,referencedEntityMetadata:e.entityMetadata,columns:a,referencedColumns:r,name:a[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.onDelete||"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.onUpdate||"CASCADE"}),new Pt({entityMetadata:s,referencedEntityMetadata:e.inverseEntityMetadata,columns:c,referencedColumns:n,name:c[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onDelete:"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onUpdate:"CASCADE"})]:[],s.ownIndices=[new ct({entityMetadata:s,columns:a,args:{target:s.target,synchronize:!0}}),new ct({entityMetadata:s,columns:c,args:{target:s.target,synchronize:!0}})],s}collectReferencedColumns(e,t){let r=t.joinColumns?t.joinColumns.find(n=>!!n.referencedColumnName):!1;return!t.joinColumns||t.joinColumns&&!r?e.entityMetadata.columns.filter(n=>n.isPrimary):t.joinColumns.map(n=>{let i=e.entityMetadata.columns.find(s=>s.propertyName===n.referencedColumnName);if(!i)throw new y(`Referenced column ${n.referencedColumnName} was not found in entity ${e.entityMetadata.name}`);return i})}collectInverseReferencedColumns(e,t){let r=!!t.inverseJoinColumns,n=r?t.inverseJoinColumns.find(i=>!!i.referencedColumnName):!1;return!r||r&&!n?e.inverseEntityMetadata.primaryColumns:t.inverseJoinColumns.map(i=>{let s=e.inverseEntityMetadata.ownColumns.find(a=>a.propertyName===i.referencedColumnName);if(!s)throw new y(`Referenced column ${i.referencedColumnName} was not found in entity ${e.inverseEntityMetadata.name}`);return s})}changeDuplicatedColumnNames(e,t){e.forEach(r=>{t.forEach(n=>{if(r.givenDatabaseName===n.givenDatabaseName){let i=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(r.propertyName,1);r.propertyName=i,r.givenDatabaseName=i;let s=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(n.propertyName,2);n.propertyName=s,n.givenDatabaseName=s}})})}};var lc=class{constructor(e){this.connection=e}build(e){let t=new at({parentClosureEntityMetadata:e,connection:this.connection,args:{target:"",name:e.treeOptions&&e.treeOptions.closureTableName?e.treeOptions.closureTableName:e.tableNameWithoutPrefix,type:"closure-junction"}});return t.build(),e.primaryColumns.forEach(r=>{t.ownColumns.push(new tt({connection:this.connection,entityMetadata:t,closureType:"ancestor",referencedColumn:r,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.ancestorColumnName?e.treeOptions.ancestorColumnName(r):r.propertyName+"_ancestor",options:{primary:!0,length:r.length,type:r.type,unsigned:r.unsigned,width:r.width,precision:r.precision,scale:r.scale,zerofill:r.zerofill,charset:r.charset,collation:r.collation}}})),t.ownColumns.push(new tt({connection:this.connection,entityMetadata:t,closureType:"descendant",referencedColumn:r,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.descendantColumnName?e.treeOptions.descendantColumnName(r):r.propertyName+"_descendant",options:{primary:!0,length:r.length,type:r.type,unsigned:r.unsigned,width:r.width,precision:r.precision,scale:r.scale,zerofill:r.zerofill,charset:r.charset,collation:r.collation}}}))}),t.ownIndices=[new ct({entityMetadata:t,columns:[t.ownColumns[0]],args:{target:t.target,synchronize:!0}}),new ct({entityMetadata:t,columns:[t.ownColumns[1]],args:{target:t.target,synchronize:!0}})],e.treeLevelColumn&&t.ownColumns.push(new tt({connection:this.connection,entityMetadata:t,args:{target:"",mode:"virtual",propertyName:"level",options:{type:this.connection.driver.mappedDataTypes.treeLevel}}})),t.foreignKeys=[new Pt({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[0]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"}),new Pt({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[1]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"})],t}};var xr=class{constructor(e){this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,this.givenName=e.args.name,this.givenColumnNames=e.args.columns,this.deferrable=e.args.deferrable)}build(e){let t={};if(this.givenColumnNames){let r=[];if(Array.isArray(this.givenColumnNames))r=this.givenColumnNames.map(n=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+n:n.trim()),r.forEach(n=>t[n]=1);else{let n=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(n)?(r=n.map(i=>String(i)),r.forEach(i=>t[i]=1)):(r=Object.keys(n).map(i=>String(i)),Object.keys(n).forEach(i=>t[i]=n[i]))}this.columns=r.map(n=>{let i=this.entityMetadata.columns.find(u=>u.propertyPath===n);if(i)return[i];let s=this.entityMetadata.relations.find(u=>u.isWithJoinColumn&&u.propertyName===n);if(s)return s.joinColumns;let a=this.givenName?'"'+this.givenName+'" ':"",c=this.entityMetadata.targetName;throw new y(`Unique constraint ${a}contains column that is missing in the entity (${c}): `+n)}).reduce((n,i)=>n.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((r,n)=>{let i=this.entityMetadata.columns.find(s=>s.propertyPath===n);return i&&(r[i.databasePath]=t[n]),r},{}),this.name=this.givenName?this.givenName:e.uniqueConstraintName(this.entityMetadata.tableName,this.columns.map(r=>r.databaseName)),this}};var hc=class{constructor(e){this.connection=e}build(e,t){let r=this.collectReferencedColumns(e,t),n=this.collectColumns(e,t,r);if(!r.length||!t.createForeignKeyConstraints)return{foreignKey:void 0,columns:n,uniqueConstraint:void 0};let i=new Pt({name:e[0]?.foreignKeyConstraintName,entityMetadata:t.entityMetadata,referencedEntityMetadata:t.inverseEntityMetadata,namingStrategy:this.connection.namingStrategy,columns:n,referencedColumns:r,onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable});if(n.every(a=>a.isPrimary)||!t.isOneToOne)return{foreignKey:i,columns:n,uniqueConstraint:void 0};let s=new xr({entityMetadata:t.entityMetadata,columns:i.columns,args:{name:this.connection.namingStrategy.relationConstraintName(t.entityMetadata.tableName,i.columns.map(a=>a.databaseName)),target:t.entityMetadata.target}});return s.build(this.connection.namingStrategy),{foreignKey:i,columns:n,uniqueConstraint:s}}collectReferencedColumns(e,t){let r=e.find(s=>!!s.referencedColumnName),n=e.length===0&&t.isManyToOne,i=e.length>0&&!r;return n||i?t.inverseEntityMetadata.primaryColumns:e.map(s=>{let a=t.inverseEntityMetadata.ownColumns.find(c=>c.propertyName===s.referencedColumnName);if(!a)throw new y(`Referenced column ${s.referencedColumnName} was not found in entity ${t.inverseEntityMetadata.name}`);return a})}collectColumns(e,t,r){return r.map(n=>{let i=e.find(u=>(!u.referencedColumnName||u.referencedColumnName===n.propertyName)&&!!u.name),s=i?i.name:this.connection.namingStrategy.joinColumnName(t.propertyName,n.propertyName),c=(t.embeddedMetadata?t.embeddedMetadata.columns:t.entityMetadata.ownColumns).find(u=>u.databaseNameWithoutPrefixes===s);return c?c.referencedColumn&&(c=K.cloneObject(c)):(c=new tt({connection:this.connection,entityMetadata:t.entityMetadata,embeddedMetadata:t.embeddedMetadata,args:{target:"",mode:"virtual",propertyName:t.propertyName,options:{name:s,type:n.type,length:!n.length&&(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&this.connection.driver.normalizeType(n)!=="uuid"&&(n.generationStrategy==="uuid"||n.type==="uuid")?"36":n.length,width:n.width,charset:n.charset,collation:n.collation,precision:n.precision,scale:n.scale,zerofill:n.zerofill,unsigned:n.unsigned,comment:n.comment,enum:n.enum,enumName:n.enumName,primary:t.isPrimary,nullable:t.isNullable}}}),t.entityMetadata.registerColumn(c)),c.referencedColumn=n,c.type=n.type,c.relationMetadata=t,c.build(this.connection),c})}};var ys=class{constructor(e){this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.type=e.args.type}isAllowed(e){return this.entityMetadata.target===e.constructor||typeof this.entityMetadata.target=="function"&&e.constructor.prototype instanceof this.entityMetadata.target}execute(e){if(!this.embeddedMetadata){let t=e[this.propertyName];if(!t)throw new Error(`Entity listener method "${this.propertyName}" does not exist in entity "${e.constructor.name}".`);if(typeof t!="function")throw new Error(`Entity listener method "${this.propertyName}" in entity "${e.constructor.name}" must be a function but got "${typeof t}".`);return t.call(e)}this.callEntityEmbeddedMethod(e,this.embeddedMetadata.propertyPath.split("."))}callEntityEmbeddedMethod(e,t){let r=t.shift();!r||!e[r]||(t.length===0?Array.isArray(e[r])?e[r].map(n=>n[this.propertyName]()):e[r][this.propertyName]():e[r]&&this.callEntityEmbeddedMethod(e[r],t))}};var pc=class{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.checkConstraintName(this.entityMetadata.tableName,this.expression),this}};var dc=class{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.exclusionConstraintName(this.entityMetadata.tableName,this.expression),this}};var gs=class{constructor(e,t){this.connection=e,this.metadataArgsStorage=t,this.junctionEntityMetadataBuilder=new uc(e),this.closureJunctionEntityMetadataBuilder=new lc(e),this.relationJoinColumnBuilder=new hc(e)}build(e){let n=(e?this.metadataArgsStorage.filterTables(e):this.metadataArgsStorage.tables).filter(i=>i.type==="regular"||i.type==="closure"||i.type==="entity-child"||i.type==="view").map(i=>this.createEntityMetadata(i));return n.forEach(i=>this.computeParentEntityMetadata(n,i)),n.forEach(i=>{i.childEntityMetadatas=n.filter(s=>typeof i.target=="function"&&typeof s.target=="function"&&Er.isInherited(s.target,i.target))}),n.filter(i=>i.tableType!=="entity-child").forEach(i=>i.build()),n.filter(i=>i.tableType==="entity-child").forEach(i=>i.build()),n.filter(i=>i.tableType!=="entity-child").forEach(i=>this.computeEntityMetadataStep1(n,i)),n.filter(i=>i.tableType==="entity-child").forEach(i=>this.computeEntityMetadataStep1(n,i)),n.forEach(i=>this.computeEntityMetadataStep2(i)),n.forEach(i=>this.computeInverseProperties(i,n)),n.filter(i=>i.tableType!=="entity-child").forEach(i=>{i.relations.filter(s=>s.isOneToOne||s.isManyToOne).forEach(s=>{let a=this.metadataArgsStorage.filterJoinColumns(s.target,s.propertyName),{foreignKey:c,columns:u,uniqueConstraint:l}=this.relationJoinColumnBuilder.build(a,s);if(c&&(s.registerForeignKeys(c),i.foreignKeys.push(c)),u&&s.registerJoinColumns(u),l)if(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){let h=new ct({entityMetadata:l.entityMetadata,columns:l.columns,args:{target:l.target,name:l.name,unique:!0,synchronize:!0}});this.connection.driver.options.type==="mssql"&&(h.where=h.columns.map(p=>`${this.connection.driver.escape(p.databaseName)} IS NOT NULL`).join(" AND ")),this.connection.driver.options.type==="spanner"&&(h.isNullFiltered=!0),s.embeddedMetadata?s.embeddedMetadata.indices.push(h):s.entityMetadata.ownIndices.push(h),this.computeEntityMetadataStep2(i)}else s.embeddedMetadata?s.embeddedMetadata.uniques.push(l):s.entityMetadata.ownUniques.push(l),this.computeEntityMetadataStep2(i);if(c&&this.connection.driver.options.type==="cockroachdb"){let h=new ct({entityMetadata:s.entityMetadata,columns:c.columns,args:{target:s.entityMetadata.target,synchronize:!0}});s.embeddedMetadata?s.embeddedMetadata.indices.push(h):s.entityMetadata.ownIndices.push(h),this.computeEntityMetadataStep2(i)}}),i.relations.filter(s=>s.isManyToMany).forEach(s=>{let a=this.metadataArgsStorage.findJoinTable(s.target,s.propertyName);if(!a)return;let c=this.junctionEntityMetadataBuilder.build(s,a);s.registerForeignKeys(...c.foreignKeys),s.registerJoinColumns(c.ownIndices[0].columns,c.ownIndices[1].columns),s.registerJunctionEntityMetadata(c),this.computeEntityMetadataStep2(c),this.computeInverseProperties(c,n),n.push(c)})}),n.forEach(i=>{i.relationsWithJoinColumns=i.relations.filter(s=>s.isWithJoinColumn),i.hasNonNullableRelations=i.relationsWithJoinColumns.some(s=>!s.isNullable||s.isPrimary)}),n.filter(i=>i.treeType==="closure-table").forEach(i=>{let s=this.closureJunctionEntityMetadataBuilder.build(i);i.closureJunctionTable=s,this.computeEntityMetadataStep2(s),this.computeInverseProperties(s,n),n.push(s)}),n.filter(i=>i.inheritancePattern==="STI"&&i.discriminatorColumn).forEach(i=>this.createKeysForTableInheritance(i)),n.forEach(i=>{i.indices.forEach(s=>s.build(this.connection.namingStrategy))}),n.forEach(i=>{i.uniques.forEach(s=>s.build(this.connection.namingStrategy))}),n.forEach(i=>{i.checks.forEach(s=>s.build(this.connection.namingStrategy))}),n.forEach(i=>{i.exclusions.forEach(s=>s.build(this.connection.namingStrategy))}),n.forEach(i=>this.createForeignKeys(i,n)),n.filter(i=>typeof i.target=="function").forEach(i=>{i.relations.filter(s=>s.isLazy).forEach(s=>{this.connection.relationLoader.enableLazyLoad(s,i.target.prototype)})}),n.forEach(i=>{i.columns.forEach(s=>{let a=this.metadataArgsStorage.findGenerated(s.target,s.propertyName);a&&(s.isGenerated=!0,s.generationStrategy=a.strategy,a.strategy==="uuid"?s.type="uuid":a.strategy==="rowid"?s.type="int":s.type=s.type||Number,s.build(this.connection),this.computeEntityMetadataStep2(i))})}),n}createEntityMetadata(e){let t=typeof e.target=="function"?Er.getInheritanceTree(e.target):[e.target],r=this.metadataArgsStorage.findInheritanceType(e.target),n=this.metadataArgsStorage.findTree(e.target),i;return(r&&r.pattern==="STI"||e.type==="entity-child")&&(i=this.metadataArgsStorage.filterSingleTableChildren(e.target).map(s=>s.target).filter(s=>typeof s=="function"),t.push(...i)),new at({connection:this.connection,args:e,inheritanceTree:t,tableTree:n,inheritancePattern:r?r.pattern:void 0})}computeParentEntityMetadata(e,t){t.tableType==="entity-child"&&(t.parentEntityMetadata=e.find(r=>r.inheritanceTree.indexOf(t.target)!==-1&&r.inheritancePattern==="STI"))}computeEntityMetadataStep1(e,t){let r=this.metadataArgsStorage.findInheritanceType(t.target),n=this.metadataArgsStorage.findDiscriminatorValue(t.target);if(typeof n<"u"?t.discriminatorValue=n.value:t.discriminatorValue=t.target.name,t.embeddeds=this.createEmbeddedsRecursively(t,this.metadataArgsStorage.filterEmbeddeds(t.inheritanceTree)).map(s=>(t.inheritancePattern==="STI"&&(s.columns=s.columns.map(a=>(a.isNullable=!0,a))),s)),t.ownColumns=this.metadataArgsStorage.filterColumns(t.inheritanceTree).map(s=>{if(t.tableType==="entity-child")return t.parentEntityMetadata.ownColumns.find(u=>u.propertyName===s.propertyName);if(t.tableType==="regular"&&s.target!==t.target){let u=this.metadataArgsStorage.columns.find(l=>l.propertyName===s.propertyName&&l.target===t.target);u&&u.options.default&&(s.options.default=u.options.default)}let a=new tt({connection:this.connection,entityMetadata:t,args:s});return e.find(u=>u.tableType==="entity-child"&&u.target===s.target)&&(a.isNullable=!0),a}),r&&r.column){let s=r.column&&r.column.name?r.column.name:"type",a=t.ownColumns.find(c=>c.propertyName===s);a?a.isDiscriminator=!0:(a=new tt({connection:this.connection,entityMetadata:t,args:{target:t.target,mode:"virtual",propertyName:s,options:r.column||{name:s,type:"varchar",nullable:!1}}}),a.isVirtual=!0,a.isDiscriminator=!0,t.ownColumns.push(a))}if(t.tableType==="entity-child"){let s=t.parentEntityMetadata.ownColumns.find(a=>a.isDiscriminator);s&&!t.ownColumns.find(a=>a===s)&&t.ownColumns.push(s),t.inheritancePattern=t.parentEntityMetadata.inheritancePattern,!t.treeType&&t.parentEntityMetadata.treeType&&(t.treeType=t.parentEntityMetadata.treeType,t.treeOptions=t.parentEntityMetadata.treeOptions,t.treeParentRelation=t.parentEntityMetadata.treeParentRelation,t.treeLevelColumn=t.parentEntityMetadata.treeLevelColumn)}let{namingStrategy:i}=this.connection;if(t.treeType==="materialized-path")t.ownColumns.push(new tt({connection:this.connection,entityMetadata:t,materializedPath:!0,args:{target:t.target,mode:"virtual",propertyName:"mpath",options:{name:i.materializedPathColumnName,type:String,nullable:!0,default:""}}}));else if(t.treeType==="nested-set"){let{left:s,right:a}=i.nestedSetColumnNames;t.ownColumns.push(new tt({connection:this.connection,entityMetadata:t,nestedSetLeft:!0,args:{target:t.target,mode:"virtual",propertyName:s,options:{name:s,type:Number,nullable:!1,default:1}}})),t.ownColumns.push(new tt({connection:this.connection,entityMetadata:t,nestedSetRight:!0,args:{target:t.target,mode:"virtual",propertyName:a,options:{name:a,type:Number,nullable:!1,default:2}}}))}if(t.ownRelations=this.metadataArgsStorage.filterRelations(t.inheritanceTree).map(s=>{if(t.tableType==="entity-child"){let a=t.parentEntityMetadata.ownRelations.find(u=>u.propertyName===s.propertyName),c=typeof s.type=="function"?s.type():s.type;if(a.type!==c){let u=Object.create(a);return u.type=c,u}return a}return new ds({entityMetadata:t,args:s})}),t.relationIds=this.metadataArgsStorage.filterRelationIds(t.inheritanceTree).map(s=>t.tableType==="entity-child"?t.parentEntityMetadata.relationIds.find(a=>a.propertyName===s.propertyName):new ms({entityMetadata:t,args:s})),t.relationCounts=this.metadataArgsStorage.filterRelationCounts(t.inheritanceTree).map(s=>t.tableType==="entity-child"?t.parentEntityMetadata.relationCounts.find(a=>a.propertyName===s.propertyName):new fs({entityMetadata:t,args:s})),t.ownListeners=this.metadataArgsStorage.filterListeners(t.inheritanceTree).map(s=>new ys({entityMetadata:t,args:s})),t.checks=this.metadataArgsStorage.filterChecks(t.inheritanceTree).map(s=>new pc({entityMetadata:t,args:s})),this.connection.driver.options.type==="postgres"&&(t.exclusions=this.metadataArgsStorage.filterExclusions(t.inheritanceTree).map(s=>new dc({entityMetadata:t,args:s}))),this.connection.driver.options.type==="cockroachdb"){t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(a=>!a.unique).map(a=>new ct({entityMetadata:t,args:a}));let s=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(a=>a.unique).map(a=>new xr({entityMetadata:t,args:{target:a.target,name:a.name,columns:a.columns}}));t.ownUniques.push(...s)}else t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).map(s=>new ct({entityMetadata:t,args:s}));if(H.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){let s=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(a=>new ct({entityMetadata:t,args:{target:a.target,name:a.name,columns:a.columns,unique:!0,synchronize:!0}}));t.ownIndices.push(...s)}else{let s=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(a=>new xr({entityMetadata:t,args:a}));t.ownUniques.push(...s)}}createEmbeddedsRecursively(e,t){return t.map(r=>{let n=new cc({entityMetadata:e,args:r}),i=typeof n.type=="function"?Er.getInheritanceTree(n.type):[n.type];return n.columns=this.metadataArgsStorage.filterColumns(i).map(s=>new tt({connection:this.connection,entityMetadata:e,embeddedMetadata:n,args:s})),n.relations=this.metadataArgsStorage.filterRelations(i).map(s=>new ds({entityMetadata:e,embeddedMetadata:n,args:s})),n.listeners=this.metadataArgsStorage.filterListeners(i).map(s=>new ys({entityMetadata:e,embeddedMetadata:n,args:s})),n.indices=this.metadataArgsStorage.filterIndices(i).map(s=>new ct({entityMetadata:e,embeddedMetadata:n,args:s})),n.uniques=this.metadataArgsStorage.filterUniques(i).map(s=>new xr({entityMetadata:e,embeddedMetadata:n,args:s})),n.relationIds=this.metadataArgsStorage.filterRelationIds(i).map(s=>new ms({entityMetadata:e,args:s})),n.relationCounts=this.metadataArgsStorage.filterRelationCounts(i).map(s=>new fs({entityMetadata:e,args:s})),n.embeddeds=this.createEmbeddedsRecursively(e,this.metadataArgsStorage.filterEmbeddeds(i)),n.embeddeds.forEach(s=>s.parentEmbeddedMetadata=n),e.allEmbeddeds.push(n),n})}computeEntityMetadataStep2(e){e.embeddeds.forEach(t=>t.build(this.connection)),e.embeddeds.forEach(t=>{t.columnsFromTree.forEach(r=>r.build(this.connection)),t.relationsFromTree.forEach(r=>r.build())}),e.ownColumns.forEach(t=>t.build(this.connection)),e.ownRelations.forEach(t=>t.build()),e.relations=e.embeddeds.reduce((t,r)=>t.concat(r.relationsFromTree),e.ownRelations),e.eagerRelations=e.relations.filter(t=>t.isEager),e.lazyRelations=e.relations.filter(t=>t.isLazy),e.oneToOneRelations=e.relations.filter(t=>t.isOneToOne),e.oneToManyRelations=e.relations.filter(t=>t.isOneToMany),e.manyToOneRelations=e.relations.filter(t=>t.isManyToOne),e.manyToManyRelations=e.relations.filter(t=>t.isManyToMany),e.ownerOneToOneRelations=e.relations.filter(t=>t.isOneToOneOwner),e.ownerManyToManyRelations=e.relations.filter(t=>t.isManyToManyOwner),e.treeParentRelation=e.relations.find(t=>t.isTreeParent),e.treeChildrenRelation=e.relations.find(t=>t.isTreeChildren),e.columns=e.embeddeds.reduce((t,r)=>t.concat(r.columnsFromTree),e.ownColumns),e.listeners=e.embeddeds.reduce((t,r)=>t.concat(r.listenersFromTree),e.ownListeners),e.afterLoadListeners=e.listeners.filter(t=>t.type===Re.AFTER_LOAD),e.afterInsertListeners=e.listeners.filter(t=>t.type===Re.AFTER_INSERT),e.afterUpdateListeners=e.listeners.filter(t=>t.type===Re.AFTER_UPDATE),e.afterRemoveListeners=e.listeners.filter(t=>t.type===Re.AFTER_REMOVE),e.afterSoftRemoveListeners=e.listeners.filter(t=>t.type===Re.AFTER_SOFT_REMOVE),e.afterRecoverListeners=e.listeners.filter(t=>t.type===Re.AFTER_RECOVER),e.beforeInsertListeners=e.listeners.filter(t=>t.type===Re.BEFORE_INSERT),e.beforeUpdateListeners=e.listeners.filter(t=>t.type===Re.BEFORE_UPDATE),e.beforeRemoveListeners=e.listeners.filter(t=>t.type===Re.BEFORE_REMOVE),e.beforeSoftRemoveListeners=e.listeners.filter(t=>t.type===Re.BEFORE_SOFT_REMOVE),e.beforeRecoverListeners=e.listeners.filter(t=>t.type===Re.BEFORE_RECOVER),e.indices=e.embeddeds.reduce((t,r)=>t.concat(r.indicesFromTree),e.ownIndices),e.uniques=e.embeddeds.reduce((t,r)=>t.concat(r.uniquesFromTree),e.ownUniques),e.primaryColumns=e.columns.filter(t=>t.isPrimary),e.nonVirtualColumns=e.columns.filter(t=>!t.isVirtual),e.ancestorColumns=e.columns.filter(t=>t.closureType==="ancestor"),e.descendantColumns=e.columns.filter(t=>t.closureType==="descendant"),e.hasMultiplePrimaryKeys=e.primaryColumns.length>1,e.generatedColumns=e.columns.filter(t=>t.isGenerated||t.isObjectId),e.hasUUIDGeneratedColumns=e.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,e.createDateColumn=e.columns.find(t=>t.isCreateDate),e.updateDateColumn=e.columns.find(t=>t.isUpdateDate),e.deleteDateColumn=e.columns.find(t=>t.isDeleteDate),e.versionColumn=e.columns.find(t=>t.isVersion),e.discriminatorColumn=e.columns.find(t=>t.isDiscriminator),e.treeLevelColumn=e.columns.find(t=>t.isTreeLevel),e.nestedSetLeftColumn=e.columns.find(t=>t.isNestedSetLeft),e.nestedSetRightColumn=e.columns.find(t=>t.isNestedSetRight),e.materializedPathColumn=e.columns.find(t=>t.isMaterializedPath),e.objectIdColumn=e.columns.find(t=>t.isObjectId),e.foreignKeys.forEach(t=>t.build(this.connection.namingStrategy)),e.propertiesMap=e.createPropertiesMap(),e.relationIds.forEach(t=>t.build()),e.relationCounts.forEach(t=>t.build()),e.embeddeds.forEach(t=>{t.relationIdsFromTree.forEach(r=>r.build()),t.relationCountsFromTree.forEach(r=>r.build())})}computeInverseProperties(e,t){e.relations.forEach(r=>{let n=t.find(i=>i.target===r.type||typeof r.type=="string"&&(i.targetName===r.type||i.givenTableName===r.type));if(!n)throw new y("Entity metadata for "+e.name+"#"+r.propertyPath+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");r.inverseEntityMetadata=n,r.inverseSidePropertyPath=r.buildInverseSidePropertyPath(),r.inverseRelation=n.relations.find(i=>i.propertyPath===r.inverseSidePropertyPath)})}createKeysForTableInheritance(e){e.indices.some(({givenColumnNames:r})=>!!r&&Array.isArray(r)&&r.length===1&&r[0]===e.discriminatorColumn?.databaseName)||e.indices.push(new ct({entityMetadata:e,columns:[e.discriminatorColumn],args:{target:e.target,unique:!1}}))}createForeignKeys(e,t){this.metadataArgsStorage.filterForeignKeys(e.inheritanceTree).forEach(r=>{let n=typeof r.type=="function"?r.type():r.type,i=t.find(h=>typeof n=="string"?h.targetName===n||h.givenTableName===n:x.isEntitySchema(n)?h.target===n.options.name||h.target===n.options.target:h.target===n);if(!i)throw new y("Entity metadata for "+e.name+(r.propertyName?"#"+r.propertyName:"")+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");let s=r.columnNames??[],a=r.referencedColumnNames??[],c=[],u=[];r.propertyName&&(s.push(r.propertyName),r.inverseSide&&(typeof r.inverseSide=="function"?a.push(r.inverseSide(i.propertiesMap)):a.push(r.inverseSide))),a.length||u.push(...i.primaryColumns);let l=(h,p)=>{let d=p.columns.find(A=>A.propertyName===h||A.databaseName===h);if(d)return d;let m=r.name?'"'+r.name+'" ':"",f=p.targetName;throw new y(`Foreign key constraint ${m}contains column that is missing in the entity (${f}): ${h}`)};c.push(...s.map(h=>l(h,e))),u.push(...a.map(h=>l(h,i))),e.foreignKeys.push(new Pt({entityMetadata:e,referencedEntityMetadata:i,namingStrategy:this.connection.namingStrategy,columns:c,referencedColumns:u,...r}))})}};var mc=class o extends y{static createEntitySchemaIsRequiredException(e){return new o(`EntitySchema is required for ${e} embedded field`)}static createTargetIsRequired(e){return new o(`Target field is required for ${e} embedded EntitySchema`)}constructor(e){super(e)}};var fc=class{transform(e){let t=new Wn;return e.forEach(r=>{let n=r.options,i={target:n.target||n.name,name:n.tableName,database:n.database,schema:n.schema,type:n.type||"regular",orderBy:n.orderBy,synchronize:n.synchronize,withoutRowid:!!n.withoutRowid,expression:n.expression};t.tables.push(i);let{inheritance:s}=n;s&&t.inheritances.push({target:n.target,pattern:s.pattern??"STI",column:s.column?typeof s.column=="string"?{name:s.column}:s.column:void 0});let{discriminatorValue:a}=n;a&&t.discriminatorValues.push({target:n.target||n.name,value:a}),this.transformColumnsRecursive(n,t)}),t}transformColumnsRecursive(e,t){Object.keys(e.columns).forEach(r=>{let i=e.columns[r],s="regular";i.createDate&&(s="createDate"),i.updateDate&&(s="updateDate"),i.deleteDate&&(s="deleteDate"),i.version&&(s="version"),i.treeChildrenCount&&(s="treeChildrenCount"),i.treeLevel&&(s="treeLevel"),i.objectId&&(s="objectId"),i.virtualProperty&&(s="virtual-property");let a={target:e.target||e.name,mode:s,propertyName:r,options:{type:i.type,name:i.objectId?"_id":i.name,primaryKeyConstraintName:i.primaryKeyConstraintName,length:i.length,width:i.width,nullable:i.nullable,readonly:i.readonly,update:i.update,select:i.select,insert:i.insert,primary:i.primary,unique:i.unique,comment:i.comment,default:i.default,onUpdate:i.onUpdate,precision:i.precision,scale:i.scale,zerofill:i.zerofill,unsigned:i.unsigned,charset:i.charset,collation:i.collation,enum:i.enum,enumName:i.enumName,asExpression:i.asExpression,generatedType:i.generatedType,hstoreType:i.hstoreType,array:i.array,transformer:i.transformer,spatialFeatureType:i.spatialFeatureType,srid:i.srid,query:i.query}};if(t.columns.push(a),i.generated){let c={target:e.target||e.name,propertyName:r,strategy:typeof i.generated=="string"?i.generated:"increment"};t.generations.push(c)}if(i.unique&&t.uniques.push({target:e.target||e.name,columns:[r]}),i.foreignKey){let c=i.foreignKey,u={target:e.target||e.name,type:c.target,propertyName:r,inverseSide:c.inverseSide,name:c.name,onDelete:c.onDelete,onUpdate:c.onUpdate,deferrable:c.deferrable};t.foreignKeys.push(u)}}),e.relations&&Object.keys(e.relations).forEach(r=>{let n=e.relations[r],i={target:e.target||e.name,propertyName:r,relationType:n.type,isLazy:n.lazy||!1,type:n.target,inverseSideProperty:n.inverseSide,isTreeParent:n.treeParent,isTreeChildren:n.treeChildren,options:{eager:n.eager||!1,cascade:n.cascade,nullable:n.nullable,onDelete:n.onDelete,onUpdate:n.onUpdate,deferrable:n.deferrable,createForeignKeyConstraints:n.createForeignKeyConstraints,persistence:n.persistence,orphanedRowAction:n.orphanedRowAction}};if(t.relations.push(i),n.joinColumn)if(typeof n.joinColumn=="boolean"){let s={target:e.target||e.name,propertyName:r};t.joinColumns.push(s)}else{let s=Array.isArray(n.joinColumn)?n.joinColumn:[n.joinColumn];for(let a of s){let c={target:e.target||e.name,propertyName:r,name:a.name,referencedColumnName:a.referencedColumnName,foreignKeyConstraintName:a.foreignKeyConstraintName};t.joinColumns.push(c)}}if(n.joinTable)if(typeof n.joinTable=="boolean"){let s={target:e.target||e.name,propertyName:r};t.joinTables.push(s)}else{let s={target:e.target||e.name,propertyName:r,name:n.joinTable.name,database:n.joinTable.database,schema:n.joinTable.schema,joinColumns:n.joinTable.joinColumn?[n.joinTable.joinColumn]:n.joinTable.joinColumns,inverseJoinColumns:n.joinTable.inverseJoinColumn?[n.joinTable.inverseJoinColumn]:n.joinTable.inverseJoinColumns};t.joinTables.push(s)}}),e.relationIds&&Object.keys(e.relationIds).forEach(r=>{let n=e.relationIds[r],i={propertyName:r,relation:n.relationName,target:e.target||e.name,alias:n.alias,queryBuilderFactory:n.queryBuilderFactory};t.relationIds.push(i)}),e.indices&&e.indices.forEach(r=>{let n={target:e.target||e.name,name:r.name,unique:r.unique===!0,spatial:r.spatial===!0,fulltext:r.fulltext===!0,nullFiltered:r.nullFiltered===!0,parser:r.parser,synchronize:r.synchronize!==!1,where:r.where,sparse:r.sparse,columns:r.columns};t.indices.push(n)}),e.foreignKeys&&e.foreignKeys.forEach(r=>{let n={target:e.target||e.name,type:r.target,columnNames:r.columnNames,referencedColumnNames:r.referencedColumnNames,name:r.name,onDelete:r.onDelete,onUpdate:r.onUpdate,deferrable:r.deferrable};t.foreignKeys.push(n)}),e.uniques&&e.uniques.forEach(r=>{let n={target:e.target||e.name,name:r.name,columns:r.columns,deferrable:r.deferrable};t.uniques.push(n)}),e.checks&&e.checks.forEach(r=>{let n={target:e.target||e.name,name:r.name,expression:r.expression};t.checks.push(n)}),e.exclusions&&e.exclusions.forEach(r=>{let n={target:e.target||e.name,name:r.name,expression:r.expression};t.exclusions.push(n)}),e.embeddeds&&Object.keys(e.embeddeds).forEach(r=>{let n=e.embeddeds[r];if(!n.schema)throw mc.createEntitySchemaIsRequiredException(r);let i=n.schema.options;t.embeddeds.push({target:e.target||e.name,propertyName:r,isArray:n.array===!0,prefix:n.prefix!==void 0?n.prefix:void 0,type:()=>i?.target||i.name}),this.transformColumnsRecursive(i,t)})}};var yc=class{constructor(e){this.connection=e}async buildMigrations(e){let[t,r]=K.splitClassesAndStrings(e);return[...t,...await sc(this.connection.logger,r)].map(i=>oc(i))}async buildSubscribers(e){let[t,r]=K.splitClassesAndStrings(e||[]),n=[...t,...await sc(this.connection.logger,r)];return pe().filterSubscribers(n).map(i=>oc(i.target))}async buildEntityMetadatas(e){let[t,r]=K.splitClassesAndStrings(e||[]),n=t.filter(l=>!x.isEntitySchema(l)),i=t.filter(l=>x.isEntitySchema(l)),s=[...n,...await sc(this.connection.logger,r)];s.forEach(l=>{x.isEntitySchema(l)&&i.push(l)});let a=new gs(this.connection,pe()).build(s),c=new fc().transform(i),u=new gs(this.connection,c).build();return[...a,...u]}};var Kt=class{constructor(e){this.options=e}logQuery(e,t,r){this.isLogEnabledFor("query")&&this.writeLog("query",{type:"query",prefix:"query",message:e,format:"sql",parameters:t},r)}logQueryError(e,t,r,n){this.isLogEnabledFor("query-error")&&this.writeLog("warn",[{type:"query-error",prefix:"query failed",message:t,format:"sql",parameters:r},{type:"query-error",prefix:"error",message:e}],n)}logQuerySlow(e,t,r,n){this.isLogEnabledFor("query-slow")&&this.writeLog("warn",[{type:"query-slow",prefix:"query is slow",message:t,format:"sql",parameters:r,additionalInfo:{time:e}},{type:"query-slow",prefix:"execution time",message:e}],n)}logSchemaBuild(e,t){this.isLogEnabledFor("schema-build")&&this.writeLog("schema",{type:"schema-build",message:e},t)}logMigration(e,t){this.isLogEnabledFor("migration")&&this.writeLog("log",{type:"migration",message:e},t)}log(e,t,r){switch(e){case"log":if(!this.isLogEnabledFor("log"))return;this.writeLog("log",{type:"log",message:t},r);break;case"info":if(!this.isLogEnabledFor("info"))return;this.writeLog("info",{type:"info",prefix:"info",message:t},r);break;case"warn":if(!this.isLogEnabledFor("warn"))return;this.writeLog("warn",{type:"warn",message:t},r);break}}isLogEnabledFor(e){switch(e){case"query":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1;case"error":case"query-error":return this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1;case"query-slow":return!0;case"schema":case"schema-build":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1;case"migration":return!0;case"log":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1;case"info":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1;case"warn":return this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1;default:return!1}}prepareLogMessages(e,t,r){t={addColonToPrefix:!0,appendParameterAsComment:!0,highlightSql:!0,formatSql:!1,...t};let n=Array.isArray(e)?e:[e];for(let i of n){if(typeof i!="object"&&(i={message:i}),i.format==="sql"){let s=String(i.message);t.formatSql&&(s=ge.formatSql(s,r?.connection?.options.type)),t.appendParameterAsComment&&i.parameters&&i.parameters.length&&(s+=` -- PARAMETERS: ${this.stringifyParams(i.parameters)}`),t.highlightSql&&(s=ge.highlightSql(s)),i.message=s}t.addColonToPrefix&&i.prefix&&(i.prefix+=":")}return n}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}};var gc=class extends Kt{writeLog(e,t,r){let n=this.prepareLogMessages(t,{highlightSql:!1});for(let i of n)switch(i.type??e){case"log":case"schema-build":case"migration":console.log(i.message);break;case"info":case"query":i.prefix?console.info(i.prefix,i.message):console.info(i.message);break;case"warn":case"query-slow":i.prefix?console.warn(i.prefix,i.message):console.warn(i.message);break;case"error":case"query-error":i.prefix?console.error(i.prefix,i.message):console.error(i.message);break}}};var Es=class extends Kt{writeLog(e,t,r){let n=this.prepareLogMessages(t);for(let i of n)switch(i.type??e){case"log":case"schema-build":case"migration":ge.log(String(i.message));break;case"info":case"query":i.prefix?ge.logInfo(i.prefix,i.message):ge.log(String(i.message));break;case"warn":case"query-slow":i.prefix?ge.logWarn(i.prefix,i.message):console.warn(ge.warn(String(i.message)));break;case"error":case"query-error":i.prefix?ge.logError(i.prefix,String(i.message)):console.error(ge.error(String(i.message)));break}}};var Sl=class{logQuery(){throw new Error("This logger is not applicable in a browser context")}logQueryError(){throw new Error("This logger is not applicable in a browser context")}logQuerySlow(){throw new Error("This logger is not applicable in a browser context")}logSchemaBuild(){throw new Error("This logger is not applicable in a browser context")}logMigration(){throw new Error("This logger is not applicable in a browser context")}log(){throw new Error("This logger is not applicable in a browser context")}},Ec=class extends Sl{};var zt=It(ug()),wc=class extends Kt{constructor(){super(...arguments),this.logger={log:(0,zt.debug)("typeorm:log"),info:(0,zt.debug)("typeorm:info"),warn:(0,zt.debug)("typeorm:warn"),error:(0,zt.debug)("typeorm:error"),query:(0,zt.debug)("typeorm:query:log"),"query-error":(0,zt.debug)("typeorm:query:error"),"query-slow":(0,zt.debug)("typeorm:query:slow"),"schema-build":(0,zt.debug)("typeorm:schema"),migration:(0,zt.debug)("typeorm:migration")}}isLogEnabledFor(e){switch(e){case"query":return this.logger.query.enabled;case"query-error":return this.logger["query-error"].enabled;case"query-slow":return!0;case"schema":case"schema-build":return this.logger["schema-build"].enabled;case"migration":return this.logger.migration.enabled;case"log":return this.logger.log.enabled;case"info":return this.logger.info.enabled;case"warn":return this.logger.warn.enabled;default:return!1}}writeLog(e,t,r){let n=this.prepareLogMessages(t,{appendParameterAsComment:!1});for(let i of n){let s=i.type??e;s in this.logger&&(i.prefix?this.logger[s](i.prefix,i.message):this.logger[s](i.message),i.parameters&&i.parameters.length&&this.logger[s]("parameters:",i.parameters))}}};var Nc=class extends Kt{writeLog(e,t,r){let n=this.prepareLogMessages(t,{highlightSql:!0,formatSql:!0},r);for(let i of n)switch(i.type??e){case"log":case"schema-build":case"migration":ge.log(String(i.message));break;case"info":case"query":i.prefix?ge.logInfo(i.prefix,i.message):ge.log(String(i.message));break;case"warn":case"query-slow":i.prefix?ge.logWarn(i.prefix,i.message):console.warn(ge.warn(String(i.message)));break;case"error":case"query-error":i.prefix?ge.logError(i.prefix,String(i.message)):console.error(ge.error(String(i.message)));break}}};var Ts=class{create(e,t){if(X.isObject(e))return e;if(e)switch(e){case"simple-console":return new gc(t);case"file":return new Ec(t);case"advanced-console":return new Es(t);case"formatted-console":return new Nc(t);case"debug":return new wc}return new Es(t)}};var Ac=class{constructor(e,t){this.connection=e,this.clientType=t,this.redis=this.loadRedis()}async connect(){let e=this.connection.options.cache;if(this.clientType==="redis"){let t={...e?.options},r=this.redis.createClient(t);typeof r.connect=="function"&&(t.legacyMode=!0,r=this.redis.createClient(t)),this.client=r,typeof this.connection.options.cache=="object"&&this.connection.options.cache.ignoreErrors&&this.client.on("error",i=>{this.connection.logger.log("warn",i)}),typeof this.client.connect=="function"&&await this.client.connect(),this.detectRedisVersion()}else if(this.clientType==="ioredis")e&&e.port?e.options?this.client=new this.redis(e.port,e.options):this.client=new this.redis(e.port):e&&e.options?this.client=new this.redis(e.options):this.client=new this.redis;else if(this.clientType==="ioredis/cluster")if(e&&e.options&&Array.isArray(e.options))this.client=new this.redis.Cluster(e.options);else if(e&&e.options&&e.options.startupNodes)this.client=new this.redis.Cluster(e.options.startupNodes,e.options.options);else throw new y(`options.startupNodes required for ${this.clientType}.`)}async disconnect(){if(this.isRedis5OrHigher()){await this.client.quit(),this.client=void 0;return}return new Promise((e,t)=>{this.client.quit((r,n)=>{if(r)return t(r);e(),this.client=void 0})})}async synchronize(e){}getFromCache(e,t){let r=e.identifier||e.query;return r?this.isRedis5OrHigher()?this.client.get(r).then(n=>n?JSON.parse(n):void 0):new Promise((n,i)=>{this.client.get(r,(s,a)=>{if(s)return i(s);n(a?JSON.parse(a):void 0)})}):Promise.resolve(void 0)}isExpired(e){return e.time+e.duration<Date.now()}async storeInCache(e,t,r){let n=e.identifier||e.query;if(!n)return;let i=JSON.stringify(e),s=e.duration;if(this.isRedis5OrHigher()){await this.client.set(n,i,{PX:s});return}return new Promise((a,c)=>{this.client.set(n,i,"PX",s,(u,l)=>{if(u)return c(u);a()})})}async clear(e){if(this.isRedis5OrHigher()){await this.client.flushDb();return}return new Promise((t,r)=>{this.client.flushdb((n,i)=>{if(n)return r(n);t()})})}async remove(e,t){await Promise.all(e.map(r=>this.deleteKey(r)))}async deleteKey(e){if(this.isRedis5OrHigher()){await this.client.del(e);return}return new Promise((t,r)=>{this.client.del(e,(n,i)=>{if(n)return r(n);t()})})}loadRedis(){try{return this.clientType==="ioredis/cluster"?ge.load("ioredis"):ge.load(this.clientType)}catch{throw new y(`Cannot use cache because ${this.clientType} is not installed. Please run "npm i ${this.clientType}".`)}}detectRedisVersion(){if(this.clientType==="redis")try{let e=this.client.set;e&&e.length<=3?this.redisMajorVersion=5:this.redisMajorVersion=3}catch{this.redisMajorVersion=3}}isRedis5OrHigher(){return this.clientType!=="redis"?!1:this.redisMajorVersion!==void 0&&this.redisMajorVersion>=5}};var xc=class{constructor(e){this.connection=e;let{schema:t}=this.connection.driver.options,r=this.connection.driver.database,i=(typeof this.connection.options.cache=="object"?this.connection.options.cache:{}).tableName||"query-result-cache";this.queryResultCacheDatabase=r,this.queryResultCacheSchema=t,this.queryResultCacheTable=this.connection.driver.buildTableName(i,t,r)}async connect(){}async disconnect(){}async synchronize(e){e=this.getQueryRunner(e);let t=this.connection.driver;await e.hasTable(this.queryResultCacheTable)||await e.createTable(new Me({database:this.queryResultCacheDatabase,schema:this.queryResultCacheSchema,name:this.queryResultCacheTable,columns:[{name:"id",isPrimary:!0,isNullable:!1,type:t.normalizeType({type:t.mappedDataTypes.cacheId}),generationStrategy:t.options.type==="spanner"?"uuid":"increment",isGenerated:!0},{name:"identifier",type:t.normalizeType({type:t.mappedDataTypes.cacheIdentifier}),isNullable:!0},{name:"time",type:t.normalizeType({type:t.mappedDataTypes.cacheTime}),isPrimary:!1,isNullable:!1},{name:"duration",type:t.normalizeType({type:t.mappedDataTypes.cacheDuration}),isPrimary:!1,isNullable:!1},{name:"query",type:t.normalizeType({type:t.mappedDataTypes.cacheQuery}),isPrimary:!1,isNullable:!1},{name:"result",type:t.normalizeType({type:t.mappedDataTypes.cacheResult}),isNullable:!1}]}))}getFromCache(e,t){t=this.getQueryRunner(t);let r=this.connection.createQueryBuilder(t).select().from(this.queryResultCacheTable,"cache");return e.identifier?r.where(`${r.escape("cache")}.${r.escape("identifier")} = :identifier`).setParameters({identifier:this.connection.driver.options.type==="mssql"?new mt(e.identifier,"nvarchar"):e.identifier}).cache(!1).getRawOne():e.query?this.connection.driver.options.type==="oracle"?r.where(`dbms_lob.compare(${r.escape("cache")}.${r.escape("query")}, :query) = 0`,{query:e.query}).cache(!1).getRawOne():r.where(`${r.escape("cache")}.${r.escape("query")} = :query`).setParameters({query:this.connection.driver.options.type==="mssql"?new mt(e.query,"nvarchar"):e.query}).cache(!1).getRawOne():Promise.resolve(void 0)}isExpired(e){let t=typeof e.duration=="string"?parseInt(e.duration):e.duration;return(typeof e.time=="string"?parseInt(e.time):e.time)+t<Date.now()}async storeInCache(e,t,r){let n=r===void 0||r?.getReplicationMode()==="slave";(r===void 0||n)&&(r=this.connection.createQueryRunner("master"));let i=e;if(this.connection.driver.options.type==="mssql"&&(i={identifier:new mt(e.identifier,"nvarchar"),time:new mt(e.time,"bigint"),duration:new mt(e.duration,"int"),query:new mt(e.query,"nvarchar"),result:new mt(e.result,"nvarchar")}),t&&t.identifier){let s=r.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);s.where(`${s.escape("identifier")} = :condition`,{condition:i.identifier}),await s.execute()}else if(t&&t.query){let s=r.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);this.connection.driver.options.type==="oracle"?s.where('dbms_lob.compare("query", :condition) = 0',{condition:i.query}):s.where(`${s.escape("query")} = :condition`,{condition:i.query}),await s.execute()}else this.connection.driver.options.type==="spanner"&&!i.id&&(i.id=is()),await r.manager.createQueryBuilder().insert().into(this.queryResultCacheTable).values(i).execute();n&&await r.release()}async clear(e){return this.getQueryRunner(e).clearTable(this.queryResultCacheTable)}async remove(e,t){let r=t||this.getQueryRunner();await Promise.all(e.map(n=>{let i=r.manager.createQueryBuilder();return i.delete().from(this.queryResultCacheTable).where(`${i.escape("identifier")} = :identifier`,{identifier:n}).execute()})),t||await r.release()}getQueryRunner(e){return e||this.connection.createQueryRunner()}};var bs=class{constructor(e){this.connection=e}create(){if(!this.connection.options.cache)throw new y("To use cache you need to enable it in connection options by setting cache: true or providing some caching options. Example: { host: ..., username: ..., cache: true }");let e=this.connection.options.cache;return e.provider&&typeof e.provider=="function"?e.provider(this.connection):e.type==="redis"||e.type==="ioredis"||e.type==="ioredis/cluster"?new Ac(this.connection,e.type):new xc(this.connection)}};var Cc=class{constructor(e){this.connection=e}load(e,t,r,n){return r&&r.isReleased&&(r=void 0),e.isManyToOne||e.isOneToOneOwner?this.loadManyToOneOrOneToOneOwner(e,t,r,n):e.isOneToMany||e.isOneToOneNotOwner?this.loadOneToManyOrOneToOneNotOwner(e,t,r,n):e.isManyToManyOwner?this.loadManyToManyOwner(e,t,r,n):this.loadManyToManyNotOwner(e,t,r,n)}loadManyToOneOrOneToOneOwner(e,t,r,n){let i=Array.isArray(t)?t:[t],s=e.entityMetadata.name,a=n||this.connection.createQueryBuilder(r).select(e.propertyName).from(e.type,e.propertyName),c=a.expressionMap.mainAlias.name,u=e.entityMetadata.primaryColumns,h=(e.isOwning?e.joinColumns:e.inverseRelation.joinColumns).map(p=>`${e.entityMetadata.name}.${p.propertyName} = ${c}.${p.referencedColumn.propertyName}`).join(" AND ");if(a.innerJoin(e.entityMetadata.target,s,h),u.length===1)a.where(`${s}.${u[0].propertyPath} IN (:...${s+"_"+u[0].propertyName})`),a.setParameter(s+"_"+u[0].propertyName,i.map(p=>u[0].getEntityValue(p,!0)));else{let p=i.map((d,m)=>u.map((f,A)=>{let R=s+"_entity_"+m+"_"+A;return a.setParameter(R,f.getEntityValue(d,!0)),s+"."+f.propertyPath+" = :"+R}).join(" AND ")).map(d=>"("+d+")").join(" OR ");a.where(p)}return Ge.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadOneToManyOrOneToOneNotOwner(e,t,r,n){let i=Array.isArray(t)?t:[t],s=e.inverseRelation.joinColumns,a=n||this.connection.createQueryBuilder(r).select(e.propertyName).from(e.inverseRelation.entityMetadata.target,e.propertyName),c=a.expressionMap.mainAlias.name;if(s.length===1)a.where(`${c}.${s[0].propertyPath} IN (:...${c+"_"+s[0].propertyName})`),a.setParameter(c+"_"+s[0].propertyName,i.map(u=>s[0].referencedColumn.getEntityValue(u,!0)));else{let u=i.map((l,h)=>s.map((p,d)=>{let m=c+"_entity_"+h+"_"+d;return a.setParameter(m,p.referencedColumn.getEntityValue(l,!0)),c+"."+p.propertyPath+" = :"+m}).join(" AND ")).map(l=>"("+l+")").join(" OR ");a.where(u)}return Ge.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadManyToManyOwner(e,t,r,n){let i=Array.isArray(t)?t:[t],s=e.joinColumns.reduce((p,d)=>(p[d.propertyName]=i.map(m=>d.referencedColumn.getEntityValue(m,!0)),p),{}),a=n||this.connection.createQueryBuilder(r).select(e.propertyName).from(e.type,e.propertyName),c=a.expressionMap.mainAlias.name,u=e.junctionEntityMetadata.tableName,l=e.joinColumns.map(p=>`${u}.${p.propertyName} IN (:...${p.propertyName})`),h=e.inverseJoinColumns.map(p=>`${u}.${p.propertyName}=${c}.${p.referencedColumn.propertyName}`);return a.innerJoin(u,u,[...l,...h].join(" AND ")).setParameters(s),Ge.joinEagerRelations(a,a.alias,a.expressionMap.mainAlias.metadata),a.getMany()}loadManyToManyNotOwner(e,t,r,n){let i=Array.isArray(t)?t:[t],s=n||this.connection.createQueryBuilder(r).select(e.propertyName).from(e.type,e.propertyName),a=s.expressionMap.mainAlias.name,c=e.junctionEntityMetadata.tableName,u=e.inverseRelation.joinColumns.map(p=>`${c}.${p.propertyName} = ${a}.${p.referencedColumn.propertyName}`),l=e.inverseRelation.inverseJoinColumns.map(p=>`${c}.${p.propertyName} IN (:...${p.propertyName})`),h=e.inverseRelation.inverseJoinColumns.reduce((p,d)=>(p[d.propertyName]=i.map(m=>d.referencedColumn.getEntityValue(m,!0)),p),{});return s.innerJoin(c,c,[...u,...l].join(" AND ")).setParameters(h),Ge.joinEagerRelations(s,s.alias,s.expressionMap.mainAlias.metadata),s.getMany()}enableLazyLoad(e,t,r){let n=this,i="__"+e.propertyName+"__",s="__promise_"+e.propertyName+"__",a="__has_"+e.propertyName+"__",c=(l,h)=>(l[i]=h,l[a]=!0,delete l[s],h),u=(l,h)=>(delete l[a],delete l[i],l[s]=h,h.then(p=>l[s]===h?c(l,p):p),h);Object.defineProperty(t,e.propertyName,{get:function(){if(this[a]===!0||this[i]!==void 0)return Promise.resolve(this[i]);if(this[s])return this[s];let l=n.load(e,this,r).then(h=>e.isOneToOne||e.isManyToOne?h.length===0?null:h[0]:h);return u(this,l)},set:function(l){l instanceof Promise?u(this,l):c(this,l)},configurable:!0,enumerable:!1})}};xl();var Zr=class{constructor(e){this["@instanceof"]=Symbol.for("DataSource"),this.migrations=[],this.subscribers=[],this.entityMetadatas=[],this.entityMetadatasMap=new Map,xl(),this.name=e.name||"default",this.options=e,this.logger=new Ts().create(this.options.logger,this.options.logging),this.driver=new Vn().create(this),this.manager=this.createEntityManager(),this.namingStrategy=e.namingStrategy||new zn,this.metadataTableName=e.metadataTableName||"typeorm_metadata",this.queryResultCache=e.cache?new bs(this).create():void 0,this.relationLoader=new Cc(this),this.relationIdLoader=new Kn(this),this.isInitialized=!1}get isConnected(){return this.isInitialized}get mongoManager(){if(!x.isMongoEntityManager(this.manager))throw new y("MongoEntityManager is only available for MongoDB databases.");return this.manager}get sqljsManager(){if(!x.isSqljsEntityManager(this.manager))throw new y("SqljsEntityManager is only available for Sqljs databases.");return this.manager}setOptions(e){return Object.assign(this.options,e),(e.logger||e.logging)&&(this.logger=new Ts().create(e.logger||this.options.logger,e.logging||this.options.logging)),e.namingStrategy&&(this.namingStrategy=e.namingStrategy),e.cache&&(this.queryResultCache=new bs(this).create()),e.database&&(this.driver.database=H.buildDriverOptions(this.options).database),this}async initialize(){if(this.isInitialized)throw new Va(this.name);await this.driver.connect(),this.queryResultCache&&await this.queryResultCache.connect(),X.assign(this,{isInitialized:!0});try{await this.buildMetadatas(),await this.driver.afterConnect(),this.options.dropSchema&&await this.dropDatabase(),this.options.migrationsRun&&await this.runMigrations({transaction:this.options.migrationsTransactionMode}),this.options.synchronize&&await this.synchronize()}catch(e){throw await this.destroy(),e}return this}async connect(){return this.initialize()}async destroy(){if(!this.isInitialized)throw new yr(this.name);await this.driver.disconnect(),this.queryResultCache&&await this.queryResultCache.disconnect(),X.assign(this,{isInitialized:!1})}async close(){return this.destroy()}async synchronize(e=!1){if(!this.isInitialized)throw new yr(this.name);e&&await this.dropDatabase(),await this.driver.createSchemaBuilder().build()}async dropDatabase(){let e=this.createQueryRunner();try{if(this.driver.options.type==="mssql"||H.isMySQLFamily(this.driver)||this.driver.options.type==="aurora-mysql"||H.isSQLiteFamily(this.driver)){let t=[];if(this.entityMetadatas.forEach(r=>{r.database&&t.indexOf(r.database)===-1&&t.push(r.database)}),t.length===0&&this.driver.database&&t.push(this.driver.database),t.length===0)await e.clearDatabase();else for(let r of t)await e.clearDatabase(r)}else await e.clearDatabase()}finally{await e.release()}}async runMigrations(e){if(!this.isInitialized)throw new yr(this.name);let t=new Jr(this);return t.transaction=e?.transaction||this.options?.migrationsTransactionMode||"all",t.fake=e&&e.fake||!1,await t.executePendingMigrations()}async undoLastMigration(e){if(!this.isInitialized)throw new yr(this.name);let t=new Jr(this);t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.undoLastMigration()}async showMigrations(){if(!this.isInitialized)throw new yr(this.name);return await new Jr(this).showMigrations()}hasMetadata(e){return!!this.findMetadata(e)}getMetadata(e){let t=this.findMetadata(e);if(!t)throw new za(e);return t}getRepository(e){return this.manager.getRepository(e)}getTreeRepository(e){return this.manager.getTreeRepository(e)}getMongoRepository(e){if(this.driver.options.type!=="mongodb")throw new y("You can use getMongoRepository only for MongoDB connections.");return this.manager.getRepository(e)}getCustomRepository(e){return this.manager.getCustomRepository(e)}async transaction(e,t){return this.manager.transaction(e,t)}async query(e,t,r){if(x.isMongoEntityManager(this.manager))throw new y("Queries aren't supported by MongoDB.");if(r&&r.isReleased)throw new Qn;let n=r||this.createQueryRunner();try{return await n.query(e,t)}finally{r||await n.release()}}async sql(e,...t){let{query:r,parameters:n}=gr({driver:this.driver,strings:e,expressions:t});return await this.query(r,n)}createQueryBuilder(e,t,r){if(x.isMongoEntityManager(this.manager))throw new y("Query Builder is not supported by MongoDB.");if(t){t=H.buildAlias(this.driver,void 0,t);let n=this.getMetadata(e);return new Nr(this,r).select(t).from(n.target,t)}else return new Nr(this,e)}createQueryRunner(e="master"){let t=this.driver.createQueryRunner(e),r=this.createEntityManager(t);return Object.assign(t,{manager:r}),t}getManyToManyMetadata(e,t){let r=this.getMetadata(e).findRelationWithPropertyPath(t);if(!r)throw new y(`Relation "${t}" was not found in ${e} entity.`);if(!r.isManyToMany)throw new y(`Relation "${e}#${t}" does not have a many-to-many relationship.You can use this method only on many-to-many relations.`);return r.junctionEntityMetadata}createEntityManager(e){return new ic().create(this,e)}findMetadata(e){let t=this.entityMetadatasMap.get(e);if(t)return t;for(let[r,n]of this.entityMetadatasMap){if(x.isEntitySchema(e)&&n.name===e.options.name)return n;if(typeof e=="string"){if(e.indexOf(".")!==-1){if(n.tablePath===e)return n}else if(n.name===e||n.tableName===e)return n}if(X.isObjectWithName(e)&&typeof e.name=="string"){if(e.name.indexOf(".")!==-1){if(n.tablePath===e.name)return n}else if(n.name===e.name||n.tableName===e.name)return n}}}async buildMetadatas(){let e=new yc(this),t=new Ho,r=X.mixedListToArray(this.options.subscribers||[]),n=await e.buildSubscribers(r);X.assign(this,{subscribers:n});let i=X.mixedListToArray(this.options.entities||[]),s=await e.buildEntityMetadatas(i);X.assign(this,{entityMetadatas:s,entityMetadatasMap:new Map(s.map(u=>[u.target,u]))});let a=X.mixedListToArray(this.options.migrations||[]),c=await e.buildMigrations(a);X.assign(this,{migrations:c}),t.validateMany(this.entityMetadatas.filter(u=>u.tableType!=="view"),this.driver);for(let u of s)x.isBaseEntityConstructor(u.target)&&u.target.useDataSource(this)}defaultReplicationModeForReads(){if("replication"in this.driver.options&&this.driver.options.replication){let e=this.driver.options.replication.defaultMode;if(e)return e}return"slave"}};function pe(){let o=ge.getGlobalVariable();return o.typeormMetadataArgsStorage||(o.typeormMetadataArgsStorage=new Wn),o.typeormMetadataArgsStorage}var Dx=class{constructor(o,e){this.client=o,this.driver=e,this.connection=e.connection,this.manager=this.connection?.manager,this.broadcaster=new Be(this)}connection;isReleased=!1;isTransactionActive=!1;data={};manager;broadcaster;async connect(){await this.client.connect()}async release(){this.isReleased=!0}async startTransaction(o){let e=o?`begin isolation level ${o}`:"begin";await this.query(e),this.isTransactionActive=!0}async commitTransaction(){await this.query("commit"),this.isTransactionActive=!1}async rollbackTransaction(){await this.query("rollback"),this.isTransactionActive=!1}async query(o,e,t){o=o.replace(/COUNT\(1\)/,"COUNT(*)"),this.connection?.options?.logging&&console.log(`[tailordb] query: ${o} -- params: ${JSON.stringify(e)}`);let r=await this.client.queryObject(o,e??[]),n=r?.rows??[],i=r?.rowCount??n.length??0;return t?{records:n,affected:i,raw:n}:n}},Lx=class{options;client;connection;supportedUpsertTypes=[];spatialTypes=[];withLengthColumnTypes=[];withPrecisionColumnTypes=[];withScaleColumnTypes=[];mappedDataTypes={createDate:"timestamp",createDateDefault:"CURRENT_TIMESTAMP",createDatePrecision:void 0,updateDate:"timestamp",updateDateDefault:"CURRENT_TIMESTAMP",updateDatePrecision:void 0,deleteDate:"timestamp",deleteDateNullable:!0,deleteDatePrecision:void 0,version:"int",treeLevel:"int"};dataTypeDefaults={};supportedDataTypes=["int","integer","bigint","smallint","numeric","decimal","real","float","varchar","character varying","char","character","text","boolean","date","time","timestamp","timestamptz","uuid","json","jsonb"];constructor(o){this.options=o;let e=o?.tailordb?.namespace??o?.namespace;this.options.type="postgres",this.options.schema||(this.options.schema=o?.schema??o?.tailordb?.schema??e),this.client=new tailordb.Client({namespace:e})}async connect(){await this.client.connect()}async afterConnect(){}async disconnect(){await this.client.end()}createQueryRunner(o="master"){return new Dx(this.client,this)}escape(o){return o.startsWith('"')&&o.endsWith('"')?o:'"'+o.replace(/"/g,'""')+'"'}buildTableName(o,e){return this.escape(o)}createParameter(o,e){return`$${e+1}`}isReturningSqlSupported(){return!0}isUUIDGenerationSupported(){return!0}escapeQueryWithParameters(o,e,t){if(Array.isArray(t))return[o,t];let r=t&&typeof t=="object"&&Object.keys(t).length>0?t:e&&typeof e=="object"?e:{},n=[];o=o.replace(/:([A-Za-z0-9_]+)/g,(s,a)=>{if(!(a in r))return s;let c=n.indexOf(a);return c===-1&&(n.push(a),c=n.length-1),`$${c+1}`});let i=n.map(s=>r[s]);return[o,i]}parametrizeValue(o,e){return e}preparePersistentValue(o){return o}prepareHydratedValue(o){return o}normalizeType(o){return"text"}normalizeDefault(o){}normalizeIsUnique(o){return!1}createGeneratedMap(o,e){let t;if(e&&typeof e=="object"&&(Array.isArray(e.records)?t=e.records[0]:Array.isArray(e.raw)?t=e.raw[0]:Array.isArray(e)?t=e[0]:t=e),!t)return;let r={};for(let n of o?.columns??[]){let i=n.databaseName;Object.prototype.hasOwnProperty.call(t,i)&&(r[n.propertyName]=t[i])}return r}obtainMasterConnection(){return null}obtainSlaveConnection(){return null}createSchemaBuilder(){throw new Error("SchemaBuilder not supported in Tailordb prototype")}createQueryRunnerMode(o){return this.createQueryRunner("master")}};function hg(o){let e=Vn;if(e.__tailordb_patched)throw Error("Tailordb driver already registered");let t=e.prototype.create;return e.prototype.create=function(r){let n=r?.options;if(n&&n.type==="tailordb"){let i=new Lx(n);return i.connection=r,i}return t.apply(this,arguments)},e.__tailordb_patched=!0,new Zr({type:"tailordb",tailordb:{namespace:o.namespace},entities:o.entities,synchronize:!1,logging:o.logging})}var Ehe=async()=>{let o=hg({namespace:"provisioning",entities:[St],logging:!0});await o.initialize();let e=o.getRepository(St);await e.deleteAll();let t=await e.count({});console.log(`count=${t}`),await o.transaction(async i=>{let s=i.getRepository(St);for(let a=0;a<3;a++){let c=await s.save(s.create({name:"test",email:`test${a}@example.com`}));console.log("Inserted user:",c.id,c.name,c.email)}}),console.log(`count=${await e.count({})}`);let r=await e.find();for(let i of r)console.log(`Confirm: ${i.id}, ${i.name}, ${i.email}`);await o.transaction(async i=>{let s=i.getRepository(St);for(let a=0;a<3;a++){let c=await s.findOneBy({id:r[a].id});c&&(c.name=`test-update${a}`,await s.save(c),console.log("Updated user:",c.id,c.name,c.email))}});let n=await e.find();for(let i of n)console.log(`Confirm2: ${i.id}, ${i.name}, ${i.email}`);await o.destroy()};export{Ehe as default};
/*! Bundled license information:

reflect-metadata/Reflect.js:
reflect-metadata/Reflect.js:
  (*! *****************************************************************************
  Copyright (C) Microsoft. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License"); you may not use
  this file except in compliance with the License. You may obtain a copy of the
  License at http://www.apache.org/licenses/LICENSE-2.0
  
  THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
  WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
  MERCHANTABLITY OR NON-INFRINGEMENT.
  
  See the Apache Version 2.0 License for specific language governing permissions
  and limitations under the License.
  ***************************************************************************** *)

ieee754/index.js:
ieee754/index.js:
  (*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> *)

buffer/index.js:
buffer/index.js:
  (*!
   * The buffer module from node.js, for the browser.
   *
   * @author   Feross Aboukhadijeh <https://feross.org>
   * @license  MIT
   *)

safe-buffer/index.js:
safe-buffer/index.js:
  (*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> *)

typeorm/browser/index.js:
typeorm/browser/index.js:
  (*!
   *)
*/
